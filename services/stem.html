<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü–æ–∂–µ–∂–Ω–∏–∫ —ñ –í–æ–≥–æ–Ω—å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --cell-gap-sm: 2px;
        --cell-gap-lg: 4px;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        touch-action: manipulation;
      }
      .grid-cell {
        aspect-ratio: 1;
        border: 2px solid #fdba74;
        transition: all 0.2s;
        position: relative;
      }
      @media (max-width: 640px) {
        .grid-cell {
          border-width: 1px;
        }
      }

      /* –ó–ú–Ü–ù–ê v7: –ó–±—ñ–ª—å—à–µ–Ω–æ —Ä–æ–∑–º—ñ—Ä —Å–ª–æ—Ç–∞ —Ç–∞ —Ä–∞–º–∫–∏ */
      .command-slot {
        aspect-ratio: 1;
        border: 4px dashed #f97316; /* –¢–æ–≤—â–∞ —Ä–∞–º–∫–∞ */
        transition: all 0.2s;
        height: 60px; /* –ë—É–ª–æ 48px */
        flex-shrink: 0;
        width: auto;
      }
      .command-slot.filled {
        border-style: solid;
        border-color: #ea580c;
        background-color: #fff7ed;
        cursor: pointer;
      }
      @media (min-width: 640px) {
        .command-slot {
          height: 80px; /* –ë—É–ª–æ 64px */
        }
      }
      #commandSlots {
        display: flex;
        gap: 0.5rem;
        padding-bottom: 4px;
      }
      @media (min-width: 640px) {
        #commandSlots {
          gap: 0.75rem;
        }
      }

      /* –ó–ú–Ü–ù–ê v7: –ó–±—ñ–ª—å—à–µ–Ω–æ –∑–æ–Ω—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è (min-width/height) —Ç–∞ —ñ–∫–æ–Ω–∫—É */
      .arrow-btn {
        min-width: 70px;
        min-height: 70px;
        aspect-ratio: 1;
        font-size: 2rem; /* –ë—ñ–ª—å—à–∞ —ñ–∫–æ–Ω–∫–∞ */
        cursor: pointer;
        transition: transform 0.15s;
        user-select: none;
      }
      .arrow-btn:active {
        transform: scale(1.08);
      }
      @media (min-width: 640px) {
        .arrow-btn {
          min-width: 90px;
          min-height: 90px;
          font-size: 2.5rem;
        }
      }

      @keyframes firefighter-float {
        0%,
        100% {
          transform: translateY(0) rotate(0);
        }
        50% {
          transform: translateY(-8px) rotate(5deg);
        }
      }
      /* –ó–ú–Ü–ù–ê v7: –ó–±—ñ–ª—å—à–µ–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –¥–æ–¥–∞–Ω–æ —Ç—ñ–Ω—å */
      .character {
        animation: firefighter-float 2s infinite ease-in-out;
        font-size: 3rem !important; /* –ë—ñ–ª—å—à–∏–π –ø–æ–∂–µ–∂–Ω–∏–∫ */
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3)); /* –¢—ñ–Ω—å */
        transform-style: preserve-3d;
      }
      @media (min-width: 640px) {
        .character {
          font-size: 4rem !important;
        }
      }

      @keyframes fire-extinguish {
        0% {
          transform: scale(1) rotate(0);
          opacity: 1;
        }
        50% {
          transform: scale(1.5) rotate(180deg);
          opacity: 0.7;
        }
        100% {
          transform: scale(0.2) rotate(360deg);
          opacity: 0;
        }
      }
      .extinguishing {
        animation: fire-extinguish 0.7s forwards;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .shake {
        animation: shake 0.5s;
      }
      @keyframes cell-sparkle {
        0% {
          transform: scale(1);
          background-color: #fff7ed;
          box-shadow: 0 0 0 rgba(234, 88, 12, 0);
        }
        50% {
          transform: scale(1.05);
          background-color: #ffedd5;
          box-shadow: 0 0 20px rgba(234, 88, 12, 0.6);
        }
        100% {
          transform: scale(1);
          background-color: #fff7ed;
          box-shadow: 0 0 0 rgba(234, 88, 12, 0);
        }
      }
      .landing {
        animation: cell-sparkle 0.4s ease-out;
      }
      @keyframes win-rainbow {
        0% {
          transform: scale(1) rotate(0);
          filter: hue-rotate(0deg);
        }
        20% {
          transform: scale(1.15) rotate(-8deg);
          filter: hue-rotate(60deg);
        }
        40% {
          transform: scale(1.15) rotate(8deg);
          filter: hue-rotate(120deg);
        }
        60% {
          transform: scale(1.15) rotate(-8deg);
          filter: hue-rotate(180deg);
        }
        80% {
          transform: scale(1.15) rotate(8deg);
          filter: hue-rotate(240deg);
        }
        100% {
          transform: scale(1) rotate(0);
          filter: hue-rotate(360deg);
        }
      }
      .win-pulse div {
        animation: win-rainbow 1.5s ease-in-out;
      }
      @keyframes grid-shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-6px);
        }
      }
      .grid-shaking {
        animation: grid-shake 0.4s linear;
      }
      .sparkle-container {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .sparkle-bit {
        position: absolute;
        width: 10px;
        height: 10px;
        background: linear-gradient(45deg, #facc15, #ef4444);
        border-radius: 50%;
        animation: sparkle-fx 0.9s forwards;
        opacity: 0;
      }
      @keyframes sparkle-fx {
        0% {
          opacity: 1;
          transform: scale(0.5) translate(0, 0);
        }
        100% {
          opacity: 0;
          transform: scale(1.5) var(--tw-translate);
        }
      }
      /* –ó–ú–Ü–ù–ê v7: –ê–¥–∞–ø—Ç–æ–≤–∞–Ω–æ –ø—ñ–¥ –Ω–æ–≤—ñ —Ä–æ–∑–º—ñ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
      .emoji-xs {
        font-size: 1.75rem !important;
      }
      .emoji-sm {
        font-size: 2.25rem !important;
      }
      .emoji-md {
        font-size: 3rem !important;
      }
      .emoji-lg {
        font-size: 4rem !important;
      }
      .trail-dot {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ef4444, #f97316);
        opacity: 0.9;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: trail-fade 0.7s ease-out forwards;
        box-shadow: 0 0 8px rgba(234, 88, 12, 0.6);
      }
      @keyframes trail-fade {
        to {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.3);
        }
      }
      .near-obstacle {
        box-shadow: inset 0 0 0 3px rgba(239, 68, 68, 0.4);
        animation: near-pulse 0.6s ease-out 1;
      }
      @keyframes near-pulse {
        0% {
          box-shadow: inset 0 0 0 0 rgba(239, 68, 68, 0);
        }
        50% {
          box-shadow: inset 0 0 0 6px rgba(239, 68, 68, 0.4);
        }
        100% {
          box-shadow: inset 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
      }
      .confetti {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 100;
      }
      .confetti-bit {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        opacity: 0.95;
        animation: confetti-fall 1400ms ease-out forwards;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(-30px) rotate(0) scale(1);
        }
        100% {
          transform: translateY(180px) rotate(1080deg) scale(0.5);
          opacity: 0;
        }
      }
      @keyframes float-achievement {
        0% {
          transform: translateY(20px) scale(0.8);
          opacity: 0;
        }
        50% {
          transform: translateY(0) scale(1.08);
          opacity: 1;
        }
        100% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }
      .achievement-toast {
        animation: float-achievement 0.7s ease-out;
      }
      .progress-bar {
        height: 10px;
        background: linear-gradient(
          90deg,
          #ef4444 0%,
          #f97316 50%,
          #facc15 100%
        );
        border-radius: 999px;
        transition: width 0.6s ease-out;
        box-shadow: 0 0 10px rgba(234, 88, 12, 0.5);
      }
      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(234, 88, 12, 0.6),
            0 0 40px rgba(249, 115, 22, 0.4);
        }
        50% {
          box-shadow: 0 0 30px rgba(234, 88, 12, 0.8),
            0 0 60px rgba(249, 115, 22, 0.6);
        }
      }
      .pulse-glow {
        animation: pulse-glow 2s infinite;
      }
      .hint-bubble {
        animation: bounce 2s infinite;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-6px);
        }
      }
      .fire-glow {
        animation: fire-pulse 1.5s infinite;
      }
      @keyframes fire-pulse {
        0%,
        100% {
          transform: scale(1);
          filter: brightness(1);
        }
        50% {
          transform: scale(1.1);
          filter: brightness(1.3);
        }
      }

      /* –ó–ú–Ü–ù–ê v7: –ê–Ω—ñ–º–∞—Ü—ñ—è –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
      @keyframes pulse-hint {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 0 20px 10px rgba(249, 115, 22, 0.3);
        }
      }
      .pulse-hint-animation {
        animation: pulse-hint 1.5s infinite;
      }
      
      /* –ó–ú–Ü–ù–ê v7: –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –ø–ª–∞–≤–∞—é—á–æ–≥–æ —Å–º–∞–π–ª–∏–∫–∞ */
      @keyframes float-up-emoji {
          0% { transform: translateY(0) scale(0.5); opacity: 1; }
          100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
      }
      .floating-emoji {
          position: absolute;
          z-index: 1000;
          animation: float-up-emoji 1.5s ease-out forwards;
      }

      /* –ó–ú–Ü–ù–ê v7: –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
      @media (max-width: 375px) {
        .arrow-btn {
          min-width: 65px;
          min-height: 65px;
          font-size: 1.75rem;
          padding: 0.75rem;
        }

        .command-slot {
          height: 55px;
        }

        .grid-cell {
          min-height: 50px; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –∫–æ–ª–∞–ø—Å—É —Å—ñ—Ç–∫–∏ */
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-red-200 via-orange-200 to-yellow-200 min-h-screen p-2 sm:p-4"
  >
    <div class="max-w-7xl mx-auto">
      <!-- Header --><header
        class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 mb-3 sm:mb-6 border-4 border-orange-300"
      >
        <div class="flex justify-between items-start mb-3">
          <h1
            class="text-2xl sm:text-3xl md:text-4xl font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent"
          >
            <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>
            –ü–æ–∂–µ–∂–Ω–∏–∫ —ñ –í–æ–≥–æ–Ω—å
          </h1>
          <div class="flex items-center gap-2 sm:gap-3">
            <button
              id="fullscreenBtn"
              class="bg-gradient-to-r from-orange-200 to-red-200 hover:from-orange-300 hover:to-red-300 px-3 py-2 rounded-xl transition"
              title="–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω"
            >
              <i
                class="fas fa-expand text-xl text-orange-600"
                aria-hidden="true"
              ></i>
              <span class="sr-only">–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω</span>
            </button>
            <button
              id="soundBtn"
              class="bg-gradient-to-r from-orange-200 to-red-200 hover:from-orange-300 hover:to-red-300 px-3 py-2 rounded-xl transition"
              title="–ó–≤—É–∫"
              aria-pressed="true"
            >
              <i
                class="fas fa-volume-high text-xl text-orange-600"
                aria-hidden="true"
              ></i>
              <span class="sr-only">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</span>
            </button>
          </div>
        </div>

        <!-- Progress Bar --><div
          class="bg-gray-200 rounded-full h-4 mb-3 overflow-hidden border-2 border-orange-300"
          aria-label="–ü—Ä–æ–≥—Ä–µ—Å —Ä—ñ–≤–Ω—ñ–≤"
        >
          <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>

        <div
          class="flex justify-between items-center text-lg sm:text-xl md:text-2xl"
          role="status"
          aria-live="polite"
        >
          <div class="font-bold text-orange-600">
            –†—ñ–≤–µ–Ω—å: <span id="levelNum">1</span>/<span id="totalLevels"
              >8</span
            > <!-- –ó–ú–Ü–ù–ê v7: –û–Ω–æ–≤–ª–µ–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—ñ–≤–Ω—ñ–≤ -->
          </div>
          <div
            class="font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent"
          >
            <i class="fas fa-fire" aria-hidden="true"></i>
            <span id="gemsCount">0</span>
          </div>
        </div>

        <!-- Hint bubble --><div
          id="hintBubble"
          class="hidden mt-3 bg-gradient-to-r from-orange-100 to-red-100 border-2 border-orange-400 rounded-xl p-3 text-center hint-bubble"
        >
          <p class="text-lg sm:text-xl font-bold text-orange-700">
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
            <span id="hintText"></span>
          </p>
        </div>
      </header>

      <main class="flex flex-col sm:flex-row gap-3 sm:gap-6">
        <!-- –ö–æ–ª–æ–Ω–∫–∞ –∫–Ω–æ–ø–æ–∫-—Å—Ç—Ä—ñ–ª–æ–∫. --><div
          id="arrowControls"
          class="flex flex-row sm:flex-col gap-2 sm:gap-4 justify-center sm:h-full sm:items-center order-2 sm:order-none"
        >
          <button
            id="upBtn"
            class="arrow-btn bg-gradient-to-br from-orange-400 to-orange-600 hover:from-orange-500 hover:to-orange-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–≥–æ—Ä—É"
          >
            <i class="fas fa-arrow-up" aria-hidden="true"></i>
          </button>
          <button
            id="downBtn"
            class="arrow-btn bg-gradient-to-br from-red-400 to-red-600 hover:from-red-500 hover:to-red-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–Ω–∏–∑"
          >
            <i class="fas fa-arrow-down" aria-hidden="true"></i>
          </button>
          <button
            id="leftBtn"
            class="arrow-btn bg-gradient-to-br from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–ª—ñ–≤–æ"
          >
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
          </button>
          <button
            id="rightBtn"
            class="arrow-btn bg-gradient-to-br from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–ø—Ä–∞–≤–æ"
          >
            <i class="fas fa-arrow-right" aria-hidden="true"></i>
          </button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ñ–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è + —Å–ª–æ—Ç—ñ–≤. --><div class="flex flex-col gap-3 sm:gap-6 min-w-0 flex-grow order-1 sm:order-none">
          <!-- –Ü–≥—Ä–æ–≤–µ –ø–æ–ª–µ. --><section
            class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 flex flex-col border-4 border-orange-300 flex-grow"
            aria-label="–Ü–≥—Ä–æ–≤–µ –ø–æ–ª–µ"
          >
            <div
              class="flex-1 flex justify-center items-center min-h-[300px] md:min-h-[420px]"
            >
              <div
                id="gameGrid"
                class="relative"
                aria-label="–°—ñ—Ç–∫–∞ –≥—Ä–∏"
                role="grid"
              ></div>
            </div>
          </section>

          <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ü–Ü–î —ñ–≥—Ä–æ–≤–∏–º –ø–æ–ª–µ–º. --><div
            id="executionPanel"
            class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-4 flex flex-col sm:flex-row items-center gap-3 sm:gap-4 border-4 border-orange-300 flex-shrink-0"
          >
            <!-- –ó–ú–Ü–ù–ê v7: –î–æ–¥–∞–Ω–æ –∫–Ω–æ–ø–∫–∏ "–ü—ñ–¥–∫–∞–∑–∫–∞" —Ç–∞ "–í—ñ–¥–º—ñ–Ω–∞" (–±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —á–µ—Ä–µ–∑ JS) -->
            
            <!-- –ö–Ω–æ–ø–∫–∏ '–ì–∞—Å–∏—Ç–∏' —Ç–∞ '–û—á–∏—Å—Ç–∏—Ç–∏' --><div class="flex gap-2 flex-shrink-0 w-full sm:w-auto" id="mainControls">
              <button
                id="runBtn"
                class="flex-1 bg-gradient-to-r from-blue-400 to-cyan-500 hover:from-blue-500 hover:to-cyan-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
              >
                <i class="fas fa-water" aria-hidden="true"></i> –ì–∞—Å–∏—Ç–∏!
              </button>
              <button
                id="clearBtn"
                class="flex-1 bg-gradient-to-r from-red-400 to-orange-500 hover:from-red-500 hover:to-orange-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl shadow-lg"
              >
                <i class="fas fa-eraser" aria-hidden="true"></i> –û—á–∏—Å—Ç–∏—Ç–∏
              </button>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–æ—Ç—ñ–≤ -->
            <div
              class="flex-shrink min-w-0 w-full sm:w-auto overflow-x-auto py-1"
            >
              <div
                id="commandSlots"
                class="flex-shrink-0"
                aria-label="–°–ª–æ—Ç–∏ –∫–æ–º–∞–Ω–¥"
              ></div>
            </div>
          </div>
        </div>
      </main>

      <!-- Win modal --><div
        id="winModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        role="dialog"
        aria-modal="true"
      >
        <div
          class="bg-gradient-to-br from-orange-100 to-red-100 rounded-3xl p-6 sm:p-8 max-w-md w-full text-center relative overflow-hidden border-4 border-orange-400 shadow-2xl"
        >
          <div id="winConfetti" class="confetti"></div>
          <div class="text-6xl sm:text-7xl mb-4 win-pulse">
            <div>üë®‚Äçüöí</div>
          </div>
          <h2
            class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent mb-2"
          >
            –í–æ–≥–æ–Ω—å –ø–æ–≥–∞—à–µ–Ω–æ!
          </h2>
          <p
            class="text-xl sm:text-2xl mb-4 font-bold text-orange-600"
            id="encouragement"
          ></p>
          <p class="text-lg sm:text-xl mb-6 text-gray-700" id="winMessage"></p>
          <button
            id="nextLevelBtn"
            class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-4 px-8 rounded-xl text-xl w-full pulse-glow shadow-lg"
          >
            –ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–∫–ª–∏–∫
            <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Error modal (–ó–ú–Ü–ù–ê v7: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ–∑–∏—Ç–∏–≤–Ω–µ –ø—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è) --><div
        id="errorModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        role="dialog"
        aria-modal="true"
      >
        <div
          class="bg-gradient-to-br from-orange-100 to-yellow-100 rounded-3xl p-6 sm:p-8 max-w-md w-full text-center border-4 border-orange-400 shadow-2xl"
        >
          <!-- 'errorMessage' –±—É–¥–µ –º—ñ—Å—Ç–∏—Ç–∏ HTML –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
          <div id="errorMessage"></div>
          
          <div class="flex gap-2 flex-wrap justify-center mt-6">
            <button
              id="retryBtn"
              class="bg-gradient-to-r from-orange-400 to-red-400 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg"
            >
              –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ <i class="fas fa-rotate-right" aria-hidden="true"></i>
            </button>
            <button
              id="closeErrBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl text-lg shadow-lg"
            >
              –ó—Ä–æ–∑—É–º—ñ–ª–æ
            </button>
          </div>
        </div>
      </div>

      <!-- Achievement toast --><div
        id="achievementToast"
        class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-[60] bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 text-white px-6 py-4 rounded-2xl shadow-2xl achievement-toast border-4 border-white"
      >
        <div class="flex items-center gap-3">
          <div class="text-4xl" id="achievementIcon"></div>
          <div>
            <div class="font-bold text-lg" id="achievementTitle"></div>
            <div class="text-sm" id="achievementText"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- –ó–ú–Ü–ù–ê v7: –î–æ–¥–∞–Ω–æ HTML –¥–ª—è —Ç—É—Ç–æ—Ä—ñ–∞–ª—É -->
    <div id="tutorialOverlay" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-6 sm:p-8 max-w-md text-center">
        <div class="text-7xl mb-4 animate-bounce">üë®‚Äçüöí</div>
        <h2 class="text-3xl font-bold text-orange-600 mb-4">–ü—Ä–∏–≤—ñ—Ç, —é–Ω–∏–π –ø–æ–∂–µ–∂–Ω–∏–∫—É!</h2>
        <p class="text-xl mb-6">–î–æ–ø–æ–º–æ–∂–∏ –º–µ–Ω—ñ –∑–∞–≥–∞—Å–∏—Ç–∏ –≤–æ–≥–æ–Ω—å! üî•</p>
        
        <div class="space-y-4">
          <div class="flex items-center gap-4 bg-orange-50 p-4 rounded-xl">
            <div class="text-5xl">‚¨ÜÔ∏è</div>
            <p class="text-lg text-left">–ù–∞—Ç–∏—Å–∫–∞–π —Å—Ç—Ä—ñ–ª–∫–∏, —â–æ–± —è —Ä—É—Ö–∞–≤—Å—è</p>
          </div>
          
          <div class="flex items-center gap-4 bg-blue-50 p-4 rounded-xl">
            <div class="text-5xl">üíß</div>
            <p class="text-lg text-left">–ü–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω–∏ "–ì–∞—Å–∏—Ç–∏!"</p>
          </div>
        </div>
        
        <button id="startTutorial" class="mt-6 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-4 px-8 rounded-xl text-2xl w-full pulse-glow">
          –ü–æ—á–∞—Ç–∏! üöí
        </button>
      </div>
    </div>
    
    <!-- –ó–ú–Ü–ù–ê v7: –î–æ–¥–∞–Ω–æ HTML –¥–ª—è –ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ —Ä–µ–∂–∏–º—É -->
    <button id="parentBtn" class="fixed bottom-4 right-4 bg-gray-300 text-gray-700 p-3 rounded-full z-50 shadow-lg">
      <i class="fas fa-user-tie"></i>
    </button>

    <div id="parentModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-6 max-w-lg w-full">
        <h2 class="text-2xl font-bold mb-4">üìä –ü—Ä–æ–≥—Ä–µ—Å –¥–∏—Ç–∏–Ω–∏</h2>
        
        <div class="space-y-3">
          <div class="flex justify-between">
            <span>–ü—Ä–æ–π–¥–µ–Ω–æ —Ä—ñ–≤–Ω—ñ–≤:</span>
            <strong id="parentLevels">0/8</strong>
          </div>
          <div class="flex justify-between">
            <span>–ó—ñ–±—Ä–∞–Ω–æ –≤–æ–≥–Ω—é:</span>
            <strong id="parentGems">0</strong>
          </div>
          <div class="flex justify-between">
            <span>–ß–∞—Å —Å–µ—Å—ñ—ó:</span>
            <strong id="parentTime">0 —Ö–≤</strong>
          </div>
        </div>
        
        <div class="mt-6 p-4 bg-blue-50 rounded-xl">
          <h3 class="font-bold mb-2">üí° –ü–æ—Ä–∞–¥–∏:</h3>
          <ul class="text-sm space-y-1 list-disc list-inside">
            <li>–ì—Ä–∞—é—á–∏ —Ä–∞–∑–æ–º, –∑–∞–ø–∏—Ç—É–π—Ç–µ: "–ö—É–¥–∏ –º–∞—î –π—Ç–∏ –ø–æ–∂–µ–∂–Ω–∏–∫?"</li>
            <li>–°–≤—è—Ç–∫—É–π—Ç–µ –∫–æ–∂–Ω—É —Å–ø—Ä–æ–±—É, –Ω–µ –ª–∏—à–µ –ø–µ—Ä–µ–º–æ–≥–∏.</li>
            <li>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —á–∞—Å –≥—Ä–∏: 15 —Ö–≤–∏–ª–∏–Ω.</li>
          </ul>
        </div>
        
        <button id="closeParentModal" class="mt-4 bg-orange-500 text-white py-3 px-6 rounded-xl w-full">
          –ó–∞–∫—Ä–∏—Ç–∏
        </button>
      </div>
    </div>

    <script>
      // ===== Constants =====
      const ANIMATION_SPEED = 250; // –ó–ú–Ü–ù–ê v7: –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–æ (–±—É–ª–æ 350)
      const DIRECTION_VECTORS = {
        up: [-1, 0],
        down: [1, 0],
        left: [0, -1],
        right: [0, 1],
      };
      const ARROW_ICONS = {
        up: '<i class="fas fa-arrow-up text-orange-500" aria-hidden="true"></i>',
        down: '<i class="fas fa-arrow-down text-red-500" aria-hidden="true"></i>',
        left: '<i class="fas fa-arrow-left text-yellow-500" aria-hidden="true"></i>',
        right:
          '<i class="fas fa-arrow-right text-amber-500" aria-hidden="true"></i>',
      };

      // –ó–ú–Ü–ù–ê v7: –°–ø—Ä–æ—â–µ–Ω—ñ —Ä—ñ–≤–Ω—ñ –¥–ª—è 4-5 —Ä–æ–∫—ñ–≤
      const LEVELS = [
        // 1. –ü—Ä—è–º–∞ –ª—ñ–Ω—ñ—è
        {
          size: 3, start: [1, 0], obstacles: [], gems: [[1, 1], [1, 2]],
          maxCommands: 2, hint: "–ù–∞—Ç–∏—Å–Ω–∏ —Å—Ç—Ä—ñ–ª–∫—É '–í–ø—Ä–∞–≤–æ' ‚û°Ô∏è –¥–≤—ñ—á—ñ!",
          optimizeGrid: false,
        },
        // 2. –ü—Ä—è–º–∞ –ª—ñ–Ω—ñ—è
        {
          size: 4, start: [0, 0], obstacles: [], gems: [[1, 0], [2, 0], [3, 0]],
          maxCommands: 3, hint: "–ù–∞—Ç–∏—Å–Ω–∏ —Å—Ç—Ä—ñ–ª–∫—É '–í–Ω–∏–∑' ‚¨áÔ∏è —Ç—Ä–∏—á—ñ!",
          optimizeGrid: false,
        },
        // 3. –ü—Ä–æ—Å—Ç–∏–π –ø–æ–≤–æ—Ä–æ—Ç
        {
          size: 4, start: [0, 0], obstacles: [], gems: [[0, 1], [1, 1], [1, 2]],
          maxCommands: 4, hint: "–°–ø–µ—Ä—à—É '–í–ø—Ä–∞–≤–æ' ‚û°Ô∏è, –ø–æ—Ç—ñ–º '–í–Ω–∏–∑' ‚¨áÔ∏è...",
          optimizeGrid: false,
        },
        // 4. –ü–µ—Ä—à–∞ –ø–µ—Ä–µ—à–∫–æ–¥–∞
        {
          size: 4, start: [0, 0], obstacles: [[1, 1]], gems: [[0, 2], [2, 0], [2, 2]],
          maxCommands: 6, hint: "–û–±–µ—Ä–µ–∂–Ω–æ, –≤–æ–¥–∞! üåä –¢—Ä–µ–±–∞ –æ–±—ñ–π—Ç–∏.",
          optimizeGrid: true,
        },
        // 5. –©–µ –æ–¥–Ω–∞ –ø–µ—Ä–µ—à–∫–æ–¥–∞
        {
          size: 4, start: [0,0], obstacles: [[1,0]], gems: [[0,1], [2,1]],
          maxCommands: 5, optimizeGrid: true,
        },
        // 6. –î–≤—ñ –ø–µ—Ä–µ—à–∫–æ–¥–∏, 5x5
        {
          size: 5, start: [2, 0], obstacles: [[2, 1], [2, 2]], gems: [[1, 1], [3, 1], [2, 3]],
          maxCommands: 9, optimizeGrid: true,
        },
        // 7. –ü—Ä–æ—Å—Ç–∏–π –ª–∞–±—ñ—Ä–∏–Ω—Ç 5x5
        {
          size: 5, start: [0, 0], obstacles: [[1, 1], [2, 2], [3, 3]], gems: [[0, 2], [2, 0], [4, 4]],
          maxCommands: 10, optimizeGrid: true,
        },
        // 8. –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å 5x5
        {
          size: 5, start: [0, 2], obstacles: [[1, 0], [1, 1], [1, 3], [1, 4], [3, 2]],
          gems: [[0, 0], [0, 4], [4, 0], [4, 4]],
          maxCommands: 10, optimizeGrid: true,
        },
      ];
      
      const TOTAL_LEVELS_COUNT = LEVELS.length;

      // –ó–ú–Ü–ù–ê v7: –ü–æ–∑–∏—Ç–∏–≤–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      const ENCOURAGEMENTS = [
        "–¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π! üöí", "–í–æ–≥–æ–Ω—å –ø–æ–≥–∞—à–µ–Ω–æ! üî•", "–ß—É–¥–æ–≤–∞ —Ä–æ–±–æ—Ç–∞, –ø–æ–∂–µ–∂–Ω–∏–∫—É! üë®‚Äçüöí",
        "–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üíß", "–ì–∞—Å–∏—à —è–∫ –ø—Ä–æ—Ñ—ñ! üíØ", "–í–æ–≥–Ω—è–Ω–∏–π –º–∞–π—Å—Ç–µ—Ä! üèÜ",
      ];
      const POSITIVE_ERRORS = [
        "–ú–∞–π–∂–µ –≤–∏–π—à–ª–æ! –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑! üí™", "–¢–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —à–ª—è—Ö—É! –ü—Ä–æ–¥–æ–≤–∂—É–π! üåü",
        "–ß—É–¥–æ–≤–∞ —Å–ø—Ä–æ–±–∞! –ú–æ–∂–µ, —ñ–Ω—à–∏–π –º–∞—Ä—à—Ä—É—Ç? ü§î", "–¢–∞–∫ –±–ª–∏–∑—å–∫–æ! –¢–∏ –≤–ø–æ—Ä–∞—î—à—Å—è! ‚≠ê",
      ];

      // ===== Achievements =====
      const ACHIEVEMENTS = {
        firstGems: { icon: "üî•", title: "–ü–µ—Ä—à—ñ –ø–æ–ª—É–º'—è!", text: "–¢–∏ –∑–∞–≥–∞—Å–∏–≤ —Å–≤—ñ–π –ø–µ—Ä—à–∏–π –≤–æ–≥–æ–Ω—å!" },
        halfwayDone: { icon: "üë®‚Äçüöí", title: "–ù–∞ –ø—ñ–≤–¥–æ—Ä–æ–∑—ñ!", text: "–ü–æ–ª–æ–≤–∏–Ω–∞ –≤–∏–∫–ª–∏–∫—ñ–≤ –ø–æ–∑–∞–¥—É!" },
        master: { icon: "üåü", title: "–ú–∞–π—Å—Ç–µ—Ä –ø–æ–∂–µ–∂–æ–≥–∞—Å—ñ–Ω–Ω—è!", text: "–¢–∏ –ø—Ä–æ–π—à–æ–≤ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ, –≥–µ—Ä–æ–π!" }
      };

      // ===== State =====
      const gameState = {
        currentLevel: 0,
        commands: [],
        totalGems: 0,
        isExecuting: false,
        currentPos: null,
        soundEnabled: true,
        shownAchievements: new Set(),
        optimizedGridMap: null,
      };
      
      // –ó–ú–Ü–ù–ê v7: –¢–∞–π–º–µ—Ä —Å–µ—Å—ñ—ó
      let sessionStartTime = Date.now();
      const MAX_SESSION_TIME = 15 * 60 * 1000; // 15 —Ö–≤–∏–ª–∏–Ω

      // AudioContext (–æ–¥–∏–Ω —Ä–∞–∑) + —Ä–µ–∑—é–º–µ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó
      let audioCtx = null;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.warn("AudioContext is not supported, sounds will be disabled.");
      }
      const ensureAudio = async () => {
        try {
          if (audioCtx && audioCtx.state === "suspended") {
            await audioCtx.resume();
          }
        } catch (e) { /* ignore */ }
      };

      // ===== DOM =====
      const el = (id) => document.getElementById(id);
      const elements = {
        gameGrid: el("gameGrid"),
        commandSlots: el("commandSlots"),
        runBtn: el("runBtn"),
        clearBtn: el("clearBtn"),
        winModal: el("winModal"),
        errorModal: el("errorModal"),
        nextLevelBtn: el("nextLevelBtn"),
        retryBtn: el("retryBtn"),
        closeErrBtn: el("closeErrBtn"),
        levelNum: el("levelNum"),
        totalLevels: el("totalLevels"),
        gemsCount: el("gemsCount"),
        winMessage: el("winMessage"),
        errorMessage: el("errorMessage"),
        upBtn: el("upBtn"),
        downBtn: el("downBtn"),
        leftBtn: el("leftBtn"),
        rightBtn: el("rightBtn"),
        progressBar: el("progressBar"),
        encouragement: el("encouragement"),
        hintBubble: el("hintBubble"),
        hintText: el("hintText"),
        soundBtn: el("soundBtn"),
        fullscreenBtn: el("fullscreenBtn"),
        achievementToast: el("achievementToast"),
        achievementIcon: el("achievementIcon"),
        achievementTitle: el("achievementTitle"),
        achievementText: el("achievementText"),
        winConfetti: el("winConfetti"),
        // –ó–ú–Ü–ù–ê v7: –ù–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ DOM
        tutorialOverlay: el("tutorialOverlay"),
        startTutorial: el("startTutorial"),
        parentBtn: el("parentBtn"),
        parentModal: el("parentModal"),
        closeParentModal: el("closeParentModal"),
        parentLevels: el("parentLevels"),
        parentGems: el("parentGems"),
        parentTime: el("parentTime"),
        executionPanel: el("executionPanel"),
        mainControls: el("mainControls"),
      };

      // ===== Utils =====
      const utils = {
        sleep: (ms) => new Promise((r) => setTimeout(r, ms)),
        arraysEqual: (a, b) => a && b && a[0] === b[0] && a[1] === b[1],
        isValidPosition: (pos, level) => {
          const gridMap = gameState.optimizedGridMap || {
            rows: level.size,
            cols: level.size,
            rowMap: Array.from({ length: level.size }, (_, i) => i),
            colMap: Array.from({ length: level.size }, (_, i) => i),
          };
          
          const mappedRowIndex = gridMap.rowMap.indexOf(pos[0]);
          const mappedColIndex = gridMap.colMap.indexOf(pos[1]);

          return (
            mappedRowIndex !== -1 &&
            mappedColIndex !== -1 &&
            !level.obstacles.some((o) => utils.arraysEqual(o, pos))
          );
        },
        emojiClass: () => {
          const w = window.innerWidth;
          if (w < 480) return "emoji-xs";
          if (w < 640) return "emoji-sm";
          if (w < 1024) return "emoji-md";
          return "emoji-lg";
        },
        getCellSize: (level) => {
          const wrap = elements.gameGrid.parentElement;
          const rect = wrap.getBoundingClientRect();
          const gap = window.innerWidth < 640 ? 2 : 4;
          const gridMap = gameState.optimizedGridMap || {
            rows: level.size,
            cols: level.size,
            rowMap: Array.from({ length: level.size }, (_, i) => i),
            colMap: Array.from({ length: level.size }, (_, i) => i),
          };
          const columns = gridMap.cols;
          const rows = gridMap.rows;
          
          const availableWidth = rect.width - (columns - 1) * gap - 10; // -10 for padding
          const availableHeight = rect.height - (rows - 1) * gap - 10;

          const sizeBasedOnWidth = availableWidth / columns;
          const sizeBasedOnHeight = availableHeight / rows;
          
          const size = Math.floor(Math.min(sizeBasedOnWidth, sizeBasedOnHeight));
          
          return Math.max(36, Math.min(size, 110));
        },
        randomChoice: (arr) => arr[Math.floor(Math.random() * arr.length)],
        playSound: (freq, duration = 100) => {
          if (!gameState.soundEnabled || !audioCtx) return;
          try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = "sine";
            gain.gain.value = 0.1;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(
              0.01,
              audioCtx.currentTime + duration / 1000
            );
            osc.stop(audioCtx.currentTime + duration / 1000);
          } catch (e) {
            console.error("Error playing sound:", e);
          }
        },
      };

      // ===== Sound Effects =====
      const sounds = {
        move: () => utils.playSound(350, 70),
        collect: () => {
          utils.playSound(200, 80);
          setTimeout(() => utils.playSound(300, 100), 80);
        },
        win: () => {
          utils.playSound(440, 120);
          setTimeout(() => utils.playSound(523, 120), 120);
          setTimeout(() => utils.playSound(440, 150), 240);
          setTimeout(() => utils.playSound(523, 200), 390);
        },
        error: () => utils.playSound(150, 250),
        click: () => utils.playSound(650, 40),
        // –ó–ú–Ü–ù–ê v7: –ó–≤—É–∫ –¥–ª—è "–º–∞–ª–µ–Ω—å–∫–æ—ó –ø–µ—Ä–µ–º–æ–≥–∏"
        cheer: () => {
            utils.playSound(523, 100);
            setTimeout(() => utils.playSound(659, 150), 100);
        }
      };
      
      // –ó–ú–Ü–ù–ê v7: –§—É–Ω–∫—Ü—ñ—è –≤—ñ–±—Ä–∞—Ü—ñ—ó
      function vibrateDevice(pattern = [50]) {
        if ('vibrate' in navigator) {
          navigator.vibrate(pattern);
        }
      }
      
      // –ó–ú–Ü–ù–ê v7: –§—É–Ω–∫—Ü—ñ—è –≥–æ–ª–æ—Å–æ–≤–∏—Ö –ø—ñ–¥–∫–∞–∑–æ–∫
      function speak(text) {
        if ('speechSynthesis' in window && gameState.soundEnabled) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'uk-UA';
          utterance.rate = 0.9;
          utterance.pitch = 1.2;
          window.speechSynthesis.speak(utterance);
        }
      }
      
      // –ó–ú–Ü–ù–ê v7: –§—É–Ω–∫—Ü—ñ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è/–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
      function saveProgress() {
        try {
          localStorage.setItem('firefighterProgress', JSON.stringify({
            level: gameState.currentLevel,
            gems: gameState.totalGems,
            achievements: Array.from(gameState.shownAchievements),
            timestamp: Date.now()
          }));
        } catch(e) { console.warn("Could not save progress.", e); }
      };

      function loadProgress() {
        try {
          const saved = localStorage.getItem('firefighterProgress');
          if (saved) {
            const data = JSON.parse(saved);
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –ª–∏—à–µ —è–∫—â–æ –º–∏–Ω—É–ª–æ –º–µ–Ω—à–µ 7 –¥–Ω—ñ–≤
            if (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000) {
              gameState.currentLevel = data.level || 0;
              gameState.totalGems = data.gems || 0;
              gameState.shownAchievements = new Set(data.achievements || []);
              elements.gemsCount.textContent = gameState.totalGems;
            }
          }
        } catch(e) { console.warn("Could not load progress.", e); }
      };

      // ===== Achievements =====
      function checkAchievements() {
        const gems = gameState.totalGems;
        const level = gameState.currentLevel;

        if (gems >= 1 && !gameState.shownAchievements.has('firstGems')) {
          showAchievement(ACHIEVEMENTS.firstGems);
          gameState.shownAchievements.add('firstGems');
        }
        
        if (level === Math.floor(TOTAL_LEVELS_COUNT / 2) && !gameState.shownAchievements.has('halfwayDone')) {
          showAchievement(ACHIEVEMENTS.halfwayDone);
          gameState.shownAchievements.add('halfwayDone');
        }
        
        if (level === TOTAL_LEVELS_COUNT - 1 && !gameState.shownAchievements.has('master')) {
          showAchievement(ACHIEVEMENTS.master);
          gameState.shownAchievements.add('master');
        }
      }

      function showAchievement(ach) {
        elements.achievementIcon.textContent = ach.icon;
        elements.achievementTitle.textContent = ach.title;
        elements.achievementText.textContent = ach.text;
        elements.achievementToast.classList.remove("hidden");

        setTimeout(() => {
          elements.achievementToast.style.transition =
            "opacity 0.5s, transform 0.5s";
          elements.achievementToast.style.opacity = "0";
          elements.achievementToast.style.transform = "translate(-50%, -20px)";
          setTimeout(() => {
            elements.achievementToast.classList.add("hidden");
            elements.achievementToast.style.opacity = "1";
            elements.achievementToast.style.transform = "translate(-50%, 0)";
          }, 500);
        }, 3500);
      }

      // ===== Confetti =====
      function createConfetti() {
        const container = elements.winConfetti;
        container.innerHTML = "";
        const colors = [
          "#f59e0b", "#ef4444", "#f87171", "#fbbf24", "#f97316", "#dc2626",
        ];

        for (let i = 0; i < 40; i++) {
          const bit = document.createElement("div");
          bit.className = "confetti-bit";
          bit.style.left = Math.random() * 100 + "%";
          bit.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          bit.style.animationDelay = Math.random() * 0.4 + "s";
          container.appendChild(bit);
        }
      }

      // ===== Sparkles =====
      function createSparkles(cell) {
        cell.querySelectorAll(".sparkle-container").forEach((s) => s.remove());
        const container = document.createElement("div");
        container.className = "sparkle-container";
        cell.appendChild(container);

        for (let i = 0; i < 8; i++) {
          const sparkle = document.createElement("div");
          sparkle.className = "sparkle-bit";
          const angle = (i / 8) * Math.PI * 2;
          const distance = 30;
          const tx = Math.cos(angle) * distance;
          const ty = Math.sin(angle) * distance;
          sparkle.style.setProperty(
            "--tw-translate",
            `translate(${tx}px, ${ty}px)`
          );
          sparkle.style.left = "50%";
          sparkle.style.top = "50%";
          sparkle.style.animationDelay = i * 0.05 + "s";
          container.appendChild(sparkle);
        }
        setTimeout(() => container.remove(), 1000);
      }
      
      // –ó–ú–Ü–ù–ê v7: –ü–ª–∞–≤–∞—é—á–∏–π —Å–º–∞–π–ª–∏–∫
      function showFloatingEmoji(emoji, pos) {
          const cell = getCellElement(pos);
          if (!cell) return;
          
          const floater = document.createElement('div');
          floater.textContent = emoji;
          floater.className = 'floating-emoji text-4xl';
          cell.appendChild(floater);
          
          setTimeout(() => floater.remove(), 1500);
      }
      
      // –ó–ú–Ü–ù–ê v7: –ú–∞–ª–µ–Ω—å–∫–µ —Å–≤—è—Ç–∫—É–≤–∞–Ω–Ω—è
      function celebrateSmallWin(cell) {
          sounds.cheer();
          createSparkles(cell);
          showFloatingEmoji('üéâ', gameState.currentPos);
      }

      // ===== Level Management =====
      function updateProgress() {
        const progress = ((gameState.currentLevel + 1) / TOTAL_LEVELS_COUNT) * 100;
        elements.progressBar.style.width = progress + "%";
      }

      function showHint(level) {
        if (level.hint && gameState.currentLevel < 3) {
          elements.hintText.textContent = level.hint;
          elements.hintBubble.classList.remove("hidden");
        } else {
          elements.hintBubble.classList.add("hidden");
        }
      }

      function optimizeGrid(level) {
        if (!level.optimizeGrid) {
          gameState.optimizedGridMap = null;
          return;
        }
        const activeRows = new Set();
        const activeCols = new Set();
        const allPositions = [
          level.start,
          ...level.obstacles,
          ...level.gems,
        ];
        allPositions.forEach(([r, c]) => {
          activeRows.add(r);
          activeCols.add(c);
        });
        const minR = Math.min(...activeRows);
        const maxR = Math.max(...activeRows);
        const minC = Math.min(...activeCols);
        const maxC = Math.max(...activeCols);
        for (let r = minR; r <= maxR; r++) {
          for (let c = minC; c <= maxC; c++) {
            if (!level.obstacles.some((o) => utils.arraysEqual(o, [r, c]))) {
              activeRows.add(r);
              activeCols.add(c);
            }
          }
        }
        level.obstacles.forEach(([r, c]) => {
          if (r >= minR && r <= maxR && c >= minC && c <= maxC) {
            activeRows.add(r);
            activeCols.add(c);
          }
        });
        const sortedRows = Array.from(activeRows).sort((a, b) => a - b);
        const sortedCols = Array.from(activeCols).sort((a, b) => a - b);
        gameState.optimizedGridMap = {
          rows: sortedRows.length,
          cols: sortedCols.length,
          rowMap: sortedRows,
          colMap: sortedCols,
        };
      }

      // ===== Init Level (–≥–ª–æ–±–∞–ª—å–Ω–µ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è) =====
      function initLevel() {
        const level = LEVELS[gameState.currentLevel];
        if (!level) {
          console.error("Invalid level index:", gameState.currentLevel);
          gameState.currentLevel = 0; // –°–∫–∏–Ω—É—Ç–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
          initLevel();
          return;
        }
        document
          .querySelectorAll(".sparkle-container, .trail-dot, .floating-emoji")
          .forEach((n) => n.remove());
        elements.gameGrid.classList.remove("grid-shaking");

        optimizeGrid(level);

        elements.totalLevels.textContent = TOTAL_LEVELS_COUNT;
        elements.levelNum.textContent = gameState.currentLevel + 1;
        gameState.commands = Array(level.maxCommands).fill(null);
        gameState.currentPos = [...level.start];
        renderGrid(level);
        renderCommandSlots();
        updateProgress();
        showHint(level);
        elements.runBtn.disabled = false;
        gameState.isExecuting = false;
        
        // –ó–ú–Ü–ù–ê v7: –ü–æ–∫–∞–∑ –ø—ñ–¥–∫–∞–∑–æ–∫
        showNextStepHint();
        if (level.obstacles.length > 0 && !localStorage.getItem('shownObstacleIntro')) {
            showObstacleIntro();
            localStorage.setItem('shownObstacleIntro', 'true');
        }
      }

      // ===== Render Grid =====
      function renderGrid(level) {
        const g = elements.gameGrid;
        g.classList.remove("grid-shaking");
        g.innerHTML = "";

        const gridMap = gameState.optimizedGridMap || {
          rows: level.size,
          cols: level.size,
          rowMap: Array.from({ length: level.size }, (_, i) => i),
          colMap: Array.from({ length: level.size }, (_, i) => i),
        };

        const cellSize = utils.getCellSize(level);
        const gap = window.innerWidth < 640 ? "2px" : "4px";
        g.style.display = "grid";
        g.style.gridTemplateColumns = `repeat(${gridMap.cols}, ${cellSize}px)`;
        g.style.gridTemplateRows = `repeat(${gridMap.rows}, ${cellSize}px)`;
        g.style.gap = gap;

        const emojiCls = utils.emojiClass();
        for (let r = 0; r < gridMap.rows; r++) {
          for (let c = 0; c < gridMap.cols; c++) {
            const originalRow = gridMap.rowMap[r];
            const originalCol = gridMap.colMap[c];
            const originalPos = [originalRow, originalCol];

            const cell = document.createElement("div");
            cell.className =
              "grid-cell flex items-center justify-center bg-orange-50 rounded-lg";
            cell.dataset.row = originalRow;
            cell.dataset.col = originalCol;
            cell.setAttribute("role", "gridcell");

            if (utils.arraysEqual(originalPos, level.start)) {
              cell.innerHTML = `<div class="character ${emojiCls}" aria-label="–ü–æ–∂–µ–∂–Ω–∏–∫">üë®‚Äçüöí</div>`;
              cell.classList.add("bg-red-200");
            } else if (
              level.obstacles.some((o) => utils.arraysEqual(o, originalPos))
            ) {
              cell.innerHTML = `<i class="fas fa-water text-blue-600 ${emojiCls}" aria-hidden="true"></i>`;
              cell.classList.add("bg-blue-300");
            } else if (
              level.gems.some((g) => utils.arraysEqual(g, originalPos))
            ) {
              cell.innerHTML = `<div class="${emojiCls} fire-glow" data-gem="fire" aria-label="–í–æ–≥–æ–Ω—å">üî•</div>`;
              cell.classList.add(
                "bg-gradient-to-br",
                "from-red-100",
                "to-yellow-100"
              );
            }
            g.appendChild(cell);
          }
        }
      }

      // ===== Render Command Slots =====
      function renderCommandSlots() {
        const level = LEVELS[gameState.currentLevel];
        const wrap = elements.commandSlots;
        wrap.innerHTML = "";

        for (let i = 0; i < level.maxCommands; i++) {
          const slot = document.createElement("div");
          slot.className =
            "command-slot flex items-center justify-center rounded-lg text-2xl sm:text-3xl md:text-4xl";
          slot.dataset.index = i;

          if (gameState.commands[i]) {
            slot.classList.add("filled");
            slot.innerHTML = ARROW_ICONS[gameState.commands[i]];
            slot.setAttribute("title", "–ö–ª—ñ–∫ ‚Äî –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É");
            slot.addEventListener("click", () => {
              if (!gameState.isExecuting) {
                vibrateDevice([30]);
                sounds.click();
                gameState.commands[i] = null;
                renderCommandSlots();
              }
            });
          }
          wrap.appendChild(slot);
        }
      }
      
      // –ó–ú–Ü–ù–ê v7: –ü—ñ–¥–∫–∞–∑–∫–∞ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É
      function showNextStepHint() {
          // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏
          document.querySelectorAll('.pulse-hint-animation').forEach(el => el.classList.remove('pulse-hint-animation'));
          
          const level = LEVELS[gameState.currentLevel];
          if (gameState.currentLevel < 2 && gameState.commands.every(c => c === null)) {
              const solution = findSimplestPath(level);
              if (solution && solution.length > 0) {
                  const nextMove = solution[0];
                  const button = elements[`${nextMove}Btn`];
                  if (button) {
                      button.classList.add('pulse-hint-animation');
                  }
              }
          }
      }

      // ===== Add Command =====
      async function addCommand(direction) {
        if (gameState.isExecuting) return;
        await ensureAudio();
        vibrateDevice([30]);
        sounds.click();

        const firstEmpty = gameState.commands.indexOf(null);
        if (firstEmpty !== -1) {
          gameState.commands[firstEmpty] = direction;
          renderCommandSlots();
        }
        // –ó–ú–Ü–ù–ê v7: –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∫–ª—ñ–∫—É
        document.querySelectorAll('.pulse-hint-animation').forEach(el => el.classList.remove('pulse-hint-animation'));
      }

      // ===== Clear Commands =====
      async function clearCommands() {
        if (gameState.isExecuting) return;
        await ensureAudio();
        vibrateDevice([50]);
        sounds.click();
        const level = LEVELS[gameState.currentLevel];
        gameState.commands = Array(level.maxCommands).fill(null);
        renderCommandSlots();
        showNextStepHint(); // –ó–ú–Ü–ù–ê v7: –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É –∑–Ω–æ–≤—É
      }

      // ===== Get Cell Element =====
      function getCellElement(pos) {
        return elements.gameGrid.querySelector(
          `[data-row="${pos[0]}"][data-col="${pos[1]}"]`
        );
      }

      function highlightNearObstacles(pos, level) {
        elements.gameGrid
          .querySelectorAll(".near-obstacle")
          .forEach((cell) => cell.classList.remove("near-obstacle"));
        const [r, c] = pos;
        const neighbors = [
          [r - 1, c], [r + 1, c], [r, c - 1], [r, c + 1],
        ];
        for (const neighborPos of neighbors) {
          if (level.obstacles.some((o) => utils.arraysEqual(o, neighborPos))) {
            const cell = getCellElement(neighborPos);
            if (cell) {
              cell.classList.add("near-obstacle");
            }
          }
        }
      }

      // ===== Update Character Position =====
      function updateCharacterPosition(newPos, noJump = false) {
        const level = LEVELS[gameState.currentLevel];
        const oldCell = getCellElement(gameState.currentPos);
        const newCell = getCellElement(newPos);

        if (oldCell) {
          const char = oldCell.querySelector(".character");
          if (char) char.remove();
          oldCell.querySelectorAll(".trail-dot").forEach((t) => t.remove());
          if (utils.arraysEqual(gameState.currentPos, level.start)) {
            oldCell.classList.add("bg-red-200");
          } else {
            oldCell.classList.remove("bg-red-200", "landing");
          }
          if (!utils.arraysEqual(gameState.currentPos, newPos)) {
            const trail = document.createElement("div");
            trail.className = "trail-dot";
            oldCell.appendChild(trail);
            setTimeout(() => trail.remove(), 700);
          }
        }

        if (newCell) {
          const emojiCls = utils.emojiClass();
          const char = document.createElement("div");
          char.className = `character ${emojiCls}`;
          char.setAttribute("aria-label", "–ü–æ–∂–µ–∂–Ω–∏–∫");
          char.textContent = "üë®‚Äçüöí";
          newCell.appendChild(char);
          if (!noJump) {
            newCell.classList.add("landing");
            setTimeout(() => newCell.classList.remove("landing"), 400);
            // createSparkles(newCell); // –ó–ú–Ü–ù–ê v7: –ü—Ä–∏–±—Ä–∞–Ω–æ –∑–≤—ñ–¥—Å–∏, –¥–æ–¥–∞–Ω–æ –¥–æ 'celebrateSmallWin'
          }
          highlightNearObstacles(newPos, level);
        }
        gameState.currentPos = newPos;
      }

      // ===== Execute Commands =====
      async function executeCommands() {
        if (gameState.isExecuting) return;
        await ensureAudio();
        vibrateDevice([100]);

        const hasCommands = gameState.commands.some((c) => c !== null);
        if (!hasCommands) {
          showError("–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –≥–∞—Å—ñ–Ω–Ω—è –≤–æ–≥–Ω—é! üî•", false);
          return;
        }

        gameState.isExecuting = true;
        elements.runBtn.disabled = true;

        const level = LEVELS[gameState.currentLevel];
        let pos = [...level.start];
        let collectedGems = 0;
        const remainingGems = [...level.gems];
        
        updateCharacterPosition(level.start, true);
        await utils.sleep(100);
        
        for (let i = 0; i < gameState.commands.length; i++) {
          const cmd = gameState.commands[i];
          if (!cmd) break;

          const [dr, dc] = DIRECTION_VECTORS[cmd];
          const newPos = [pos[0] + dr, pos[1] + dc];

          await utils.sleep(ANIMATION_SPEED);

          if (!utils.isValidPosition(newPos, level)) {
            sounds.error();
            elements.gameGrid.classList.add("grid-shaking");
            setTimeout(
              () => elements.gameGrid.classList.remove("grid-shaking"),
              400
            );
            const gridMap = gameState.optimizedGridMap || { rowMap: [], colMap: [] };
            const mappedRowIndex = gridMap.rowMap.indexOf(newPos[0]);
            const mappedColIndex = gridMap.colMap.indexOf(newPos[1]);
            const errorMsg =
              (mappedRowIndex === -1 || mappedColIndex === -1)
                ? "–ü–æ–∂–µ–∂–Ω–∏–∫ –≤–∏–π—à–æ–≤ –∑–∞ –º–µ–∂—ñ –∑–æ–Ω–∏ –≥–∞—Å—ñ–Ω–Ω—è! üöí"
                : "–û–π, –ø–æ–∂–µ–∂–Ω–∏–∫ –Ω–µ –º–æ–∂–µ –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≤–æ–¥—É! üåä";
            showError(errorMsg, true);
            gameState.isExecuting = false;
            elements.runBtn.disabled = false;
            return;
          }

          sounds.move();
          updateCharacterPosition(newPos);
          pos = newPos;

          const gemIdx = remainingGems.findIndex((g) =>
            utils.arraysEqual(g, pos)
          );
          if (gemIdx !== -1) {
            // –ó–ú–Ü–ù–ê v7: –ú–∞–ª–µ–Ω—å–∫–µ —Å–≤—è—Ç–∫—É–≤–∞–Ω–Ω—è
            const cell = getCellElement(pos);
            celebrateSmallWin(cell); 
            
            collectedGems++;
            const fire = cell?.querySelector('[data-gem="fire"]');
            if (fire) {
              fire.classList.add("extinguishing");
              setTimeout(() => fire.remove(), 700);
            }
            remainingGems.splice(gemIdx, 1);
          }
        }

        if (remainingGems.length === 0) {
          sounds.win();
          gameState.totalGems += collectedGems;
          elements.gemsCount.textContent = gameState.totalGems;
          checkAchievements();
          saveProgress(); // –ó–ú–Ü–ù–ê v7: –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å
          await utils.sleep(400);
          showWin(collectedGems);
        } else {
          sounds.error();
          const leftGems = remainingGems.length;
          const fireWord =
            leftGems === 1 ? "–æ—Å–µ—Ä–µ–¥–æ–∫" : (leftGems < 5 ? "–æ—Å–µ—Ä–µ–¥–∫–∏" : "–æ—Å–µ—Ä–µ–¥–∫—ñ–≤");
          showError(`–ó–∞–ª–∏—à–∏–ª–æ—Å—å —â–µ ${leftGems} ${fireWord} –≤–æ–≥–Ω—é! üî•`, true);
        }

        gameState.isExecuting = false;
        elements.runBtn.disabled = false;
      }

      // ===== Show Win =====
      function showWin(firesExtinguished) {
        createConfetti();
        elements.encouragement.textContent =
          utils.randomChoice(ENCOURAGEMENTS);

        const fireWord =
          firesExtinguished === 1 ? "–æ—Å–µ—Ä–µ–¥–æ–∫" : (firesExtinguished < 5 ? "–æ—Å–µ—Ä–µ–¥–∫–∏" : "–æ—Å–µ—Ä–µ–¥–∫—ñ–≤");
        elements.winMessage.textContent = `–¢–∏ –∑–∞–≥–∞—Å–∏–≤ ${firesExtinguished} ${fireWord}! üí™ –ë–µ–∑–ø–µ–∫–∞ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞!`;

        if (gameState.currentLevel === TOTAL_LEVELS_COUNT - 1) {
          elements.nextLevelBtn.innerHTML = "–í—ñ—Ç–∞—î–º–æ! üéä";
          elements.winMessage.textContent = `–¢–∏ –ø—Ä–æ–π—à–æ–≤ –≤—Å—ñ ${TOTAL_LEVELS_COUNT} —Ä—ñ–≤–Ω—ñ–≤! –ó–∞–≥–∞—à–µ–Ω–æ –æ—Å–µ—Ä–µ–¥–∫—ñ–≤ –≤–æ–≥–Ω—é: ${gameState.totalGems} üî•`;
          speak("–ù–µ–π–º–æ–≤—ñ—Ä–Ω–æ! –¢–∏ –ø—Ä–æ–π—à–æ–≤ —É—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π!");
        } else {
          elements.nextLevelBtn.innerHTML =
            '–ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–∫–ª–∏–∫ <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>';
          speak("–ú–æ–ª–æ–¥–µ—Ü—å! –¢–∏ –∑–∞–≥–∞—Å–∏–≤ –≤–µ—Å—å –≤–æ–≥–æ–Ω—å!");
        }

        elements.winModal.classList.remove("hidden");
      }

      // ===== Show Error =====
      function showError(msg, canRetry) {
        // –ó–ú–Ü–ù–ê v7: –ü–æ–∑–∏—Ç–∏–≤–Ω–µ –ø—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è
        const encouragingMsg = utils.randomChoice(POSITIVE_ERRORS);
        elements.errorMessage.innerHTML = `
          <div class="text-5xl mb-4">üòä</div>
          <p class="text-2xl font-bold text-orange-600 mb-2">${encouragingMsg}</p>
          <p class="text-lg text-gray-600">${msg}</p>
        `;
        speak("–°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑! –¢–∏ –≤–ø–æ—Ä–∞—î—à—Å—è!");
        elements.retryBtn.style.display = canRetry ? "inline-block" : "none";
        elements.errorModal.classList.remove("hidden");
      }
      
      // –ó–ú–Ü–ù–ê v7: –Ü–Ω—Ç—Ä–æ –ø—Ä–æ –ø–µ—Ä–µ—à–∫–æ–¥–∏
      function showObstacleIntro() {
        const modal = document.createElement('div');
        modal.className = "fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4";
        modal.innerHTML = `
          <div class="bg-white rounded-3xl p-8 text-center max-w-md">
            <div class="text-8xl mb-4">üåä</div>
            <h2 class="text-3xl font-bold text-blue-600 mb-4">–û–±–µ—Ä–µ–∂–Ω–æ!</h2>
            <p class="text-2xl mb-4">–¶–µ –≤–æ–¥–∞! –ü–æ–∂–µ–∂–Ω–∏–∫ –Ω–µ –º–æ–∂–µ –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≤–æ–¥—É.</p>
            <p class="text-xl mb-6">–ó–Ω–∞–π–¥–∏ —ñ–Ω—à–∏–π —à–ª—è—Ö! üîÑ</p>
            
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="bg-orange-500 text-white py-4 px-8 rounded-xl text-xl w-full pulse-glow">
              –ó—Ä–æ–∑—É–º—ñ–ª–æ! üí™
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        speak("–û–±–µ—Ä–µ–∂–Ω–æ! –¶–µ –≤–æ–¥–∞. –ó–Ω–∞–π–¥–∏ —ñ–Ω—à–∏–π —à–ª—è—Ö!");
      }

      // ===== Fullscreen =====
      function updateFullscreenIcon() {
        const icon = elements.fullscreenBtn.querySelector("i");
        if (document.fullscreenElement) {
          icon.className = "fas fa-compress text-xl text-orange-600";
          elements.fullscreenBtn.title = "–í–∏–π—Ç–∏ –∑ –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É";
        } else {
          icon.className = "fas fa-expand text-xl text-orange-600";
          elements.fullscreenBtn.title = "–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω";
        }
      }
      function toggleFullScreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch((err) => {
            console.warn(
              `Error attempting to enable full-screen mode: ${err.message} (${err.name})`
            );
          });
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      }
      
      // –ó–ú–Ü–ù–ê v7: –¢–∞–π–º–µ—Ä —Å–µ—Å—ñ—ó
      function checkSessionTime() {
        const elapsed = Date.now() - sessionStartTime;
        
        if (elapsed > MAX_SESSION_TIME && document.querySelectorAll('.break-reminder').length === 0) {
          showBreakReminder();
        }
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –±–∞—Ç—å–∫—ñ–≤
        elements.parentTime.textContent = `${Math.floor(elapsed / 60000)} —Ö–≤`;
      }

      function showBreakReminder() {
        const modal = document.createElement('div');
        modal.className = 'break-reminder fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-3xl p-8 text-center max-w-md">
            <div class="text-8xl mb-4">‚è∞</div>
            <h2 class="text-3xl font-bold text-orange-600 mb-4">–ß–∞—Å –≤—ñ–¥–ø–æ—á–∏—Ç–∏!</h2>
            <p class="text-xl mb-6">–¢–∏ —á—É–¥–æ–≤–æ –ø–æ–ø—Ä–∞—Ü—é–≤–∞–≤! –î–∞–≤–∞–π –∑—Ä–æ–±–∏–º–æ –ø–µ—Ä–µ—Ä–≤—É? üåü</p>
            
            <button onclick="this.closest('div.break-reminder').remove(); sessionStartTime = Date.now();" 
                    class="bg-green-500 text-white py-4 px-8 rounded-xl text-xl w-full mb-3">
              –©–µ —Ç—Ä–æ—à–∫–∏ –ø–æ–≥—Ä–∞—é üéÆ
            </button>
            <button onclick="location.reload()" 
                    class="bg-orange-500 text-white py-4 px-8 rounded-xl text-xl w-full">
              –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ –≥—Ä—É üëã
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        speak("–ß–∞—Å –≤—ñ–¥–ø–æ—á–∏—Ç–∏! –¢–∏ —á—É–¥–æ–≤–æ –ø–æ–ø—Ä–∞—Ü—é–≤–∞–≤!");
      }
      
      // –ó–ú–Ü–ù–ê v7: –ü–æ—à—É–∫ —à–ª—è—Ö—É (BFS) –¥–ª—è –ø—ñ–¥–∫–∞–∑–∫–∏
      function findSimplestPath(level) {
          const queue = [[level.start, []]]; // [position, path_array]
          const visited = new Set([level.start.toString()]);
          const target = level.gems[0]; // –ú–µ—Ç–∞ - –ø–µ—Ä—à–∏–π –≤–æ–≥–æ–Ω—å
          
          if (!target) return [];

          while (queue.length > 0) {
              const [currentPos, path] = queue.shift();

              if (utils.arraysEqual(currentPos, target)) {
                  return path; // –ó–Ω–∞–π—à–ª–∏ —à–ª—è—Ö
              }

              for (const direction in DIRECTION_VECTORS) {
                  const [dr, dc] = DIRECTION_VECTORS[direction];
                  const newPos = [currentPos[0] + dr, currentPos[1] + dc];
                  
                  if (utils.isValidPosition(newPos, level) && !visited.has(newPos.toString())) {
                      visited.add(newPos.toString());
                      queue.push([newPos, [...path, direction]]);
                  }
              }
          }
          return []; // –®–ª—è—Ö –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
      }
      
      // –ó–ú–Ü–ù–ê v7: –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ "–ü—ñ–¥–∫–∞–∑–∫–∞" —Ç–∞ "–í—ñ–¥–º—ñ–Ω–∞"
      function addExtraButtons() {
          // –ö–Ω–æ–ø–∫–∞ "–ü—ñ–¥–∫–∞–∑–∫–∞"
          const helpBtn = document.createElement('button');
          helpBtn.innerHTML = '<i class="fas fa-lightbulb"></i>';
          helpBtn.className = 'bg-yellow-400 hover:bg-yellow-500 text-white font-bold p-3 sm:py-4 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl shadow-lg';
          helpBtn.title = '–ü—ñ–¥–∫–∞–∑–∫–∞';
          
          helpBtn.addEventListener('click', async () => {
              vibrateDevice([50, 50, 50]);
              const solution = findSimplestPath(LEVELS[gameState.currentLevel]);
              if (solution.length > 0) {
                  // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä—à—ñ 2-3 –∫—Ä–æ–∫–∏
                  for (let i = 0; i < Math.min(3, solution.length); i++) {
                      if (gameState.commands[i] === null) {
                        gameState.commands[i] = solution[i];
                        renderCommandSlots();
                        const btn = elements[`${solution[i]}Btn`];
                        btn.classList.add('pulse-hint-animation');
                        await utils.sleep(500);
                        btn.classList.remove('pulse-hint-animation');
                      }
                  }
              }
          });
          
          // –ö–Ω–æ–ø–∫–∞ "–í—ñ–¥–º—ñ–Ω–∞"
          const undoBtn = document.createElement('button');
          undoBtn.innerHTML = '<i class="fas fa-undo"></i>';
          undoBtn.className = 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-3 sm:py-4 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl shadow-lg';
          undoBtn.title = '–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é –∫–æ–º–∞–Ω–¥—É';
          
          undoBtn.addEventListener('click', () => {
              for (let i = gameState.commands.length - 1; i >= 0; i--) {
                  if (gameState.commands[i] !== null) {
                      gameState.commands[i] = null;
                      renderCommandSlots();
                      vibrateDevice([30]);
                      break;
                  }
              }
          });
          
          // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏
          const panel = elements.mainControls;
          panel.insertBefore(helpBtn, panel.children[1]); // –î–æ–¥–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –ø–µ—Ä–µ–¥ "–û—á–∏—Å—Ç–∏—Ç–∏"
          panel.appendChild(undoBtn); // –î–æ–¥–∞—î–º–æ –≤—ñ–¥–º—ñ–Ω—É –≤ –∫—ñ–Ω–µ—Ü—å
      }

      // ===== Event Listeners =====
      elements.upBtn.addEventListener("click", () => { addCommand("up"); });
      elements.downBtn.addEventListener("click", () => { addCommand("down"); });
      elements.leftBtn.addEventListener("click", () => { addCommand("left"); });
      elements.rightBtn.addEventListener("click", () => { addCommand("right"); });
      elements.clearBtn.addEventListener("click", () => { clearCommands(); });
      elements.runBtn.addEventListener("click", () => { executeCommands(); });

      elements.nextLevelBtn.addEventListener("click", async () => {
        await ensureAudio();
        elements.winModal.classList.add("hidden");
        if (gameState.currentLevel < TOTAL_LEVELS_COUNT - 1) {
          gameState.currentLevel++;
          initLevel();
        } else {
          // Game completed - restart
          gameState.currentLevel = 0;
          gameState.totalGems = 0;
          gameState.shownAchievements.clear();
          elements.gemsCount.textContent = "0";
          elements.nextLevelBtn.innerHTML =
            '–ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–∫–ª–∏–∫ <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>';
          initLevel();
        }
        saveProgress(); // –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å
      });

      elements.retryBtn.addEventListener("click", async () => {
        await ensureAudio();
        elements.errorModal.classList.add("hidden");
        initLevel();
      });

      elements.closeErrBtn.addEventListener("click", async () => {
        await ensureAudio();
        elements.errorModal.classList.add("hidden");
        const level = LEVELS[gameState.currentLevel];
        updateCharacterPosition(level.start, true);
        gameState.currentPos = [...level.start];
        highlightNearObstacles(level.start, level);
      });

      elements.soundBtn.addEventListener("click", async () => {
        await ensureAudio();
        gameState.soundEnabled = !gameState.soundEnabled;
        elements.soundBtn.setAttribute(
          "aria-pressed",
          String(gameState.soundEnabled)
        );
        const icon = elements.soundBtn.querySelector("i");
        if (gameState.soundEnabled) {
          icon.className = "fas fa-volume-high text-xl text-orange-600";
          sounds.click();
        } else {
          icon.className = "fas fa-volume-xmark text-xl text-orange-600";
          window.speechSynthesis.cancel(); // –í–∏–º–∫–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ —Ä–µ–ø–ª—ñ–∫–∏
        }
      });

      elements.fullscreenBtn.addEventListener("click", () => {
        toggleFullScreen();
      });
      document.addEventListener("fullscreenchange", updateFullscreenIcon);
      
      // –ó–ú–Ü–ù–ê v7: –°–ª—É—Ö–∞—á—ñ —Ç—É—Ç–æ—Ä—ñ–∞–ª—É —Ç–∞ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ —Ä–µ–∂–∏–º—É
      elements.startTutorial.addEventListener("click", () => {
          elements.tutorialOverlay.style.display = 'none';
          ensureAudio(); // –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∞—É–¥—ñ–æ –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –≤–∑–∞—î–º–æ–¥—ñ—ó
      });
      
      elements.parentBtn.addEventListener('click', () => {
          // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
          elements.parentLevels.textContent = `${gameState.currentLevel}/${TOTAL_LEVELS_COUNT}`;
          elements.parentGems.textContent = gameState.totalGems;
          checkSessionTime(); // –û–Ω–æ–≤–∏—Ç–∏ —Ç–∞–π–º–µ—Ä
          elements.parentModal.classList.remove('hidden');
      });
      
      elements.closeParentModal.addEventListener('click', () => {
          elements.parentModal.classList.add('hidden');
      });

      // Keyboard support
      document.addEventListener("keydown", (e) => {
        if (gameState.isExecuting) return;
        if (
          !elements.winModal.classList.contains("hidden") ||
          !elements.errorModal.classList.contains("hidden")
        )
          return;

        switch (e.key) {
          case "ArrowUp": e.preventDefault(); addCommand("up"); break;
          case "ArrowDown": e.preventDefault(); addCommand("down"); break;
          case "ArrowLeft": e.preventDefault(); addCommand("left"); break;
          case "ArrowRight": e.preventDefault(); addCommand("right"); break;
          case "Enter": e.preventDefault(); executeCommands(); break;
          case "Escape":
          case "Backspace": e.preventDefault(); clearCommands(); break;
        }
      });

      // Responsive reflow
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const level = LEVELS[gameState.currentLevel];
          renderGrid(level);
          updateCharacterPosition(gameState.currentPos || level.start, true);
        }, 250);
      });

      // ===== Initialize Game =====
      
      // –ó–ú–Ü–ù–ê v7: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —Ç—É—Ç–æ—Ä—ñ–∞–ª –≤–∂–µ –±–∞—á–∏–ª–∏
      if (localStorage.getItem('firefighterProgress')) {
          elements.tutorialOverlay.style.display = 'none';
      }
      
      loadProgress(); // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å
      initLevel();
      addExtraButtons(); // –î–æ–¥–∞—Ç–∏ –∫–Ω–æ–ø–∫–∏ "–ü—ñ–¥–∫–∞–∑–∫–∞" —Ç–∞ "–í—ñ–¥–º—ñ–Ω–∞"
      setInterval(checkSessionTime, 2 * 60 * 1000); // –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–∞–π–º–µ—Ä —Å–µ—Å—ñ—ó
    </script>
  </body>
</html>

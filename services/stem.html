<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü–æ–∂–µ–∂–Ω–∏–∫ 101</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --cell-gap-sm: 2px;
        --cell-gap-lg: 4px;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        /* –í–∞–∂–ª–∏–≤–æ –¥–ª—è –≤—ñ–¥—á—É—Ç—Ç—è '–∑–∞—Å—Ç–æ—Å—É–Ω–∫—É': –≤–∏–º–∏–∫–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–∞ –¥–∏–≤–Ω—ñ –¥–æ—Ç–∏–∫–∏ */
        touch-action: manipulation;
        overflow: hidden;
        height: 100vh;
        /* –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—é —Ç–µ–∫—Å—Ç—É –ø—Ä–∏ —à–≤–∏–¥–∫–∏—Ö –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è—Ö */
        user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
      }
      .grid-cell {
        aspect-ratio: 1;
        border: 2px solid #fdba74;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }
      @media (max-width: 640px) {
        .grid-cell {
          border-width: 1px;
        }
      }

      .command-slot {
        aspect-ratio: 1;
        border: 4px dashed #f97316;
        transition: all 0.2s;
        height: 60px;
        flex-shrink: 0;
        width: auto;
      }
      .command-slot.filled {
        border-style: solid;
        border-color: #ea580c;
        background-color: #fff7ed;
        /* –ü–û–ö–†–ê–©–ï–ù–ù–Ø UX: –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫—É—Ä—Å–æ—Ä 'pointer', –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –∫–ª—ñ–∫ –≤–∏–º–∫–Ω–µ–Ω–æ */
        cursor: default;
      }
      @media (min-width: 640px) {
        .command-slot {
          height: 80px;
        }
      }
      @media (min-width: 768px) {
        #commandSlots {
          gap: 0.75rem;
        }
      }

      .arrow-btn {
        min-width: 70px;
        min-height: 70px;
        aspect-ratio: 1;
        font-size: 2rem;
        cursor: pointer;
        transition: transform 0.15s;
        user-select: none;
      }
      /* –ï—Ñ–µ–∫—Ç "–Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è" –¥–ª—è —Ç–∞—á-–ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ */
      .arrow-btn:active {
        transform: scale(1.08);
      }
      @media (min-width: 768px) {
        .arrow-btn {
          min-width: 90px;
          min-height: 90px;
          font-size: 2.5rem;
        }
      }

      @keyframes firefighter-float {
        0%,
        100% {
          transform: translateY(0) rotate(0);
        }
        50% {
          transform: translateY(-8px) rotate(5deg);
        }
      }
      .character {
        animation: firefighter-float 2s infinite ease-in-out;
        font-size: 3rem;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        transform-style: preserve-3d;
      }
      @media (min-width: 768px) {
        .character {
          font-size: 4rem;
        }
      }

      @keyframes fire-extinguish {
        0% {
          transform: scale(1) rotate(0);
          opacity: 1;
        }
        50% {
          transform: scale(1.5) rotate(180deg);
          opacity: 0.7;
        }
        100% {
          transform: scale(0.2) rotate(360deg);
          opacity: 0;
        }
      }
      .extinguishing {
        animation: fire-extinguish 0.7s forwards;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .shake {
        animation: shake 0.5s;
      }
      @keyframes cell-sparkle {
        0% {
          transform: scale(1);
          background-color: #fff7ed;
          box-shadow: 0 0 0 rgba(234, 88, 12, 0);
        }
        50% {
          transform: scale(1.05);
          background-color: #ffedd5;
          box-shadow: 0 0 20px rgba(234, 88, 12, 0.6);
        }
        100% {
          transform: scale(1);
          background-color: #fff7ed;
          box-shadow: 0 0 0 rgba(234, 88, 12, 0);
        }
      }
      .landing {
        animation: cell-sparkle 0.4s ease-out;
      }
      @keyframes win-rainbow {
        0% {
          transform: scale(1) rotate(0);
          filter: hue-rotate(0deg);
        }
        20% {
          transform: scale(1.15) rotate(-8deg);
          filter: hue-rotate(60deg);
        }
        40% {
          transform: scale(1.15) rotate(8deg);
          filter: hue-rotate(120deg);
        }
        60% {
          transform: scale(1.15) rotate(-8deg);
          filter: hue-rotate(180deg);
        }
        80% {
          transform: scale(1.15) rotate(8deg);
          filter: hue-rotate(240deg);
        }
        100% {
          transform: scale(1) rotate(0);
          filter: hue-rotate(360deg);
        }
      }
      .win-pulse div {
        animation: win-rainbow 1.5s ease-in-out;
      }
      @keyframes grid-shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-6px);
        }
      }
      .grid-shaking {
        animation: grid-shake 0.4s linear;
      }
      .sparkle-container {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .sparkle-bit {
        position: absolute;
        width: 10px;
        height: 10px;
        background: linear-gradient(45deg, #facc15, #ef4444);
        border-radius: 50%;
        animation: sparkle-fx 0.9s forwards;
        opacity: 0;
      }
      @keyframes sparkle-fx {
        0% {
          opacity: 1;
          transform: scale(0.5) translate(0, 0);
        }
        100% {
          opacity: 0;
          transform: scale(1.5) var(--tw-translate);
        }
      }
      .emoji-xs {
        font-size: 1.75rem;
      }
      .emoji-sm {
        font-size: 2.25rem;
      }
      @media (min-width: 768px) {
        .emoji-md {
          font-size: 3rem;
        }
        .emoji-lg {
          font-size: 4rem;
        }
      }
      .trail-dot {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ef4444, #f97316);
        opacity: 0.9;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: trail-fade 0.7s ease-out forwards;
        box-shadow: 0 0 8px rgba(234, 88, 12, 0.6);
      }
      @keyframes trail-fade {
        to {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.3);
        }
      }
      .near-obstacle {
        box-shadow: inset 0 0 0 3px rgba(239, 68, 68, 0.4);
        animation: near-pulse 0.6s ease-out 1;
      }
      @keyframes near-pulse {
        0% {
          box-shadow: inset 0 0 0 0 rgba(239, 68, 68, 0);
        }
        50% {
          box-shadow: inset 0 0 0 6px rgba(239, 68, 68, 0.4);
        }
        100% {
          box-shadow: inset 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
      }
      .confetti {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 100;
      }
      .confetti-bit {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        opacity: 0.95;
        animation: confetti-fall 1400ms ease-out forwards;
      }
      @keyframes confetti-fall {
        0% {
          transform: translateY(-30px) rotate(0) scale(1);
        }
        100% {
          transform: translateY(180px) rotate(1080deg) scale(0.5);
          opacity: 0;
        }
      }
      @keyframes float-achievement {
        0% {
          transform: translateY(20px) scale(0.8) translateX(-50%);
          opacity: 0;
        }
        50% {
          transform: translateY(0) scale(1.08) translateX(-50%);
          opacity: 1;
        }
        100% {
          transform: translateY(0) scale(1) translateX(-50%);
          opacity: 1;
        }
      }
      .achievement-toast {
        animation: float-achievement 0.7s ease-out;
      }
      .progress-bar {
        height: 10px;
        background: linear-gradient(
          90deg,
          #ef4444 0%,
          #f97316 50%,
          #facc15 100%
        );
        border-radius: 999px;
        transition: width 0.6s ease-out;
        box-shadow: 0 0 10px rgba(234, 88, 12, 0.5);
      }
      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(234, 88, 12, 0.6),
            0 0 40px rgba(249, 115, 22, 0.4);
        }
        50% {
          box-shadow: 0 0 30px rgba(234, 88, 12, 0.8),
            0 0 60px rgba(249, 115, 22, 0.6);
        }
      }
      .pulse-glow {
        animation: pulse-glow 2s infinite;
      }
      .fire-glow {
        animation: fire-pulse 1.5s infinite;
      }
      @keyframes fire-pulse {
        0%,
        100% {
          transform: scale(1);
          filter: brightness(1);
        }
        50% {
          transform: scale(1.1);
          filter: brightness(1.3);
        }
      }

      @keyframes pulse-hint {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 0 20px 10px rgba(249, 115, 22, 0.3);
        }
      }
      .pulse-hint-animation {
        animation: pulse-hint 1.5s infinite;
      }

      @keyframes float-up-emoji {
        0% {
          transform: translateY(0) scale(0.5);
          opacity: 1;
        }
        100% {
          transform: translateY(-50px) scale(1.5);
          opacity: 0;
        }
      }
      .floating-emoji {
        position: absolute;
        z-index: 1000;
        animation: float-up-emoji 1.5s ease-out forwards;
      }

      /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –¥—É–∂–µ –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
      @media (max-width: 375px) {
        .arrow-btn {
          min-width: 65px;
          min-height: 65px;
          font-size: 1.75rem;
          padding: 0.75rem;
        }

        .command-slot {
          height: 55px;
        }

        .grid-cell {
          min-height: 50px;
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-red-200 via-orange-200 to-yellow-200 min-h-screen p-2 sm:p-4"
  >
    <!-- –û—Å–Ω–æ–≤–Ω–∞ –æ–±–≥–æ—Ä—Ç–∫–∞, —â–æ –∑–∞–π–º–∞—î –≤–µ—Å—å –µ–∫—Ä–∞–Ω -->
    <div
      class="max-w-7xl mx-auto h-full flex flex-col"
      aria-label="–û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—Ä–∏"
    >
      <!-- Header -->
      <header
        class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 mb-3 sm:mb-6 border-4 border-orange-300 flex-shrink-0"
      >
        <div
          class="flex justify-between items-center mb-3 gap-3 sm:gap-6"
          role="status"
          aria-live="polite"
        >
          <h1
            class="text-2xl sm:text-3xl md:text-4xl font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent flex-shrink-0"
          >
            <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>
            –ü–æ–∂–µ–∂–Ω–∏–∫ 101
          </h1>

          <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –†—ñ–≤–Ω—è —Ç–∞ –û—á–æ–∫ (—Ä–æ—Å—Ç–µ, —â–æ–± –∑–∞–π–Ω—è—Ç–∏ –º—ñ—Å—Ü–µ) -->
          <div
            class="flex items-center gap-3 sm:gap-5 text-lg sm:text-xl md:text-2xl flex-grow min-w-0 justify-center"
          >
            <div class="font-bold text-orange-600">
              –†—ñ–≤–µ–Ω—å: <span id="levelNum">1</span>/<span id="totalLevels"
                >10</span
              >
            </div>
            <div
              class="font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent"
            >
              <i class="fas fa-fire" aria-hidden="true"></i>
              <span id="gemsCount">0</span>
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è (–ó–≤—É–∫, –ü–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω) -->
          <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
            <button
              id="fullscreenBtn"
              class="bg-gradient-to-r from-orange-200 to-red-200 hover:from-orange-300 hover:to-red-300 px-3 py-2 rounded-xl transition"
              title="–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω"
            >
              <i
                class="fas fa-expand text-xl text-orange-600"
                aria-hidden="true"
              ></i>
              <span class="sr-only">–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω</span>
            </button>
            <button
              id="soundBtn"
              class="bg-gradient-to-r from-orange-200 to-red-200 hover:from-orange-300 hover:to-red-300 px-3 py-2 rounded-xl transition"
              title="–ó–≤—É–∫"
              aria-pressed="true"
            >
              <i
                class="fas fa-volume-high text-xl text-orange-600"
                aria-hidden="true"
              ></i>
              <span class="sr-only">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</span>
            </button>
          </div>
        </div>

        <!-- Progress Bar -->
        <div
          class="bg-gray-200 rounded-full h-4 overflow-hidden border-2 border-orange-300"
          aria-label="–ü—Ä–æ–≥—Ä–µ—Å —Ä—ñ–≤–Ω—ñ–≤"
        >
          <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>
      </header>

      <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–≥—Ä–æ–≤–∞ –∑–æ–Ω–∞: 'min-h-0' –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–∏–π –¥–ª—è flex-—Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤ Safari -->
      <main class="flex flex-col md:flex-row gap-3 sm:gap-6 flex-grow min-h-0">
        <!-- –ö–æ–ª–æ–Ω–∫–∞ –∫–Ω–æ–ø–æ–∫-—Å—Ç—Ä—ñ–ª–æ–∫. -->
        <div
          id="arrowControls"
          class="flex flex-row md:flex-col gap-2 sm:gap-4 justify-center md:h-full md:items-center order-2 md:order-none"
        >
          <button
            id="upBtn"
            class="arrow-btn bg-gradient-to-br from-orange-400 to-orange-600 hover:from-orange-500 hover:to-orange-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–≥–æ—Ä—É"
          >
            <i class="fas fa-arrow-up" aria-hidden="true"></i>
          </button>
          <button
            id="downBtn"
            class="arrow-btn bg-gradient-to-br from-red-400 to-red-600 hover:from-red-500 hover:to-red-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–Ω–∏–∑"
          >
            <i class="fas fa-arrow-down" aria-hidden="true"></i>
          </button>
          <button
            id="leftBtn"
            class="arrow-btn bg-gradient-to-br from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–ª—ñ–≤–æ"
          >
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
          </button>
          <button
            id="rightBtn"
            class="arrow-btn bg-gradient-to-br from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-white rounded-xl shadow-lg w-full sm:w-auto"
            aria-label="–í–ø—Ä–∞–≤–æ"
          >
            <i class="fas fa-arrow-right" aria-hidden="true"></i>
          </button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ñ–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è + —Å–ª–æ—Ç—ñ–≤. -->
        <div
          class="flex flex-col gap-3 sm:gap-6 min-w-0 flex-grow order-1 md:order-none min-h-0"
        >
          <!-- –Ü–≥—Ä–æ–≤–µ –ø–æ–ª–µ. -->
          <section
            class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 flex flex-col border-4 border-orange-300 flex-grow"
            aria-label="–Ü–≥—Ä–æ–≤–µ –ø–æ–ª–µ"
          >
            <div class="flex-1 flex justify-center items-center">
              <div
                id="gameGrid"
                class="relative"
                aria-label="–°—ñ—Ç–∫–∞ –≥—Ä–∏"
                role="grid"
              ></div>
            </div>
          </section>

          <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ü–Ü–î —ñ–≥—Ä–æ–≤–∏–º –ø–æ–ª–µ–º. -->
          <div
            id="executionPanel"
            class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-4 flex flex-col md:flex-row items-center gap-3 sm:gap-4 border-4 border-orange-300 flex-shrink-0"
          >
            <!-- –ö–Ω–æ–ø–∫–∏ '–ì–∞—Å–∏—Ç–∏' —Ç–∞ '–û—á–∏—Å—Ç–∏—Ç–∏' -->
            <!-- 
              –ü–û–ö–†–ê–©–ï–ù–ù–Ø –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–Ü (–∑–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º):
              - 'mainControls' —Ç–µ–ø–µ—Ä 'grid grid-cols-[1fr_auto]'.
              - –¶–µ —Å—Ç–≤–æ—Ä—é—î —Å—ñ—Ç–∫—É 2x2:
              - –ö–æ–ª–æ–Ω–∫–∞ 1 (—à–∏—Ä–æ–∫–∞): –ì–∞—Å–∏—Ç–∏!, –û—á–∏—Å—Ç–∏—Ç–∏
              - –ö–æ–ª–æ–Ω–∫–∞ 2 (–≤—É–∑—å–∫–∞): –ü—ñ–¥–∫–∞–∑–∫–∞, –í—ñ–¥–º—ñ–Ω–∏—Ç–∏
              - –¶–µ –∑–≤—ñ–ª—å–Ω—è—î –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –¥–ª—è —Å–ª–æ—Ç—ñ–≤ –∫–æ–º–∞–Ω–¥.
            -->
            <div
              id="mainControls"
              class="grid grid-cols-[1fr_auto] gap-2 flex-shrink-0 justify-center"
            >
              <button
                id="runBtn"
                class="bg-gradient-to-r from-blue-400 to-cyan-500 hover:from-blue-500 hover:to-cyan-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
              >
                <i class="fas fa-water" aria-hidden="true"></i> –ì–∞—Å–∏—Ç–∏!
              </button>
              <button
                id="clearBtn"
                class="bg-gradient-to-r from-red-400 to-orange-500 hover:from-red-500 hover:to-orange-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl shadow-lg"
              >
                <i class="fas fa-eraser" aria-hidden="true"></i> –û—á–∏—Å—Ç–∏—Ç–∏
              </button>
              <!-- –ö–Ω–æ–ø–∫–∏ "–ü—ñ–¥–∫–∞–∑–∫–∞" —Ç–∞ "–í—ñ–¥–º—ñ–Ω–∏—Ç–∏" –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —Å—é–¥–∏ –¥–∏–Ω–∞–º—ñ—á–Ω–æ JS -->
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–æ—Ç—ñ–≤ -->
            <div class="flex-1 min-w-0 w-full sm:w-auto py-1">
              <div id="commandSlots" aria-label="–°–ª–æ—Ç–∏ –∫–æ–º–∞–Ω–¥"></div>
            </div>
          </div>
        </div>
      </main>

      <!-- Win modal (–¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö —Ä—ñ–≤–Ω—ñ–≤) -->
      <div
        id="winModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        role="dialog"
        aria-modal="true"
      >
        <div
          class="bg-gradient-to-br from-orange-100 to-red-100 rounded-3xl p-6 sm:p-8 max-w-md w-full text-center relative overflow-hidden border-4 border-orange-400 shadow-2xl"
        >
          <div id="winConfetti" class="confetti"></div>
          <div class="text-6xl sm:text-7xl mb-4 win-pulse">
            <div>üë®‚Äçüöí</div>
          </div>
          <h2
            class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent mb-2"
          >
            –í–æ–≥–æ–Ω—å –ø–æ–≥–∞—à–µ–Ω–æ!
          </h2>
          <p
            class="text-xl sm:text-2xl mb-4 font-bold text-orange-600"
            id="encouragement"
          ></p>
          <p class="text-lg sm:text-xl mb-6 text-gray-700" id="winMessage"></p>
          <button
            id="nextLevelBtn"
            class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-4 px-8 rounded-xl text-xl w-full pulse-glow shadow-lg"
          >
            –ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–∫–ª–∏–∫
            <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Game Complete modal (–ù–û–í–ï –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û) -->
      <div
        id="gameCompleteModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        role="dialog"
        aria-modal="true"
      >
        <div
          class="bg-gradient-to-br from-yellow-100 to-orange-200 rounded-3xl p-6 sm:p-8 max-w-md w-full text-center relative overflow-hidden border-4 border-yellow-400 shadow-2xl"
        >
          <div id="completeConfetti" class="confetti"></div>
          <div class="text-7xl sm:text-8xl mb-4 win-pulse">
            <div>üèÜ</div>
          </div>
          <h2
            class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent mb-4"
          >
            –¢–∏ –ø—Ä–æ–π—à–æ–≤ –≥—Ä—É!
          </h2>
          <p class="text-lg sm:text-xl mb-6 text-gray-700">
            –í—ñ—Ç–∞—î–º–æ! –¢–∏ —Å—Ç–∞–≤ —Å–ø—Ä–∞–≤–∂–Ω—ñ–º –º–∞–π—Å—Ç—Ä–æ–º –ø–æ–∂–µ–∂–æ–≥–∞—Å—ñ–Ω–Ω—è, –∑—ñ–±—Ä–∞–≤—à–∏
            <strong class="text-orange-600" id="finalGemsCount">0</strong>
            –æ—Å–µ—Ä–µ–¥–∫—ñ–≤ –≤–æ–≥–Ω—é!
          </p>
          <div class="flex flex-col sm:flex-row gap-3">
            <button
              id="restartGameBtn"
              class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-3 px-6 rounded-xl text-lg w-full pulse-glow shadow-lg"
            >
              <i class="fas fa-redo-alt" aria-hidden="true"></i>
              –ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É
            </button>
            <button
              id="goHomeBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl text-lg w-full shadow-lg"
            >
              <i class="fas fa-home" aria-hidden="true"></i>
              –ù–∞ –≥–æ–ª–æ–≤–Ω—É
            </button>
          </div>
        </div>
      </div>

      <!-- Error modal -->
      <div
        id="errorModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        role="dialog"
        aria-modal="true"
      >
        <div
          class="bg-gradient-to-br from-orange-100 to-yellow-100 rounded-3xl p-6 sm:p-8 max-w-md w-full text-center border-4 border-orange-400 shadow-2xl"
        >
          <!-- 'errorMessage' –±—É–¥–µ –º—ñ—Å—Ç–∏—Ç–∏ HTML –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
          <div id="errorMessage"></div>

          <div class="flex gap-2 flex-wrap justify-center mt-6">
            <button
              id="retryBtn"
              class="bg-gradient-to-r from-orange-400 to-red-400 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg"
            >
              –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ <i class="fas fa-rotate-right" aria-hidden="true"></i>
            </button>
            <button
              id="closeErrBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl text-lg shadow-lg"
            >
              –ó—Ä–æ–∑—É–º—ñ–ª–æ
            </button>
          </div>
        </div>
      </div>

      <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø—ñ–¥–∫–∞–∑–∫–∏ -->
      <div
        id="hintModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        role="dialog"
        aria-modal="true"
      >
        <div
          class="bg-gradient-to-br from-orange-100 to-yellow-100 rounded-3xl p-6 sm:p-8 max-w-md w-full text-center border-4 border-orange-400 shadow-2xl"
        >
          <div class="text-6xl mb-4">üí°</div>
          <h2
            class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-red-500 to-orange-600 bg-clip-text text-transparent mb-4"
          >
            –ü—ñ–¥–∫–∞–∑–∫–∞!
          </h2>
          <p
            class="text-xl sm:text-2xl mb-6 font-bold text-orange-700"
            id="hintModalText"
          ></p>
          <button
            id="closeHintBtn"
            class="bg-gradient-to-r from-orange-400 to-red-400 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg w-full"
          >
            –ó—Ä–æ–∑—É–º—ñ–ª–æ!
          </button>
        </div>
      </div>

      <!-- Achievement toast -->
      <div
        id="achievementToast"
        class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-[60] bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500 text-white px-6 py-4 rounded-2xl shadow-2xl achievement-toast border-4 border-white"
      >
        <div class="flex items-center gap-3">
          <div class="text-4xl" id="achievementIcon"></div>
          <div>
            <div class="font-bold text-lg" id="achievementTitle"></div>
            <div class="text-sm" id="achievementText"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢—É—Ç–æ—Ä—ñ–∞–ª -->
    <div
      id="tutorialOverlay"
      class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-3xl p-6 sm:p-8 max-w-md text-center">
        <div class="text-7xl mb-4 animate-bounce">üë®‚Äçüöí</div>
        <h2 class="text-3xl font-bold text-orange-600 mb-4">
          –ü—Ä–∏–≤—ñ—Ç, —é–Ω–∏–π –ø–æ–∂–µ–∂–Ω–∏–∫—É!
        </h2>
        <p class="text-xl mb-6">–î–æ–ø–æ–º–æ–∂–∏ –º–µ–Ω—ñ –∑–∞–≥–∞—Å–∏—Ç–∏ –≤–æ–≥–æ–Ω—å! üî•</p>

        <div class="space-y-4">
          <div class="flex items-center gap-4 bg-orange-50 p-4 rounded-xl">
            <div class="text-5xl">‚¨ÜÔ∏è</div>
            <p class="text-lg text-left">–ù–∞—Ç–∏—Å–∫–∞–π —Å—Ç—Ä—ñ–ª–∫–∏, —â–æ–± —è —Ä—É—Ö–∞–≤—Å—è</p>
          </div>

          <div class="flex items-center gap-4 bg-blue-50 p-4 rounded-xl">
            <div class="text-5xl">üíß</div>
            <p class="text-lg text-left">–ü–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω–∏ "–ì–∞—Å–∏—Ç–∏!"</p>
          </div>
        </div>

        <button
          id="startTutorial"
          class="mt-6 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-4 px-8 rounded-xl text-2xl w-full pulse-glow"
        >
          –ü–æ—á–∞—Ç–∏! üöí
        </button>
      </div>
    </div>

    <!-- –ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π —Ä–µ–∂–∏–º -->
    <button
      id="parentBtn"
      class="fixed bottom-4 right-4 bg-gray-300 text-gray-700 p-3 rounded-full z-50 shadow-lg"
    >
      <i class="fas fa-user-tie"></i>
    </button>

    <div
      id="parentModal"
      class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-3xl p-6 max-w-lg w-full">
        <h2 class="text-2xl font-bold mb-4">üìä –ü—Ä–æ–≥—Ä–µ—Å –¥–∏—Ç–∏–Ω–∏</h2>

        <div class="space-y-3">
          <div class="flex justify-between">
            <span>–ü—Ä–æ–π–¥–µ–Ω–æ —Ä—ñ–≤–Ω—ñ–≤:</span>
            <strong id="parentLevels">0/10</strong>
          </div>
          <div class="flex justify-between">
            <span>–ó–∞–≥–∞—à–µ–Ω–æ –æ—Å–µ—Ä–µ–¥–∫—ñ–≤:</span>
            <strong id="parentGems">0</strong>
          </div>
          <div class="flex justify-between">
            <span>–ß–∞—Å —Å–µ—Å—ñ—ó:</span>
            <strong id="parentTime">0 —Ö–≤</strong>
          </div>
        </div>

        <div class="mt-6 p-4 bg-blue-50 rounded-xl">
          <h3 class="font-bold mb-2">üí° –ü–æ—Ä–∞–¥–∏:</h3>
          <ul class="text-sm space-y-1 list-disc list-inside">
            <li>–ì—Ä–∞—é—á–∏ —Ä–∞–∑–æ–º, –∑–∞–ø–∏—Ç—É–π—Ç–µ: "–ö—É–¥–∏ –º–∞—î –π—Ç–∏ –ø–æ–∂–µ–∂–Ω–∏–∫?"</li>
            <li>–°–≤—è—Ç–∫—É–π—Ç–µ –∫–æ–∂–Ω—É —Å–ø—Ä–æ–±—É, –Ω–µ –ª–∏—à–µ –ø–µ—Ä–µ–º–æ–≥–∏.</li>
            <li>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —á–∞—Å –≥—Ä–∏: 15 —Ö–≤–∏–ª–∏–Ω.</li>
          </ul>
        </div>

        <button
          id="closeParentModal"
          class="mt-4 bg-orange-500 text-white py-3 px-6 rounded-xl w-full"
        >
          –ó–∞–∫—Ä–∏—Ç–∏
        </button>
      </div>
    </div>

    <script>
      // –í–µ—Å—å –∫–æ–¥ –≥—Ä–∏ –∑–∞–≥–æ—Ä–Ω—É—Ç–æ –≤ IIFE (Immediately Invoked Function Expression)
      // –¶–µ —Å—Ç–≤–æ—Ä—é—î –ø—Ä–∏–≤–∞—Ç–Ω—É –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—ñ —Ç–∞ –∑–∞–ø–æ–±—ñ–≥–∞—î –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—é –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ 'window'
      (function () {
        "use strict"; // –í–º–∏–∫–∞—î–º–æ —Å—É–≤–æ—Ä–∏–π —Ä–µ–∂–∏–º JavaScript

        // ===== 1. –ö–û–ù–°–¢–ê–ù–¢–ò =====
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏, —è–∫—ñ –Ω–µ –∑–º—ñ–Ω—é—é—Ç—å—Å—è
        // =================================

        const ANIMATION_SPEED = 250; // –®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä—É—Ö—É –ø–æ–∂–µ–∂–Ω–∏–∫–∞ (–º—Å)
        const DIRECTION_VECTORS = {
          up: [-1, 0],
          down: [1, 0],
          left: [0, -1],
          right: [0, 1],
        };
        const ARROW_ICONS = {
          up: '<i class="fas fa-arrow-up text-orange-500" aria-hidden="true"></i>',
          down: '<i class="fas fa-arrow-down text-red-500" aria-hidden="true"></i>',
          left: '<i class="fas fa-arrow-left text-yellow-500" aria-hidden="true"></i>',
          right:
            '<i class="fas fa-arrow-right text-amber-500" aria-hidden="true"></i>',
        };

        // –£—Å—ñ —Ä—ñ–≤–Ω—ñ –≥—Ä–∏
        const LEVELS = [
          // 1. –ü—Ä—è–º–∞ –ª—ñ–Ω—ñ—è
          {
            size: 3,
            start: [1, 0],
            obstacles: [],
            gems: [
              [1, 1],
              [1, 2],
            ],
            maxCommands: 2,
            hint: "–ù–∞—Ç–∏—Å–Ω–∏ —Å—Ç—Ä—ñ–ª–∫—É '–í–ø—Ä–∞–≤–æ' ‚û°Ô∏è –¥–≤—ñ—á—ñ!",
            optimizeGrid: false,
          },
          // 2. –ü—Ä—è–º–∞ –ª—ñ–Ω—ñ—è
          {
            size: 4,
            start: [0, 0],
            obstacles: [],
            gems: [
              [1, 0],
              [2, 0],
              [3, 0],
            ],
            maxCommands: 3,
            hint: "–ù–∞—Ç–∏—Å–Ω–∏ —Å—Ç—Ä—ñ–ª–∫—É '–í–Ω–∏–∑' ‚¨áÔ∏è —Ç—Ä–∏—á—ñ!",
            optimizeGrid: false,
          },
          // 3. –ü—Ä–æ—Å—Ç–∏–π –ø–æ–≤–æ—Ä–æ—Ç
          {
            size: 3,
            start: [0, 0],
            obstacles: [],
            gems: [
              [0, 1],
              [0, 2],
              [1, 2],
            ],
            maxCommands: 3,
            hint: "–ü—Ä–æ–≤–µ–¥–∏ –ø–æ–∂–µ–∂–Ω–∏–∫–∞ –¥–æ –≤–æ–≥–Ω—é!",
            optimizeGrid: false,
          },
          // 4. –ü–µ—Ä—à–∞ –ø–µ—Ä–µ—à–∫–æ–¥–∞
          {
            size: 4,
            start: [0, 0],
            obstacles: [[1, 0]],
            gems: [
              [0, 1],
              [2, 1],
            ],
            maxCommands: 5,
            optimizeGrid: true,
            hint: "–û–π! –¢—Ä–µ–±–∞ –æ–±—ñ–π—Ç–∏ –≤–æ–¥—É! üåä",
          },
          // 5. –©–µ –æ–¥–Ω–∞ –ø–µ—Ä–µ—à–∫–æ–¥–∞
          // –ó–ú–Ü–ù–ï–ù–û: –ü–æ–ª–µ 3x3, optimizeGrid: false
          {
            size: 3,
            start: [0, 0],
            obstacles: [[1, 1]],
            gems: [
              [0, 2],
              [2, 0],
              [2, 2],
            ],
            maxCommands: 6,
            hint: "–û–±–µ—Ä–µ–∂–Ω–æ, –≤–æ–¥–∞! üåä –¢—Ä–µ–±–∞ –æ–±—ñ–π—Ç–∏.",
            optimizeGrid: false, // –ü–æ–ª–µ —Ç–µ–ø–µ—Ä –∫–æ–º–ø–∞–∫—Ç–Ω–µ 3x3
          },
          // 6. –î–≤—ñ –ø–µ—Ä–µ—à–∫–æ–¥–∏, 5x5
          {
            size: 5,
            start: [2, 0],
            obstacles: [
              [2, 1],
              [2, 2],
            ],
            gems: [
              [1, 1],
              [3, 1],
              [2, 3],
            ],
            maxCommands: 9,
            optimizeGrid: true,
            hint: "–ó–Ω–∞–π–¥–∏ —à–ª—è—Ö –Ω–∞–≤–∫–æ–ª–æ –ø–µ—Ä–µ—à–∫–æ–¥!",
          },
          // 7. –ü—Ä–æ—Å—Ç–∏–π –ª–∞–±—ñ—Ä–∏–Ω—Ç
          // –ó–ú–Ü–ù–ï–ù–û: –ü–æ–ª–µ 4x4, –æ–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–∑–∏—Ü—ñ—ó —Ç–∞ —Å–ª–æ—Ç–∏
          {
            size: 4,
            start: [0, 0],
            obstacles: [
              [1, 1],
              [2, 2],
            ],
            gems: [
              [0, 2],
              [2, 0],
              [3, 0],
            ],
            maxCommands: 8, // –ó–º–µ–Ω—à–µ–Ω–æ –∑ 12
            optimizeGrid: false, // –ü–æ–ª–µ —Ç–µ–ø–µ—Ä –∫–æ–º–ø–∞–∫—Ç–Ω–µ 4x4
            hint: "–¢—Ä–µ–±–∞ –∑—ñ–±—Ä–∞—Ç–∏ –≤–µ—Å—å –≤–æ–≥–æ–Ω—å! üî•",
          },
          // 8. –°–∫–ª–∞–¥–Ω—ñ—à–∏–π 5x5
          {
            size: 5,
            start: [0, 2],
            obstacles: [
              [1, 0],
              [1, 1],
              [1, 3],
              [1, 4],
              [3, 2],
            ],
            gems: [
              [4, 0],
              [4, 4],
            ],
            maxCommands: 10,
            optimizeGrid: true,
            hint: "–°–∫–ª–∞–¥–Ω–∏–π –≤–∏–∫–ª–∏–∫! –¢–∏ –≤–ø–æ—Ä–∞—î—à—Å—è! üí™",
          },
          // 9. –õ–∞–±—ñ—Ä–∏–Ω—Ç
          // –ó–ú–Ü–ù–ï–ù–û: –ó–±—ñ–ª—å—à–µ–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ª–æ—Ç—ñ–≤
          {
            size: 5,
            start: [0, 0],
            obstacles: [
              [1, 0],
              [1, 1],
              [1, 2],
              [3, 2],
              [3, 3],
              [3, 4],
            ],
            gems: [
              [0, 4],
              [4, 0],
              [4, 4],
            ],
            maxCommands: 16, // –ó–±—ñ–ª—å—à–µ–Ω–æ –∑ 14
            optimizeGrid: true,
            hint: "–ú–∞–π–∂–µ —Ñ—ñ–Ω–∞–ª! –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑—ñ–±—Ä–∞—Ç–∏ –≤–µ—Å—å –≤–æ–≥–æ–Ω—å!",
          },
          // 10. –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å (–£–°–ö–õ–ê–î–ù–ï–ù–û)
          {
            size: 5,
            start: [2, 0],
            obstacles: [
              [1, 1],
              [1, 3],
              [2, 1],
              [2, 3],
              [3, 1],
              [3, 3],
            ],
            gems: [
              [0, 2],
              [2, 2],
              [4, 2],
              [0, 4], // –î–æ–¥–∞–Ω–æ
              [4, 4], // –î–æ–¥–∞–Ω–æ
            ],
            maxCommands: 22, // –ó–±—ñ–ª—å—à–µ–Ω–æ –∑ 15 –¥–æ 22
            optimizeGrid: true,
            hint: "–§—ñ–Ω–∞–ª—å–Ω–∏–π –≤–∏–∫–ª–∏–∫! –£—Å—ñ –æ—Å–µ—Ä–µ–¥–∫–∏ –≤–æ–≥–Ω—é –º–∞—é—Ç—å –±—É—Ç–∏ –ø–æ–≥–∞—à–µ–Ω—ñ!",
          },
        ];

        const TOTAL_LEVELS_COUNT = LEVELS.length;

        // –í–∞—Ä—ñ–∞–Ω—Ç–∏ –ø—ñ–¥–±–∞–¥—å–æ—Ä–ª–∏–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        const ENCOURAGEMENTS = [
          "–¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π! üöí",
          "–í–æ–≥–æ–Ω—å –ø–æ–≥–∞—à–µ–Ω–æ! üî•",
          "–ß—É–¥–æ–≤–∞ —Ä–æ–±–æ—Ç–∞, –ø–æ–∂–µ–∂–Ω–∏–∫—É! üë®‚Äçüöí",
          "–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üíß",
          "–ì–∞—Å–∏—à —è–∫ –ø—Ä–æ—Ñ—ñ! üíØ",
          "–í–æ–≥–Ω—è–Ω–∏–π –º–∞–π—Å—Ç–µ—Ä! üèÜ",
        ];
        // –í–∞—Ä—ñ–∞–Ω—Ç–∏ "–ø–æ–∑–∏—Ç–∏–≤–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫"
        const POSITIVE_ERRORS = [
          "–ú–∞–π–∂–µ –≤–∏–π—à–ª–æ! –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑! üí™",
          "–¢–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —à–ª—è—Ö—É! –ü—Ä–æ–¥–æ–≤–∂—É–π! üåü",
          "–ß—É–¥–æ–≤–∞ —Å–ø—Ä–æ–±–∞! –ú–æ–∂–µ, —ñ–Ω—à–∏–π –º–∞—Ä—à—Ä—É—Ç? ü§î",
          "–¢–∞–∫ –±–ª–∏–∑—å–∫–æ! –¢–∏ –≤–ø–æ—Ä–∞—î—à—Å—è! ‚≠ê",
        ];

        // –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è
        const ACHIEVEMENTS = {
          firstGems: {
            icon: "üî•",
            title: "–ü–µ—Ä—à—ñ –ø–æ–ª—É–º'—è!",
            text: "–¢–∏ –∑–∞–≥–∞—Å–∏–≤ —Å–≤—ñ–π –ø–µ—Ä—à–∏–π –≤–æ–≥–æ–Ω—å!",
          },
          halfwayDone: {
            icon: "üë®‚Äçüöí",
            title: "–ù–∞ –ø—ñ–≤–¥–æ—Ä–æ–∑—ñ!",
            text: "–ü–æ–ª–æ–≤–∏–Ω–∞ –≤–∏–∫–ª–∏–∫—ñ–≤ –ø–æ–∑–∞–¥—É!",
          },
          master: {
            icon: "üåü",
            title: "–ú–∞–π—Å—Ç–µ—Ä –ø–æ–∂–µ–∂–æ–≥–∞—Å—ñ–Ω–Ω—è!",
            text: "–¢–∏ –ø—Ä–æ–π—à–æ–≤ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ, –≥–µ—Ä–æ–π!",
          },
        };

        // ===== 2. –°–¢–ê–ù –ì–†–ò =====
        // –Ñ–¥–∏–Ω–∏–π –æ–±'—î–∫—Ç, —â–æ –≤—ñ–¥—Å—Ç–µ–∂—É—î –≤—Å–µ, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —É –≥—Ä—ñ
        // ============================

        const gameState = {
          currentLevel: 0,
          commands: [], // –ú–∞—Å–∏–≤ –¥–ª—è –∫–æ–º–∞–Ω–¥ (–Ω–∞–ø—Ä., ['right', 'right', null])
          totalGems: 0, // –ó–∞–≥–∞–ª—å–Ω–∞ –∫-—Å—Ç—å "–≤–æ–≥–Ω—é"
          isExecuting: false, // –ß–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∞–Ω—ñ–º–∞—Ü—ñ—è
          currentPos: null, // [row, col] –ø–æ–∑–∏—Ü—ñ—è –ø–æ–∂–µ–∂–Ω–∏–∫–∞
          soundEnabled: true,
          shownAchievements: new Set(), // –Ø–∫—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –≤–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ñ
          optimizedGridMap: null, // –î–ª—è –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏—Ö —Å—ñ—Ç–æ–∫
        };

        let sessionStartTime = Date.now();
        const MAX_SESSION_TIME = 15 * 60 * 1000; // 15 —Ö–≤–∏–ª–∏–Ω

        // ===== 3. –ê–£–î–Ü–û –¢–ê –í–Ü–ë–†–ê–¶–Ü–Ø =====
        // –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∑–≤—É–∫–æ–≤–∏–º–∏ –µ—Ñ–µ–∫—Ç–∞–º–∏ —Ç–∞ –≤—ñ–±—Ä–∞—Ü—ñ—î—é
        // ==================================

        let audioCtx = null;
        try {
          // –°—Ç–≤–æ—Ä—é—î–º–æ AudioContext –¥–ª—è –∑–≤—É–∫—ñ–≤
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.warn("AudioContext is not supported, sounds will be disabled.");
        }
        // –ë—Ä–∞—É–∑–µ—Ä–∏ –±–ª–æ–∫—É—é—Ç—å –∞—É–¥—ñ–æ –¥–æ –ø–µ—Ä—à–æ–≥–æ –¥–æ—Ç–∏–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –¶—è —Ñ—É–Ω–∫—Ü—ñ—è "–ø—Ä–æ–±—É–¥–∂—É—î" –∞—É–¥—ñ–æ.
        const ensureAudio = async () => {
          try {
            if (audioCtx && audioCtx.state === "suspended") {
              await audioCtx.resume();
            }
          } catch (e) {
            /* —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ –Ω–µ –≤–∏–π—à–ª–æ */
          }
        };

        const utils = {
          // –ü—Ä–æ—Å—Ç–∞ —É—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–∞—É–∑–∏
          sleep: (ms) => new Promise((r) => setTimeout(r, ms)),
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –¥–≤–∞ –º–∞—Å–∏–≤–∏ (–ø–æ–∑–∏—Ü—ñ—ó) –æ–¥–Ω–∞–∫–æ–≤—ñ
          arraysEqual: (a, b) => a && b && a[0] === b[0] && a[1] === b[1],
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –º–æ–∂–Ω–∞ —Å—Ç–∞—Ç–∏ –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫—É (–Ω–µ –∑–∞ –º–µ–∂–∞–º–∏ —ñ –Ω–µ –ø–µ—Ä–µ—à–∫–æ–¥–∞)
          isValidPosition: (pos, level) => {
            const gridMap = gameState.optimizedGridMap || {
              rows: level.size,
              cols: level.size,
              rowMap: Array.from({ length: level.size }, (_, i) => i),
              colMap: Array.from({ length: level.size }, (_, i) => i),
            };

            const mappedRowIndex = gridMap.rowMap.indexOf(pos[0]);
            const mappedColIndex = gridMap.colMap.indexOf(pos[1]);

            return (
              mappedRowIndex !== -1 &&
              mappedColIndex !== -1 &&
              !level.obstacles.some((o) => utils.arraysEqual(o, pos))
            );
          },
          // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É –µ–º–æ–¥–∑—ñ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —à–∏—Ä–∏–Ω–∏ –µ–∫—Ä–∞–Ω—É
          emojiClass: () => {
            const w = window.innerWidth;
            if (w < 480) return "emoji-xs";
            if (w < 640) return "emoji-sm";
            if (w < 1024) return "emoji-md";
            return "emoji-lg";
          },
          // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ä–æ–∑–º—ñ—Ä—É –∫–ª—ñ—Ç–∏–Ω–∫–∏, —â–æ–± –≤–æ–Ω–∞ –≤–ø–∏—Å–∞–ª–∞—Å—è –≤ –µ–∫—Ä–∞–Ω
          getCellSize: (level) => {
            const wrap = elements.gameGrid.parentElement;
            if (!wrap) return 60; // F–∞llback
            const rect = wrap.getBoundingClientRect();
            const gap = window.innerWidth < 640 ? 2 : 4;
            const gridMap = gameState.optimizedGridMap || {
              rows: level.size,
              cols: level.size,
              rowMap: Array.from({ length: level.size }, (_, i) => i),
              colMap: Array.from({ length: level.size }, (_, i) => i),
            };
            const columns = gridMap.cols;
            const rows = gridMap.rows;

            const availableWidth = rect.width - (columns - 1) * gap - 10; // -10 for padding
            const availableHeight = rect.height - (rows - 1) * gap - 10;

            const sizeBasedOnWidth = availableWidth / columns;
            const sizeBasedOnHeight = availableHeight / rows;

            const size = Math.floor(Math.min(sizeBasedOnWidth, sizeBasedOnHeight));

            return Math.max(36, Math.min(size, 110)); // –û–±–º–µ–∂—É—î–º–æ –º—ñ–Ω. —Ç–∞ –º–∞–∫—Å. —Ä–æ–∑–º—ñ—Ä
          },
          // –í–∏–ø–∞–¥–∫–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –∑ –º–∞—Å–∏–≤—É
          randomChoice: (arr) => arr[Math.floor(Math.random() * arr.length)],
          // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø—Ä–æ–≥—Ä–∞–≤–∞–Ω–Ω—è –∑–≤—É–∫—É
          playSound: (freq, duration = 100) => {
            if (!gameState.soundEnabled || !audioCtx) return;
            try {
              const osc = audioCtx.createOscillator();
              const gain = audioCtx.createGain();
              osc.connect(gain);
              gain.connect(audioCtx.destination);
              osc.frequency.value = freq;
              osc.type = "sine";
              gain.gain.value = 0.1; // –ù–µ–≤–µ–ª–∏–∫–∞ –≥—É—á–Ω—ñ—Å—Ç—å
              osc.start();
              gain.gain.exponentialRampToValueAtTime(
                0.01,
                audioCtx.currentTime + duration / 1000
              );
              osc.stop(audioCtx.currentTime + duration / 1000);
            } catch (e) {
              console.error("Error playing sound:", e);
            }
          },
        };

        // –ù–∞–±—ñ—Ä –∑–≤—É–∫–æ–≤–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
        const sounds = {
          move: () => utils.playSound(350, 70),
          collect: () => {
            utils.playSound(200, 80);
            setTimeout(() => utils.playSound(300, 100), 80);
          },
          win: () => {
            utils.playSound(440, 120);
            setTimeout(() => utils.playSound(523, 120), 120);
            setTimeout(() => utils.playSound(440, 150), 240);
            setTimeout(() => utils.playSound(523, 200), 390);
          },
          error: () => utils.playSound(150, 250),
          click: () => utils.playSound(650, 40),
          cheer: () => {
            utils.playSound(523, 100);
            setTimeout(() => utils.playSound(659, 150), 100);
          },
        };

        // –í—ñ–±—Ä–∞—Ü—ñ—è (–¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö)
        function vibrateDevice(pattern = [50]) {
          if ("vibrate" in navigator) {
            navigator.vibrate(pattern);
          }
        }

        // –û–∑–≤—É—á–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É (–¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫ —Ç–∞ –ø–µ—Ä–µ–º–æ–≥)
        function speak(text) {
          if ("speechSynthesis" in window && gameState.soundEnabled) {
            window.speechSynthesis.cancel(); // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "uk-UA";
            utterance.rate = 0.9;
            utterance.pitch = 1.2;
            window.speechSynthesis.speak(utterance);
          }
        }

        // ===== 4. –ö–ï–®–£–í–ê–ù–ù–Ø DOM =====
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ HTML –µ–ª–µ–º–µ–Ω—Ç–∏, —â–æ–± –Ω–µ —à—É–∫–∞—Ç–∏ —ó—Ö —â–æ—Ä–∞–∑—É
        // ==============================

        const el = (id) => document.getElementById(id); // –•–µ–ª–ø–µ—Ä –¥–ª—è 'getElementById'
        const elements = {
          gameGrid: el("gameGrid"),
          commandSlots: el("commandSlots"),
          runBtn: el("runBtn"),
          clearBtn: el("clearBtn"),
          winModal: el("winModal"),
          errorModal: el("errorModal"),
          hintModal: el("hintModal"),
          hintModalText: el("hintModalText"),
          closeHintBtn: el("closeHintBtn"),
          nextLevelBtn: el("nextLevelBtn"),
          retryBtn: el("retryBtn"),
          closeErrBtn: el("closeErrBtn"),
          levelNum: el("levelNum"),
          totalLevels: el("totalLevels"),
          gemsCount: el("gemsCount"),
          winMessage: el("winMessage"),
          errorMessage: el("errorMessage"),
          upBtn: el("upBtn"),
          downBtn: el("downBtn"),
          leftBtn: el("leftBtn"),
          rightBtn: el("rightBtn"),
          progressBar: el("progressBar"),
          encouragement: el("encouragement"),
          soundBtn: el("soundBtn"),
          fullscreenBtn: el("fullscreenBtn"),
          achievementToast: el("achievementToast"),
          achievementIcon: el("achievementIcon"),
          achievementTitle: el("achievementTitle"),
          achievementText: el("achievementText"),
          winConfetti: el("winConfetti"),
          tutorialOverlay: el("tutorialOverlay"),
          startTutorial: el("startTutorial"),
          parentBtn: el("parentBtn"),
          parentModal: el("parentModal"),
          closeParentModal: el("closeParentModal"),
          parentLevels: el("parentLevels"),
          parentGems: el("parentGems"),
          parentTime: el("parentTime"),
          executionPanel: el("executionPanel"),
          mainControls: el("mainControls"),
          // –ù–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
          gameCompleteModal: el("gameCompleteModal"),
          restartGameBtn: el("restartGameBtn"),
          goHomeBtn: el("goHomeBtn"),
          finalGemsCount: el("finalGemsCount"),
          completeConfetti: el("completeConfetti"),
        };

        // ===== 5. –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –ü–†–û–ì–†–ï–°–£ =====
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ localStorage –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è —Ç–∞ –æ—á–æ–∫
        // ====================================

        function saveProgress() {
          try {
            localStorage.setItem(
              "firefighterProgress",
              JSON.stringify({
                level: gameState.currentLevel,
                gems: gameState.totalGems,
                achievements: Array.from(gameState.shownAchievements),
                timestamp: Date.now(),
              })
            );
          } catch (e) {
            console.warn("Could not save progress.", e);
          }
        }

        function loadProgress() {
          try {
            const saved = localStorage.getItem("firefighterProgress");
            if (saved) {
              const data = JSON.parse(saved);
              // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å, —è–∫—â–æ –≤—ñ–Ω –Ω–µ —Å—Ç–∞—Ä—ñ—à–∏–π –∑–∞ 7 –¥–Ω—ñ–≤
              if (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000) {
                gameState.currentLevel = data.level || 0;
                gameState.totalGems = data.gems || 0;
                gameState.shownAchievements = new Set(data.achievements || []);
                elements.gemsCount.textContent = gameState.totalGems;
              }
            }
          } catch (e) {
            console.warn("Could not load progress.", e);
          }
        }

        // ===== 6. –î–û–°–Ø–ì–ù–ï–ù–ù–Ø –¢–ê –ï–§–ï–ö–¢–ò =====
        // –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–æ—Å—Ç–∞–º–∏, –∫–æ–Ω—Ñ–µ—Ç—Ç—ñ —Ç–∞ —ñ–Ω—à–∏–º–∏ "—Å–æ–∫–æ–≤–∏—Ç–∏–º–∏" –µ—Ñ–µ–∫—Ç–∞–º–∏
        // ========================================

        function checkAchievements() {
          const gems = gameState.totalGems;
          const level = gameState.currentLevel;

          if (gems >= 1 && !gameState.shownAchievements.has("firstGems")) {
            showAchievement(ACHIEVEMENTS.firstGems);
            gameState.shownAchievements.add("firstGems");
          }

          if (
            level === Math.floor(TOTAL_LEVELS_COUNT / 2) &&
            !gameState.shownAchievements.has("halfwayDone")
          ) {
            showAchievement(ACHIEVEMENTS.halfwayDone);
            gameState.shownAchievements.add("halfwayDone");
          }

          if (
            level === TOTAL_LEVELS_COUNT - 1 &&
            !gameState.shownAchievements.has("master")
          ) {
            showAchievement(ACHIEVEMENTS.master);
            gameState.shownAchievements.add("master");
          }
        }

        function showAchievement(ach) {
          elements.achievementIcon.textContent = ach.icon;
          elements.achievementTitle.textContent = ach.title;
          elements.achievementText.textContent = ach.text;
          elements.achievementToast.classList.remove("hidden");

          // –°—Ö–æ–≤–∞—Ç–∏ —Ç–æ—Å—Ç —á–µ—Ä–µ–∑ 3.5 —Å–µ–∫—É–Ω–¥–∏
          setTimeout(() => {
            elements.achievementToast.style.transition =
              "opacity 0.5s, transform 0.5s";
            elements.achievementToast.style.opacity = "0";
            elements.achievementToast.style.transform = "translate(-50%, -20px)";
            setTimeout(() => {
              elements.achievementToast.classList.add("hidden");
              elements.achievementToast.style.opacity = "1";
              elements.achievementToast.style.transform = "translate(-50%, 0)";
            }, 500);
          }, 3500);
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–Ω—Ñ–µ—Ç—Ç—ñ —É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ –ø–µ—Ä–µ–º–æ–≥–∏
        function createConfetti(container) {
          if (!container) return;
          container.innerHTML = "";
          const colors = [
            "#f59e0b",
            "#ef4444",
            "#f87171",
            "#fbbf24",
            "#f97316",
            "#dc2626",
          ];

          for (let i = 0; i < 40; i++) {
            const bit = document.createElement("div");
            bit.className = "confetti-bit";
            bit.style.left = Math.random() * 100 + "%";
            bit.style.backgroundColor =
              colors[Math.floor(Math.random() * colors.length)];
            bit.style.animationDelay = Math.random() * 0.4 + "s";
            container.appendChild(bit);
          }
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ—Å–∫–æ—Ä –ø—Ä–∏ –∑–±–æ—Ä—ñ –≤–æ–≥–Ω—é
        function createSparkles(cell) {
          cell.querySelectorAll(".sparkle-container").forEach((s) => s.remove());
          const container = document.createElement("div");
          container.className = "sparkle-container";
          cell.appendChild(container);

          for (let i = 0; i < 8; i++) {
            const sparkle = document.createElement("div");
            sparkle.className = "sparkle-bit";
            const angle = (i / 8) * Math.PI * 2;
            const distance = 30;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;
            sparkle.style.setProperty(
              "--tw-translate",
              `translate(${tx}px, ${ty}px)`
            );
            sparkle.style.left = "50%";
            sparkle.style.top = "50%";
            sparkle.style.animationDelay = i * 0.05 + "s";
            container.appendChild(sparkle);
          }
          setTimeout(() => container.remove(), 1000);
        }

        // –ü–æ–∫–∞–∑ –ø–ª–∞–≤–∞—é—á–æ–≥–æ –µ–º–æ–¥–∑—ñ (–Ω–∞–ø—Ä. "üéâ")
        function showFloatingEmoji(emoji, pos) {
          const cell = getCellElement(pos);
          if (!cell) return;

          const floater = document.createElement("div");
          floater.textContent = emoji;
          floater.className = "floating-emoji text-4xl";
          cell.appendChild(floater);

          setTimeout(() => floater.remove(), 1500);
        }

        // –ú–∞–ª–µ–Ω—å–∫–µ —Å–≤—è—Ç–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∑–±–æ—Ä—ñ 1 –≤–æ–≥–Ω—é
        function celebrateSmallWin(cell) {
          sounds.cheer();
          createSparkles(cell);
          showFloatingEmoji("üéâ", gameState.currentPos);
        }

        // ===== 7. –ö–ï–†–£–í–ê–ù–ù–Ø –†–Ü–í–ù–ï–ú =====
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä—ñ–≤–Ω—ñ–≤
        // ===================================

        function updateProgress() {
          const progress =
            ((gameState.currentLevel + 1) / TOTAL_LEVELS_COUNT) * 100;
          elements.progressBar.style.width = progress + "%";
        }

        // –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Å—ñ—Ç–∫–∏: –≤–∏–¥–∞–ª—è—î –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏/–∫–æ–ª–æ–Ω–∫–∏
        function optimizeGrid(level) {
          if (!level.optimizeGrid) {
            gameState.optimizedGridMap = null;
            return;
          }
          const activeRows = new Set();
          const activeCols = new Set();
          const allPositions = [
            level.start,
            ...level.obstacles,
            ...level.gems,
          ];
          allPositions.forEach(([r, c]) => {
            activeRows.add(r);
            activeCols.add(c);
          });
          const minR = Math.min(...activeRows);
          const maxR = Math.max(...activeRows);
          const minC = Math.min(...activeCols);
          const maxC = Math.max(...activeCols);
          for (let r = minR; r <= maxR; r++) {
            for (let c = minC; c <= maxC; c++) {
              if (!level.obstacles.some((o) => utils.arraysEqual(o, [r, c]))) {
                activeRows.add(r);
                activeCols.add(c);
              }
            }
          }
          level.obstacles.forEach(([r, c]) => {
            if (r >= minR && r <= maxR && c >= minC && c <= maxC) {
              activeRows.add(r);
              activeCols.add(c);
            }
          });
          const sortedRows = Array.from(activeRows).sort((a, b) => a - b);
          const sortedCols = Array.from(activeCols).sort((a, b) => a - b);
          gameState.optimizedGridMap = {
            rows: sortedRows.length,
            cols: sortedCols.length,
            rowMap: sortedRows,
            colMap: sortedCols,
          };
        }

        // –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ä—ñ–≤–Ω—è
        function initLevel() {
          const level = LEVELS[gameState.currentLevel];
          if (!level) {
            console.error("Invalid level index:", gameState.currentLevel);
            gameState.currentLevel = 0;
            initLevel();
            return;
          }
          // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Å–º—ñ—Ç—Ç—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ä—ñ–≤–Ω—è
          document
            .querySelectorAll(".sparkle-container, .trail-dot, .floating-emoji")
            .forEach((n) => n.remove());
          elements.gameGrid.classList.remove("grid-shaking");

          optimizeGrid(level); // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—É —Å—ñ—Ç–∫—É

          elements.totalLevels.textContent = TOTAL_LEVELS_COUNT;
          elements.levelNum.textContent = gameState.currentLevel + 1;
          gameState.commands = Array(level.maxCommands).fill(null);
          gameState.currentPos = [...level.start];

          renderGrid(level); // –ú–∞–ª—é—î–º–æ —Å—ñ—Ç–∫—É
          renderCommandSlots(); // –ú–∞–ª—é—î–º–æ —Å–ª–æ—Ç–∏
          updateProgress(); // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä

          elements.runBtn.disabled = false;
          gameState.isExecuting = false;

          showNextStepHint(); // –ü–æ–∫–∞–∑ –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –ø–µ—Ä—à–∏—Ö —Ä—ñ–≤–Ω—ñ–≤

          // –ü–æ–∫–∞–∑ —ñ–Ω—Ç—Ä–æ –ø—Ä–æ –ø–µ—Ä–µ—à–∫–æ–¥–∏
          if (
            level.obstacles.length > 0 &&
            !localStorage.getItem("shownObstacleIntro")
          ) {
            showObstacleIntro();
            localStorage.setItem("shownObstacleIntro", "true");
          }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–º–∞–ª—é–≤–∞–Ω–Ω—è) —ñ–≥—Ä–æ–≤–æ—ó —Å—ñ—Ç–∫–∏
        function renderGrid(level) {
          const g = elements.gameGrid;
          g.classList.remove("grid-shaking");
          g.innerHTML = "";

          const gridMap = gameState.optimizedGridMap || {
            rows: level.size,
            cols: level.size,
            rowMap: Array.from({ length: level.size }, (_, i) => i),
            colMap: Array.from({ length: level.size }, (_, i) => i),
          };

          const cellSize = utils.getCellSize(level);
          const gap = window.innerWidth < 640 ? "2px" : "4px";
          g.style.display = "grid";
          g.style.gridTemplateColumns = `repeat(${gridMap.cols}, ${cellSize}px)`;
          g.style.gridTemplateRows = `repeat(${gridMap.rows}, ${cellSize}px)`;
          g.style.gap = gap;

          const emojiCls = utils.emojiClass();
          for (let r = 0; r < gridMap.rows; r++) {
            for (let c = 0; c < gridMap.cols; c++) {
              const originalRow = gridMap.rowMap[r];
              const originalCol = gridMap.colMap[c];
              const originalPos = [originalRow, originalCol];

              const cell = document.createElement("div");
              cell.className =
                "grid-cell flex items-center justify-center bg-orange-50 rounded-lg";
              cell.dataset.row = originalRow;
              cell.dataset.col = originalCol;
              cell.setAttribute("role", "gridcell");

              if (utils.arraysEqual(originalPos, level.start)) {
                cell.innerHTML = `<div class="character ${emojiCls}" aria-label="–ü–æ–∂–µ–∂–Ω–∏–∫">üë®‚Äçüöí</div>`;
                cell.classList.add("bg-red-200");
              } else if (
                level.obstacles.some((o) => utils.arraysEqual(o, originalPos))
              ) {
                cell.innerHTML = `<i class="fas fa-water text-blue-600 ${emojiCls}" aria-hidden="true"></i>`;
                cell.classList.add("bg-blue-300");
              } else if (
                level.gems.some((g) => utils.arraysEqual(g, originalPos))
              ) {
                cell.innerHTML = `<div class="${emojiCls} fire-glow" data-gem="fire" aria-label="–í–æ–≥–æ–Ω—å">üî•</div>`;
                cell.classList.add(
                  "bg-gradient-to-br",
                  "from-red-100",
                  "to-yellow-100"
                );
              }
              g.appendChild(cell);
            }
          }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–º–∞–ª—é–≤–∞–Ω–Ω—è) —Å–ª–æ—Ç—ñ–≤ –¥–ª—è –∫–æ–º–∞–Ω–¥
        function renderCommandSlots() {
          const level = LEVELS[gameState.currentLevel];
          const wrap = elements.commandSlots;
          wrap.innerHTML = "";
          wrap.className =
            "flex flex-row flex-wrap gap-2 justify-start items-center";

          for (let i = 0; i < level.maxCommands; i++) {
            const slot = document.createElement("div");
            slot.className =
              "command-slot flex items-center justify-center rounded-lg text-2xl sm:text-3xl md:text-4xl";
            slot.dataset.index = i;

            if (gameState.commands[i]) {
              slot.classList.add("filled");
              slot.innerHTML = ARROW_ICONS[gameState.commands[i]];
              slot.setAttribute("title", "–ö–æ–º–∞–Ω–¥–∞ –¥–æ–¥–∞–Ω–∞");
              // –ü–û–ö–†–ê–©–ï–ù–ù–Ø UX:
              // –ú–∏ —Å–≤—ñ–¥–æ–º–æ –≤–∏–¥–∞–ª–∏–ª–∏ addEventListener –¥–ª—è –∫–ª—ñ–∫—É –ø–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ–º—É —Å–ª–æ—Ç—É.
              // –î–ª—è –¥—ñ—Ç–µ–π 4-5 —Ä–æ–∫—ñ–≤ –ø—Ä–æ—Å—Ç—ñ—à–µ –º–∞—Ç–∏ –æ–¥–Ω—É –¥—ñ—é (–¥–æ–¥–∞—Ç–∏)
              // —Ç–∞ –æ–∫—Ä–µ–º—ñ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è ("–û—á–∏—Å—Ç–∏—Ç–∏", "–í—ñ–¥–º—ñ–Ω–∏—Ç–∏").
              // –¶–µ —Å–ø—Ä–æ—â—É—î –º–æ–¥–µ–ª—å –≤–∑–∞—î–º–æ–¥—ñ—ó.
            }
            wrap.appendChild(slot);
          }
        }

        // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–µ—Ä—à–∏—Ö —Ä—ñ–≤–Ω—ñ–≤)
        function showNextStepHint() {
          document
            .querySelectorAll(".pulse-hint-animation")
            .forEach((el) => el.classList.remove("pulse-hint-animation"));

          const level = LEVELS[gameState.currentLevel];
          if (
            gameState.currentLevel < 2 &&
            gameState.commands.every((c) => c === null)
          ) {
            const solution = findSimplestPath(level);
            if (solution && solution.length > 0) {
              const nextMove = solution[0];
              const button = elements[`${nextMove}Btn`];
              if (button) {
                button.classList.add("pulse-hint-animation");
              }
            }
          }
        }

        // ===== 8. –õ–û–ì–Ü–ö–ê –ì–†–ò =====
        // –û—Å–Ω–æ–≤–Ω—ñ –¥—ñ—ó: –¥–æ–¥–∞—Ç–∏/–æ—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É, –≤–∏–∫–æ–Ω–∞—Ç–∏, –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏
        // ============================

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ —É –ø–µ—Ä—à–∏–π –≤—ñ–ª—å–Ω–∏–π —Å–ª–æ—Ç
        async function addCommand(direction) {
          if (gameState.isExecuting) return;
          await ensureAudio();
          vibrateDevice([30]);
          sounds.click();

          const firstEmpty = gameState.commands.indexOf(null);
          if (firstEmpty !== -1) {
            gameState.commands[firstEmpty] = direction;
            renderCommandSlots();
          }
          // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∫–ª—ñ–∫—É
          document
            .querySelectorAll(".pulse-hint-animation")
            .forEach((el) => el.classList.remove("pulse-hint-animation"));
        }

        // –û—á–∏—â–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫–æ–º–∞–Ω–¥
        async function clearCommands() {
          if (gameState.isExecuting) return;
          await ensureAudio();
          vibrateDevice([50]);
          sounds.click();
          const level = LEVELS[gameState.currentLevel];
          gameState.commands = Array(level.maxCommands).fill(null);
          renderCommandSlots();
          showNextStepHint(); // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É –∑–Ω–æ–≤—É, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        }

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è DOM-–µ–ª–µ–º–µ–Ω—Ç–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –∑–∞ —ó—ó –ø–æ–∑–∏—Ü—ñ—î—é [r, c]
        function getCellElement(pos) {
          return elements.gameGrid.querySelector(
            `[data-row="${pos[0]}"][data-col="${pos[1]}"]`
          );
        }

        // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ—à–∫–æ–¥, –∫–æ–ª–∏ –ø–æ–∂–µ–∂–Ω–∏–∫ –ø–æ—Ä—É—á
        function highlightNearObstacles(pos, level) {
          elements.gameGrid
            .querySelectorAll(".near-obstacle")
            .forEach((cell) => cell.classList.remove("near-obstacle"));
          const [r, c] = pos;
          const neighbors = [
            [r - 1, c],
            [r + 1, c],
            [r, c - 1],
            [r, c + 1],
          ];
          for (const neighborPos of neighbors) {
            if (
              level.obstacles.some((o) => utils.arraysEqual(o, neighborPos))
            ) {
              const cell = getCellElement(neighborPos);
              if (cell) {
                cell.classList.add("near-obstacle");
              }
            }
          }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –ø–æ–∂–µ–∂–Ω–∏–∫–∞ –Ω–∞ —Å—ñ—Ç—Ü—ñ (–≤—ñ–∑—É–∞–ª—å–Ω–æ)
        function updateCharacterPosition(newPos, noJump = false) {
          const level = LEVELS[gameState.currentLevel];
          const oldCell = getCellElement(gameState.currentPos);
          const newCell = getCellElement(newPos);

          if (oldCell) {
            const char = oldCell.querySelector(".character");
            if (char) char.remove();
            oldCell.querySelectorAll(".trail-dot").forEach((t) => t.remove());
            if (utils.arraysEqual(gameState.currentPos, level.start)) {
              oldCell.classList.add("bg-red-200");
            } else {
              oldCell.classList.remove("bg-red-200", "landing");
            }
            if (!utils.arraysEqual(gameState.currentPos, newPos)) {
              const trail = document.createElement("div");
              trail.className = "trail-dot";
              oldCell.appendChild(trail);
              setTimeout(() => trail.remove(), 700);
            }
          }

          if (newCell) {
            const emojiCls = utils.emojiClass();
            const char = document.createElement("div");
            char.className = `character ${emojiCls}`;
            char.setAttribute("aria-label", "–ü–æ–∂–µ–∂–Ω–∏–∫");
            char.textContent = "üë®‚Äçüöí";
            newCell.appendChild(char);
            if (!noJump) {
              newCell.classList.add("landing");
              setTimeout(() => newCell.classList.remove("landing"), 400);
            }
            highlightNearObstacles(newPos, level);
          }
          gameState.currentPos = newPos;
        }

        // –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –∫–æ–º–∞–Ω–¥
        async function executeCommands() {
          if (gameState.isExecuting) return;
          await ensureAudio();
          vibrateDevice([100]);

          const hasCommands = gameState.commands.some((c) => c !== null);
          if (!hasCommands) {
            showError("–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –≥–∞—Å—ñ–Ω–Ω—è –≤–æ–≥–Ω—é! üî•", false);
            return;
          }

          gameState.isExecuting = true;
          elements.runBtn.disabled = true;

          const level = LEVELS[gameState.currentLevel];
          let pos = [...level.start];
          let collectedGems = 0;
          const remainingGems = [...level.gems];

          updateCharacterPosition(level.start, true);
          await utils.sleep(100);

          for (let i = 0; i < gameState.commands.length; i++) {
            const cmd = gameState.commands[i];
            if (!cmd) break; // –ó—É–ø–∏–Ω—è—î–º–æ—Å—å –Ω–∞ –ø–µ—Ä—à–æ–º—É –ø–æ—Ä–æ–∂–Ω—å–æ–º—É —Å–ª–æ—Ç—ñ

            const [dr, dc] = DIRECTION_VECTORS[cmd];
            const newPos = [pos[0] + dr, pos[1] + dc];

            await utils.sleep(ANIMATION_SPEED);

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è
            if (!utils.isValidPosition(newPos, level)) {
              sounds.error();
              elements.gameGrid.classList.add("grid-shaking");
              setTimeout(
                () => elements.gameGrid.classList.remove("grid-shaking"),
                400
              );
              const gridMap = gameState.optimizedGridMap || {
                rowMap: [],
                colMap: [],
              };
              const mappedRowIndex = gridMap.rowMap.indexOf(newPos[0]);
              const mappedColIndex = gridMap.colMap.indexOf(newPos[1]);
              const errorMsg =
                mappedRowIndex === -1 || mappedColIndex === -1
                  ? "–ü–æ–∂–µ–∂–Ω–∏–∫ –≤–∏–π—à–æ–≤ –∑–∞ –º–µ–∂—ñ –∑–æ–Ω–∏ –≥–∞—Å—ñ–Ω–Ω—è! üöí"
                  : "–û–π, –ø–æ–∂–µ–∂–Ω–∏–∫ –Ω–µ –º–æ–∂–µ –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≤–æ–¥—É! üåä";
              showError(errorMsg, true);
              gameState.isExecuting = false;
              elements.runBtn.disabled = false;
              return;
            }

            // –†—É—Ö
            sounds.move();
            updateCharacterPosition(newPos);
            pos = newPos;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–±—ñ—Ä –≤–æ–≥–Ω—é
            const gemIdx = remainingGems.findIndex((g) =>
              utils.arraysEqual(g, pos)
            );
            if (gemIdx !== -1) {
              const cell = getCellElement(pos);
              celebrateSmallWin(cell);

              collectedGems++;
              const fire = cell?.querySelector('[data-gem="fire"]');
              if (fire) {
                fire.classList.add("extinguishing");
                setTimeout(() => fire.remove(), 700);
              }
              remainingGems.splice(gemIdx, 1);
            }
          }

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ–º–æ–≥—É
          if (remainingGems.length === 0) {
            sounds.win();
            gameState.totalGems += collectedGems;
            elements.gemsCount.textContent = gameState.totalGems;
            checkAchievements(); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—è–≥–Ω–µ–Ω—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ —Å—é–¥–∏
            saveProgress();
            await utils.sleep(400);
            showWin(collectedGems);
          } else {
            // –ù–µ –≤–µ—Å—å –≤–æ–≥–æ–Ω—å –∑—ñ–±—Ä–∞–Ω–æ
            sounds.error();
            const leftGems = remainingGems.length;
            const fireWord =
              leftGems === 1
                ? "–æ—Å–µ—Ä–µ–¥–æ–∫"
                : leftGems < 5
                ? "–æ—Å–µ—Ä–µ–¥–∫–∏"
                : "–æ—Å–µ—Ä–µ–¥–∫—ñ–≤";
            showError(`–ó–∞–ª–∏—à–∏–ª–æ—Å—å —â–µ ${leftGems} ${fireWord} –≤–æ–≥–Ω—é! üî•`, true);
          }

          gameState.isExecuting = false;
          elements.runBtn.disabled = false;
        }

        // ===== 9. –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê =====
        // –ü–æ–∫–∞–∑ –≤—ñ–∫–æ–Ω –ø–µ—Ä–µ–º–æ–≥–∏, –ø–æ–º–∏–ª–∫–∏, –ø—ñ–¥–∫–∞–∑–æ–∫
        // =================================

        // –ü–æ–∫–∞–∑ –≤—ñ–∫–Ω–∞ –ø–µ—Ä–µ–º–æ–≥–∏
        function showWin(firesExtinguished) {
          if (gameState.currentLevel === TOTAL_LEVELS_COUNT - 1) {
            // –û—Å—Ç–∞–Ω–Ω—è –ø–µ—Ä–µ–º–æ–≥–∞ - –ø–æ–∫–∞–∑—É—î–º–æ –Ω–æ–≤–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
            showGameComplete();
            return; // –í–∏—Ö–æ–¥–∏–º–æ, —â–æ–± –Ω–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∑–≤–∏—á–∞–π–Ω–µ –≤—ñ–∫–Ω–æ
          }

          createConfetti(elements.winConfetti); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
          elements.encouragement.textContent =
            utils.randomChoice(ENCOURAGEMENTS);

          const fireWord =
            firesExtinguished === 1
              ? "–æ—Å–µ—Ä–µ–¥–æ–∫"
              : firesExtinguished < 5
              ? "–æ—Å–µ—Ä–µ–¥–∫–∏"
              : "–æ—Å–µ—Ä–µ–¥–∫—ñ–≤";
          elements.winMessage.textContent = `–¢–∏ –∑–∞–≥–∞—Å–∏–≤ ${firesExtinguished} ${fireWord}! üí™ –ë–µ–∑–ø–µ–∫–∞ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞!`;

          elements.nextLevelBtn.innerHTML =
            '–ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–∫–ª–∏–∫ <i class="fas fa-fire-extinguisher" aria-hidden="true"></i>';
          speak("–ú–æ–ª–æ–¥–µ—Ü—å! –¢–∏ –∑–∞–≥–∞—Å–∏–≤ –≤–µ—Å—å –≤–æ–≥–æ–Ω—å!");

          elements.winModal.classList.remove("hidden");
        }

        // –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        function showGameComplete() {
          createConfetti(elements.completeConfetti); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
          elements.finalGemsCount.textContent = gameState.totalGems;
          elements.gameCompleteModal.classList.remove("hidden");
          speak("–ù–µ–π–º–æ–≤—ñ—Ä–Ω–æ! –¢–∏ –ø—Ä–æ–π—à–æ–≤ —É—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π!");
        }

        // –ü–æ–∫–∞–∑ "–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ" –≤—ñ–∫–Ω–∞ –ø–æ–º–∏–ª–∫–∏
        function showError(msg, canRetry) {
          const encouragingMsg = utils.randomChoice(POSITIVE_ERRORS);
          elements.errorMessage.innerHTML = `
            <div class="text-5xl mb-4">üòä</div>
            <p class="text-2xl font-bold text-orange-600 mb-2">${encouragingMsg}</p>
            <p class="text-lg text-gray-600">${msg}</p>
          `;
          speak("–°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑! –¢–∏ –≤–ø–æ—Ä–∞—î—à—Å—è!");
          elements.retryBtn.style.display = canRetry ? "inline-block" : "none";
          elements.errorModal.classList.remove("hidden");
        }

        // –ü–æ–∫–∞–∑ —ñ–Ω—Ç—Ä–æ-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤–æ–¥—É
        function showObstacleIntro() {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4";
          modal.innerHTML = `
            <div class="bg-white rounded-3xl p-8 text-center max-w-md">
              <div class="text-8xl mb-4">üåä</div>
              <h2 class="text-3xl font-bold text-blue-600 mb-4">–û–±–µ—Ä–µ–∂–Ω–æ!</h2>
              <p class="text-2xl mb-4">–¶–µ –≤–æ–¥–∞! –ü–æ–∂–µ–∂–Ω–∏–∫ –Ω–µ –º–æ–∂–µ –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≤–æ–¥—É.</p>
              <p class="text-xl mb-6">–ó–Ω–∞–π–¥–∏ —ñ–Ω—à–∏–π —à–ª—è—Ö! üîÑ</p>
              
              <button class="bg-orange-500 text-white py-4 px-8 rounded-xl text-xl w-full pulse-glow">
                –ó—Ä–æ–∑—É–º—ñ–ª–æ! üí™
              </button>
            </div>
          `;

          modal.querySelector("button").addEventListener("click", () => {
            modal.remove();
          });

          document.body.appendChild(modal);
          speak("–û–±–µ—Ä–µ–∂–Ω–æ! –¶–µ –≤–æ–¥–∞. –ó–Ω–∞–π–¥–∏ —ñ–Ω—à–∏–π —à–ª—è—Ö!");
        }

        // ===== 10. –î–û–î–ê–¢–ö–û–í–Ü –§–£–ù–ö–¶–Ü–á =====
        // –ü–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω, —Ç–∞–π–º–µ—Ä —Å–µ—Å—ñ—ó, –ø–æ—à—É–∫ —à–ª—è—Ö—É
        // ===================================

        // –ö–µ—Ä—É–≤–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–æ—é –ø–æ–≤–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É
        function updateFullscreenIcon() {
          const icon = elements.fullscreenBtn.querySelector("i");
          if (document.fullscreenElement) {
            icon.className = "fas fa-compress text-xl text-orange-600";
            elements.fullscreenBtn.title = "–í–∏–π—Ç–∏ –∑ –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É";
          } else {
            icon.className = "fas fa-expand text-xl text-orange-600";
            elements.fullscreenBtn.title = "–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω";
          }
        }
        function toggleFullScreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch((err) => {
              console.warn(
                `Error attempting to enable full-screen mode: ${err.message} (${err.name})`
              );
            });
          } else {
            if (document.exitFullscreen) {
              document.exitFullscreen();
            }
          }
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∞—Å—É —Å–µ—Å—ñ—ó –¥–ª—è –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—é
        function checkSessionTime() {
          const elapsed = Date.now() - sessionStartTime;

          if (
            elapsed > MAX_SESSION_TIME &&
            document.querySelectorAll(".break-reminder").length === 0
          ) {
            showBreakReminder();
          }

          elements.parentTime.textContent = `${Math.floor(elapsed / 60000)} —Ö–≤`;
        }

        // –ü–æ–∫–∞–∑ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –ø–µ—Ä–µ—Ä–≤—É
        function showBreakReminder() {
          const modal = document.createElement("div");
          modal.className =
            "break-reminder fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4";
          modal.innerHTML = `
            <div class="bg-white rounded-3xl p-8 text-center max-w-md">
              <div class="text-8xl mb-4">‚è∞</div>
              <h2 class="text-3xl font-bold text-orange-600 mb-4">–ß–∞—Å –≤—ñ–¥–ø–æ—á–∏—Ç–∏!</h2>
              <p class="text-xl mb-6">–¢–∏ —á—É–¥–æ–≤–æ –ø–æ–ø—Ä–∞—Ü—é–≤–∞–≤! –î–∞–≤–∞–π –∑—Ä–æ–±–∏–º–æ –ø–µ—Ä–µ—Ä–≤—É? üåü</p>
              
              <button id="breakPlayMoreBtn" class="bg-green-500 text-white py-4 px-8 rounded-xl text-xl w-full mb-3">
                –©–µ —Ç—Ä–æ—à–∫–∏ –ø–æ–≥—Ä–∞—é üéÆ
              </button>
              <button id="breakEndGameBtn" class="bg-orange-500 text-white py-4 px-8 rounded-xl text-xl w-full">
                –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ –≥—Ä—É üëã
              </button>
            </div>
          `;

          modal
            .querySelector("#breakPlayMoreBtn")
            .addEventListener("click", () => {
              modal.remove();
              sessionStartTime = Date.now(); // –°–∫–∏–Ω—É—Ç–∏ —Ç–∞–π–º–µ—Ä
            });

          modal
            .querySelector("#breakEndGameBtn")
            .addEventListener("click", () => {
              location.reload(); // –ü—Ä–æ—Å—Ç–∏–π —Å–ø–æ—Å—ñ–± "–∑–∞–∫—ñ–Ω—á–∏—Ç–∏"
            });

          document.body.appendChild(modal);
          speak("–ß–∞—Å –≤—ñ–¥–ø–æ—á–∏—Ç–∏! –¢–∏ —á—É–¥–æ–≤–æ –ø–æ–ø—Ä–∞—Ü—é–≤–∞–≤!");
        }

        // –ü–æ—à—É–∫ –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–æ–≥–æ —à–ª—è—Ö—É (BFS) –¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫
        function findSimplestPath(level) {
          const queue = [[level.start, []]]; // [position, path_array]
          const visited = new Set([level.start.toString()]);
          const target = level.gems[0]; // –®—É–∫–∞—î–º–æ —à–ª—è—Ö –¥–æ –ø–µ—Ä—à–æ–≥–æ –≤–æ–≥–Ω—é

          if (!target) return [];

          while (queue.length > 0) {
            const [currentPos, path] = queue.shift();

            if (utils.arraysEqual(currentPos, target)) {
              return path; // –ó–Ω–∞–π—à–ª–∏
            }

            for (const direction in DIRECTION_VECTORS) {
              const [dr, dc] = DIRECTION_VECTORS[direction];
              const newPos = [currentPos[0] + dr, currentPos[1] + dc];

              if (
                utils.isValidPosition(newPos, level) &&
                !visited.has(newPos.toString())
              ) {
                visited.add(newPos.toString());
                queue.push([newPos, [...path, direction]]);
              }
            }
          }
          return []; // –®–ª—è—Ö –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ "–ü—ñ–¥–∫–∞–∑–∫–∞" —Ç–∞ "–í—ñ–¥–º—ñ–Ω–∏—Ç–∏"
        function addExtraButtons() {
          const helpBtn = document.createElement("button");
          helpBtn.id = "hintBtn"; // –î–æ–¥–∞–Ω–æ ID –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
          helpBtn.innerHTML = '<i class="fas fa-lightbulb"></i>';
          helpBtn.className =
            "bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 sm:py-4 px-3 sm:px-4 rounded-xl text-base sm:text-lg md:text-xl shadow-lg";
          helpBtn.title = "–ü—ñ–¥–∫–∞–∑–∫–∞";

          helpBtn.addEventListener("click", async () => {
            vibrateDevice([50, 50, 50]);
            await ensureAudio();
            sounds.click();

            const level = LEVELS[gameState.currentLevel];
            const hint =
              level.hint || "–°–ø—Ä–æ–±—É–π —Å–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ –≤–æ–≥–Ω—é! üöí";

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ç–∞ –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
            elements.hintModalText.textContent = hint;
            elements.hintModal.classList.remove("hidden");
            speak(hint); // –û–∑–≤—É—á—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É

            // –ê–≤—Ç–æ-–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–µ—Ä—à–∏—Ö 3 –∫—Ä–æ–∫—ñ–≤
            const solution = findSimplestPath(LEVELS[gameState.currentLevel]);
            if (solution.length > 0) {
              for (let i = 0; i < Math.min(3, solution.length); i++) {
                if (gameState.commands[i] === null) {
                  gameState.commands[i] = solution[i];
                  renderCommandSlots();
                  const btn = elements[`${solution[i]}Btn`];
                  if (btn) {
                    btn.classList.add("pulse-hint-animation");
                    await utils.sleep(500);
                    btn.classList.remove("pulse-hint-animation");
                  }
                }
              }
            }
          });

          const undoBtn = document.createElement("button");
          undoBtn.id = "undoBtn"; // –î–æ–¥–∞–Ω–æ ID –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
          undoBtn.innerHTML = '<i class="fas fa-undo"></i>';
          undoBtn.className =
            "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 sm:py-4 px-3 sm:px-4 rounded-xl text-base sm:text-lg md:text-xl shadow-lg";
          undoBtn.title = "–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é –∫–æ–º–∞–Ω–¥—É";

          undoBtn.addEventListener("click", () => {
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—é –¥–æ–¥–∞–Ω—É –∫–æ–º–∞–Ω–¥—É —ñ –≤–∏–¥–∞–ª—è—î–º–æ —ó—ó
            for (let i = gameState.commands.length - 1; i >= 0; i--) {
              if (gameState.commands[i] !== null) {
                gameState.commands[i] = null;
                renderCommandSlots();
                vibrateDevice([30]);
                break;
              }
            }
          });

          // –ó–ú–Ü–ù–ï–ù–û: –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ —É –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–π flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          const panel = elements.mainControls;
          // –í—Å—Ç–∞–≤–ª—è—î–º–æ "–ü—ñ–¥–∫–∞–∑–∫—É" –ø—ñ—Å–ª—è "–ì–∞—Å–∏—Ç–∏!"
          panel.insertBefore(helpBtn, panel.children[1]);
          // –î–æ–¥–∞—î–º–æ "–í—ñ–¥–º—ñ–Ω–∏—Ç–∏" –≤ –∫—ñ–Ω–µ—Ü—å (–ø—ñ—Å–ª—è "–û—á–∏—Å—Ç–∏—Ç–∏")
          panel.appendChild(undoBtn);
        }

        // ===== 11. –°–õ–£–•–ê–ß–Ü –ü–û–î–Ü–ô =====
        // –ü—Ä–∏–≤'—è–∑–∫–∞ —Ñ—É–Ω–∫—Ü—ñ–π –¥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω—å –∫–Ω–æ–ø–æ–∫
        // ================================

        // –ö–Ω–æ–ø–∫–∏-—Å—Ç—Ä—ñ–ª–∫–∏
        elements.upBtn.addEventListener("click", () => {
          addCommand("up");
        });
        elements.downBtn.addEventListener("click", () => {
          addCommand("down");
        });
        elements.leftBtn.addEventListener("click", () => {
          addCommand("left");
        });
        elements.rightBtn.addEventListener("click", () => {
          addCommand("right");
        });
        // –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
        elements.clearBtn.addEventListener("click", () => {
          clearCommands();
        });
        elements.runBtn.addEventListener("click", () => {
          executeCommands();
        });

        // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
        elements.nextLevelBtn.addEventListener("click", async () => {
          await ensureAudio();
          elements.winModal.classList.add("hidden");
          // checkAchievements(); // –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ executeCommands
          if (gameState.currentLevel < TOTAL_LEVELS_COUNT - 1) {
            gameState.currentLevel++;
            initLevel();
          }
          // –ë–ª–æ–∫ 'else' –¥–ª—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç—É—Ç
          saveProgress();
        });

        elements.retryBtn.addEventListener("click", async () => {
          await ensureAudio();
          elements.errorModal.classList.add("hidden");
          initLevel(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ —Ä—ñ–≤–µ–Ω—å
        });

        elements.closeErrBtn.addEventListener("click", async () => {
          await ensureAudio();
          elements.errorModal.classList.add("hidden");
          // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–∂–µ–∂–Ω–∏–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç (–∞–ª–µ –Ω–µ —Å–∫–∏–¥–∞—î–º–æ –∫–æ–º–∞–Ω–¥–∏)
          const level = LEVELS[gameState.currentLevel];
          updateCharacterPosition(level.start, true);
          gameState.currentPos = [...level.start];
          highlightNearObstacles(level.start, level);
        });

        elements.closeHintBtn.addEventListener("click", async () => {
          await ensureAudio();
          sounds.click();
          elements.hintModal.classList.add("hidden");
        });

        // –ù–æ–≤—ñ —Å–ª—É—Ö–∞—á—ñ –¥–ª—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        elements.restartGameBtn.addEventListener("click", async () => {
          await ensureAudio();
          elements.gameCompleteModal.classList.add("hidden");
          // –ì—Ä–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, –ø–æ—á–∏–Ω–∞—î–º–æ —Å–ø–æ—á–∞—Ç–∫—É
          gameState.currentLevel = 0;
          gameState.totalGems = 0;
          gameState.shownAchievements.clear();
          elements.gemsCount.textContent = "0";
          initLevel();
          saveProgress(); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–∫–∏–¥–∞–Ω–Ω—è
        });

        elements.goHomeBtn.addEventListener("click", async () => {
          await ensureAudio();
          elements.gameCompleteModal.classList.add("hidden");
          // –ü–æ–∫–∏ —â–æ "–ù–∞ –≥–æ–ª–æ–≤–Ω—É" –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≥—Ä—É
          location.reload();
        });

        // –ö–Ω–æ–ø–∫–∏ –≤ —Ö–µ–¥–µ—Ä—ñ
        elements.soundBtn.addEventListener("click", async () => {
          await ensureAudio();
          gameState.soundEnabled = !gameState.soundEnabled;
          elements.soundBtn.setAttribute(
            "aria-pressed",
            String(gameState.soundEnabled)
          );
          const icon = elements.soundBtn.querySelector("i");
          if (gameState.soundEnabled) {
            icon.className = "fas fa-volume-high text-xl text-orange-600";
            sounds.click();
          } else {
            icon.className = "fas fa-volume-xmark text-xl text-orange-600";
            window.speechSynthesis.cancel();
          }
        });

        elements.fullscreenBtn.addEventListener("click", () => {
          toggleFullScreen();
        });
        document.addEventListener("fullscreenchange", updateFullscreenIcon);

        // –¢—É—Ç–æ—Ä—ñ–∞–ª —Ç–∞ –ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π —Ä–µ–∂–∏–º
        elements.startTutorial.addEventListener("click", () => {
          elements.tutorialOverlay.style.display = "none";
          ensureAudio(); // –ü–µ—Ä—à–∏–π –¥–æ—Ç–∏–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        });

        elements.parentBtn.addEventListener("click", () => {
          elements.parentLevels.textContent = `${
            gameState.currentLevel + 1
          }/${TOTAL_LEVELS_COUNT}`;
          elements.parentGems.textContent = gameState.totalGems;
          checkSessionTime();
          elements.parentModal.classList.remove("hidden");
        });

        elements.closeParentModal.addEventListener("click", () => {
          elements.parentModal.classList.add("hidden");
        });

        // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ)
        document.addEventListener("keydown", (e) => {
          if (gameState.isExecuting) return;
          if (
            !elements.winModal.classList.contains("hidden") ||
            !elements.errorModal.classList.contains("hidden") ||
            !elements.hintModal.classList.contains("hidden")
          )
            return;

          switch (e.key) {
            case "ArrowUp":
              e.preventDefault();
              addCommand("up");
              break;
            case "ArrowDown":
              e.preventDefault();
              addCommand("down");
              break;
            case "ArrowLeft":
              e.preventDefault();
              addCommand("left");
              break;
            case "ArrowRight":
              e.preventDefault();
              addCommand("right");
              break;
            case "Enter":
              e.preventDefault();
              executeCommands();
              break;
            case "Escape":
            case "Backspace":
              e.preventDefault();
              clearCommands();
              break;
          }
        });

        // –ê–¥–∞–ø—Ç–∞—Ü—ñ—è —Å—ñ—Ç–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const level = LEVELS[gameState.currentLevel];
            renderGrid(level);
            updateCharacterPosition(gameState.currentPos || level.start, true);
          }, 250);
        });

        // ===== 12. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ì–†–ò =====
        // –ó–∞–ø—É—Å–∫ –≥—Ä–∏
        // =================================

        if (localStorage.getItem("firefighterProgress")) {
          // –Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å –≤–∂–µ –≥—Ä–∞–≤, —Ö–æ–≤–∞—î–º–æ —Ç—É—Ç–æ—Ä—ñ–∞–ª
          elements.tutorialOverlay.style.display = "none";
        }

        loadProgress(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å
        initLevel(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å
        addExtraButtons(); // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ '–ü—ñ–¥–∫–∞–∑–∫–∞' —Ç–∞ '–í—ñ–¥–º—ñ–Ω–∏—Ç–∏'
        setInterval(checkSessionTime, 2 * 60 * 1000); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∞—Å —Å–µ—Å—ñ—ó –∫–æ–∂–Ω—ñ 2 —Ö–≤
      })(); // –ö—ñ–Ω–µ—Ü—å IIFE
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –ù–ú–¢ –¥–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f9ff;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23a3d5f7' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .app-container {
            transition: all 0.3s ease-in-out;
        }
        .btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn.correct {
            background-color: #22c55e !important;
            color: white !important;
            transform: scale(1.05);
            border-color: #16a34a;
        }
        .option-btn.incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626;
        }
        .badge {
            transition: transform 0.3s ease;
        }
        .badge:hover {
            transform: scale(1.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            animation: slideIn 0.3s;
            margin: auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="app-container min-h-screen flex items-start justify-center p-4 pt-10 sm:pt-16">
    
        <!-- –ì–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω -->
        <div id="welcome-container" class="w-full max-w-2xl text-center">
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                 <h1 class="text-4xl font-bold text-blue-600 mb-2">–ó—ñ—Ä–∫–æ–≤–∏–π –°—Ç–∞—Ä—Ç!</h1>
                <p class="text-gray-500 mb-8">–û–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</p>
                <!-- –í–∏–±—ñ—Ä —Ä–µ–∂–∏–º—É –¥–ª—è –≥–æ—Å—Ç–µ–π -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6 max-w-md mx-auto">
                    <p class="text-center font-semibold mb-3">–û–±–µ—Ä–∏ —Ä–µ–∂–∏–º:</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="welcome-practice-mode-btn" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition">
                            <i class="fas fa-book-open mr-2"></i>–ù–∞–≤—á–∞–Ω–Ω—è<br><span class="text-xs font-normal">–ë–µ–∑ —Ç–∞–π–º–µ—Ä–∞</span>
                        </button>
                        <button id="welcome-exam-mode-btn" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition">
                            <i class="fas fa-stopwatch mr-2"></i>–Ü—Å–ø–∏—Ç<br><span class="text-xs font-normal">–ó —Ç–∞–π–º–µ—Ä–æ–º</span>
                        </button>
                    </div>
                </div>
                <div class="grid sm:grid-cols-3 gap-6 mb-8">
                    <button data-subject="math" class="start-test-btn btn flex flex-col items-center justify-center h-48 bg-gradient-to-br from-green-400 to-blue-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:from-green-500 hover:to-blue-600">
                        <i class="fas fa-calculator text-5xl mb-2"></i>
                        <span>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span>
                    </button>
                    <button data-subject="ukrainian" class="start-test-btn btn flex flex-col items-center justify-center h-48 bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:from-yellow-500 hover:to-orange-600">
                        <i class="fas fa-book text-5xl mb-2"></i>
                        <span>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞<br>–º–æ–≤–∞</span>
                    </button>
                    <button data-subject="english" class="start-test-btn btn flex flex-col items-center justify-center h-48 bg-gradient-to-br from-purple-400 to-pink-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:from-purple-500 hover:to-pink-600">
                        <i class="fas fa-globe-americas text-5xl mb-2"></i>
                        <span>–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</span>
                    </button>
                </div>
                <p class="text-gray-600">
                    <a href="#" id="show-login-btn" class="text-blue-500 font-semibold hover:underline">–£–≤—ñ–π–¥—ñ—Ç—å –≤ –∞–∫–∞—É–Ω—Ç</a>, —â–æ–± –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å —Ç–∞ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –Ω–∞–≥–æ—Ä–æ–¥–∏!
                </p>
            </div>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –≤—Ö–æ–¥—É —Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
        <div id="auth-container" class="w-full max-w-md hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
                <h1 class="text-3xl font-bold text-blue-600 mb-6">–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É</h1>
                 <button id="google-signin-btn" class="btn w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 flex items-center justify-center space-x-2">
                    <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google logo" class="h-5">
                    <span>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                </button>
                <div class="my-4 flex items-center">
                    <hr class="flex-grow border-t border-gray-300">
                    <span class="px-2 text-gray-500 text-sm">–∞–±–æ</span>
                    <hr class="flex-grow border-t border-gray-300">
                </div>

                <div id="email-auth-forms">
                    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É -->
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="btn w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">–£–≤—ñ–π—Ç–∏</button>
                    </form>

                    <!-- –§–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
                    <form id="register-form" class="space-y-4 hidden">
                        <input type="email" id="register-email" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        <button type="submit" class="btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
                    </form>
                    <p class="mt-4">
                        <a href="#" id="toggle-auth" class="text-blue-500 hover:underline text-sm">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
                    </p>
                </div>
                 <p id="auth-error" class="text-red-500 mt-4 text-sm h-4"></p>
                 <button id="back-to-welcome-btn" class="mt-4 text-gray-500 hover:underline text-sm">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</button>
            </div>
        </div>

        <!-- –ì–æ–ª–æ–≤–Ω–∞ –ø–∞–Ω–µ–ª—å (Dashboard) -->
        <div id="dashboard-container" class="w-full max-w-6xl hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full">
                <!-- Header with greeting and logout -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-blue-600">–ü—Ä–∏–≤—ñ—Ç, —é–Ω–∏–π –≥–µ–Ω—ñ—é!</h1>
                        <p class="text-gray-500" id="user-email-display"></p>
                    </div>
                    <button id="logout-btn" class="btn bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>–í–∏–π—Ç–∏</span>
                    </button>
                </div>

                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Main content: Training selection (Left) -->
                    <div class="md:col-span-2">
                        <h2 class="text-2xl font-semibold mb-4">–û–±–µ—Ä–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h2>
                        <!-- Mode selection -->
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <p class="text-center font-semibold mb-3">–û–±–µ—Ä–∏ —Ä–µ–∂–∏–º:</p>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="practice-mode-btn" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition">
                                    <i class="fas fa-book-open mr-2"></i>–ù–∞–≤—á–∞–Ω–Ω—è<br><span class="text-xs font-normal">–ë–µ–∑ —Ç–∞–π–º–µ—Ä–∞, –∑ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏</span>
                                </button>
                                <button id="exam-mode-btn" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition">
                                    <i class="fas fa-stopwatch mr-2"></i>–Ü—Å–ø–∏—Ç<br><span class="text-xs font-normal">–ó —Ç–∞–π–º–µ—Ä–æ–º, —è–∫ –Ω–∞ –ù–ú–¢</span>
                                </button>
                            </div>
                        </div>
                        <!-- Subject selection -->
                        <div class="grid sm:grid-cols-3 gap-6">
                             <button data-subject="math" class="start-test-btn btn flex flex-col items-center justify-center h-48 bg-gradient-to-br from-green-400 to-blue-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:from-green-500 hover:to-blue-600">
                                <i class="fas fa-calculator text-5xl mb-2"></i>
                                <span>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span>
                            </button>
                            <button data-subject="ukrainian" class="start-test-btn btn flex flex-col items-center justify-center h-48 bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:from-yellow-500 hover:to-orange-600">
                                <i class="fas fa-book text-5xl mb-2"></i>
                                <span>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞<br>–º–æ–≤–∞</span>
                            </button>
                            <button data-subject="english" class="start-test-btn btn flex flex-col items-center justify-center h-48 bg-gradient-to-br from-purple-400 to-pink-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:from-purple-500 hover:to-pink-600">
                                <i class="fas fa-globe-americas text-5xl mb-2"></i>
                                <span>–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</span>
                            </button>
                        </div>
                    </div>

                    <!-- Sidebar: Stats (Right) -->
                    <div class="md:col-span-1 bg-gray-50 p-6 rounded-2xl">
                        <h2 class="text-2xl font-semibold mb-6 text-center">–¢–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å</h2>
                        <!-- Total score -->
                        <div class="bg-blue-100 p-6 rounded-xl text-center mb-6">
                            <p class="text-lg font-semibold text-blue-800">–ó–∞–≥–∞–ª—å–Ω–∏–π –†–∞—Ö—É–Ω–æ–∫</p>
                            <p id="total-score" class="text-5xl font-bold text-blue-600 my-2">0</p>
                            <p class="text-blue-500">–±–∞–ª—ñ–≤</p>
                        </div>
                        <!-- Awards -->
                        <div class="bg-yellow-100 p-6 rounded-xl text-center">
                            <p class="text-lg font-semibold text-yellow-800 mb-4">–¢–≤–æ—ó –ù–∞–≥–æ—Ä–æ–¥–∏</p>
                            <div id="badges-container" class="flex flex-wrap justify-center items-center gap-x-5 gap-y-4 min-h-[40px]">
                                <!-- –ù–∞–≥–æ—Ä–æ–¥–∏ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- –°–µ–∫—Ü—ñ—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è -->
        <div id="test-container" class="w-full max-w-2xl hidden">
             <div class="bg-white p-8 rounded-2xl shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="test-title" class="text-2xl font-bold text-blue-600">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</h2>
                    <div class="flex items-center gap-4">
                        <div id="timer-display" class="hidden text-lg font-bold bg-orange-100 text-orange-700 px-4 py-2 rounded-lg items-center">
                            <i class="fas fa-stopwatch mr-2"></i>
                            <div><span id="timer-minutes">5</span>:<span id="timer-seconds">00</span></div>
                        </div>
                        <p class="text-lg font-semibold"><span id="current-question-num">1</span> / <span id="total-questions-num">5</span></p>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 20%"></div>
                </div>

                <div class="bg-blue-50 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                    <p id="question-text" class="text-xl text-center font-medium">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è...</p>
                </div>

                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- –û–ø—Ü—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
                
                <div class="text-center mt-6 min-h-[80px]">
                    <p id="feedback-text" class="font-semibold h-6"></p>
                    <button id="next-question-btn" class="btn bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 hidden mt-2">–ù–∞—Å—Ç—É–ø–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è</button>
                </div>
                
                <!-- –ü–æ—è—Å–Ω–µ–Ω–Ω—è -->
                <div id="explanation-container" class="hidden mt-6 bg-green-50 border-2 border-green-200 p-6 rounded-lg">
                    <p class="font-semibold text-green-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>–ü–æ—è—Å–Ω–µ–Ω–Ω—è:</p>
                    <p id="explanation-text" class="text-gray-700"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ -->
    <div id="results-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-4">–ß—É–¥–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</h2>
            <p class="text-lg mb-2">–¢–∏ –≤—ñ–¥–ø–æ–≤—ñ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞</p>
            <p class="text-6xl font-extrabold text-green-500 mb-4"><span id="results-score">0</span> –∑ <span id="results-total">0</span></p>
            
            <!-- –î–ª—è –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
            <div id="new-badge-container" class="hidden my-6">
                <p class="text-lg font-semibold text-yellow-600 mb-2"><i class="fas fa-trophy mr-2"></i>–ù–æ–≤–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞! üéâ</p>
                <div id="new-badge" class="inline-block text-5xl bg-yellow-100 p-4 rounded-full"></div>
                <p id="new-badge-name" class="font-bold mt-2"></p>
            </div>
             <button id="back-to-dashboard-btn" class="btn w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 mt-6">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</button>

            <!-- –î–ª—è –≥–æ—Å—Ç–µ–π -->
            <div id="guest-prompt" class="hidden mt-6 bg-blue-50 p-6 rounded-lg">
                <p class="font-semibold mb-3">–•–æ—á–µ—à –∑–±–µ—Ä–µ–≥—Ç–∏ —Ü–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?</p>
                <p class="text-sm text-gray-600 mb-4">–°—Ç–≤–æ—Ä–∏ –∞–∫–∞—É–Ω—Ç –∞–±–æ —É–≤—ñ–π–¥–∏, —â–æ–± –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å —Ç–∞ –∑–∞—Ä–æ–±–ª—è—Ç–∏ –Ω–∞–≥–æ—Ä–æ–¥–∏!</p>
                <button id="save-progress-btn" class="btn w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">–£–≤—ñ–π—Ç–∏ —Ç–∞ –∑–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBgyNmD9ixU_vHOo-MM4_UARiHU35hlt6k",
            authDomain: "tests4-2a91a.firebaseapp.com",
            projectId: "tests4-2a91a",
            storageBucket: "tests4-2a91a.appspot.com",
            messagingSenderId: "706201183615",
            appId: "1:706201183615:web:7104601b8da69ee1ff664a"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setPersistence(auth, browserLocalPersistence);

        // DOM Elements
        const welcomeContainer = document.getElementById('welcome-container');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const testContainer = document.getElementById('test-container');
        const resultsModal = document.getElementById('results-modal');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleAuthLink = document.getElementById('toggle-auth');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const backToWelcomeBtn = document.getElementById('back-to-welcome-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const totalScoreDisplay = document.getElementById('total-score');
        const badgesContainer = document.getElementById('badges-container');
        const startTestBtns = document.querySelectorAll('.start-test-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const guestPrompt = document.getElementById('guest-prompt');
        const saveProgressBtn = document.getElementById('save-progress-btn');
        const practiceModeBtn = document.getElementById('practice-mode-btn');
        const examModeBtn = document.getElementById('exam-mode-btn');
        const welcomePracticeModeBtn = document.getElementById('welcome-practice-mode-btn');
        const welcomeExamModeBtn = document.getElementById('welcome-exam-mode-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        // State variables
        let currentUser = null;
        let currentUserData = null;
        let currentTest = { questions: [], subject: '', currentIndex: 0, score: 0, mode: 'practice' };
        let timer = null;
        let timeLeft = 300; // 5 minutes for exam mode
        const TEST_LENGTH = 5; // Number of questions per test

        // Questions Database
        const questions = {
             math: [
                { q: "–ü–ª–æ—â–∞ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ –∑—ñ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 8 —Å–º —ñ 5 —Å–º –¥–æ—Ä—ñ–≤–Ω—é—î...", a: ["40 —Å–º", "26 —Å–º", "40 –∫–≤. —Å–º", "13 —Å–º"], correct: 2, explanation: "–©–æ–± –∑–Ω–∞–π—Ç–∏ –ø–ª–æ—â—É –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞, –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –π–æ–≥–æ –¥–æ–≤–∂–∏–Ω—É –Ω–∞ —à–∏—Ä–∏–Ω—É: 8 —Å–º * 5 —Å–º = 40 –∫–≤. —Å–º." },
                { q: "–†–æ–∑–≤'—è–∂–∏ —Ä—ñ–≤–Ω—è–Ω–Ω—è: x - 25 = 50", a: ["x = 25", "x = 75", "x = 50", "x = 100"], correct: 1, explanation: "–©–æ–± –∑–Ω–∞–π—Ç–∏ –Ω–µ–≤—ñ–¥–æ–º–µ –∑–º–µ–Ω—à—É–≤–∞–Ω–µ, –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ —Ä—ñ–∑–Ω–∏—Ü—ñ –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥'—î–º–Ω–∏–∫: x = 50 + 25, –æ—Ç–∂–µ x = 75." },
                { q: "–ó–Ω–∞–π–¥–∏ 1/5 –≤—ñ–¥ —á–∏—Å–ª–∞ 100.", a: ["20", "25", "50", "10"], correct: 0, explanation: "–©–æ–± –∑–Ω–∞–π—Ç–∏ —á–∞—Å—Ç–∏–Ω—É –≤—ñ–¥ —á–∏—Å–ª–∞, –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ü–µ —á–∏—Å–ª–æ –ø–æ–¥—ñ–ª–∏—Ç–∏ –Ω–∞ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –¥—Ä–æ–±—É: 100 / 5 = 20." },
                { q: "–°–∫—ñ–ª—å–∫–∏ –≥—Ä–∞–º—ñ–≤ —É 3 –∫—ñ–ª–æ–≥—Ä–∞–º–∞—Ö?", a: ["300 –≥", "30 –≥", "3000 –≥", "1000 –≥"], correct: 2, explanation: "–í –æ–¥–Ω–æ–º—É –∫—ñ–ª–æ–≥—Ä–∞–º—ñ 1000 –≥—Ä–∞–º—ñ–≤, —Ç–æ–º—É –≤ —Ç—Ä—å–æ—Ö –∫—ñ–ª–æ–≥—Ä–∞–º–∞—Ö: 3 * 1000 = 3000 –≥—Ä–∞–º—ñ–≤." },
                { q: "–ü–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ 24 —Å–º. –Ø–∫–∞ –¥–æ–≤–∂–∏–Ω–∞ –π–æ–≥–æ —Å—Ç–æ—Ä–æ–Ω–∏?", a: ["6 —Å–º", "4 —Å–º", "8 —Å–º", "12 —Å–º"], correct: 0, explanation: "–£ –∫–≤–∞–¥—Ä–∞—Ç–∞ 4 –æ–¥–Ω–∞–∫–æ–≤—ñ —Å—Ç–æ—Ä–æ–Ω–∏. –©–æ–± –∑–Ω–∞–π—Ç–∏ –¥–æ–≤–∂–∏–Ω—É –æ–¥–Ω—ñ—î—ó —Å—Ç–æ—Ä–æ–Ω–∏, –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–∏–º–µ—Ç—Ä –ø–æ–¥—ñ–ª–∏—Ç–∏ –Ω–∞ 4: 24 —Å–º / 4 = 6 —Å–º." },
                { q: "–í –∞–≤—Ç–æ–±—É—Å—ñ —ó—Ö–∞–ª–æ 45 –ø–∞—Å–∞–∂–∏—Ä—ñ–≤. –ù–∞ –∑—É–ø–∏–Ω—Ü—ñ –≤–∏–π—à–ª–æ 12, –∞ –∑–∞–π—à–ª–æ 7. –°–∫—ñ–ª—å–∫–∏ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Å—Ç–∞–ª–æ –≤ –∞–≤—Ç–æ–±—É—Å—ñ?", a: ["40", "33", "52", "43"], correct: 0, explanation: "–°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ —Ç–∏—Ö, —Ö—Ç–æ –≤–∏–π—à–æ–≤: 45 - 12 = 33. –ü–æ—Ç—ñ–º –¥–æ–¥–∞—î–º–æ —Ç–∏—Ö, —Ö—Ç–æ –∑–∞–π—à–æ–≤: 33 + 7 = 40." },
                { q: "–Ø–∫–∏–π –∑ –¥—Ä–æ–±—ñ–≤ –Ω–∞–π–±—ñ–ª—å—à–∏–π: 1/3, 1/8, 1/2, 1/5?", a: ["1/3", "1/8", "1/2", "1/5"], correct: 2, explanation: "–Ø–∫—â–æ —á–∏—Å–µ–ª—å–Ω–∏–∫–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ, —Ç–æ –±—ñ–ª—å—à–∏–º —î —Ç–æ–π –¥—Ä—ñ–±, —É —è–∫–æ–≥–æ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –º–µ–Ω—à–∏–π. 1/2 (–ø–æ–ª–æ–≤–∏–Ω–∞) - —Ü–µ –Ω–∞–π–±—ñ–ª—å—à–∞ —á–∞—Å—Ç–∏–Ω–∞." },
                { q: "5 –≥–æ–¥–∏–Ω - —Ü–µ —Å–∫—ñ–ª—å–∫–∏ —Ö–≤–∏–ª–∏–Ω?", a: ["500 —Ö–≤", "250 —Ö–≤", "300 —Ö–≤", "360 —Ö–≤"], correct: 2, explanation: "–í –æ–¥–Ω—ñ–π –≥–æ–¥–∏–Ω—ñ 60 —Ö–≤–∏–ª–∏–Ω. –û—Ç–∂–µ, 5 –≥–æ–¥–∏–Ω * 60 —Ö–≤–∏–ª–∏–Ω = 300 —Ö–≤–∏–ª–∏–Ω." },
                { q: "–û–±—á–∏—Å–ª–∏: 640 / 8 + 20", a: ["100", "80", "82", "660"], correct: 0, explanation: "–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∫–æ–Ω—É—î–º–æ –¥—ñ–ª–µ–Ω–Ω—è: 640 / 8 = 80. –ü–æ—Ç—ñ–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è: 80 + 20 = 100." },
                { q: "–£ –∫–Ω–∏–∑—ñ 120 —Å—Ç–æ—Ä—ñ–Ω–æ–∫. –û–ª–µ–Ω–∫–∞ –ø—Ä–æ—á–∏—Ç–∞–ª–∞ —á–≤–µ—Ä—Ç—å. –°–∫—ñ–ª—å–∫–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —ó–π –∑–∞–ª–∏—à–∏–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏?", a: ["30", "90", "60", "80"], correct: 1, explanation: "–ß–≤–µ—Ä—Ç—å - —Ü–µ 1/4. –°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞—Ö–æ–¥–∏–º–æ, —Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ –ø—Ä–æ—á–∏—Ç–∞–ª–∞: 120 / 4 = 30 —Å—Ç–æ—Ä—ñ–Ω–æ–∫. –ü–æ—Ç—ñ–º –∑–Ω–∞—Ö–æ–¥–∏–º–æ –∑–∞–ª–∏—à–æ–∫: 120 - 30 = 90 —Å—Ç–æ—Ä—ñ–Ω–æ–∫." }
            ],
            ukrainian: [
                { q: "–í–∏–∑–Ω–∞—á —Ä—ñ–¥ —ñ–º–µ–Ω–Ω–∏–∫–∞ '—Å–æ–±–∞–∫–∞'.", a: ["–ß–æ–ª–æ–≤—ñ—á–∏–π", "–ñ—ñ–Ω–æ—á–∏–π", "–°–µ—Ä–µ–¥–Ω—ñ–π", "–°–ø—ñ–ª—å–Ω–∏–π"], correct: 1, explanation: "–°–ª–æ–≤–æ '—Å–æ–±–∞–∫–∞' –∂—ñ–Ω–æ—á–æ–≥–æ —Ä–æ–¥—É (–≤–æ–Ω–∞ –º–æ—è —Å–æ–±–∞–∫–∞)." },
                { q: "–Ø–∫–µ —Å–ª–æ–≤–æ —î –ø—Ä–∏–∫–º–µ—Ç–Ω–∏–∫–æ–º —É —Ä–µ—á–µ–Ω–Ω—ñ: '–ù–∞—Å—Ç–∞–ª–∞ —Ç–µ–ø–ª–∞ –≤–µ—Å–Ω–∞.'?", a: ["–ù–∞—Å—Ç–∞–ª–∞", "—Ç–µ–ø–ª–∞", "–≤–µ—Å–Ω–∞", "–ù–∞"], correct: 1, explanation: "–ü—Ä–∏–∫–º–µ—Ç–Ω–∏–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è '—è–∫–∞?' —ñ –≤–∫–∞–∑—É—î –Ω–∞ –æ–∑–Ω–∞–∫—É –ø—Ä–µ–¥–º–µ—Ç–∞. –í–µ—Å–Ω–∞ (—è–∫–∞?) —Ç–µ–ø–ª–∞." },
                { q: "–ó–Ω–∞–π–¥–∏ —Å–ª–æ–≤–æ, —É —è–∫–æ–º—É –¥–æ–ø—É—â–µ–Ω–æ –ø–æ–º–∏–ª–∫—É.", a: ["–°–≤—è—Ç–æ", "–±—É—Ä—è–∫", "–∑–¥–æ—Ä–æ–≤'—è", "–º–æ—Ä–∫–≤—è–Ω–∏–π"], correct: 2, explanation: "–°–ª–æ–≤–æ '–∑–¥–æ—Ä–æ–≤'—è' –ø–∏—à–µ—Ç—å—Å—è –∑ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–º –ø—ñ—Å–ª—è '—Ä' –ø–µ—Ä–µ–¥ '—è'." },
                { q: "–î–æ–±–µ—Ä–∏ –∞–Ω—Ç–æ–Ω—ñ–º –¥–æ —Å–ª–æ–≤–∞ '—Ä–∞–¥—ñ—Å—Ç—å'.", a: ["–©–∞—Å—Ç—è", "—Å–º—ñ—Ö", "—Å—É–º", "–≤–µ—Å–µ–ª—ñ—Å—Ç—å"], correct: 2, explanation: "–ê–Ω—Ç–æ–Ω—ñ–º–∏ ‚Äì —Ü–µ —Å–ª–æ–≤–∞ –∑ –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º. –ü—Ä–æ—Ç–∏–ª–µ–∂–Ω—ñ—Å—Ç—é –¥–æ —Ä–∞–¥–æ—Å—Ç—ñ —î —Å—É–º." },
                { q: "–í —è–∫–æ–º—É —Å–ª–æ–≤—ñ –Ω–∞ –º—ñ—Å—Ü—ñ –ø—Ä–æ–ø—É—Å–∫—É –ø–∏—à–µ—Ç—å—Å—è –º'—è–∫–∏–π –∑–Ω–∞–∫?", a: ["–•–∞—Ä..–∫—ñ–≤", "–±—ñ–ª..—Ü—ñ", "–¥–æ–Ω..—á–∏–Ω", "–º–µ–Ω..—à–∏–π"], correct: 1, explanation: "–£ —Å–ª–æ–≤—ñ '–±—ñ–ª—Ü—ñ' –ø–∏—à–µ–º–æ –º'—è–∫–∏–π –∑–Ω–∞–∫ –¥–ª—è –ø–æ–º'—è–∫—à–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø—Ä–∏–≥–æ–ª–æ—Å–Ω–æ–≥–æ [–ª']." },
                { q: "–í–∏–∑–Ω–∞—á –≥–æ–ª–æ–≤–Ω—ñ —á–ª–µ–Ω–∏ —Ä–µ—á–µ–Ω–Ω—è: '–î—ñ—Ç–∏ –≤–µ—Å–µ–ª–æ –≥—Ä–∞–ª–∏—Å—è —É –¥–≤–æ—Ä—ñ.'", a: ["–î—ñ—Ç–∏ –≥—Ä–∞–ª–∏—Å—è", "–≤–µ—Å–µ–ª–æ –≥—Ä–∞–ª–∏—Å—è", "–≥—Ä–∞–ª–∏—Å—è —É –¥–≤–æ—Ä—ñ", "–¥—ñ—Ç–∏ —É –¥–≤–æ—Ä—ñ"], correct: 0, explanation: "–ì–æ–ª–æ–≤–Ω—ñ —á–ª–µ–Ω–∏ —Ä–µ—á–µ–Ω–Ω—è ‚Äì —Ü–µ –ø—ñ–¥–º–µ—Ç (—Ö—Ç–æ? —â–æ?) —ñ –ø—Ä–∏—Å—É–¥–æ–∫ (—â–æ —Ä–æ–±–∏–≤?). –•—Ç–æ? ‚Äì –¥—ñ—Ç–∏. –©–æ —Ä–æ–±–∏–ª–∏? ‚Äì –≥—Ä–∞–ª–∏—Å—è." },
                { q: "–Ø–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ —Å–ª–æ–≤–∞ —î –∑–º—ñ–Ω–Ω–æ—é?", a: ["–ö–æ—Ä—ñ–Ω—å", "–ü—Ä–µ—Ñ—ñ–∫—Å", "–°—É—Ñ—ñ–∫—Å", "–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è"], correct: 3, explanation: "–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è ‚Äì —Ü–µ –∑–º—ñ–Ω–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ —Å–ª–æ–≤–∞, —è–∫–∞ —Å–ª—É–∂–∏—Ç—å –¥–ª—è –∑–≤'—è–∑–∫—É —Å–ª—ñ–≤ —É —Ä–µ—á–µ–Ω–Ω—ñ." },
                { q: "–ü–æ—Å—Ç–∞–≤ —Å–ª–æ–≤–æ '–∫–Ω–∏–≥–∞' –≤ –æ—Ä—É–¥–Ω–æ–º—É –≤—ñ–¥–º—ñ–Ω–∫—É.", a: ["–∫–Ω–∏–≥–∏", "–∫–Ω–∏–∑—ñ", "–∫–Ω–∏–≥–æ—é", "–Ω–∞ –∫–Ω–∏–∑—ñ"], correct: 2, explanation: "–û—Ä—É–¥–Ω–∏–π –≤—ñ–¥–º—ñ–Ω–æ–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è '–∫–∏–º? —á–∏–º?'. –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Ñ–æ—Ä–º–∞ ‚Äì (—á–∏–º?) –∫–Ω–∏–≥–æ—é." },
                { q: "–í —è–∫–æ–º—É —Ä—è–¥–∫—É –≤—Å—ñ —Å–ª–æ–≤–∞ —î —ñ–º–µ–Ω–Ω–∏–∫–∞–º–∏?", a: ["–°—Ç—ñ–ª, –±—ñ–≥—Ç–∏, –∑–µ–ª–µ–Ω–∏–π", "–°–æ–Ω—Ü–µ, —Ö–º–∞—Ä–∞, –¥–æ—â", "–ì–∞—Ä–Ω–∏–π, –≤–∏—Å–æ–∫–æ, –≤—ñ–Ω", "–ß–∏—Ç–∞—Ç–∏, –ø–∏—Å–∞—Ç–∏, –º–∞–ª—é–≤–∞—Ç–∏"], correct: 1, explanation: "–Ü–º–µ–Ω–Ω–∏–∫–∏ –Ω–∞–∑–∏–≤–∞—é—Ç—å –ø—Ä–µ–¥–º–µ—Ç–∏ —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è '—Ö—Ç–æ? —â–æ?'. –°–æ–Ω—Ü–µ, —Ö–º–∞—Ä–∞, –¥–æ—â - –≤—Å–µ —ñ–º–µ–Ω–Ω–∏–∫–∏." },
                { q: "–Ø–∫–∏–º —î —Ä–µ—á–µ–Ω–Ω—è –∑–∞ –º–µ—Ç–æ—é –≤–∏—Å–ª–æ–≤–ª—é–≤–∞–Ω–Ω—è: '–ö–æ–ª–∏ —Ç–∏ –ø—Ä–∏–π–¥–µ—à –¥–æ–¥–æ–º—É?'", a: ["–†–æ–∑–ø–æ–≤—ñ–¥–Ω–µ", "–ü–∏—Ç–∞–ª—å–Ω–µ", "–°–ø–æ–Ω—É–∫–∞–ª—å–Ω–µ", "–û–∫–ª–∏—á–Ω–µ"], correct: 1, explanation: "–†–µ—á–µ–Ω–Ω—è, —É —è–∫–æ–º—É –ø—Ä–æ —â–æ—Å—å –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è, —î –ø–∏—Ç–∞–ª—å–Ω–∏–º. –í –∫—ñ–Ω—Ü—ñ —Å—Ç–∞–≤–∏–º–æ –∑–Ω–∞–∫ –ø–∏—Ç–∞–Ω–Ω—è." }
            ],
            english: [
                { q: "What ___ you doing now?", a: ["is", "are", "am", "do"], correct: 1, explanation: "With the pronoun 'you', we use the verb 'are' in Present Continuous tense." },
                { q: "She ___ to school yesterday.", a: ["go", "goes", "went", "is going"], correct: 2, explanation: "'Yesterday' indicates the past, so we use the past form of the verb 'go', which is 'went'." },
                { q: "There are many ___ on the tree in autumn.", a: ["leaf", "leafs", "leafes", "leaves"], correct: 3, explanation: "The plural form of 'leaf' is irregular: 'leaves'." },
                { q: "My birthday is ___ July.", a: ["on", "at", "in", "by"], correct: 2, explanation: "We use the preposition 'in' for months and years." },
                { q: "He is ___ than his brother.", a: ["tall", "taller", "the tallest", "more tall"], correct: 1, explanation: "To compare two people or things, we use the comparative form of the adjective, which is 'taller'." },
                { q: "___ is your name?", a: ["What", "Where", "Who", "When"], correct: 0, explanation: "'What' is the correct question word to ask for a name." },
                { q: "Can you swim? - Yes, I ___.", a: ["can't", "can", "am", "is"], correct: 1, explanation: "The short answer should use the same modal verb as the question. 'Yes, I can.'" },
                { q: "She has ___ nice dress.", a: ["a", "an", "the", "-"], correct: 0, explanation: "We use the article 'a' before a consonant sound ('nice')." },
                { q: "They ___ football every Sunday.", a: ["plays", "play", "are playing", "played"], correct: 1, explanation: "'Every Sunday' indicates a regular action, so we use Present Simple. For 'they', the verb is 'play'." },
                { q: "The book is ___ the table.", a: ["under", "on", "behind", "in front"], correct: 1, explanation: "'On' is the preposition used to show that something is on a surface, like a table." }
            ]
        };

        const badges = {
            math_rookie: { icon: 'fas fa-calculator', name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫-–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å', subject: 'math', score: 10 },
            math_adept: { icon: 'fas fa-ruler-combined', name: '–ó–Ω–∞–≤–µ—Ü—å —Ñ–æ—Ä–º—É–ª', subject: 'math', score: 50 },
            ukrainian_rookie: { icon: 'fas fa-pen-nib', name: '–ú–æ–≤–æ–∑–Ω–∞–≤–µ—Ü—å-–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å', subject: 'ukrainian', score: 10 },
            ukrainian_adept: { icon: 'fas fa-book-reader', name: '–•—Ä–∞–Ω–∏—Ç–µ–ª—å –º–æ–≤–∏', subject: 'ukrainian', score: 50 },
            english_rookie: { icon: 'fas fa-language', name: 'English Starter', subject: 'english', score: 10 },
            english_adept: { icon: 'fas fa-graduation-cap', name: 'English Speaker', subject: 'english', score: 50 },
            genius: { icon: 'fas fa-brain', name: '–Æ–Ω–∏–π –≥–µ–Ω—ñ–π', subject: 'total', score: 100 },
            mastermind: { icon: 'fas fa-trophy', name: '–í–æ–ª–æ–¥–∞—Ä –∑–Ω–∞–Ω—å', subject: 'total', score: 200 }
        };
        
        // --- UI Navigation ---
        const showScreen = (screen) => {
            [welcomeContainer, authContainer, dashboardContainer, testContainer].forEach(c => c.classList.add('hidden'));
            document.getElementById(`${screen}-container`).classList.remove('hidden');
        };

        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentUserData = await getUserData(user.uid);
                updateDashboard();
                showScreen('dashboard');
            } else {
                currentUser = null;
                currentUserData = null;
                setMode('practice'); // Default to practice mode for guests
                showScreen('welcome');
            }
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authError.textContent = '';
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => authError.textContent = getAuthErrorMessage(error.code));
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => authError.textContent = getAuthErrorMessage(error.code));
        });
        
        googleSigninBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            authError.textContent = '';
            signInWithPopup(auth, provider)
                .catch(error => authError.textContent = getAuthErrorMessage(error.code));
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- Auth UI Toggles ---
        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            const isLoginVisible = !loginForm.classList.contains('hidden');
            loginForm.classList.toggle('hidden', !isLoginVisible);
            registerForm.classList.toggle('hidden', isLoginVisible);
            toggleAuthLink.textContent = isLoginVisible ? '–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏' : '–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è';
            authError.textContent = '';
        });

        showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); showScreen('auth'); });
        backToWelcomeBtn.addEventListener('click', () => showScreen('welcome'));

        // --- Firestore Logic ---
        const getUserData = async (userId) => {
            const userDocRef = doc(db, 'users', userId);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                return userDocSnap.data();
            } else {
                const newUserData = {
                    email: currentUser.email,
                    totalScore: 0,
                    badges: [],
                    scores: { math: 0, ukrainian: 0, english: 0 }
                };
                await setDoc(userDocRef, newUserData);
                return newUserData;
            }
        };
        
        const updateUserData = async (data) => {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userDocRef, data);
            currentUserData = { ...currentUserData, ...data }; // Update local data
        };

        // --- Dashboard Logic ---
        const updateDashboard = () => {
            if (!currentUserData) return;
            userEmailDisplay.textContent = currentUser.email;
            totalScoreDisplay.textContent = currentUserData.totalScore || 0;
            badgesContainer.innerHTML = '';
            if (currentUserData.badges && currentUserData.badges.length > 0) {
                currentUserData.badges.forEach(badgeId => {
                    const badge = badges[badgeId];
                    if (badge) {
                        const badgeEl = document.createElement('div');
                        badgeEl.className = 'badge text-4xl cursor-pointer text-yellow-500';
                        badgeEl.title = badge.name;
                        const iconEl = document.createElement('i');
                        iconEl.className = badge.icon;
                        badgeEl.appendChild(iconEl);
                        badgesContainer.appendChild(badgeEl);
                    }
                });
            } else {
                badgesContainer.innerHTML = '<p class="text-gray-500">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –Ω–∞–≥–æ—Ä–æ–¥. –ü—Ä–æ—Ö–æ–¥—å —Ç–µ—Å—Ç–∏!</p>';
            }
            setMode('practice'); // Default to practice mode on dashboard
        };

        // --- Test Logic ---
        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

        const startTest = (subject) => {
            currentTest.subject = subject;
            currentTest.questions = shuffleArray([...questions[subject]]).slice(0, TEST_LENGTH);
            currentTest.currentIndex = 0;
            currentTest.score = 0;
            
            document.getElementById('test-title').textContent = {
                math: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                ukrainian: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞',
                english: '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞'
            }[subject];
            document.getElementById('total-questions-num').textContent = currentTest.questions.length;
            
            showScreen('test');
            displayQuestion();

            if (currentTest.mode === 'exam') {
                startTimer();
            } else {
                document.getElementById('timer-display').classList.add('hidden');
            }
        };

        const displayQuestion = () => {
            const question = currentTest.questions[currentTest.currentIndex];
            const optionsContainer = document.getElementById('options-container');
            
            document.getElementById('current-question-num').textContent = currentTest.currentIndex + 1;
            document.getElementById('progress-bar').style.width = `${((currentTest.currentIndex + 1) / currentTest.questions.length) * 100}%`;
            document.getElementById('question-text').textContent = question.q;
            optionsContainer.innerHTML = '';
            document.getElementById('feedback-text').innerHTML = '';
            document.getElementById('explanation-container').classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            
            question.a.forEach((answer, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn btn bg-white border-2 border-gray-300 text-gray-700 font-semibold p-4 rounded-lg text-left hover:border-blue-400 hover:bg-blue-50';
                button.textContent = answer;
                button.addEventListener('click', () => selectAnswer(index, button));
                optionsContainer.appendChild(button);
            });
        };

        const selectAnswer = (selectedIndex, button) => {
            const question = currentTest.questions[currentTest.currentIndex];
            const isCorrect = selectedIndex === question.correct;
            const feedbackText = document.getElementById('feedback-text');
            
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            
            if (isCorrect) {
                currentTest.score++;
                button.classList.add('correct');
                feedbackText.innerHTML = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! <i class="fas fa-thumbs-up"></i>';
                feedbackText.className = 'text-center mt-6 font-semibold h-6 text-green-600';
            } else {
                button.classList.add('incorrect');
                feedbackText.innerHTML = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ <i class="fas fa-thumbs-down"></i>';
                feedbackText.className = 'text-center mt-6 font-semibold h-6 text-red-600';
                document.querySelectorAll('.option-btn')[question.correct].classList.add('correct');
            }

            if (currentTest.mode === 'practice') {
                document.getElementById('explanation-text').textContent = question.explanation;
                document.getElementById('explanation-container').classList.remove('hidden');
            }
            
            if (currentTest.currentIndex === currentTest.questions.length - 1) {
                nextQuestionBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç';
            } else {
                nextQuestionBtn.textContent = '–ù–∞—Å—Ç—É–ø–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è';
            }
            
            nextQuestionBtn.classList.remove('hidden');
        };
        
        const nextQuestion = () => {
            currentTest.currentIndex++;
            if (currentTest.currentIndex < currentTest.questions.length) {
                displayQuestion();
            } else {
                endTest();
            }
        };

        const endTest = async () => {
            stopTimer();
            resultsModal.style.display = 'flex';
            document.getElementById('results-score').textContent = currentTest.score;
            document.getElementById('results-total').textContent = currentTest.questions.length;
            
            if (currentUser) {
                guestPrompt.classList.add('hidden');
                document.getElementById('new-badge-container').classList.add('hidden');
                
                const scoreToAdd = currentTest.score;
                const newTotalScore = (currentUserData.totalScore || 0) + scoreToAdd;
                const newSubjectScore = (currentUserData.scores[currentTest.subject] || 0) + scoreToAdd;

                await updateUserData({
                    totalScore: increment(scoreToAdd),
                    [`scores.${currentTest.subject}`]: increment(scoreToAdd)
                });
                
                const awardedBadges = [];
                for (const badgeId in badges) {
                    const badge = badges[badgeId];
                    if (!currentUserData.badges.includes(badgeId)) {
                        const checkScore = badge.subject === 'total' ? newTotalScore : newSubjectScore;
                        if (checkScore >= badge.score) {
                            awardedBadges.push(badgeId);
                        }
                    }
                }
                
                if (awardedBadges.length > 0) {
                    const newBadgesList = [...currentUserData.badges, ...awardedBadges];
                    await updateUserData({ badges: newBadgesList });
                    
                    const lastBadge = badges[awardedBadges[awardedBadges.length - 1]];
                    const newBadgeEl = document.getElementById('new-badge');
                    newBadgeEl.innerHTML = `<i class="${lastBadge.icon}"></i>`;
                    document.getElementById('new-badge-name').textContent = lastBadge.name;
                    document.getElementById('new-badge-container').classList.remove('hidden');
                }
                
            } else {
                guestPrompt.classList.remove('hidden');
            }
        };
        
        // --- Timer Logic ---
        const startTimer = () => {
            timeLeft = 300; // 5 minutes
            document.getElementById('timer-display').classList.remove('hidden');
            document.getElementById('timer-display').classList.add('flex');
            updateTimerDisplay();
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    endTest();
                }
            }, 1000);
        };

        const stopTimer = () => {
            clearInterval(timer);
            timer = null;
        };
        
        const updateTimerDisplay = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer-minutes').textContent = minutes;
            document.getElementById('timer-seconds').textContent = seconds.toString().padStart(2, '0');
        };

        // --- Event Listeners ---
        startTestBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                startTest(btn.dataset.subject);
            });
        });
        
        backToDashboardBtn.addEventListener('click', async () => {
            resultsModal.style.display = 'none';
            if(currentUser) {
                currentUserData = await getUserData(currentUser.uid); // Re-fetch data
                updateDashboard();
                showScreen('dashboard');
            } else {
                showScreen('welcome');
            }
        });
        
        saveProgressBtn.addEventListener('click', () => {
            resultsModal.style.display = 'none';
            showScreen('auth');
        });

        const setMode = (mode) => {
            currentTest.mode = mode;
            const isPractice = mode === 'practice';
            const activeClasses = ['border-2', 'border-blue-500', 'bg-blue-100'];
            const inactiveClasses = ['bg-white'];

            const applyClasses = (btn, isActive) => {
                const add = isActive ? activeClasses : inactiveClasses;
                const remove = isActive ? inactiveClasses : activeClasses;
                btn.classList.add(...add);
                btn.classList.remove(...remove);
            };

            applyClasses(practiceModeBtn, isPractice);
            applyClasses(examModeBtn, !isPractice);
            applyClasses(welcomePracticeModeBtn, isPractice);
            applyClasses(welcomeExamModeBtn, !isPractice);
        };

        practiceModeBtn.addEventListener('click', () => setMode('practice'));
        examModeBtn.addEventListener('click', () => setMode('exam'));
        welcomePracticeModeBtn.addEventListener('click', () => setMode('practice'));
        welcomeExamModeBtn.addEventListener('click', () => setMode('exam'));
        nextQuestionBtn.addEventListener('click', nextQuestion);

        // --- Helper Functions ---
        const getAuthErrorMessage = (code) => {
            switch (code) {
                case 'auth/wrong-password': return '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.';
                case 'auth/user-not-found': return '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–æ—é –ø–æ—à—Ç–æ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.';
                case 'auth/email-already-in-use': return '–¶—è –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∞.';
                case 'auth/weak-password': return '–ü–∞—Ä–æ–ª—å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤.';
                default: return '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
            }
        };

        // Initial setup
        setMode('practice');

    </script>
</body>
</html>


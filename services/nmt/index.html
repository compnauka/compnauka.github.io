<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –ù–ú–¢ –¥–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <style>
    :root{
      --color-primary:#3b82f6; --color-primary-dark:#2563eb; --color-secondary:#22c55e;
      --color-danger:#ef4444; --color-warning:#f59e0b; --color-text-light:#fff;
      --color-text-dark:#374151; --border-radius:.75rem;
      --shadow-xl:0 20px 25px -5px rgb(0 0 0 / .1),0 8px 10px -6px rgb(0 0 0 / .1);
    }
    body{
      font-family:'Montserrat',sans-serif;
      background:#f0f9ff;
      background-image:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23a3d5f7' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .app-container{transition:all .3s ease-in-out}
    .btn{transition:transform .2s ease,box-shadow .2s ease}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .btn:disabled{cursor:not-allowed;opacity:.7}
    .option-btn{transition:all .2s ease}
    .option-btn.correct{background:var(--color-secondary)!important;color:var(--color-text-light)!important;transform:scale(1.05);border-color:#16a34a}
    .option-btn.incorrect{background:var(--color-danger)!important;color:var(--color-text-light)!important;border-color:#dc2626}
    .option-btn:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.6)}
    .badge{transition:transform .3s ease}
    .badge:hover{transform:scale(1.1)}
    .modal{
      display:none;position:fixed;z-index:100;inset:0;width:100%;height:100%;
      overflow:auto;background:rgba(0,0,0,.5);animation:fadeIn .3s;align-items:center;justify-content:center
    }
    .modal-content{animation:slideIn .3s;margin:auto}
    #toast-notification{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      padding:12px 24px;border-radius:9999px;color:#fff;font-weight:600;z-index:9999;
      opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s,transform .3s
    }
    #toast-notification.show{opacity:1;visibility:visible;transform:translate(-50%,-10px)}
    #toast-notification.error{background:var(--color-danger)}
    #toast-notification.success{background:var(--color-secondary)}
    #toast-notification.info{background:var(--color-primary)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}
  </style>
</head>
<body class="text-gray-800">

  <div id="app" class="app-container min-h-screen flex items-start justify-center p-4 pt-10 sm:pt-16">

    <!-- Welcome -->
    <div id="welcome-container" class="w-full max-w-2xl text-center">
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 mb-2">–ó—ñ—Ä–∫–æ–≤–∏–π –°—Ç–∞—Ä—Ç!</h1>
        <p class="text-gray-500 mb-8">–û–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</p>

        <div class="bg-blue-50 p-4 rounded-lg mb-6 max-w-md mx-auto">
          <p class="text-center font-semibold mb-3">–û–±–µ—Ä–∏ —Ä–µ–∂–∏–º:</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button data-mode="practice" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition" aria-label="–û–±—Ä–∞—Ç–∏ —Ä–µ–∂–∏–º –ù–∞–≤—á–∞–Ω–Ω—è">
              <i class="fas fa-book-open mr-2" aria-hidden="true"></i>–ù–∞–≤—á–∞–Ω–Ω—è<br><span class="text-xs font-normal">–ó –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏</span>
            </button>
            <button data-mode="exam" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition" aria-label="–û–±—Ä–∞—Ç–∏ —Ä–µ–∂–∏–º –Ü—Å–ø–∏—Ç">
              <i class="fas fa-stopwatch mr-2" aria-hidden="true"></i>–Ü—Å–ø–∏—Ç<br><span class="text-xs font-normal">–ó —Ç–∞–π–º–µ—Ä–æ–º</span>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-8">
          <button data-subject="math" class="start-test-btn btn flex flex-col items-center justify-center h-40 sm:h-48 bg-gradient-to-br from-green-400 to-blue-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg">
            <i class="fas fa-calculator text-4xl sm:text-5xl mb-2" aria-hidden="true"></i><span>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span>
          </button>
          <button data-subject="ukrainian" class="start-test-btn btn flex flex-col items-center justify-center h-40 sm:h-48 bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg">
            <i class="fas fa-book text-4xl sm:text-5xl mb-2" aria-hidden="true"></i><span>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞<br/>–º–æ–≤–∞</span>
          </button>
          <button data-subject="english" class="start-test-btn btn flex flex-col items-center justify-center h-40 sm:h-48 bg-gradient-to-br from-purple-400 to-pink-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg">
            <i class="fas fa-globe-americas text-4xl sm:text-5xl mb-2" aria-hidden="true"></i><span>–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</span>
          </button>
        </div>

        <p class="text-gray-600">
          <a href="#" id="show-login-btn" class="text-blue-500 font-semibold hover:underline">–£–≤—ñ–π–¥—ñ—Ç—å –≤ –∞–∫–∞—É–Ω—Ç</a>, —â–æ–± –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å!
        </p>
      </div>
    </div>

    <!-- Auth -->
    <div id="auth-container" class="w-full max-w-md hidden">
      <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É</h1>
        <button id="google-signin-btn" class="btn w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 flex items-center justify-center space-x-2">
          <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google" class="h-5"/>
          <span>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
        </button>
        <div class="my-4 flex items-center"><hr class="flex-grow"/><span class="px-2 text-gray-500 text-sm">–∞–±–æ</span><hr class="flex-grow"/></div>
        <form id="login-form" class="space-y-4">
          <input type="email" id="login-email" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required/>
          <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required/>
          <button type="submit" class="btn w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">–£–≤—ñ–π—Ç–∏</button>
        </form>
        <form id="register-form" class="space-y-4 hidden">
          <input type="email" id="register-email" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required/>
          <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required/>
          <button type="submit" class="btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
        </form>
        <p class="mt-4">
          <a href="#" id="toggle-auth" class="text-blue-500 hover:underline text-sm">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
        </p>
        <p id="auth-error" class="text-red-500 mt-4 text-sm h-4"></p>
        <button id="back-to-welcome-btn" class="mt-4 text-gray-500 hover:underline text-sm">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-container" class="w-full max-w-6xl hidden">
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-600">–ü—Ä–∏–≤—ñ—Ç, —é–Ω–∏–π –≥–µ–Ω—ñ—é!</h1>
            <p class="text-gray-500 text-sm sm:text-base" id="user-email-display"></p>
          </div>
          <button id="logout-btn" class="btn bg-red-500 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 self-end sm:self-center">
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i><span>–í–∏–π—Ç–∏</span>
          </button>
        </div>

        <div class="grid md:grid-cols-3 gap-8">
          <div class="md:col-span-2">
            <h2 class="text-2xl font-semibold mb-4">–û–±–µ—Ä–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h2>

            <div class="bg-blue-50 p-4 rounded-lg mb-6">
              <p class="text-center font-semibold mb-3">–û–±–µ—Ä–∏ —Ä–µ–∂–∏–º:</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button data-mode="practice" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition">
                  <i class="fas fa-book-open mr-2" aria-hidden="true"></i>–ù–∞–≤—á–∞–Ω–Ω—è<br/><span class="text-xs font-normal">–ó –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏</span>
                </button>
                <button data-mode="exam" class="mode-btn btn text-blue-700 font-semibold py-3 px-4 rounded-lg transition">
                  <i class="fas fa-stopwatch mr-2" aria-hidden="true"></i>–Ü—Å–ø–∏—Ç<br/><span class="text-xs font-normal">–ó —Ç–∞–π–º–µ—Ä–æ–º</span>
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6">
              <button data-subject="math" class="start-test-btn btn flex flex-col items-center justify-center h-40 sm:h-48 bg-gradient-to-br from-green-400 to-blue-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg">
                <i class="fas fa-calculator text-4xl sm:text-5xl mb-2" aria-hidden="true"></i><span>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span>
              </button>
              <button data-subject="ukrainian" class="start-test-btn btn flex flex-col items-center justify-center h-40 sm:h-48 bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg">
                <i class="fas fa-book text-4xl sm:text-5xl mb-2" aria-hidden="true"></i><span>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞<br/>–º–æ–≤–∞</span>
              </button>
              <button data-subject="english" class="start-test-btn btn flex flex-col items-center justify-center h-40 sm:h-48 bg-gradient-to-br from-purple-400 to-pink-500 text-white p-4 rounded-xl text-xl font-bold shadow-lg">
                <i class="fas fa-globe-americas text-4xl sm:text-5xl mb-2" aria-hidden="true"></i><span>–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞</span>
              </button>
            </div>
          </div>

          <div class="md:col-span-1 bg-gray-50 p-6 rounded-2xl">
            <h2 class="text-2xl font-semibold mb-6 text-center">–¢–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å</h2>
            <div class="bg-blue-100 p-6 rounded-xl text-center mb-6">
              <p class="text-lg font-semibold text-blue-800">–ó–∞–≥–∞–ª—å–Ω–∏–π –†–∞—Ö—É–Ω–æ–∫</p>
              <p id="total-score" class="text-5xl font-bold text-blue-600 my-2">0</p>
              <p class="text-blue-500">–±–∞–ª—ñ–≤</p>
            </div>
            <div class="bg-yellow-100 p-6 rounded-xl text-center">
              <p class="text-lg font-semibold text-yellow-800 mb-4">–¢–≤–æ—ó –ù–∞–≥–æ—Ä–æ–¥–∏</p>
              <div id="badges-container" class="flex flex-wrap justify-center items-center gap-x-5 gap-y-4 min-h-[40px]"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test -->
    <div id="test-container" class="w-full max-w-2xl hidden">
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
          <div class="flex items-center">
            <h2 id="test-title" class="text-xl sm:text-2xl font-bold text-blue-600">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</h2>
            <span id="test-mode-indicator" class="text-xs sm:text-sm font-semibold bg-gray-200 text-gray-700 px-3 py-1 rounded-full ml-3"></span>
          </div>
          <div class="flex items-center gap-2 sm:gap-4">
            <div id="timer-display" class="hidden text-base sm:text-lg font-bold bg-orange-100 text-orange-700 px-3 py-2 rounded-lg items-center">
              <i class="fas fa-stopwatch mr-2" aria-hidden="true"></i>
              <div><span id="timer-minutes">5</span>:<span id="timer-seconds">00</span></div>
            </div>
            <p class="text-base sm:text-lg font-semibold">
              <span id="current-question-num">0</span> / <span id="total-questions-num">5</span>
            </p>
            <button id="quit-test-btn" class="btn bg-gray-200 text-gray-600 text-xs sm:text-sm font-bold py-2 px-3 rounded-lg hover:bg-gray-300" aria-label="–í–∏–π—Ç–∏ –∑ —Ç–µ—Å—Ç—É">–í–∏–π—Ç–∏</button>
          </div>
        </div>

        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6" aria-hidden="true">
          <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>

        <div class="bg-blue-50 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
          <p id="question-text" class="text-lg sm:text-xl text-center font-medium">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è...</p>
        </div>

        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4" role="radiogroup" aria-labelledby="question-text"></div>

        <div class="text-center mt-6 min-h-[80px]">
          <p id="feedback-text" class="font-semibold h-6"></p>
          <button id="next-question-btn" class="btn bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hidden mt-2">–ù–∞—Å—Ç—É–ø–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è</button>
        </div>

        <div id="explanation-container" class="hidden mt-6 bg-green-50 border-2 border-green-200 p-6 rounded-lg">
          <p class="font-semibold text-green-800 mb-2"><i class="fas fa-lightbulb mr-2" aria-hidden="true"></i>–ü–æ—è—Å–Ω–µ–Ω–Ω—è:</p>
          <p id="explanation-text" class="text-gray-700"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div id="results-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1">
    <div class="modal-content bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center mx-4">
      <h2 id="results-title" class="text-3xl font-bold text-blue-600 mb-4">–ß—É–¥–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</h2>
      <p class="text-lg mb-2">–¢–∏ –≤—ñ–¥–ø–æ–≤—ñ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞</p>
      <p class="text-6xl font-extrabold text-green-500 mb-4"><span id="results-score">0</span> –∑ <span id="results-total">0</span></p>
      <p id="time-up-message" class="hidden text-orange-600 font-semibold mb-4">–ß–∞—Å –≤–∏–π—à–æ–≤!</p>
      <div id="new-badge-container" class="hidden my-6">
        <p class="text-lg font-semibold text-yellow-600 mb-2"><i class="fas fa-trophy mr-2" aria-hidden="true"></i>–ù–æ–≤–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞! üéâ</p>
        <div id="new-badge" class="inline-block text-5xl bg-yellow-100 p-4 rounded-full"></div>
        <p id="new-badge-name" class="font-bold mt-2"></p>
      </div>
      <div class="flex flex-col sm:flex-row gap-4 mt-6">
        <button id="review-answers-btn" class="btn w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</button>
        <button id="back-to-main-btn" class="btn w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
      </div>
      <div id="guest-prompt" class="hidden mt-6 bg-blue-50 p-6 rounded-lg">
        <p class="font-semibold mb-3">–•–æ—á–µ—à –∑–±–µ—Ä–µ–≥—Ç–∏ —Ü–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?</p>
        <p class="text-sm text-gray-600 mb-4">–°—Ç–≤–æ—Ä–∏ –∞–∫–∞—É–Ω—Ç –∞–±–æ —É–≤—ñ–π–¥–∏, —â–æ–± –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å!</p>
        <button id="save-progress-btn" class="btn w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg">–£–≤—ñ–π—Ç–∏ —Ç–∞ –∑–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="review-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="review-title" tabindex="-1">
    <div class="modal-content bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-2xl text-left mx-4 max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 id="review-title" class="text-2xl font-bold text-blue-600">–ü–µ—Ä–µ–≥–ª—è–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</h2>
        <button id="close-review-btn" class="text-gray-500 hover:text-gray-800 text-2xl" aria-label="–ó–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ –ø–µ—Ä–µ–≥–ª—è–¥—É">&times;</button>
      </div>
      <div id="review-content" class="overflow-y-auto flex-grow pr-2"></div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmation-title" tabindex="-1">
    <div class="modal-content bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center mx-4">
      <h2 id="confirmation-title" class="text-2xl font-bold text-gray-800 mb-4">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?</h2>
      <p id="confirmation-text" class="text-gray-600 mb-8">–í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å —É –ø–æ—Ç–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç—ñ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.</p>
      <div class="grid grid-cols-2 gap-4">
        <button id="confirm-action-btn" class="btn w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">–¢–∞–∫, –≤–∏–π—Ç–∏</button>
        <button id="cancel-action-btn" class="btn w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-notification" role="status" aria-live="polite"></div>

  <!-- Firebase config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBgyNmD9ixU_vHOo-MM4_UARiHU35hlt6k",
      authDomain: "tests4-2a91a.firebaseapp.com",
      projectId: "tests4-2a91a",
      storageBucket: "tests4-2a91a.firebasestorage.app",
      messagingSenderId: "706201183615",
      appId: "1:706201183615:web:7104601b8da69ee1ff664a"
    };
    const __firebase_config = JSON.stringify(firebaseConfig);
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged, setPersistence, browserLocalPersistence,
      GoogleAuthProvider, signInWithPopup, signInWithCustomToken, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Initialization
    let app, auth, db;
    let isFirebaseActive = false;

    // DOM refs (static)
    const welcomeContainer = document.getElementById('welcome-container');
    const authContainer = document.getElementById('auth-container');
    const dashboardContainer = document.getElementById('dashboard-container');
    const testContainer = document.getElementById('test-container');
    const resultsModal = document.getElementById('results-modal');
    const reviewModal = document.getElementById('review-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    const optionsContainer = document.getElementById('options-container');

    // State
    let currentUser = null;
    let currentUserData = null;
    let unsubscribeUserDataListener = null;
    let currentTest = { questions: [], subject: '', currentIndex: 0, score: 0, mode: 'practice', reviewData: [] };
    let timer = null;
    let timerDeadline;
    let timeLeftWhenPaused;
    const TEST_LENGTH = 5;
    let activeTestSessionId = null;
    let previouslyFocusedElement = null;

    // Data
    const questions = {
      math: [
        { q:"–ü–ª–æ—â–∞ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ –∑—ñ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 8 —Å–º —ñ 5 —Å–º –¥–æ—Ä—ñ–≤–Ω—é—î...", a:["40 —Å–º","26 —Å–º","40 –∫–≤. —Å–º","13 —Å–º"], correct:2, explanation:"8√ó5 = 40 –∫–≤. —Å–º." },
        { q:"–†–æ–∑–≤'—è–∂–∏ —Ä—ñ–≤–Ω—è–Ω–Ω—è: x - 25 = 50", a:["x = 25","x = 75","x = 50","x = 100"], correct:1, explanation:"x = 50 + 25 = 75." },
        { q:"–ó–Ω–∞–π–¥–∏ 1/5 –≤—ñ–¥ —á–∏—Å–ª–∞ 100.", a:["20","25","50","10"], correct:0, explanation:"100 / 5 = 20." },
        { q:"–°–∫—ñ–ª—å–∫–∏ –≥—Ä–∞–º—ñ–≤ —É 3 –∫—ñ–ª–æ–≥—Ä–∞–º–∞—Ö?", a:["300 –≥","30 –≥","3000 –≥","1000 –≥"], correct:2, explanation:"3 √ó 1000 = 3000 –≥." },
        { q:"–ü–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ 24 —Å–º. –Ø–∫–∞ –¥–æ–≤–∂–∏–Ω–∞ –π–æ–≥–æ —Å—Ç–æ—Ä–æ–Ω–∏?", a:["6 —Å–º","4 —Å–º","8 —Å–º","12 —Å–º"], correct:0, explanation:"24 / 4 = 6 —Å–º." },
        { q:"–í –∞–≤—Ç–æ–±—É—Å—ñ —ó—Ö–∞–ª–æ 45 –ø–∞—Å–∞–∂–∏—Ä—ñ–≤. –ù–∞ –∑—É–ø–∏–Ω—Ü—ñ –≤–∏–π—à–ª–æ 12, –∞ –∑–∞–π—à–ª–æ 7. –°–∫—ñ–ª—å–∫–∏ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Å—Ç–∞–ª–æ –≤ –∞–≤—Ç–æ–±—É—Å—ñ?", a:["40","33","52","43"], correct:0, explanation:"45-12=33; 33+7=40." },
        { q:"–Ø–∫–∏–π –∑ –¥—Ä–æ–±—ñ–≤ –Ω–∞–π–±—ñ–ª—å—à–∏–π: 1/3, 1/8, 1/2, 1/5?", a:["1/3","1/8","1/2","1/5"], correct:2, explanation:"–ë—ñ–ª—å—à–∏–π –¥—Ä—ñ–± ‚Äî –∑ –º–µ–Ω—à–∏–º –∑–Ω–∞–º–µ–Ω–Ω–∏–∫–æ–º (–ø—Ä–∏ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö —á–∏—Å–µ–ª—å–Ω–∏–∫–∞—Ö)." },
        { q:"5 –≥–æ–¥–∏–Ω ‚Äî —Ü–µ —Å–∫—ñ–ª—å–∫–∏ —Ö–≤–∏–ª–∏–Ω?", a:["500 —Ö–≤","250 —Ö–≤","300 —Ö–≤","360 —Ö–≤"], correct:2, explanation:"5√ó60=300 —Ö–≤." },
        { q:"–û–±—á–∏—Å–ª–∏: 640 / 8 + 20", a:["100","80","82","660"], correct:0, explanation:"640/8=80; 80+20=100." },
        { q:"–£ –∫–Ω–∏–∑—ñ 120 —Å—Ç–æ—Ä—ñ–Ω–æ–∫. –û–ª–µ–Ω–∫–∞ –ø—Ä–æ—á–∏—Ç–∞–ª–∞ —á–≤–µ—Ä—Ç—å. –°–∫—ñ–ª—å–∫–∏ –∑–∞–ª–∏—à–∏–ª–æ—Å—è?", a:["30","90","60","80"], correct:1, explanation:"120/4=30; 120-30=90." }
      ],
      ukrainian: [
        { q:"–í–∏–∑–Ω–∞—á —Ä—ñ–¥ —ñ–º–µ–Ω–Ω–∏–∫–∞ ¬´—Å–æ–±–∞–∫–∞¬ª.", a:["–ß–æ–ª–æ–≤—ñ—á–∏–π","–ñ—ñ–Ω–æ—á–∏–π","–°–µ—Ä–µ–¥–Ω—ñ–π","–°–ø—ñ–ª—å–Ω–∏–π"], correct:1, explanation:"¬´–°–æ–±–∞–∫–∞¬ª ‚Äî –∂—ñ–Ω–æ—á–∏–π —Ä—ñ–¥." },
        { q:"–Ø–∫–µ —Å–ª–æ–≤–æ —î –ø—Ä–∏–∫–º–µ—Ç–Ω–∏–∫–æ–º —É —Ä–µ—á–µ–Ω–Ω—ñ: ¬´–ù–∞—Å—Ç–∞–ª–∞ —Ç–µ–ø–ª–∞ –≤–µ—Å–Ω–∞.¬ª?", a:["–ù–∞—Å—Ç–∞–ª–∞","—Ç–µ–ø–ª–∞","–≤–µ—Å–Ω–∞","–ù–∞"], correct:1, explanation:"–ü—Ä–∏–∫–º–µ—Ç–Ω–∏–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ ¬´—è–∫–∏–π/—è–∫–∞?¬ª ‚Äî —Ç–µ–ø–ª–∞." },
        { q:"–ó–Ω–∞–π–¥–∏ —Å–ª–æ–≤–æ, —É —è–∫–æ–º—É –¥–æ–ø—É—â–µ–Ω–æ –ø–æ–º–∏–ª–∫—É.", a:["–°–≤—è—Ç–æ","–±—É—Ä—è–∫","–∑–¥–æ—Ä–æ–≤—è","–º–æ—Ä–∫–≤—è–Ω–∏–π"], correct:2, explanation:"–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ¬´–∑–¥–æ—Ä–æ–≤'—è¬ª –∑ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–º." },
        { q:"–î–æ–±–µ—Ä–∏ –∞–Ω—Ç–æ–Ω—ñ–º –¥–æ —Å–ª–æ–≤–∞ ¬´—Ä–∞–¥—ñ—Å—Ç—å¬ª.", a:["–©–∞—Å—Ç—è","—Å–º—ñ—Ö","—Å—É–º","–≤–µ—Å–µ–ª—ñ—Å—Ç—å"], correct:2, explanation:"–ü—Ä–æ—Ç–∏–ª–µ–∂–Ω—ñ—Å—Ç—å ‚Äî ¬´—Å—É–º¬ª." },
        { q:"–£ —è–∫–æ–º—É —Å–ª–æ–≤—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç–∏ –º'—è–∫–∏–π –∑–Ω–∞–∫ (—å)?", a:["–±—É—Ä..—è–∫","—Å—ñ–ª..—Å—å–∫–∏–π","–¥–∑–≤..—è–∫–∞—Ç–∏","–º–æ–ª–æ–¥..—à–∏–π"], correct:1, explanation:"–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ¬´—Å—ñ–ª—å—Å—å–∫–∏–π¬ª (—å). –Ü–Ω—à—ñ ‚Äî –±–µ–∑ –º'—è–∫–æ–≥–æ –∑–Ω–∞–∫–∞ (—Ç—É—Ç –∞–±–æ –±–µ–∑ –Ω—å–æ–≥–æ, –∞–±–æ –≤–∏–º–∞–≥–∞—é—Ç—å –∞–ø–æ—Å—Ç—Ä–æ—Ñ–∞)." },
        { q:"–í–∏–∑–Ω–∞—á –≥–æ–ª–æ–≤–Ω—ñ —á–ª–µ–Ω–∏ —Ä–µ—á–µ–Ω–Ω—è: ¬´–î—ñ—Ç–∏ –≤–µ—Å–µ–ª–æ –≥—Ä–∞–ª–∏—Å—è —É –¥–≤–æ—Ä—ñ.¬ª", a:["–î—ñ—Ç–∏ –≥—Ä–∞–ª–∏—Å—è","–≤–µ—Å–µ–ª–æ –≥—Ä–∞–ª–∏—Å—è","–≥—Ä–∞–ª–∏—Å—è —É –¥–≤–æ—Ä—ñ","–¥—ñ—Ç–∏ —É –¥–≤–æ—Ä—ñ"], correct:0, explanation:"–ü—ñ–¥–º–µ—Ç ‚Äî –¥—ñ—Ç–∏, –ø—Ä–∏—Å—É–¥–æ–∫ ‚Äî –≥—Ä–∞–ª–∏—Å—è." },
        { q:"–Ø–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ —Å–ª–æ–≤–∞ —î –∑–º—ñ–Ω–Ω–æ—é?", a:["–ö–æ—Ä—ñ–Ω—å","–ü—Ä–µ—Ñ—ñ–∫—Å","–°—É—Ñ—ñ–∫—Å","–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è"], correct:3, explanation:"–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∑–º—ñ–Ω—é—î—Ç—å—Å—è." },
        { q:"–ü–æ—Å—Ç–∞–≤ —Å–ª–æ–≤–æ ¬´–∫–Ω–∏–≥–∞¬ª –≤ –æ—Ä—É–¥–Ω–æ–º—É –≤—ñ–¥–º—ñ–Ω–∫—É.", a:["–∫–Ω–∏–≥–∏","–∫–Ω–∏–∑—ñ","–∫–Ω–∏–≥–æ—é","–Ω–∞ –∫–Ω–∏–∑—ñ"], correct:2, explanation:"(–ß–∏–º?) ‚Äî –∫–Ω–∏–≥–æ—é." },
        { q:"–£ —è–∫–æ–º—É —Ä—è–¥–∫—É –≤—Å—ñ —Å–ª–æ–≤–∞ ‚Äî —ñ–º–µ–Ω–Ω–∏–∫–∏?", a:["–°—Ç—ñ–ª, –±—ñ–≥—Ç–∏, –∑–µ–ª–µ–Ω–∏–π","–°–æ–Ω—Ü–µ, —Ö–º–∞—Ä–∞, –¥–æ—â","–ì–∞—Ä–Ω–∏–π, –≤–∏—Å–æ–∫–æ, –≤—ñ–Ω","–ß–∏—Ç–∞—Ç–∏, –ø–∏—Å–∞—Ç–∏, –º–∞–ª—é–≤–∞—Ç–∏"], correct:1, explanation:"–°–æ–Ω—Ü–µ, —Ö–º–∞—Ä–∞, –¥–æ—â ‚Äî —ñ–º–µ–Ω–Ω–∏–∫–∏." },
        { q:"–Ø–∫–∏–º —î —Ä–µ—á–µ–Ω–Ω—è –∑–∞ –º–µ—Ç–æ—é –≤–∏—Å–ª–æ–≤–ª—é–≤–∞–Ω–Ω—è: ¬´–ö–æ–ª–∏ —Ç–∏ –ø—Ä–∏–π–¥–µ—à –¥–æ–¥–æ–º—É?¬ª", a:["–†–æ–∑–ø–æ–≤—ñ–¥–Ω–µ","–ü–∏—Ç–∞–ª—å–Ω–µ","–°–ø–æ–Ω—É–∫–∞–ª—å–Ω–µ","–û–∫–ª–∏—á–Ω–µ"], correct:1, explanation:"–¶–µ –ø–∏—Ç–∞–ª—å–Ω–µ —Ä–µ—á–µ–Ω–Ω—è." }
      ],
      english: [
        { q:"What ___ you doing now?", a:["is","are","am","do"], correct:1, explanation:"With ¬´you¬ª use ¬´are¬ª (Present Continuous)." },
        { q:"She ___ to school yesterday.", a:["go","goes","went","is going"], correct:2, explanation:"Past marker ¬´yesterday¬ª ‚Üí ¬´went¬ª." },
        { q:"There are many ___ on the tree in autumn.", a:["leaf","leafs","leafes","leaves"], correct:3, explanation:"Plural of ¬´leaf¬ª is ¬´leaves¬ª." },
        { q:"My birthday is ___ July.", a:["on","at","in","by"], correct:2, explanation:"Use ¬´in¬ª for months/years." },
        { q:"He is ___ than his brother.", a:["tall","taller","the tallest","more tall"], correct:1, explanation:"Comparative: taller." },
        { q:"___ is your name?", a:["What","Where","Who","When"], correct:0, explanation:"¬´What is your name?¬ª" },
        { q:"Can you swim? ‚Äî Yes, I ___.", a:["can't","can","am","is"], correct:1, explanation:"Repeat the modal: can." },
        { q:"She has ___ nice dress.", a:["a","an","the","-"], correct:0, explanation:"¬´a¬ª before consonant sound." },
        { q:"They ___ football every Sunday.", a:["plays","play","are playing","played"], correct:1, explanation:"Habitual ‚Üí Present Simple: play." },
        { q:"The book is ___ the table.", a:["under","on","behind","in front"], correct:1, explanation:"On the table." }
      ]
    };

    const badges = {
      math_rookie:{ icon:'fas fa-calculator', name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫-–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å', subject:'math', score:10 },
      math_adept:{ icon:'fas fa-ruler-combined', name:'–ó–Ω–∞–≤–µ—Ü—å —Ñ–æ—Ä–º—É–ª', subject:'math', score:50 },
      ukrainian_rookie:{ icon:'fas fa-pen-nib', name:'–ú–æ–≤–æ–∑–Ω–∞–≤–µ—Ü—å-–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å', subject:'ukrainian', score:10 },
      ukrainian_adept:{ icon:'fas fa-book-reader', name:'–•—Ä–∞–Ω–∏—Ç–µ–ª—å –º–æ–≤–∏', subject:'ukrainian', score:50 },
      english_rookie:{ icon:'fas fa-language', name:'English Starter', subject:'english', score:10 },
      english_adept:{ icon:'fas fa-graduation-cap', name:'English Speaker', subject:'english', score:50 },
      genius:{ icon:'fas fa-brain', name:'–Æ–Ω–∏–π –≥–µ–Ω—ñ–π', subject:'total', score:100 },
      mastermind:{ icon:'fas fa-trophy', name:'–í–æ–ª–æ–¥–∞—Ä –∑–Ω–∞–Ω—å', subject:'total', score:200 }
    };

    // UI helpers
    function showScreen(screen){
      [welcomeContainer,authContainer,dashboardContainer,testContainer].forEach(c=>c.classList.add('hidden'));
      document.getElementById(`${screen}-container`).classList.remove('hidden');
    }

    function setLoadingState(button,isLoading){
      if(!button) return;
      if(isLoading){
        button.disabled = true;
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i>';
      }else{
        button.disabled = false;
        if(button.dataset.originalText) button.innerHTML = button.dataset.originalText;
      }
    }

    function setMode(mode){
      currentTest.mode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn=>{
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('border-2',isActive);
        btn.classList.toggle('border-blue-500',isActive);
        btn.classList.toggle('bg-blue-100',isActive);
        btn.classList.toggle('bg-white',!isActive);
      });
    }

    function showToast(message,type='error'){
      const toast = document.getElementById('toast-notification');
      toast.textContent = message;
      toast.classList.remove('error','success','info','show');
      toast.classList.add(type,'show');
      setTimeout(()=>toast.classList.remove('show'),3000);
    }

    window.addEventListener('beforeunload',(event)=>{
      if(activeTestSessionId){
        event.preventDefault();
        event.returnValue = '';
      }
    });

    // Auth + RT data
    function setupAuthListener(){
      onAuthStateChanged(auth, async (user)=>{
        if(unsubscribeUserDataListener) unsubscribeUserDataListener();
        if(user && !user.isAnonymous){
          currentUser = user;
          listenToUserData(user.uid);
          await trySyncOfflineScores();
          showScreen('dashboard');
        }else{
          currentUser = null; currentUserData = null;
          setMode('practice'); showScreen('welcome');
        }
      });
    }

    function listenToUserData(userId){
      const userDocRef = doc(db,'users',userId);
      unsubscribeUserDataListener = onSnapshot(userDocRef, async (docSnap)=>{
        if(docSnap.exists()){
          currentUserData = docSnap.data();
          updateDashboard();
        }else{
          const newUserData = {
            email: currentUser.email, totalScore: 0, badges: [],
            scores: { math:0, ukrainian:0, english:0 }
          };
          await setDoc(userDocRef,newUserData).catch(e=>console.error('Error creating user doc:',e));
          currentUserData = newUserData;
          updateDashboard();
        }
      }, (error)=>{
        console.error('Error listening to user data:',error);
        showToast('–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ—Ñ—ñ–ª—é.');
      });
    }

    async function saveScore(score,subject,retries=3,delay=1000){
      if(!currentUser || !isFirebaseActive || score===0) return;
      const userDocRef = doc(db,'users',currentUser.uid);
      try{
        await updateDoc(userDocRef,{
          totalScore: increment(score),
          [`scores.${subject}`]: increment(score)
        });
      }catch(error){
        if(error.code==='unavailable' && retries>0){
          console.warn(`Network error. Retrying in ${delay}ms... (${retries} left)`);
          setTimeout(()=>saveScore(score,subject,retries-1,delay*2),delay);
        }else{
          console.error('Failed to save score:',error);
          showToast('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.');
          saveScoreOffline(score,subject);
          throw error;
        }
      }
    }

    function saveScoreOffline(score,subject){
      const offlineScores = JSON.parse(localStorage.getItem('offlineScores')||'[]');
      offlineScores.push({ score, subject, timestamp: Date.now() });
      localStorage.setItem('offlineScores',JSON.stringify(offlineScores));
    }

    async function trySyncOfflineScores(){
      const q = JSON.parse(localStorage.getItem('offlineScores')||'[]');
      if(q.length===0 || !isFirebaseActive || !currentUser) return;
      showToast(`–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è ${q.length} –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤...`,'info');
      const pending = [];
      for(const item of q){
        try{ await saveScore(item.score,item.subject); }
        catch{ pending.push(item); }
      }
      localStorage.setItem('offlineScores',JSON.stringify(pending));
      if(q.length>0 && pending.length===0) showToast('–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ!','success');
      else if(pending.length>0) showToast(`–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ ${pending.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç(–∏).`,'error');
    }

    async function checkForNewBadges(){
      if(!currentUser || !currentUserData || !isFirebaseActive) return;
      const userDocRef = doc(db,'users',currentUser.uid);
      const updatedUserDoc = await getDoc(userDocRef);
      if(!updatedUserDoc.exists()) return;
      const latestUserData = updatedUserDoc.data();

      const awardedBadges = [];
      for(const badgeId in badges){
        const badge = badges[badgeId];
        if(!latestUserData.badges.includes(badgeId)){
          const checkScore = badge.subject==='total' ? latestUserData.totalScore : (latestUserData.scores[badge.subject]||0);
          if(checkScore>=badge.score) awardedBadges.push(badgeId);
        }
      }
      if(awardedBadges.length>0){
        const newBadgesList = [...latestUserData.badges,...awardedBadges];
        try{
          await updateDoc(userDocRef,{ badges:newBadgesList });
          const lastBadge = badges[awardedBadges[awardedBadges.length-1]];
          document.getElementById('new-badge').innerHTML = `<i class="${lastBadge.icon}"></i>`;
          document.getElementById('new-badge-name').textContent = lastBadge.name;
          document.getElementById('new-badge-container').classList.remove('hidden');
        }catch(error){ console.error('Error awarding badges:',error); }
      }
    }

    function updateDashboard(){
      const userEmailDisplay = document.getElementById('user-email-display');
      const totalScoreDisplay = document.getElementById('total-score');
      const badgesContainer = document.getElementById('badges-container');
      if(!currentUserData || !currentUser) return;
      userEmailDisplay.textContent = currentUser.email;
      totalScoreDisplay.textContent = currentUserData.totalScore||0;
      badgesContainer.innerHTML = '';
      if(currentUserData.badges && currentUserData.badges.length>0){
        currentUserData.badges.forEach(badgeId=>{
          const badge = badges[badgeId];
          if(badge){
            const el = document.createElement('div');
            el.className = 'badge text-4xl cursor-pointer text-yellow-500';
            el.title = badge.name;
            el.innerHTML = `<i class="${badge.icon}" aria-hidden="true"></i>`;
            badgesContainer.appendChild(el);
          }
        });
      }else{
        badgesContainer.innerHTML = '<p class="text-gray-500">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –Ω–∞–≥–æ—Ä–æ–¥.</p>';
      }
      setMode('practice');
    }

    function shuffleArray(array){
      let currentIndex = array.length, randomIndex;
      while(currentIndex>0){
        randomIndex = Math.floor(Math.random()*currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }
      return array;
    }

    function startTest(subject){
      const testSessionId = Date.now();
      activeTestSessionId = testSessionId;

      const startBtn = document.querySelector(`.start-test-btn[data-subject="${subject}"]`);
      setLoadingState(startBtn,true);

      setTimeout(()=>{
        if(activeTestSessionId!==testSessionId) return;

        currentTest.subject = subject;
        currentTest.questions = shuffleArray([...questions[subject]]).slice(0,TEST_LENGTH);
        currentTest.currentIndex = 0;
        currentTest.score = 0;
        currentTest.reviewData = [];

        document.getElementById('test-title').textContent = { math:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', ukrainian:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞', english:'–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞' }[subject];
        document.getElementById('total-questions-num').textContent = currentTest.questions.length;
        document.getElementById('current-question-num').textContent = 0;
        document.getElementById('progress-bar').style.width = '0%';

        const modeIndicator = document.getElementById('test-mode-indicator');
        modeIndicator.textContent = currentTest.mode==='exam' ? '–Ü—Å–ø–∏—Ç' : '–ù–∞–≤—á–∞–Ω–Ω—è';
        modeIndicator.className = `text-xs sm:text-sm font-semibold px-3 py-1 rounded-full ml-3 ${currentTest.mode==='exam' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`;

        setLoadingState(startBtn,false);
        showScreen('test');
        displayQuestion();

        if(currentTest.mode==='exam') startTimer();
        else document.getElementById('timer-display').classList.add('hidden');
      },300);
    }

    function displayQuestion(){
      const q = currentTest.questions[currentTest.currentIndex];

      // –ø–æ–∫–∞–∑—É—î–º–æ –Ω–æ–º–µ—Ä –ø–∏—Ç–∞–Ω–Ω—è –¢–Ü–õ–¨–ö–ò –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–ø—Ä–æ–≥—Ä–µ—Å —Ä–æ—Å—Ç–µ –ø—ñ—Å–ª—è –∫–ª—ñ–∫—É)
      document.getElementById('question-text').textContent = q.q;
      optionsContainer.innerHTML = '';
      document.getElementById('feedback-text').textContent = '';
      document.getElementById('explanation-container').classList.add('hidden');
      const nextBtn = document.getElementById('next-question-btn');
      nextBtn.classList.add('hidden');

      q.a.forEach((answer,index)=>{
        const button = document.createElement('button');
        button.setAttribute('type','button');
        button.setAttribute('role','radio');
        button.setAttribute('aria-checked','false');
        button.className = 'option-btn btn bg-white border-2 border-gray-300 text-gray-700 font-semibold p-4 rounded-lg text-left hover:border-blue-400 hover:bg-blue-50';
        button.textContent = answer;
        button.dataset.index = index;
        button.tabIndex = 0;
        optionsContainer.appendChild(button);
      });

      // –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è WAI-ARIA radio pattern
      optionsContainer.addEventListener('keydown', radioKeyHandler);
      // —Å—Ñ–æ–∫—É—Å—É—î–º–æ –ø–µ—Ä—à—É –æ–ø—Ü—ñ—é
      const first = optionsContainer.querySelector('.option-btn');
      if(first) first.focus();
    }

    function updateProgressUI(){
      const total = currentTest.questions.length;
      const done = currentTest.currentIndex + 1; // —â–æ–π–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–ª–∏
      const width = Math.max(0, Math.min(100, (done/total)*100));
      document.getElementById('progress-bar').style.width = `${width}%`;
      document.getElementById('current-question-num').textContent = done;
    }

    function nextQuestion(){
      currentTest.currentIndex++;
      if(currentTest.currentIndex < currentTest.questions.length){
        displayQuestion();
      }else{
        endTest();
      }
    }

    async function endTest(timedOut=false){
      activeTestSessionId = null;
      stopTimer();

      // —Å–∫–∏–¥–∞–Ω–Ω—è —Ç–∞–π–º–µ—Ä–∞
      const timerMinutes = document.getElementById('timer-minutes');
      const timerSeconds = document.getElementById('timer-seconds');
      if(timerMinutes) timerMinutes.textContent = '5';
      if(timerSeconds) timerSeconds.textContent = '00';

      showModal(resultsModal);
      document.getElementById('results-score').textContent = currentTest.score;
      document.getElementById('results-total').textContent = currentTest.questions.length;
      document.getElementById('time-up-message').classList.toggle('hidden', !timedOut);
      document.getElementById('new-badge-container').classList.add('hidden');

      // ¬´–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ¬ª ‚Äî –∑–∞–≤–∂–¥–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
      document.getElementById('review-answers-btn').classList.remove('hidden');

      if(currentUser && isFirebaseActive && !currentUser.isAnonymous){
        document.getElementById('guest-prompt').classList.add('hidden');
        await saveScore(currentTest.score,currentTest.subject);
        await checkForNewBadges();
      }else{
        document.getElementById('guest-prompt').classList.remove('hidden');
        saveScoreOffline(currentTest.score,currentTest.subject);
      }
    }

    function stopTimer(){ clearInterval(timer); timer=null; }
    function startTimer(){
      stopTimer();
      timerDeadline = Date.now() + 300*1000;
      const timerDisplay = document.getElementById('timer-display');
      timerDisplay.classList.remove('hidden'); timerDisplay.classList.add('flex');
      updateTimerDisplay();
      timer = setInterval(updateTimerDisplay,1000);
    }
    function pauseTimer(){ if(!timer) return; stopTimer(); timeLeftWhenPaused = timerDeadline - Date.now(); }
    function resumeTimer(){
      if(currentTest.mode!=='exam' || !activeTestSessionId || timer) return;
      timerDeadline = Date.now() + timeLeftWhenPaused;
      updateTimerDisplay();
      timer = setInterval(updateTimerDisplay,1000);
    }
    function updateTimerDisplay(){
      if(!activeTestSessionId){ stopTimer(); return; }
      const timeLeftMs = timerDeadline - Date.now();
      const timeLeftSec = Math.round(timeLeftMs/1000);
      if(timeLeftSec<=0){
        document.getElementById('timer-minutes').textContent = '0';
        document.getElementById('timer-seconds').textContent = '00';
        endTest(true); return;
      }
      const m = Math.floor(timeLeftSec/60);
      const s = timeLeftSec%60;
      document.getElementById('timer-minutes').textContent = m;
      document.getElementById('timer-seconds').textContent = s.toString().padStart(2,'0');
    }

    function showReview(){
      hideModal(resultsModal,false);
      showModal(reviewModal);
      const reviewContent = document.getElementById('review-content');
      reviewContent.innerHTML = '';

      currentTest.reviewData.forEach((item,index)=>{
        const q = item.question;
        const userChoice = item.selectedIndex;
        const correctChoice = q.correct;

        const questionBlock = document.createElement('div');
        questionBlock.className = `p-4 mb-4 border rounded-lg ${userChoice===correctChoice ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;

        const title = document.createElement('p');
        title.className = 'font-bold mb-2';
        title.textContent = `${index+1}. ${q.q}`;
        questionBlock.appendChild(title);

        const ul = document.createElement('ul');
        q.a.forEach((option,i)=>{
          const li = document.createElement('li');
          li.className = 'p-2 border rounded mt-2 border-gray-300';
          if(i===correctChoice) li.className += ' border-green-500 font-bold text-green-800';
          if(i===userChoice && userChoice!==correctChoice) li.className += ' border-red-500 text-red-800 line-through';
          li.textContent = option;
          ul.appendChild(li);
        });
        questionBlock.appendChild(ul);

        const explWrap = document.createElement('div');
        explWrap.className = 'mt-3 pt-3 border-t border-gray-200';
        const explTitle = document.createElement('p');
        explTitle.className = 'font-semibold text-sm text-gray-700';
        explTitle.textContent = '–ü–æ—è—Å–Ω–µ–Ω–Ω—è:';
        const expl = document.createElement('p');
        expl.className = 'text-sm text-gray-600';
        expl.textContent = q.explanation;
        explWrap.appendChild(explTitle);
        explWrap.appendChild(expl);
        questionBlock.appendChild(explWrap);

        reviewContent.appendChild(questionBlock);
      });

      const firstError = reviewContent.querySelector('.border-red-200');
      if(firstError) firstError.scrollIntoView({ behavior:'smooth', block:'nearest' });
    }

    // A11y: radio keyboard handler
    function radioKeyHandler(e){
      const radios = [...optionsContainer.querySelectorAll('.option-btn[role="radio"]')];
      if(radios.length===0) return;
      let i = radios.indexOf(document.activeElement);
      if(e.key==='ArrowDown' || e.key==='ArrowRight'){
        i = (i+1+radios.length)%radios.length; radios[i].focus(); e.preventDefault();
      }else if(e.key==='ArrowUp' || e.key==='ArrowLeft'){
        i = (i-1+radios.length)%radios.length; radios[i].focus(); e.preventDefault();
      }else if(e.key===' ' || e.key==='Enter'){
        if(document.activeElement && document.activeElement.classList.contains('option-btn')){
          document.activeElement.click(); e.preventDefault();
        }
      }
    }

    // Modal focus trap (with Escape) ‚Äî attach to document with stored handler
    const focusableElementsSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';

    function handleFocusTrap(e, modal){
      if(e.key==='Escape'){
        e.preventDefault();
        const closeButton = modal.querySelector('#close-review-btn');
        const cancelBtn = modal.querySelector('#cancel-action-btn');
        if(closeButton) closeButton.click();
        else if(cancelBtn) cancelBtn.click();
        else hideModal(modal);
        return;
      }
      if(e.key!=='Tab') return;
      const focusable = modal.querySelectorAll(focusableElementsSelector);
      if(focusable.length===0) return;
      const first = focusable[0];
      const last = focusable[focusable.length-1];
      if(e.shiftKey){
        if(document.activeElement===first){ last.focus(); e.preventDefault(); }
      }else{
        if(document.activeElement===last){ first.focus(); e.preventDefault(); }
      }
    }

    function showModal(modal){
      previouslyFocusedElement = document.activeElement;
      modal.style.display = 'flex';
      const handler = (e)=>handleFocusTrap(e,modal);
      modal._trapHandler = handler;
      document.addEventListener('keydown', handler);
      const firstFocusable = modal.querySelector(focusableElementsSelector);
      if(firstFocusable) firstFocusable.focus();
    }

    function hideModal(modal, shouldRefocus=true){
      modal.style.display = 'none';
      if(modal._trapHandler){
        document.removeEventListener('keydown', modal._trapHandler);
        modal._trapHandler = null;
      }
      if(shouldRefocus && previouslyFocusedElement){ previouslyFocusedElement.focus(); }
    }

    const getAuthErrorMessage = (code)=>{
      switch(code){
        case 'auth/wrong-password': return '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å.';
        case 'auth/user-not-found': return '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.';
        case 'auth/email-already-in-use': return '–¶—è –ø–æ—à—Ç–∞ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∞.';
        case 'auth/weak-password': return '–ü–∞—Ä–æ–ª—å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ > 5 —Å–∏–º–≤–æ–ª—ñ–≤.';
        case 'auth/popup-closed-by-user': return '–í—ñ–∫–Ω–æ –≤—Ö–æ–¥—É –±—É–ª–æ –∑–∞–∫—Ä–∏—Ç–æ.';
        default: return '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
      }
    };

    function setupEventListeners(){
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const googleSigninBtn = document.getElementById('google-signin-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const backToMainBtn = document.getElementById('back-to-main-btn');
      const saveProgressBtn = document.getElementById('save-progress-btn');
      const toggleAuthLink = document.getElementById('toggle-auth');
      const showLoginBtn = document.getElementById('show-login-btn');
      const backToWelcomeBtn = document.getElementById('back-to-welcome-btn');
      const nextQuestionBtn = document.getElementById('next-question-btn');
      const quitTestBtn = document.getElementById('quit-test-btn');
      const cancelActionBtn = document.getElementById('cancel-action-btn');
      const confirmActionBtn = document.getElementById('confirm-action-btn');
      const reviewAnswersBtn = document.getElementById('review-answers-btn');
      const closeReviewBtn = document.getElementById('close-review-btn');

      // auth forms
      const handleAuthSubmit = async (e, fn)=>{
        e.preventDefault();
        const form = e.target;
        const email = form.querySelector('input[type="email"]').value;
        const password = form.querySelector('input[type="password"]').value;
        const submitButton = form.querySelector('button[type="submit"]');
        document.getElementById('auth-error').textContent = '';
        setLoadingState(submitButton,true);
        try{ await fn(auth,email,password); }
        catch(error){ document.getElementById('auth-error').textContent = getAuthErrorMessage(error.code); }
        finally{ setLoadingState(submitButton,false); }
      };

      if(isFirebaseActive){
        registerForm.addEventListener('submit',(e)=>handleAuthSubmit(e,createUserWithEmailAndPassword));
        loginForm.addEventListener('submit',(e)=>handleAuthSubmit(e,signInWithEmailAndPassword));
        googleSigninBtn.addEventListener('click', async ()=>{
          const provider = new GoogleAuthProvider();
          document.getElementById('auth-error').textContent = '';
          setLoadingState(googleSigninBtn,true);
          try{ await signInWithPopup(auth,provider); }
          catch(error){ document.getElementById('auth-error').textContent = getAuthErrorMessage(error.code); }
          finally{ setLoadingState(googleSigninBtn,false); }
        });
        logoutBtn.addEventListener('click', ()=>{
          if(unsubscribeUserDataListener) unsubscribeUserDataListener();
          signOut(auth);
        });
      }

      // answer click
      optionsContainer.addEventListener('click',(e)=>{
        const button = e.target.closest('.option-btn');
        if(!button || button.disabled) return;

        const selectedIndex = parseInt(button.dataset.index,10);
        const q = currentTest.questions[currentTest.currentIndex];
        const isCorrect = selectedIndex===q.correct;

        if(isCorrect) currentTest.score++;
        currentTest.reviewData.push({ question:q, selectedIndex });

        const all = optionsContainer.querySelectorAll('.option-btn');
        all.forEach((btn, idx)=>{
          btn.disabled = true;
          btn.setAttribute('aria-checked', btn===button);
        });

        button.classList.add(isCorrect?'correct':'incorrect');
        if(currentTest.mode==='practice' && !isCorrect){
          const right = optionsContainer.querySelector(`.option-btn[data-index="${q.correct}"]`);
          if(right) right.classList.add('correct');
        }
        if(currentTest.mode==='practice'){
          document.getElementById('explanation-text').textContent = q.explanation;
          document.getElementById('explanation-container').classList.remove('hidden');
        }

        // –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        updateProgressUI();

        const nextBtn = document.getElementById('next-question-btn');
        nextBtn.textContent = (currentTest.currentIndex===currentTest.questions.length-1) ? '–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç' : '–ù–∞—Å—Ç—É–ø–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è';
        nextBtn.classList.remove('hidden');
        nextBtn.focus();

        // –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –±–ª–æ–∫—É—î–º–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–ª–∞–≤—ñ—à—ñ –≤ —Ü—ñ–π –≥—Ä—É–ø—ñ
        optionsContainer.removeEventListener('keydown', radioKeyHandler);
      });

      document.querySelectorAll('.start-test-btn').forEach(btn=>{
        btn.addEventListener('click',()=>startTest(btn.dataset.subject));
      });
      document.querySelectorAll('.mode-btn').forEach(btn=>{
        btn.addEventListener('click',()=>setMode(btn.dataset.mode));
      });

      backToMainBtn.addEventListener('click',()=>{
        hideModal(resultsModal);
        if(currentUser && isFirebaseActive && !currentUser.isAnonymous) showScreen('dashboard');
        else showScreen('welcome');
      });

      saveProgressBtn.addEventListener('click',()=>{
        hideModal(resultsModal);
        showScreen('auth');
      });

      toggleAuthLink.addEventListener('click',(e)=>{
        e.preventDefault();
        document.getElementById('login-form').classList.toggle('hidden');
        document.getElementById('register-form').classList.toggle('hidden');
        toggleAuthLink.textContent =
          document.getElementById('login-form').classList.contains('hidden') ? '–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? –£–≤—ñ–π—Ç–∏' : '–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è';
        document.getElementById('auth-error').textContent = '';
      });

      document.getElementById('show-login-btn').addEventListener('click',(e)=>{ e.preventDefault(); showScreen('auth'); });
      document.getElementById('back-to-welcome-btn').addEventListener('click',()=>showScreen('welcome'));
      document.getElementById('next-question-btn').addEventListener('click',nextQuestion);

      // quit flow
      quitTestBtn.addEventListener('click',()=>{ pauseTimer(); showModal(confirmationModal); });
      cancelActionBtn.addEventListener('click',()=>{ hideModal(confirmationModal); resumeTimer(); });
      confirmActionBtn.addEventListener('click',()=>{
        hideModal(confirmationModal);
        activeTestSessionId = null;
        stopTimer();
        if(currentUser && isFirebaseActive && !currentUser.isAnonymous) showScreen('dashboard');
        else showScreen('welcome');
      });

      // review
      reviewAnswersBtn.addEventListener('click',showReview);
      closeReviewBtn.addEventListener('click',()=>{
        hideModal(reviewModal);
        if(currentUser && isFirebaseActive && !currentUser.isAnonymous) showScreen('dashboard');
        else showScreen('welcome');
      });
    }

    // Initial setup
    (async()=>{
      setMode('practice');

      try{
        if(typeof __firebase_config!=='undefined' && __firebase_config){
          const cfg = JSON.parse(__firebase_config);
          if(cfg.apiKey && cfg.projectId){
            app = initializeApp(cfg);
            auth = getAuth(app);
            db = getFirestore(app);
            await setPersistence(auth, browserLocalPersistence);
            isFirebaseActive = true;
          }else{ throw new Error('Firebase config is missing essential keys.'); }
        }else{ throw new Error('__firebase_config is not defined.'); }
      }catch(error){
        console.warn('Firebase initialization failed:', error.message, 'App will run in offline mode.');
      }

      if(isFirebaseActive){
        setupAuthListener();
        document.addEventListener('visibilitychange',()=>{
          if(document.visibilityState==='visible'){ trySyncOfflineScores(); }
        });

        if(typeof __initial_auth_token!=='undefined' && __initial_auth_token){
          try{ await signInWithCustomToken(auth,__initial_auth_token); }
          catch(error){
            console.error('Custom token sign-in failed:',error);
            try{ await signInAnonymously(auth); }catch(e){ console.error('Anonymous sign-in fallback failed:',e); }
          }
        }else{
          try{ await signInAnonymously(auth); }catch(e){ console.error('Anonymous sign-in failed:',e); }
        }

        await trySyncOfflineScores();
      }else{
        document.querySelectorAll('#show-login-btn, #google-signin-btn, #login-form, #register-form, #toggle-auth, #save-progress-btn, #logout-btn').forEach(el=>{
          el.style.opacity='.5'; el.style.pointerEvents='none'; if(el.tagName==='BUTTON') el.setAttribute('disabled',true);
        });
        const authText = document.querySelector('a#show-login-btn')?.parentElement;
        if(authText) authText.innerHTML = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ.';
        showScreen('welcome');
      }

      setupEventListeners();
    })();
  </script>
</body>
</html>

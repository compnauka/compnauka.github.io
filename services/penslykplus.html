<!DOCTYPE html> 
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü–µ–Ω–∑–ª–∏–∫ ‚ûï | –ì—Ä–∞—Ñ—ñ—á–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –¥—ñ—Ç–µ–π</title>
    <!-- Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N8T05K3NGT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      const gtag = (...args) => dataLayer.push(args);
      gtag("js", new Date());
      gtag("config", "G-N8T05K3NGT");
    </script>
    <style>
      /* –ó–∞–≥–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ */
      body {
        font-family: "Roboto", "Arial", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f8ff;
      }
      h1 {
        color: #ff6b6b;
        margin-bottom: 10px;
        text-align: center;
        font-size: 24px;
      }
      .container {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        height: 100vh;
      }
      .sidebar {
        width: 250px;
        background-color: #e6f2ff;
        padding: 15px;
        border-right: 3px solid #ffc0cb;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .main-content {
        flex-grow: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      #canvas-container {
        position: relative;
        flex-grow: 1;
        border: 5px solid #ffc0cb;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        background-color: white;
      }
      #drawing-canvas {
        background-color: white;
        cursor: crosshair;
        display: block;
        width: 100%;
        height: 100%;
      }
      .tool-section {
        background-color: #f8f8f8;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 5px;
      }
      .section-title {
        font-weight: bold;
        margin-bottom: 6px;
        color: #5980d9;
        text-align: center;
        font-size: 14px;
      }
      .tools-grid,
      .file-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      .tools-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .tool-button {
        padding: 8px;
        font-size: 14px;
        background-color: #5980d9;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
      }
      .tool-button:hover {
        background-color: #7aa5f8;
        transform: translateY(-2px);
      }
      .tool-button.active {
        background-color: #3a5289;
      }
      .tool-button strong {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
      }
      .color-palette {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 8px;
      }
      .color {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
        border: 3px solid transparent;
        margin: 0 auto;
      }
      .color:hover {
        transform: scale(1.1);
      }
      .color.active {
        border: 3px solid #333;
      }
      .size-control {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .size-slider {
        width: 100%;
        margin: 8px 0;
      }
      .shapes-container,
      .stamps-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }
      .shape-btn,
      .stamp {
        font-size: 18px;
        background-color: #9cc4ff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        height: 36px;
        transition: all 0.3s;
      }
      .shape-btn:hover,
      .stamp:hover {
        background-color: #7aa5f8;
        transform: scale(1.05);
      }
      .shape-btn.active,
      .stamp.active {
        background-color: #5980d9;
      }
      /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å */
      .file-upload {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }
      .file-upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background-color: #5980d9;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        text-align: center;
        font-weight: bold;
      }
      .file-upload-label:hover {
        background-color: #7aa5f8;
        transform: translateY(-2px);
      }
      .file-upload input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .file-upload-icon {
        margin-right: 5px;
      }
      /* –°—Ç–∏–ª—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–æ–ª—å–æ—Ä—É (–≤–±—É–¥–æ–≤–∞–Ω–æ –¥–æ –ø–∞–Ω–µ–ª—ñ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏) */
      #color-constructor {
        margin-top: 10px;
        padding: 12px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: none;
        width: 100%;
        box-sizing: border-box;
      }
      #color-constructor h3 {
        text-align: center;
        margin-bottom: 10px;
        color: #5980d9;
        font-size: 16px;
      }
      .color-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 10px;
      }
      .color-info-item {
        background-color: #f8f8f8;
        padding: 8px;
        border-radius: 6px;
        text-align: center;
        font-size: 14px;
      }
      .color-preview {
        width: 50px;
        height: 50px;
        border-radius: 6px;
        margin: 0 auto 8px;
        border: 1px solid #ddd;
      }
      .color-sliders {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
      }
      .color-slider {
        display: flex;
        align-items: center;
        font-size: 14px;
        flex-wrap: nowrap;
      }
      .color-slider label {
        width: 70px;
        text-align: right;
        margin-right: 8px;
        flex-shrink: 0;
      }
      .color-slider input[type="range"] {
        flex: 1;
        min-width: 0;
      }
      .color-slider span {
        width: 30px;
        text-align: left;
        margin-left: 8px;
        flex-shrink: 0;
      }
      .custom-color-btn {
        background-color: #5980d9;
        color: white;
        border: none;
        margin-top:10px;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        font-size: 14px;
      }
      .custom-color-btn:hover {
        background-color: #ff6b6b;
      }
      /* –ú–µ–¥—ñ–∞-–∑–∞–ø–∏—Ç–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—ñ */
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          height: auto;
        }
        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 3px solid #ffc0cb;
          padding: 10px;
        }
        .main-content {
          height: 500px;
          padding: 10px;
        }
        .tool-button,
        .shape-btn,
        .stamp {
          font-size: 16px;
          padding: 10px;
        }
        .tools-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        h1 {
          font-size: 22px;
        }
        .color-info {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 480px) {
        .tools-grid,
        .shapes-container,
        .stamps-grid,
        .color-palette {
          grid-template-columns: repeat(3, 1fr);
        }
        .sidebar {
          padding: 8px;
        }
        .tool-section {
          padding: 6px;
        }
        h1 {
          font-size: 20px;
          margin-bottom: 5px;
        }
        .tool-button strong {
          font-size: 12px;
        }
        .color-slider label {
          width: 60px;
        }
        .color-slider span {
          width: 25px;
        }
      }
    </style>
  </head>
  <body>
    <noscript>
      <p style="color: red; text-align: center">
        –î–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ —Å–∞–π—Ç—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ —É–≤—ñ–º–∫–Ω—É—Ç–∏ JavaScript.
      </p>
    </noscript>
    <div class="container">
      <div class="sidebar">
        <h1>üé® –ü–µ–Ω–∑–ª–∏–∫ ‚ûï</h1>
        <!-- –ü–∞–Ω–µ–ª—å –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ -->
        <div class="tool-section">
          <div class="section-title">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</div>
          <div class="tools-grid">
            <button id="pencil" class="tool-button active">
              <strong>‚úèÔ∏è –û–ª—ñ–≤–µ—Ü—å</strong>
            </button>
            <button id="eraser" class="tool-button">
              <strong>üßΩ –ì—É–º–∫–∞</strong>
            </button>
            <button id="fill" class="tool-button">
              <strong>ü•õ –ó–∞–ª–∏–≤–∫–∞</strong>
            </button>
            <!-- –î–ª—è –∫–Ω–æ–ø–æ–∫ –§—ñ–≥—É—Ä–∏ —Ç–∞ –®—Ç–∞–º–ø–∏ –±—ñ–ª—å—à–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ setActiveTool, –∞ –≤–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó-—Ç–æ–≥–≥–ª -->
            <button id="shapes" class="tool-button">
              <strong>üìê –§—ñ–≥—É—Ä–∏</strong>
            </button>
            <button id="stamps" class="tool-button">
              <strong>üé≠ –®—Ç–∞–º–ø–∏</strong>
            </button>
            <button id="toggle-color-constructor" class="tool-button">
              <strong>üåà –ö–æ–ª—å–æ—Ä–∏</strong>
            </button>
          </div>
        </div>
        
        <!-- –°–µ–∫—Ü—ñ—è —Ñ—ñ–≥—É—Ä (—Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞) -->
        <div class="tool-section shapes-section" style="display: none;">
          <div class="section-title">–§—ñ–≥—É—Ä–∏</div>
          <div class="shapes-container">
            <button class="shape-btn" data-shape="line">/</button>
            <button class="shape-btn" data-shape="rect">üî≤</button>
            <button class="shape-btn" data-shape="circle">‚ö™</button>
            <button class="shape-btn" data-shape="triangle">üî∫</button>
            <button class="shape-btn" data-shape="star">‚≠ê</button>
            <button class="shape-btn" data-shape="flame">üî•</button>
          </div>
        </div>
        
        <!-- –°–µ–∫—Ü—ñ—è —à—Ç–∞–º–ø—ñ–≤ (—Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞) -->
        <div class="tool-section stamps-section" style="display: none;">
          <div class="section-title">–®—Ç–∞–º–ø–∏</div>
          <div class="stamps-grid">
            <div class="stamp" data-emoji="ü¶Ñ">ü¶Ñ</div>
            <div class="stamp" data-emoji="üê±">üê±</div>
            <div class="stamp" data-emoji="üê∂">üê∂</div>
            <div class="stamp" data-emoji="ü¶ñ">ü¶ñ</div>
            <div class="stamp" data-emoji="üåà">üåà</div>
            <div class="stamp" data-emoji="üåü">üåü</div>
            <div class="stamp" data-emoji="üçï">üçï</div>
            <div class="stamp" data-emoji="üöÄ">üöÄ</div>
            <div class="stamp" data-emoji="üéÆ">üéÆ</div>
            <div class="stamp" data-emoji="üèÄ">üèÄ</div>
            <div class="stamp" data-emoji="üå∏">üå∏</div>
            <div class="stamp" data-emoji="üåû">üåû</div>
          </div>
        </div>
        
        <!-- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ–ª—å–æ—Ä—É -->
        <div id="color-constructor">
          <h3>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ–ª—å–æ—Ä—É</h3>
          <div class="color-info">
            <div class="color-info-item">
              <div id="color-preview" class="color-preview"></div>
              <h4>–ü–æ—Ç–æ—á–Ω–∏–π –∫–æ–ª—ñ—Ä</h4>
            </div>
            <div class="color-info-item">
              <h4>RGB</h4>
              <p id="rgb-value">rgb(0, 0, 0)</p>
            </div>
            <div class="color-info-item">
              <h4>HEX</h4>
              <p id="hex-value">#000000</p>
            </div>
            <div class="color-info-item">
              <h4>–î–≤—ñ–π–∫–æ–≤–∏–π</h4>
              <p id="binary-value">00000000 00000000 00000000</p>
            </div>
          </div>
          <div class="color-sliders">
            <div class="color-slider">
              <label for="red">–ß–µ—Ä–≤–æ–Ω–∏–π:</label>
              <input type="range" id="red" min="0" max="255" value="0" />
              <span id="red-value">0</span>
            </div>
            <div class="color-slider">
              <label for="green">–ó–µ–ª–µ–Ω–∏–π:</label>
              <input type="range" id="green" min="0" max="255" value="0" />
              <span id="green-value">0</span>
            </div>
            <div class="color-slider">
              <label for="blue">–°–∏–Ω—ñ–π:</label>
              <input type="range" id="blue" min="0" max="255" value="0" />
              <span id="blue-value">0</span>
            </div>
          </div>
          <button id="use-color" class="custom-color-btn">
            –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫–æ–ª—ñ—Ä
          </button>
        </div>
        
        <!-- –°–µ–∫—Ü—ñ—è –∫–æ–ª—å–æ—Ä—ñ–≤ (–ø–∞–ª—ñ—Ç—Ä–∞) -->
        <div class="tool-section">
          <div class="section-title">–ö–æ–ª—å–æ—Ä–∏</div>
          <div class="color-palette">
            <div class="color active" style="background-color: #000000" data-hex="#000000"></div>
            <div class="color" style="background-color: #ff0000" data-hex="#ff0000"></div>
            <div class="color" style="background-color: #ff9900" data-hex="#ff9900"></div>
            <div class="color" style="background-color: #ffff00" data-hex="#ffff00"></div>
            <div class="color" style="background-color: #00ff00" data-hex="#00ff00"></div>
            <div class="color" style="background-color: #00ffff" data-hex="#00ffff"></div>
            <div class="color" style="background-color: #0000ff" data-hex="#0000ff"></div>
            <div class="color" style="background-color: #9900ff" data-hex="#9900ff"></div>
            <div class="color" style="background-color: #ff00ff" data-hex="#ff00ff"></div>
            <div class="color" style="background-color: #ff6b6b" data-hex="#ff6b6b"></div>
            <div class="color" style="background-color: #7aa5f8" data-hex="#7aa5f8"></div>
            <div class="color" style="background-color: #ffffff" data-hex="#ffffff"></div>
          </div>
        </div>
        
        <!-- –°–µ–∫—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—É —Ç–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π -->
        <div class="tool-section">
          <div class="section-title">–†–æ–∑–º—ñ—Ä —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó</div>
          <div class="size-control">
            <input type="range" id="size-slider" class="size-slider" min="1" max="50" value="5" />
            <span id="size-value">5</span>
          </div>
          <div class="tools-grid">
            <button id="undo" class="tool-button">
              <strong>‚è™ –ù–∞–∑–∞–¥</strong>
            </button>
            <button id="redo" class="tool-button">
              <strong>–í–ø–µ—Ä–µ–¥ ‚è©</strong>
            </button>
          </div>
        </div>
        
        <!-- –°–µ–∫—Ü—ñ—è —Ñ–∞–π–ª—É -->
        <div class="tool-section">
          <div class="section-title">–§–∞–π–ª</div>
          <div class="tools-grid">
            <button id="clear" class="tool-button">
              <strong>üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</strong>
            </button>
            <button id="save" class="tool-button">
              <strong>üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</strong>
            </button>
          </div>
          <div class="section-title">–Ü–º–ø–æ—Ä—Ç</div>
          <div class="file-upload">
            <label class="file-upload-label">
              <span class="file-upload-icon">üìÅ</span> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
              <input type="file" id="import-file" accept="image/*" />
            </label>
          </div>
        </div>
      </div>
      <div class="main-content">
        <div id="canvas-container">
          <canvas id="drawing-canvas"></canvas>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ canvas
        const canvas = document.getElementById("drawing-canvas");
        const ctx = canvas.getContext("2d");
        if (!ctx) {
          alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î canvas.");
          return;
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç–µ–∫—ñ–≤ –¥–ª—è undo/redo
        let undoStack = [];
        let redoStack = [];
        const maxUndo = 50; // –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 50 –∫—Ä–æ–∫—ñ–≤

        // –°—Ç–∞–Ω –º–∞–ª—é–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–≥–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        const state = {
          isDrawing: false,
          lastX: 0,
          lastY: 0,
          currentTool: "pencil",
          currentColor: "#000000",
          currentSize: 5,
          currentShape: "line",
          startX: 0,
          startY: 0,
          currentStamp: null,
          canvasSnapshot: null,
          unsavedChanges: false,
        };

        // DOM –µ–ª–µ–º–µ–Ω—Ç–∏
        const elements = {
          pencilBtn: document.getElementById("pencil"),
          eraserBtn: document.getElementById("eraser"),
          fillBtn: document.getElementById("fill"),
          shapesBtn: document.getElementById("shapes"),
          stampsBtn: document.getElementById("stamps"),
          clearBtn: document.getElementById("clear"),
          saveBtn: document.getElementById("save"),
          undoBtn: document.getElementById("undo"),
          redoBtn: document.getElementById("redo"),
          importFile: document.getElementById("import-file"),
          colors: document.querySelectorAll(".color"),
          sizeSlider: document.getElementById("size-slider"),
          sizeValue: document.getElementById("size-value"),
          shapesSection: document.querySelector(".shapes-section"),
          shapeButtons: document.querySelectorAll(".shape-btn"),
          stampsSection: document.querySelector(".stamps-section"),
          stamps: document.querySelectorAll(".stamp"),
          toggleColorConstructorBtn: document.getElementById("toggle-color-constructor"),
          colorConstructor: document.getElementById("color-constructor"),
          redSlider: document.getElementById("red"),
          greenSlider: document.getElementById("green"),
          blueSlider: document.getElementById("blue"),
          redValue: document.getElementById("red-value"),
          greenValue: document.getElementById("green-value"),
          blueValue: document.getElementById("blue-value"),
          rgbValue: document.getElementById("rgb-value"),
          hexValue: document.getElementById("hex-value"),
          binaryValue: document.getElementById("binary-value"),
          colorPreview: document.getElementById("color-preview"),
          useColorBtn: document.getElementById("use-color"),
        };

        // –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É canvas –¥–ª—è undo
        function pushToUndoStack() {
          try {
            if (undoStack.length >= maxUndo) {
              undoStack.shift();
            }
            undoStack.push(canvas.toDataURL());
            redoStack = [];
            state.unsavedChanges = true;
          } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —Å—Ç–∞–Ω—É canvas:", err);
          }
        }

        // –§—É–Ω–∫—Ü—ñ—ó undo/redo
        function undo() {
          if (undoStack.length > 0) {
            redoStack.push(canvas.toDataURL());
            const dataURL = undoStack.pop();
            restoreFromDataURL(dataURL);
          }
        }
        function redo() {
          if (redoStack.length > 0) {
            undoStack.push(canvas.toDataURL());
            const dataURL = redoStack.pop();
            restoreFromDataURL(dataURL);
          }
        }
        function restoreFromDataURL(dataURL) {
          const img = new Image();
          img.onload = function () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          };
          img.src = dataURL;
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
        function resizeCanvas() {
          const dataURL = canvas.toDataURL();
          const container = document.getElementById("canvas-container");
          const rect = container.getBoundingClientRect();
          canvas.width = rect.width;
          canvas.height = rect.height;
          const img = new Image();
          img.onload = function () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          };
          img.src = dataURL;
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —ñ–∑ –≤—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –º–∞—Å—à—Ç–∞–±—É
        function getCanvasPos(e) {
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY,
          };
        }

        // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Pointer Events (—É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–æ –¥–ª—è –º–∏—à—ñ —Ç–∞ touch)
        function pointerDown(e) {
          e.preventDefault();
          canvas.setPointerCapture(e.pointerId);
          const pos = getCanvasPos(e);
          state.isDrawing = true;
          state.lastX = pos.x;
          state.lastY = pos.y;
          state.startX = pos.x;
          state.startY = pos.y;

          if (state.currentTool === "stamps" && state.currentStamp) {
            pushToUndoStack();
            placeStamp(pos.x, pos.y);
            state.isDrawing = false;
          } else if (state.currentTool === "fill") {
            pushToUndoStack();
            if (pos.x >= 0 && pos.x < canvas.width && pos.y >= 0 && pos.y < canvas.height) {
              floodFill(Math.floor(pos.x), Math.floor(pos.y));
            } else {
              console.warn("–ü–æ—á–∞—Ç–∫–æ–≤–∞ —Ç–æ—á–∫–∞ floodFill –∑–∞ –º–µ–∂–∞–º–∏ canvas.");
            }
            state.isDrawing = false;
          } else if (state.currentTool === "shapes") {
            pushToUndoStack();
            state.canvasSnapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
          } else {
            pushToUndoStack();
          }
        }
        function pointerMove(e) {
          if (!state.isDrawing) return;
          const pos = getCanvasPos(e);
          if (state.currentTool === "pencil") {
            drawFreehand(pos.x, pos.y);
          } else if (state.currentTool === "eraser") {
            erase(pos.x, pos.y);
          } else if (state.currentTool === "shapes") {
            if (state.canvasSnapshot) {
              ctx.putImageData(state.canvasSnapshot, 0, 0);
            }
            drawShape(pos.x, pos.y);
          }
          state.lastX = pos.x;
          state.lastY = pos.y;
        }
        function pointerUp(e) {
          if (state.isDrawing) {
            state.isDrawing = false;
            if (state.currentTool === "shapes") {
              state.canvasSnapshot = null;
            }
          }
          canvas.releasePointerCapture(e.pointerId);
        }
        function pointerCancel(e) {
          state.isDrawing = false;
        }
        canvas.addEventListener("pointerdown", pointerDown);
        canvas.addEventListener("pointermove", pointerMove);
        canvas.addEventListener("pointerup", pointerUp);
        canvas.addEventListener("pointercancel", pointerCancel);

        // –ú–∞–ª—é–≤–∞–Ω–Ω—è: pencil, eraser, —Ñ—ñ–≥—É—Ä–∏
        function drawFreehand(x, y) {
          ctx.strokeStyle = state.currentColor;
          ctx.lineWidth = state.currentSize;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.beginPath();
          ctx.moveTo(state.lastX, state.lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
        }
        function erase(x, y) {
          ctx.strokeStyle = "#ffffff";
          ctx.lineWidth = state.currentSize;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.beginPath();
          ctx.moveTo(state.lastX, state.lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
        }
        function drawShape(x, y) {
          ctx.strokeStyle = state.currentColor;
          ctx.fillStyle = state.currentColor;
          ctx.lineWidth = state.currentSize;
          switch (state.currentShape) {
            case "line":
              drawLine(state.startX, state.startY, x, y);
              break;
            case "rect":
              drawRectangle(state.startX, state.startY, x, y);
              break;
            case "circle":
              drawCircle(state.startX, state.startY, x, y);
              break;
            case "triangle":
              drawTriangle(state.startX, state.startY, x, y);
              break;
            case "star":
              drawStar(state.startX, state.startY, x, y);
              break;
            case "flame":
              drawHeart(state.startX, state.startY, x, y);
              break;
          }
        }
        function drawLine(x1, y1, x2, y2) {
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();
        }
        function drawRectangle(x1, y1, x2, y2) {
          const width = x2 - x1;
          const height = y2 - y1;
          ctx.beginPath();
          ctx.rect(x1, y1, width, height);
          ctx.stroke();
        }
        function drawCircle(x1, y1, x2, y2) {
          const radius = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
          if (radius < 5) return;
          ctx.beginPath();
          ctx.arc(x1, y1, radius, 0, Math.PI * 2);
          ctx.stroke();
        }
        function drawTriangle(x1, y1, x2, y2) {
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.lineTo(x1 - (x2 - x1), y2);
          ctx.closePath();
          ctx.stroke();
        }
        function drawStar(x1, y1, x2, y2) {
          const spikes = 5;
          const outerRadius = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
          if (outerRadius < 5) return;
          const innerRadius = outerRadius / 2;
          let rot = (Math.PI / 2) * 3;
          const step = Math.PI / spikes;
          ctx.beginPath();
          ctx.moveTo(x1, y1 - outerRadius);
          for (let i = 0; i < spikes; i++) {
            ctx.lineTo(
              x1 + Math.cos(rot) * outerRadius,
              y1 + Math.sin(rot) * outerRadius
            );
            rot += step;
            ctx.lineTo(
              x1 + Math.cos(rot) * innerRadius,
              y1 + Math.sin(rot) * innerRadius
            );
            rot += step;
          }
          ctx.lineTo(x1, y1 - outerRadius);
          ctx.closePath();
          ctx.stroke();
        }
        // –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è drawHeart –∑ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–º –∑–∞ –º–µ–∂–∞–º–∏ (bounding box)
        function drawHeart(x1, y1, x2, y2) {
          const left = Math.min(x1, x2);
          const right = Math.max(x1, x2);
          const top = Math.min(y1, y2);
          const bottom = Math.max(y1, y2);
          const width = right - left;
          const height = bottom - top;
          if (width < 5 || height < 5) return;
          const x = left + width / 2;
          const y = top + height / 2;
          const topCurveHeight = height * 0.3;
          ctx.beginPath();
          ctx.moveTo(x, bottom);
          ctx.bezierCurveTo(
              x - width / 2, bottom - topCurveHeight,
              left, y + topCurveHeight / 2,
              x, top + topCurveHeight
          );
          ctx.bezierCurveTo(
              right, y + topCurveHeight / 2,
              x + width / 2, bottom - topCurveHeight,
              x, bottom
          );
          ctx.closePath();
          ctx.stroke();
        }

        // Flood Fill –∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—î—é —á–µ—Ä–µ–∑ requestAnimationFrame
        function floodFill(startX, startY) {
          if (startX < 0 || startX >= canvas.width || startY < 0 || startY >= canvas.height) {
            console.warn("floodFill: –ü–æ—á–∞—Ç–∫–æ–≤–∞ —Ç–æ—á–∫–∞ –∑–∞ –º–µ–∂–∞–º–∏ canvas.");
            return;
          }
          try {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const width = canvas.width;
            const height = canvas.height;
            const targetColor = getPixelColor(imgData, startX, startY);
            const fillColor = hexToRgba(state.currentColor);
            if (colorMatch(targetColor, fillColor)) return;
            let pixelsToCheck = [[startX, startY]];
            function processPixels() {
              let count = 0;
              while (pixelsToCheck.length && count < 1000) {
                const [x, y] = pixelsToCheck.pop();
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                const currentColor = getPixelColor(imgData, x, y);
                if (!colorMatch(currentColor, targetColor)) continue;
                setPixelColor(imgData, x, y, fillColor);
                pixelsToCheck.push([x + 1, y]);
                pixelsToCheck.push([x - 1, y]);
                pixelsToCheck.push([x, y + 1]);
                pixelsToCheck.push([x, y - 1]);
                count++;
              }
              if (pixelsToCheck.length > 0) {
                requestAnimationFrame(processPixels);
              } else {
                ctx.putImageData(imgData, 0, 0);
              }
            }
            processPixels();
          } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ª–∏–≤–∫–∏:", err);
          }
        }
        function getPixelColor(imageData, x, y) {
          const index = (y * imageData.width + x) * 4;
          return [
            imageData.data[index],
            imageData.data[index + 1],
            imageData.data[index + 2],
            imageData.data[index + 3],
          ];
        }
        function setPixelColor(imageData, x, y, color) {
          const index = (y * imageData.width + x) * 4;
          imageData.data[index] = color[0];
          imageData.data[index + 1] = color[1];
          imageData.data[index + 2] = color[2];
          imageData.data[index + 3] = color[3];
        }
        function colorMatch(color1, color2) {
          const threshold = 5;
          return (
            Math.abs(color1[0] - color2[0]) <= threshold &&
            Math.abs(color1[1] - color2[1]) <= threshold &&
            Math.abs(color1[2] - color2[2]) <= threshold &&
            Math.abs(color1[3] - color2[3]) <= threshold
          );
        }
        function hexToRgba(hex) {
          try {
            hex = hex.replace("#", "");
            if (hex.length === 3) {
              hex = hex.split("").map((c) => c + c).join("");
            }
            if (hex.length !== 6) throw new Error("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç HEX");
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            return [r, g, b, 255];
          } catch (err) {
            console.error(err);
            return [0, 0, 0, 255];
          }
        }

        function placeStamp(x, y) {
          if (!state.currentStamp) return;
          // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —à—Ä–∏—Ñ—Ç—É –∑ fallback –¥–ª—è –µ–º–æ–¥–∑—ñ
          ctx.font = `${state.currentSize * 5}px "Segoe UI Emoji", "Arial", sans-serif`;
          ctx.fillStyle = state.currentColor;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(state.currentStamp, x, y);
        }

        function clearCanvas() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          pushToUndoStack();
        }

        function saveCanvas() {
          try {
            const dataURL = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.download = "my-drawing.png";
            link.href = dataURL;
            link.click();
            state.unsavedChanges = false;
          } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:", err);
            alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.");
          }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        function setActiveTool(tool) {
          state.currentTool = tool;
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–æ–ª—å–æ—Ä—É
          elements.colorConstructor.style.display = "none";
          // –°–∫–∏–¥–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —É –≤—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫
          elements.pencilBtn.classList.remove("active");
          elements.eraserBtn.classList.remove("active");
          elements.fillBtn.classList.remove("active");
          // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–∞–Ω–µ–ª—ñ –§—ñ–≥—É—Ä —Ç–∞ –®—Ç–∞–º–ø—ñ–≤
          elements.shapesSection.style.display = "none";
          elements.shapesBtn.classList.remove("active");
          elements.stampsSection.style.display = "none";
          elements.stampsBtn.classList.remove("active");
          if (tool === "pencil") {
            elements.pencilBtn.classList.add("active");
          } else if (tool === "eraser") {
            elements.eraserBtn.classList.add("active");
          } else if (tool === "fill") {
            elements.fillBtn.classList.add("active");
          }
        }

        function updateSizeValue() {
          elements.sizeValue.textContent = elements.sizeSlider.value;
        }

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ç–æ–≥–ª—É –ø–∞–Ω–µ–ª–µ–π "–§—ñ–≥—É—Ä–∏" —Ç–∞ "–®—Ç–∞–º–ø–∏"
        function toggleShapesPanel() {
          if (elements.shapesSection.style.display === "block") {
            elements.shapesSection.style.display = "none";
            elements.shapesBtn.classList.remove("active");
            if (state.currentTool === "shapes") {
              state.currentTool = "pencil";
            }
          } else {
            // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —ñ–Ω—à—ñ –ø–∞–Ω–µ–ª—ñ –¥–ª—è —É–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó —Ä–æ–±–æ—Ç–∏
            elements.stampsSection.style.display = "none";
            elements.stampsBtn.classList.remove("active");
            elements.colorConstructor.style.display = "none";
            elements.shapesSection.style.display = "block";
            elements.shapesBtn.classList.add("active");
            state.currentTool = "shapes";
          }
        }
        function toggleStampsPanel() {
          if (elements.stampsSection.style.display === "block") {
            elements.stampsSection.style.display = "none";
            elements.stampsBtn.classList.remove("active");
            if (state.currentTool === "stamps") {
              state.currentTool = "pencil";
            }
          } else {
            elements.shapesSection.style.display = "none";
            elements.shapesBtn.classList.remove("active");
            elements.colorConstructor.style.display = "none";
            elements.stampsSection.style.display = "block";
            elements.stampsBtn.classList.add("active");
            state.currentTool = "stamps";
          }
        }

        // –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –ø–æ–¥—ñ–π –¥–ª—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
        elements.pencilBtn.addEventListener("click", () => setActiveTool("pencil"));
        elements.eraserBtn.addEventListener("click", () => setActiveTool("eraser"));
        elements.fillBtn.addEventListener("click", () => setActiveTool("fill"));
        elements.shapesBtn.addEventListener("click", toggleShapesPanel);
        elements.stampsBtn.addEventListener("click", toggleStampsPanel);
        elements.clearBtn.addEventListener("click", clearCanvas);
        elements.saveBtn.addEventListener("click", saveCanvas);
        elements.undoBtn.addEventListener("click", undo);
        elements.redoBtn.addEventListener("click", redo);

        // –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –∫–æ–ª—å–æ—Ä—É –∑ –ø–∞–ª—ñ—Ç—Ä–∏
        elements.colors.forEach((color) => {
          color.addEventListener("click", function () {
            elements.colors.forEach((c) => c.classList.remove("active"));
            this.classList.add("active");
            state.currentColor = this.getAttribute("data-hex");
          });
        });

        // –ó–º—ñ–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
        elements.sizeSlider.addEventListener("input", function () {
          let newSize = Number(this.value);
          if (newSize < 1) newSize = 1;
          if (newSize > 50) newSize = 50;
          state.currentSize = newSize;
          this.value = newSize;
          updateSizeValue();
        });

        // –ü–æ–¥—ñ—ó –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ—ñ–≥—É—Ä
        elements.shapeButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            elements.shapeButtons.forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            state.currentShape = this.dataset.shape;
          });
        });

        // –ü–æ–¥—ñ—ó –¥–ª—è —à—Ç–∞–º–ø—ñ–≤
        elements.stamps.forEach((stamp) => {
          stamp.addEventListener("click", function () {
            elements.stamps.forEach((s) => s.classList.remove("active"));
            this.classList.add("active");
            state.currentStamp = this.dataset.emoji;
          });
        });

        // –Ü–º–ø–æ—Ä—Ç –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        elements.importFile.addEventListener("change", function () {
          const file = this.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
              pushToUndoStack();
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });

        // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ–ª—å–æ—Ä—É
        function toHex(value) {
          const hex = parseInt(value).toString(16);
          return hex.length === 1 ? "0" + hex : hex;
        }
        function toBinary(num) {
          let binary = parseInt(num).toString(2);
          while (binary.length < 8) {
            binary = "0" + binary;
          }
          return binary;
        }
        function updateColorPreview() {
          const red = elements.redSlider.value;
          const green = elements.greenSlider.value;
          const blue = elements.blueSlider.value;
          elements.redValue.textContent = red;
          elements.greenValue.textContent = green;
          elements.blueValue.textContent = blue;
          const rgbText = `rgb(${red}, ${green}, ${blue})`;
          const hexText = `#${toHex(red)}${toHex(green)}${toHex(blue)}`;
          const binaryText = `${toBinary(red)} ${toBinary(green)} ${toBinary(blue)}`;
          elements.rgbValue.textContent = rgbText;
          elements.hexValue.textContent = hexText;
          elements.binaryValue.textContent = binaryText;
          elements.colorPreview.style.backgroundColor = rgbText;
        }
        function useCustomColor() {
          const red = elements.redSlider.value;
          const green = elements.greenSlider.value;
          const blue = elements.blueSlider.value;
          const hexColor = `#${toHex(red)}${toHex(green)}${toHex(blue)}`;
          state.currentColor = hexColor;
          elements.colors.forEach((color) => color.classList.remove("active"));
          if (elements.colors.length > 0) {
            const lastColor = elements.colors[elements.colors.length - 1];
            lastColor.style.backgroundColor = hexColor;
            lastColor.classList.add("active");
          }
          toggleColorConstructor();
        }
        function toggleColorConstructor() {
          if (
            elements.colorConstructor.style.display === "none" ||
            elements.colorConstructor.style.display === ""
          ) {
            elements.colorConstructor.style.display = "block";
            let r = 0, g = 0, b = 0;
            if (state.currentColor.startsWith("#") && state.currentColor.length === 7) {
              r = parseInt(state.currentColor.slice(1, 3), 16);
              g = parseInt(state.currentColor.slice(3, 5), 16);
              b = parseInt(state.currentColor.slice(5, 7), 16);
            }
            elements.redSlider.value = r;
            elements.greenSlider.value = g;
            elements.blueSlider.value = b;
            updateColorPreview();
          } else {
            elements.colorConstructor.style.display = "none";
          }
        }
        elements.toggleColorConstructorBtn.addEventListener("click", toggleColorConstructor);
        elements.redSlider.addEventListener("input", updateColorPreview);
        elements.greenSlider.addEventListener("input", updateColorPreview);
        elements.blueSlider.addEventListener("input", updateColorPreview);
        elements.useColorBtn.addEventListener("click", useCustomColor);

        // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –∑–∞–∫—Ä–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏–º–∏ –∑–º—ñ–Ω–∞–º–∏ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ Web Storage API)
        if (typeof window.localStorage !== "undefined") {
          window.addEventListener("beforeunload", function (e) {
            if (state.unsavedChanges) {
              e.preventDefault();
              e.returnValue = "";
            }
          });
        } else {
          console.warn("Web Storage API –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è, –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ.");
        }
      });
    </script>
  </body>
</html>

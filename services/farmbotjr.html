<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–§–µ—Ä–º–µ—Ä –ë–æ—Ç –º–æ–ª–æ–¥—à–∏–π</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root{ --cell-gap-sm:2px; --cell-gap-lg:4px; }
    body{font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;touch-action:manipulation}
    .grid-cell{aspect-ratio:1;border:2px solid #cbd5e0;transition:all .2s;position:relative;}
    @media (max-width:640px){.grid-cell{border-width:1px}}

    .command-slot{
      aspect-ratio:1;
      border:3px dashed #a0aec0;
      transition:all .2s;
      width:100%;
      min-width:0;
      min-height:0;
    }
    @media (min-width:640px){ .command-slot{ } }
    .command-slot.filled{border-style:solid;border-color:#4299e1;background-color:#ebf8ff;cursor:pointer}

    #commandSlots{
      grid-auto-flow: row;
      grid-auto-rows: 1fr;
      grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
      gap: .5rem;
    }
    @media (min-width:640px){
      #commandSlots{
        grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
        gap: .75rem;
      }
    }

    .arrow-btn{aspect-ratio:1;cursor:pointer;transition:transform .15s;user-select:none}
    .arrow-btn:active{transform:scale(1.08)}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .character{animation:bounce 1s infinite}
    @keyframes collect{0%{transform:scale(1) rotate(0);opacity:1}100%{transform:scale(2) rotate(360deg);opacity:0}}
    .collecting{animation:collect .6s forwards}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .shake{animation:shake .5s}
    @keyframes cell-land-pulse{0%{transform:scale(1);background-color:#ebf8ff}50%{transform:scale(1.06);background-color:#bee3f8}100%{transform:scale(1);background-color:#ebf8ff}}
    .landing{animation:cell-land-pulse .35s ease-out}
    @keyframes win-tada{0%{transform:scale(1) rotate(0)}20%{transform:scale(1.2) rotate(-10deg)}40%{transform:scale(1.2) rotate(10deg)}60%{transform:scale(1.2) rotate(-10deg)}80%{transform:scale(1.2) rotate(10deg)}100%{transform:scale(1) rotate(0)}}
    .win-pulse div{animation:win-tada 1s ease-in-out}
    @keyframes grid-shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-6px)}}
    .grid-shaking{animation:grid-shake .4s linear}
    .sparkle-container{position:absolute;inset:0;pointer-events:none;overflow:hidden}
    .sparkle-bit{position:absolute;width:8px;height:8px;background-color:#fbd38d;border-radius:50%;animation:sparkle-fx .8s forwards;opacity:0}
    @keyframes sparkle-fx{0%{opacity:1;transform:scale(.5) translate(0,0)}100%{opacity:0;transform:scale(1.2) var(--tw-translate)}}

    .emoji-xs{font-size:1.35rem}
    .emoji-sm{font-size:1.75rem}
    .emoji-md{font-size:2.25rem}
    .emoji-lg{font-size:2.75rem}

    .trail-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:#60a5fa;opacity:.9;top:50%;left:50%;transform:translate(-50%,-50%);animation:trail-fade .6s ease-out forwards}
    @keyframes trail-fade{to{opacity:0;transform:translate(-50%,-50%) scale(0.4)}}
    .near-obstacle{box-shadow:inset 0 0 0 3px rgba(239,68,68,.35);animation:near-pulse .6s ease-out 1}
    @keyframes near-pulse{0%{box-shadow:inset 0 0 0 0 rgba(239,68,68,0)}50%{box-shadow:inset 0 0 0 6px rgba(239,68,68,.35)}100%{box-shadow:inset 0 0 0 3px rgba(239,68,68,.35)}}
    .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:100}
    .confetti-bit{position:absolute;width:8px;height:12px;opacity:.9;animation:confetti-fall 1200ms ease-out forwards}
    @keyframes confetti-fall{0%{transform:translateY(-20px) rotate(0)}100%{transform:translateY(150px) rotate(720deg);opacity:0}}
    
    @keyframes float-achievement{
      0%{transform:translateY(20px) scale(0.8);opacity:0}
      50%{transform:translateY(0) scale(1.05);opacity:1}
      100%{transform:translateY(0) scale(1);opacity:1}
    }
    .achievement-toast{
      animation: float-achievement 0.6s ease-out;
    }
    
    .progress-bar{
      height:8px;
      background:linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
      border-radius:999px;
      transition:width 0.5s ease-out;
    }
    
    @keyframes pulse-glow{
      0%, 100%{box-shadow:0 0 15px rgba(34,197,94,0.5)}
      50%{box-shadow:0 0 25px rgba(34,197,94,0.8)}
    }
    .pulse-glow{animation:pulse-glow 2s infinite}

    .hint-bubble{
      animation: bounce 2s infinite;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-200 via-purple-200 to-pink-200 min-h-screen p-2 sm:p-4">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 mb-3 sm:mb-6">
      <div class="flex justify-between items-start mb-3">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-purple-600">
          <i class="fas fa-puzzle-piece" aria-hidden="true"></i>
          –ü—Ä–∏–≥–æ–¥–∏ –º–∞–ª–æ–≥–æ –§–µ—Ä–º–µ—Ä –ë–æ—Ç–∞ 
        </h1>
        <button id="soundBtn" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-xl transition" title="–ó–≤—É–∫">
          <i class="fas fa-volume-up text-xl" aria-hidden="true"></i>
        </button>
      </div>
      
      <!-- Progress Bar -->
      <div class="bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
      </div>
      
      <div class="flex justify-between items-center text-lg sm:text-xl md:text-2xl" role="status" aria-live="polite">
        <div class="font-bold text-blue-600">–†—ñ–≤–µ–Ω—å: <span id="levelNum">1</span>/<span id="totalLevels">12</span></div>
        <div class="font-bold text-green-600"><i class="fas fa-star" aria-hidden="true"></i> <span id="starsCount">0</span></div>
      </div>
      
      <!-- Hint bubble -->
      <div id="hintBubble" class="hidden mt-3 bg-yellow-100 border-2 border-yellow-400 rounded-xl p-3 text-center hint-bubble">
        <p class="text-lg sm:text-xl font-bold text-yellow-800"><i class="fas fa-lightbulb"></i> <span id="hintText"></span></p>
      </div>
    </header>

    <!-- Main layout -->
    <main class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-6">
      <!-- Game board -->
      <section class="md:col-span-2 bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 flex flex-col" aria-label="–Ü–≥—Ä–æ–≤–µ –ø–æ–ª–µ">
        <div class="flex-1 flex justify-center items-center min-h-[300px] md:min-h-[420px]">
          <div id="gameGrid" class="relative" aria-label="–°—ñ—Ç–∫–∞ –≥—Ä–∏" role="grid"></div>
        </div>
      </section>

      <!-- Controls -->
      <aside class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-3 sm:p-6 flex flex-col" aria-label="–ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è">
        <h2 class="text-xl sm:text-2xl font-bold text-purple-600 mb-3 sm:mb-4 flex-shrink-0"><i class="fas fa-code" aria-hidden="true"></i> –ö–æ–º–∞–Ω–¥–∏</h2>

        <div class="grid grid-cols-2 gap-2 sm:gap-4 mb-4 sm:mb-6 flex-shrink-0">
          <button id="upBtn" class="arrow-btn bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white rounded-xl text-3xl sm:text-4xl md:text-5xl p-2 sm:p-3" aria-label="–í–≥–æ—Ä—É"><i class="fas fa-arrow-up" aria-hidden="true"></i></button>
          <button id="downBtn" class="arrow-btn bg-green-500 hover:bg-green-600 active:bg-green-700 text-white rounded-xl text-3xl sm:text-4xl md:text-5xl p-2 sm:p-3" aria-label="–í–Ω–∏–∑"><i class="fas fa-arrow-down" aria-hidden="true"></i></button>
          <button id="leftBtn" class="arrow-btn bg-yellow-500 hover:bg-yellow-600 active:bg-yellow-700 text-white rounded-xl text-3xl sm:text-4xl md:text-5xl p-2 sm:p-3" aria-label="–í–ª—ñ–≤–æ"><i class="fas fa-arrow-left" aria-hidden="true"></i></button>
          <button id="rightBtn" class="arrow-btn bg-red-500 hover:bg-red-600 active:bg-red-700 text-white rounded-xl text-3xl sm:text-4xl md:text-5xl p-2 sm:p-3" aria-label="–í–ø—Ä–∞–≤–æ"><i class="fas fa-arrow-right" aria-hidden="true"></i></button>
        </div>

        <h3 class="text-lg sm:text-xl font-bold text-gray-700 mb-2 sm:mb-3 flex-shrink-0">–ê–ª–≥–æ—Ä–∏—Ç–º:</h3>
        <div id="commandSlots" class="grid gap-2 mb-4 sm:mb-6 flex-shrink-0" aria-label="–°–ª–æ—Ç–∏ –∫–æ–º–∞–Ω–¥"></div>

        <div class="flex-grow"></div>

        <div class="flex gap-2 flex-shrink-0">
          <button id="runBtn" class="flex-1 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-3 sm:py-4 px-3 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-play" aria-hidden="true"></i> –ü—É—Å–∫</button>
          <button id="clearBtn" class="flex-1 bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-3 sm:py-4 px-3 sm:px-6 rounded-xl text-base sm:text-lg md:text-xl"><i class="fas fa-trash" aria-hidden="true"></i> –û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
      </aside>
    </main>

    <!-- Win modal -->
    <div id="winModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true">
      <div class="bg-white rounded-3xl p-6 sm:p-8 max-w-md w-full text-center relative overflow-hidden">
        <div id="winConfetti" class="confetti"></div>
        <div class="text-6xl sm:text-7xl mb-4 win-pulse"><div>üéâ</div></div>
        <h2 class="text-3xl sm:text-4xl font-bold text-purple-600 mb-2">–ß—É–¥–æ–≤–æ!</h2>
        <p class="text-xl sm:text-2xl mb-4 font-bold text-green-600" id="encouragement"></p>
        <p class="text-lg sm:text-xl mb-6" id="winMessage"></p>
        <button id="nextLevelBtn" class="bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-4 px-8 rounded-xl text-xl w-full pulse-glow">
          –ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å <i class="fas fa-arrow-right" aria-hidden="true"></i>
        </button>
      </div>
    </div>

    <!-- Error modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true">
      <div class="bg-white rounded-3xl p-6 sm:p-8 max-w-md w-full text-center">
        <div class="text-5xl sm:text-6xl mb-4" aria-hidden="true">ü§î</div>
        <h2 class="text-2xl sm:text-3xl font-bold text-orange-600 mb-4">–ú–∞–π–∂–µ –≤–∏–π—à–ª–æ!</h2>
        <p class="text-lg sm:text-xl mb-6" id="errorMessage"></p>
        <div class="flex gap-2 flex-wrap justify-center">
          <button id="retryBtn" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl text-lg">
            –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ <i class="fas fa-redo" aria-hidden="true"></i>
          </button>
          <button id="closeErrBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl text-lg">–ó—Ä–æ–∑—É–º—ñ–ª–æ</button>
        </div>
      </div>
    </div>

    <!-- Achievement toast -->
    <div id="achievementToast" class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-[60] bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-4 rounded-2xl shadow-2xl achievement-toast border-4 border-white">
      <div class="flex items-center gap-3">
        <div class="text-4xl" id="achievementIcon"></div>
        <div>
          <div class="font-bold text-lg" id="achievementTitle"></div>
          <div class="text-sm" id="achievementText"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Constants =====
    const ANIMATION_SPEED = 380;
    const DIRECTION_VECTORS = { up:[-1,0], down:[1,0], left:[0,-1], right:[0,1] };
    const ARROW_ICONS = {
      up:'<i class="fas fa-arrow-up text-blue-500" aria-hidden="true"></i>',
      down:'<i class="fas fa-arrow-down text-green-500" aria-hidden="true"></i>',
      left:'<i class="fas fa-arrow-left text-yellow-500" aria-hidden="true"></i>',
      right:'<i class="fas fa-arrow-right text-red-500" aria-hidden="true"></i>'
    };

    // ===== Levels (optimized for 4-6 years) =====
    const LEVELS = [
      // Tutorial (1-3): Single direction
      { size:3, start:[1,0], end:[1,1], obstacles:[], items:[], maxCommands:1, noItems:true, hint:"–ù–∞—Ç–∏—Å–Ω–∏ —Å—Ç—Ä—ñ–ª–∫—É –≤–ø—Ä–∞–≤–æ ‚û°Ô∏è" },
      { size:3, start:[1,0], end:[1,2], obstacles:[], items:[], maxCommands:2, noItems:true, hint:"–î–≤–∞ —Ä–∞–∑–∏ –≤–ø—Ä–∞–≤–æ! ‚û°Ô∏è‚û°Ô∏è" },
      { size:3, start:[0,1], end:[2,1], obstacles:[], items:[], maxCommands:2, noItems:true, hint:"–†—É—Ö–∞–π—Å—è –≤–Ω–∏–∑! ‚¨áÔ∏è‚¨áÔ∏è" },
      
      // Easy (4-6): Items introduction
      { size:3, start:[0,0], end:[0,2], obstacles:[], items:[[0,1]], maxCommands:2, hint:"–ó–±–µ—Ä–∏ —è–±–ª—É—á–∫–æ! üçé" },
      { size:3, start:[0,0], end:[2,2], obstacles:[], items:[[1,1]], maxCommands:4 },
      { size:4, start:[1,0], end:[1,2], obstacles:[[0,1],[2,1]], items:[[1,1]], maxCommands:3 },
      
      // Medium (7-10): Simple mazes
      { size:4, start:[0,0], end:[3,3], obstacles:[[1,1]], items:[[2,2]], maxCommands:6 },
      { size:4, start:[0,0], end:[3,0], obstacles:[[1,0],[2,0]], items:[[1,1]], maxCommands:5 },
      { size:5, start:[0,0], end:[4,4], obstacles:[], items:[[2,2]], maxCommands:8 },
      { size:5, start:[2,0], end:[2,4], obstacles:[[1,2],[3,2]], items:[[2,1],[2,3]], maxCommands:6 },
      
      // Challenge (11-12): For advanced kids
      { size:5, start:[0,0], end:[4,0], obstacles:[[1,0],[1,1],[3,1],[3,2]], items:[[2,2]], maxCommands:8 },
      { size:6, start:[0,0], end:[5,5], obstacles:[[1,1],[2,2],[3,3]], items:[[0,3],[3,0]], maxCommands:10 }
    ];

    // ===== Encouragements =====
    const ENCOURAGEMENTS = [
      "–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üåü", "–§–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–æ! üé®", "–°—É–ø–µ—Ä —Ä–æ–±–æ—Ç–∞! üí™", "–†–æ–∑—É–º–Ω–∏—Ü—è! üß†",
      "–ù–µ–π–º–æ–≤—ñ—Ä–Ω–æ! ‚ú®", "–¢–∏ –≥–µ–Ω—ñ–π! üöÄ", "–ß—É–¥–æ–≤–æ! üéØ", "–¢–∞–∫ —Ç—Ä–∏–º–∞—Ç–∏! üî•"
    ];

    const FRIENDLY_ERRORS = [
      "–û–π, —Ä–æ–±–æ—Ç –∑—É–ø–∏–Ω–∏–≤—Å—è –ø–µ—Ä–µ–¥ –¥–µ—Ä–µ–≤–æ–º! üå≥ –°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π —à–ª—è—Ö",
      "–ú–∞–π–∂–µ –≤–∏–π—à–ª–æ! –ê–ª–µ —Ä–æ–±–æ—Ç –ø–æ–∑–∞ –ø–æ–ª–µ–º ü§ñ –ü–µ—Ä–µ–≤—ñ—Ä –∫–æ–º–∞–Ω–¥–∏",
      "–•–º, —Ü–µ–π –º–∞—Ä—à—Ä—É—Ç –Ω–µ –≤–µ–¥–µ –¥–æ –∫—É–±–∫–∞ üèÜ –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!",
      "–†–æ–±–æ—Ç –∑–∞–±–ª—É–∫–∞–≤! üòÖ –ü–æ–¥—É–º–∞–π, –∫—É–¥–∏ –≤—ñ–Ω –º–∞—î –π—Ç–∏"
    ];

    // ===== Achievements =====
    const ACHIEVEMENTS = {
      firstStar: { icon:"‚≠ê", title:"–ü–µ—Ä—à–∞ –∑—ñ—Ä–∫–∞!", text:"–¢–∏ –∑–∞—Ä–æ–±–∏–≤ —Å–≤–æ—é –ø–µ—Ä—à—É –∑—ñ—Ä–∫—É!" },
      fiveStars: { icon:"üåü", title:"5 –∑—ñ—Ä–æ–∫!", text:"–£—Ö —Ç–∏! –í–∂–µ 5 –∑—ñ—Ä–æ–∫!" },
      tenStars: { icon:"‚ú®", title:"10 –∑—ñ—Ä–æ–∫!", text:"–ù–µ–π–º–æ–≤—ñ—Ä–Ω–æ! 10 –∑—ñ—Ä–æ–∫!" },
      halfwayDone: { icon:"üéØ", title:"–ü–æ–ª–æ–≤–∏–Ω–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!", text:"–¢–∏ –≤–∂–µ –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω—ñ!" },
      master: { icon:"üëë", title:"–ú–∞–π—Å—Ç–µ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤!", text:"–¢–∏ –ø—Ä–æ–π—à–æ–≤ —É—Å—ñ —Ä—ñ–≤–Ω—ñ!" }
    };

    // ===== State =====
    const gameState = {
      currentLevel: 0,
      commands: [],
      totalStars: 0,
      isExecuting: false,
      currentPos: null,
      soundEnabled: true,
      shownAchievements: new Set()
    };

    // ===== DOM =====
    const el = (id) => document.getElementById(id);
    const elements = {
      gameGrid: el('gameGrid'), commandSlots: el('commandSlots'), runBtn: el('runBtn'), clearBtn: el('clearBtn'),
      winModal: el('winModal'), errorModal: el('errorModal'), nextLevelBtn: el('nextLevelBtn'), 
      retryBtn: el('retryBtn'), closeErrBtn: el('closeErrBtn'),
      levelNum: el('levelNum'), totalLevels: el('totalLevels'), starsCount: el('starsCount'), 
      winMessage: el('winMessage'), errorMessage: el('errorMessage'),
      upBtn: el('upBtn'), downBtn: el('downBtn'), leftBtn: el('leftBtn'), rightBtn: el('rightBtn'),
      progressBar: el('progressBar'), encouragement: el('encouragement'), hintBubble: el('hintBubble'),
      hintText: el('hintText'), soundBtn: el('soundBtn'), achievementToast: el('achievementToast'),
      achievementIcon: el('achievementIcon'), achievementTitle: el('achievementTitle'),
      achievementText: el('achievementText'), winConfetti: el('winConfetti')
    };

    // ===== Utils =====
    const utils = {
      sleep: (ms) => new Promise(r => setTimeout(r, ms)),
      arraysEqual: (a,b) => a && b && a[0]===b[0] && a[1]===b[1],
      isValidPosition: (pos, level) => pos[0]>=0 && pos[0]<level.size && pos[1]>=0 && pos[1]<level.size && 
        !level.obstacles.some(o=>utils.arraysEqual(o,pos)),
      emojiClass: () => {
        const w = window.innerWidth;
        if (w < 480) return 'emoji-xs';
        if (w < 640) return 'emoji-sm';
        if (w < 1024) return 'emoji-md';
        return 'emoji-lg';
      },
      getCellSize: (level) => {
        const wrap = elements.gameGrid.parentElement;
        const rect = wrap.getBoundingClientRect();
        const gap = window.innerWidth < 640 ? 2 : 4;
        const columns = level.size;
        const maxGridWidth = Math.min(rect.width, 900);
        const size = Math.floor((maxGridWidth - (columns - 1) * gap) / columns);
        return Math.max(36, Math.min(size, 110));
      },
      randomChoice: (arr) => arr[Math.floor(Math.random() * arr.length)],
      playSound: (freq, duration=100) => {
        if (!gameState.soundEnabled) return;
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.value = 0.1;
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration/1000);
          osc.stop(ctx.currentTime + duration/1000);
        } catch(e) {}
      }
    };

    // ===== Sound Effects =====
    const sounds = {
      move: () => utils.playSound(400, 80),
      collect: () => utils.playSound(800, 150),
      win: () => {
        utils.playSound(523, 100);
        setTimeout(() => utils.playSound(659, 100), 100);
        setTimeout(() => utils.playSound(784, 200), 200);
      },
      error: () => utils.playSound(200, 200),
      click: () => utils.playSound(600, 50)
    };

    // ===== Achievements =====
    function checkAchievements() {
      const stars = gameState.totalStars;
      const level = gameState.currentLevel;
      
      if (stars === 1 && !gameState.shownAchievements.has('firstStar')) {
        showAchievement(ACHIEVEMENTS.firstStar);
        gameState.shownAchievements.add('firstStar');
      } else if (stars === 5 && !gameState.shownAchievements.has('fiveStars')) {
        showAchievement(ACHIEVEMENTS.fiveStars);
        gameState.shownAchievements.add('fiveStars');
      } else if (stars === 10 && !gameState.shownAchievements.has('tenStars')) {
        showAchievement(ACHIEVEMENTS.tenStars);
        gameState.shownAchievements.add('tenStars');
      }
      
      if (level === Math.floor(LEVELS.length/2) && !gameState.shownAchievements.has('halfwayDone')) {
        showAchievement(ACHIEVEMENTS.halfwayDone);
        gameState.shownAchievements.add('halfwayDone');
      }
      
      if (level === LEVELS.length - 1 && !gameState.shownAchievements.has('master')) {
        showAchievement(ACHIEVEMENTS.master);
        gameState.shownAchievements.add('master');
      }
    }

    function showAchievement(ach) {
      elements.achievementIcon.textContent = ach.icon;
      elements.achievementTitle.textContent = ach.title;
      elements.achievementText.textContent = ach.text;
      elements.achievementToast.classList.remove('hidden');
      
      setTimeout(() => {
        elements.achievementToast.style.transition = 'opacity 0.5s, transform 0.5s';
        elements.achievementToast.style.opacity = '0';
        elements.achievementToast.style.transform = 'translate(-50%, -20px)';
        setTimeout(() => {
          elements.achievementToast.classList.add('hidden');
          elements.achievementToast.style.opacity = '1';
          elements.achievementToast.style.transform = 'translate(-50%, 0)';
        }, 500);
      }, 3000);
    }

    // ===== Confetti =====
    function createConfetti() {
      const container = elements.winConfetti;
      container.innerHTML = '';
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7dc6f', '#ff8c94', '#c7f0bd'];
      
      for (let i = 0; i < 30; i++) {
        const bit = document.createElement('div');
        bit.className = 'confetti-bit';
        bit.style.left = Math.random() * 100 + '%';
        bit.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        bit.style.animationDelay = (Math.random() * 0.3) + 's';
        container.appendChild(bit);
      }
    }

    // ===== Level Management =====
    function ensureStars(level) {
      if (level.noItems) return;
      if (!Array.isArray(level.items)) level.items = [];
      if (level.items.length > 0) return;
      
      const n = level.size;
      const free = (r,c) => r>=0 && r<n && c>=0 && c<n && 
        !utils.arraysEqual([r,c], level.start) && 
        !utils.arraysEqual([r,c], level.end) &&
        !level.obstacles.some(o=>utils.arraysEqual(o,[r,c]));
      
      // Find safe spot near path
      const midR = Math.floor((level.start[0] + level.end[0]) / 2);
      const midC = Math.floor((level.start[1] + level.end[1]) / 2);
      
      if (free(midR, midC)) {
        level.items = [[midR, midC]];
      } else {
        // Find any free spot
        for (let r=0; r<n; r++) {
          for (let c=0; c<n; c++) {
            if (free(r,c)) {
              level.items = [[r,c]];
              return;
            }
          }
        }
      }
    }

    function updateProgress() {
      const progress = ((gameState.currentLevel + 1) / LEVELS.length) * 100;
      elements.progressBar.style.width = progress + '%';
    }

    function showHint(level) {
      if (level.hint && gameState.currentLevel < 4) {
        elements.hintText.textContent = level.hint;
        elements.hintBubble.classList.remove('hidden');
      } else {
        elements.hintBubble.classList.add('hidden');
      }
    }

    // ===== Init Level =====
    function initLevel() {
      const level = LEVELS[gameState.currentLevel];
      if (!level || !Number.isInteger(level.size) || level.size <= 0) {
        console.error('Invalid level:', level);
        return;
      }

      elements.totalLevels.textContent = LEVELS.length;
      elements.levelNum.textContent = gameState.currentLevel + 1;
      gameState.commands = Array(level.maxCommands).fill(null);
      gameState.currentPos = [...level.start];
      ensureStars(level);
      renderGrid(level);
      renderCommandSlots();
      updateProgress();
      showHint(level);
      elements.runBtn.disabled = false;
      gameState.isExecuting = false;
    }

    // ===== Render Grid =====
    function renderGrid(level) {
      const g = elements.gameGrid;
      g.classList.remove('grid-shaking');
      g.innerHTML = '';
      const cellSize = utils.getCellSize(level);
      const gap = window.innerWidth < 640 ? '2px' : '4px';
      g.style.display = 'grid';
      g.style.gridTemplateColumns = `repeat(${level.size}, ${cellSize}px)`;
      g.style.gap = gap;

      const emojiCls = utils.emojiClass();
      for (let r = 0; r < level.size; r++) {
        for (let c = 0; c < level.size; c++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell flex items-center justify-center bg-blue-50 rounded-lg';
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.setAttribute('role', 'gridcell');

          const pos = [r, c];
          if (utils.arraysEqual(pos, level.start)) {
            cell.innerHTML = `<div class="character ${emojiCls}" aria-label="–°—Ç–∞—Ä—Ç">ü§ñ</div>`;
            cell.classList.add('bg-green-200');
          } else if (utils.arraysEqual(pos, level.end)) {
            cell.innerHTML = `<div class="${emojiCls}" aria-label="–§—ñ–Ω—ñ—à">üèÜ</div>`;
            cell.classList.add('bg-yellow-200');
          } else if (level.obstacles.some(o => utils.arraysEqual(o, pos))) {
            cell.innerHTML = `<div class="${emojiCls}" aria-hidden="true">üå≥</div>`;
            cell.classList.add('bg-gray-300');
          } else if (level.items.some(it => utils.arraysEqual(it, pos))) {
            cell.innerHTML = `<div class="${emojiCls}" data-item="apple" aria-label="–Ø–±–ª—É–∫–æ">üçé</div>`;
            cell.classList.add('bg-red-100');
          }
          g.appendChild(cell);
        }
      }
    }

    // ===== Render Command Slots =====
    function renderCommandSlots() {
      const level = LEVELS[gameState.currentLevel];
      const wrap = elements.commandSlots;
      wrap.innerHTML = '';

      const maxCols = window.innerWidth < 640 ? 4 : 6;
      const cols = Math.min(level.maxCommands, maxCols);
      wrap.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      for (let i = 0; i < level.maxCommands; i++) {
        const slot = document.createElement('div');
        slot.className = 'command-slot flex items-center justify-center rounded-lg text-2xl sm:text-3xl md:text-4xl';
        slot.dataset.index = i;

        if (gameState.commands[i]) {
          slot.classList.add('filled');
          slot.innerHTML = ARROW_ICONS[gameState.commands[i]];
          slot.addEventListener('click', () => {
            if (!gameState.isExecuting) {
              sounds.click();
              gameState.commands[i] = null;
              renderCommandSlots();
            }
          });
        }
        wrap.appendChild(slot);
      }
    }

    // ===== Add Command =====
    function addCommand(direction) {
      if (gameState.isExecuting) return;
      sounds.click();
      
      const firstEmpty = gameState.commands.indexOf(null);
      if (firstEmpty !== -1) {
        gameState.commands[firstEmpty] = direction;
        renderCommandSlots();
      }
    }

    // ===== Clear Commands =====
    function clearCommands() {
      if (gameState.isExecuting) return;
      sounds.click();
      const level = LEVELS[gameState.currentLevel];
      gameState.commands = Array(level.maxCommands).fill(null);
      renderCommandSlots();
    }

    // ===== Get Cell Element =====
    function getCellElement(pos) {
      return elements.gameGrid.querySelector(`[data-row="${pos[0]}"][data-col="${pos[1]}"]`);
    }

    // ===== Update Character Position =====
    function updateCharacterPosition(newPos, noJump = false) {
      const level = LEVELS[gameState.currentLevel];
      const oldCell = getCellElement(gameState.currentPos);
      const newCell = getCellElement(newPos);

      if (oldCell) {
        const char = oldCell.querySelector('.character');
        if (char) char.remove();
        if (utils.arraysEqual(gameState.currentPos, level.start)) {
          oldCell.classList.add('bg-green-200');
        } else {
          oldCell.classList.remove('bg-green-200', 'landing');
        }
      }

      if (newCell) {
        const emojiCls = utils.emojiClass();
        const char = document.createElement('div');
        char.className = `character ${emojiCls}`;
        char.setAttribute('aria-label', '–†–æ–±–æ—Ç');
        char.textContent = 'ü§ñ';
        newCell.appendChild(char);
        
        if (!noJump) {
          newCell.classList.add('landing');
          setTimeout(() => newCell.classList.remove('landing'), 350);
        }
      }

      gameState.currentPos = newPos;
    }

    // ===== Execute Commands =====
    async function executeCommands() {
      if (gameState.isExecuting) return;
      
      const hasCommands = gameState.commands.some(c => c !== null);
      if (!hasCommands) {
        showError("–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏! –ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ —Å—Ç—Ä—ñ–ª–∫–∏ üëÜ", false);
        return;
      }

      gameState.isExecuting = true;
      elements.runBtn.disabled = true;

      const level = LEVELS[gameState.currentLevel];
      let pos = [...level.start];
      let collectedItems = 0;

      for (let i = 0; i < gameState.commands.length; i++) {
        const cmd = gameState.commands[i];
        if (!cmd) break;

        const [dr, dc] = DIRECTION_VECTORS[cmd];
        const newPos = [pos[0] + dr, pos[1] + dc];

        await utils.sleep(ANIMATION_SPEED);

        // Check collision
        if (!utils.isValidPosition(newPos, level)) {
          sounds.error();
          elements.gameGrid.classList.add('grid-shaking');
          setTimeout(() => elements.gameGrid.classList.remove('grid-shaking'), 400);
          
          const errorMsg = newPos[0] < 0 || newPos[0] >= level.size || 
                          newPos[1] < 0 || newPos[1] >= level.size
            ? "–†–æ–±–æ—Ç –ø–æ–∑–∞ –ø–æ–ª–µ–º! ü§ñ –ü–µ—Ä–µ–≤—ñ—Ä –∫–æ–º–∞–Ω–¥–∏"
            : "–û–π, —Ä–æ–±–æ—Ç –∑—É–ø–∏–Ω–∏–≤—Å—è –ø–µ—Ä–µ–¥ –¥–µ—Ä–µ–≤–æ–º! üå≥ –°–ø—Ä–æ–±—É–π —ñ–Ω—à–∏–π —à–ª—è—Ö";
          
          showError(errorMsg, true);
          gameState.isExecuting = false;
          elements.runBtn.disabled = false;
          return;
        }

        // Move character
        sounds.move();
        updateCharacterPosition(newPos);
        pos = newPos;

        // Check item collection
        const itemIdx = level.items.findIndex(it => utils.arraysEqual(it, pos));
        if (itemIdx !== -1) {
          sounds.collect();
          collectedItems++;
          const cell = getCellElement(pos);
          const apple = cell?.querySelector('[data-item="apple"]');
          if (apple) {
            apple.classList.add('collecting');
            setTimeout(() => apple.remove(), 600);
          }
          level.items.splice(itemIdx, 1);
        }
      }

      // Check win
      if (utils.arraysEqual(pos, level.end)) {
        sounds.win();
        gameState.totalStars += collectedItems;
        elements.starsCount.textContent = gameState.totalStars;
        checkAchievements();
        await utils.sleep(300);
        showWin(collectedItems);
      } else {
        sounds.error();
        showError(utils.randomChoice(FRIENDLY_ERRORS), true);
      }

      gameState.isExecuting = false;
      elements.runBtn.disabled = false;
    }

    // ===== Show Win =====
    function showWin(starsCollected) {
      createConfetti();
      elements.encouragement.textContent = utils.randomChoice(ENCOURAGEMENTS);
      
      if (starsCollected > 0) {
        // –í–ò–ü–†–ê–í–õ–ï–ù–û: "–∑—ñ—Ä–∫—É" -> "—è–±–ª—É–∫–æ". 1 —è–±–ª—É–∫–æ = 1 –∑—ñ—Ä–∫–∞ –¥–æ —Ä–∞—Ö—É–Ω–∫—É.
        const appleText = starsCollected === 1 ? '—è–±–ª—É–∫–æ' : (starsCollected > 1 && starsCollected < 5 ? '—è–±–ª—É–∫–∞' : '—è–±–ª—É–∫');
        elements.winMessage.textContent = `–¢–∏ –∑—ñ–±—Ä–∞–≤ ${starsCollected} ${appleText}! üçé (+${starsCollected} ‚≠ê –¥–æ —Ä–∞—Ö—É–Ω–∫—É)`;
      } else {
        elements.winMessage.textContent = "–¢–∏ –∑–Ω–∞–π—à–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö! üéØ";
      }
      
      if (gameState.currentLevel === LEVELS.length - 1) {
        elements.nextLevelBtn.textContent = "–í—ñ—Ç–∞—î–º–æ! üéä";
        elements.winMessage.textContent = `–¢–∏ –ø—Ä–æ–π—à–æ–≤ —É—Å—ñ ${LEVELS.length} —Ä—ñ–≤–Ω—ñ–≤! –ó—ñ–±—Ä–∞–Ω–æ –∑—ñ—Ä–æ–∫: ${gameState.totalStars} ‚≠ê`;
      }
      
      elements.winModal.classList.remove('hidden');
    }

    // ===== Show Error =====
    function showError(msg, canRetry) {
      elements.errorMessage.textContent = msg;
      elements.retryBtn.style.display = canRetry ? 'inline-block' : 'none';
      elements.errorModal.classList.remove('hidden');
    }

    // ===== Event Listeners =====
    elements.upBtn.addEventListener('click', () => addCommand('up'));
    elements.downBtn.addEventListener('click', () => addCommand('down'));
    elements.leftBtn.addEventListener('click', () => addCommand('left'));
    elements.rightBtn.addEventListener('click', () => addCommand('right'));
    elements.clearBtn.addEventListener('click', clearCommands);
    elements.runBtn.addEventListener('click', executeCommands);

    elements.nextLevelBtn.addEventListener('click', () => {
      elements.winModal.classList.add('hidden');
      if (gameState.currentLevel < LEVELS.length - 1) {
        gameState.currentLevel++;
        initLevel();
      } else {
        // Game completed - restart
        gameState.currentLevel = 0;
        gameState.totalStars = 0;
        gameState.shownAchievements.clear();
        elements.starsCount.textContent = '0';
        elements.nextLevelBtn.textContent = "–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å ‚û°Ô∏è";
        initLevel();
      }
    });

    elements.retryBtn.addEventListener('click', () => {
      elements.errorModal.classList.add('hidden');
      initLevel();
    });

    elements.closeErrBtn.addEventListener('click', () => {
      elements.errorModal.classList.add('hidden');
    });

    elements.soundBtn.addEventListener('click', () => {
      gameState.soundEnabled = !gameState.soundEnabled;
      const icon = elements.soundBtn.querySelector('i');
      if (gameState.soundEnabled) {
        icon.className = 'fas fa-volume-up text-xl';
        sounds.click();
      } else {
        icon.className = 'fas fa-volume-mute text-xl';
      }
    });

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (gameState.isExecuting) return;
      
      switch(e.key) {
        case 'ArrowUp': addCommand('up'); break;
        case 'ArrowDown': addCommand('down'); break;
        case 'ArrowLeft': addCommand('left'); break;
        case 'ArrowRight': addCommand('right'); break;
        case 'Enter': executeCommands(); break;
        case 'Escape': clearCommands(); break;
      }
    });

    // Responsive reflow
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const level = LEVELS[gameState.currentLevel];
        renderGrid(level);
        if (gameState.currentPos && !utils.arraysEqual(gameState.currentPos, level.start)) {
          updateCharacterPosition(gameState.currentPos, true);
        }
      }, 250);
    });

    // ===== Initialize Game =====
    initLevel();
  </script>
</body>
</html>

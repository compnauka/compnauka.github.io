<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>–°–õ–ê–ô–î–ò–ö Kids üé®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800;900&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --h: 64px;
      --sidebar: 220px;
      --primary: #6C63FF;
      --primary-dark: #4F46E5;
      --secondary: #FF6584;
      --accent: #FFD166;
      --green: #06D6A0;
      --orange: #FF9F1C;
      --bg-app: #EEE9FF;
      --bg-header: #1a0a3c;
      --bg-sidebar: #1a0a3c;
      --slide-w: 960px;
      --slide-h: 540px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;margin:0;padding:0;}
    body{
      font-family:'Baloo 2','Nunito',sans-serif;
      background:var(--bg-app);
      user-select:none;
      overflow:hidden;
      background-image: radial-gradient(ellipse at 10% 10%, rgba(108,99,255,.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 90% 80%, rgba(255,101,132,.12) 0%, transparent 50%);
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    #appHeader{
      height:var(--h);
      background:linear-gradient(135deg,#1a0a3c 0%,#2d1060 100%);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 16px;flex-shrink:0;gap:8px;
      border-bottom:3px solid rgba(108,99,255,.5);
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      position:relative;z-index:100;
    }
    .logo-wrap{display:flex;align-items:center;gap:10px;}
    .logo-icon{
      width:44px;height:44px;
      background:linear-gradient(135deg,#FF6584,#FFD166);
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      box-shadow:0 4px 12px rgba(255,101,132,.5);
      animation:logoBounce 3s ease-in-out infinite;
    }
    @keyframes logoBounce{0%,100%{transform:translateY(0) rotate(-3deg);}50%{transform:translateY(-4px) rotate(3deg);}}
    .logo-name{
      font-size:22px;font-weight:900;
      background:linear-gradient(90deg,#f9a8d4,#fcd34d,#6ee7b7);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      letter-spacing:.5px;
    }
    .logo-badge{
      background:#FF6584;color:#fff;
      font-size:9px;font-weight:900;letter-spacing:.5px;
      padding:2px 7px;border-radius:20px;
      text-transform:uppercase;
    }
    .header-center{display:flex;align-items:center;gap:6px;}
    .hbtn{
      display:flex;align-items:center;gap:6px;
      padding:9px 16px;border:none;cursor:pointer;
      font-family:'Baloo 2',sans-serif;font-size:13px;font-weight:800;
      border-radius:14px;transition:transform .12s,box-shadow .15s,opacity .12s;
      letter-spacing:.3px;white-space:nowrap;
    }
    .hbtn:hover{transform:translateY(-2px);}
    .hbtn:active{transform:translateY(0);opacity:.85;}
    .hbtn-undo{background:#2d1060;color:#c4b5fd;border:2px solid #4c3d80;}
    .hbtn-undo:disabled{opacity:.35;cursor:not-allowed;transform:none;}
    .hbtn-present{
      background:linear-gradient(135deg,#10b981,#059669);
      color:#fff;font-size:14px;padding:10px 20px;
      box-shadow:0 4px 16px rgba(16,185,129,.4);
    }
    .hbtn-pdf{background:linear-gradient(135deg,#6C63FF,#4F46E5);color:#fff;box-shadow:0 3px 12px rgba(108,99,255,.4);}
    .hbtn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;box-shadow:0 3px 12px rgba(239,68,68,.4);}

    /* ‚îÄ‚îÄ‚îÄ BODY LAYOUT ‚îÄ‚îÄ‚îÄ */
    #appBody{display:flex;height:calc(100vh - var(--h));overflow:hidden;}

    /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
    #sidebar{
      width:var(--sidebar);flex-shrink:0;
      background:linear-gradient(180deg,#1a0a3c 0%,#140830 100%);
      display:flex;flex-direction:column;
      border-right:3px solid rgba(108,99,255,.3);
      overflow:hidden;
    }
    .sb-new-btn{
      margin:10px;padding:14px;border:none;cursor:pointer;
      background:linear-gradient(135deg,#10b981,#059669);color:#fff;
      border-radius:16px;font-family:'Baloo 2',sans-serif;
      font-size:14px;font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition:transform .12s,box-shadow .15s;
      box-shadow:0 4px 14px rgba(16,185,129,.4);
      letter-spacing:.3px;
    }
    .sb-new-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(16,185,129,.5);}
    .sb-new-btn:active{transform:scale(.97);}
    .sb-new-btn .plus-icon{font-size:20px;line-height:1;}

    #slideList{
      flex:1;overflow-y:auto;padding:6px 8px;
      display:flex;flex-direction:column;gap:7px;
    }
    #slideList::-webkit-scrollbar{width:3px;}
    #slideList::-webkit-scrollbar-thumb{background:#4c3d80;border-radius:2px;}

    .slide-item{
      position:relative;border-radius:12px;border:3px solid transparent;
      cursor:pointer;overflow:hidden;
      transition:border-color .15s,transform .12s,box-shadow .15s;
    }
    .slide-item:hover{transform:scale(1.02);}
    .slide-item.active{
      border-color:#6C63FF;
      box-shadow:0 0 0 4px rgba(108,99,255,.25);
    }
    .slide-num{
      position:absolute;bottom:4px;right:5px;
      font-size:10px;font-weight:900;
      background:rgba(0,0,0,.5);color:#fff;
      padding:2px 6px;border-radius:6px;z-index:5;
    }
    .slide-actions{position:absolute;top:4px;right:4px;display:none;gap:3px;z-index:10;}
    .slide-item:hover .slide-actions,.slide-item.active .slide-actions{display:flex;}
    .sa-btn{
      width:24px;height:24px;border:none;cursor:pointer;
      border-radius:6px;font-size:10px;
      display:flex;align-items:center;justify-content:center;color:#fff;
    }
    .sa-dup{background:rgba(108,99,255,.85);}
    .sa-del{background:rgba(239,68,68,.85);}
    .thumb-wrap{width:100%;padding-bottom:56.25%;position:relative;background:#fff;overflow:hidden;border-radius:9px;}
    .thumb-inner{position:absolute;top:0;left:0;width:960px;height:540px;transform-origin:top left;pointer-events:none;}

    .sb-footer{padding:8px;border-top:2px solid rgba(108,99,255,.2);}
    .sb-tpl-btn{
      width:100%;padding:11px;border:2px solid #4c3d80;cursor:pointer;
      background:#2d1060;color:#c4b5fd;
      border-radius:14px;font-family:'Baloo 2',sans-serif;
      font-size:12px;font-weight:800;
      display:flex;align-items:center;justify-content:center;gap:6px;
      transition:transform .12s,background .15s;
    }
    .sb-tpl-btn:hover{background:#3d2070;transform:translateY(-1px);}

    /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
    #main{flex:1;display:flex;flex-direction:column;overflow:hidden;}

    /* ‚îÄ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ‚îÄ */
    #toolbar{
      background:#fff;border-bottom:2px solid #e8e0ff;
      padding:6px 10px;display:flex;align-items:stretch;gap:0;
      overflow-x:auto;flex-shrink:0;
      box-shadow:0 3px 12px rgba(108,99,255,.08);
    }
    #toolbar::-webkit-scrollbar{height:3px;}
    #toolbar::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:2px;}
    .tb-section{
      display:flex;flex-direction:column;gap:3px;
      padding:2px 10px;position:relative;flex-shrink:0;
    }
    .tb-section+.tb-section{border-left:2px solid #f0e8ff;}
    .tb-sec-label{
      font-size:8px;font-weight:900;letter-spacing:1.5px;
      text-transform:uppercase;color:#b39ddb;
      text-align:center;margin-bottom:1px;
    }
    .tb-row{display:flex;align-items:center;gap:4px;}

    /* Big action button */
    .tb-big{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      min-width:60px;height:54px;padding:0 8px;
      border:none;cursor:pointer;border-radius:14px;
      font-family:'Baloo 2',sans-serif;
      transition:transform .12s,box-shadow .15s,filter .12s;
      gap:2px;flex-shrink:0;position:relative;
    }
    .tb-big:hover{transform:translateY(-2px);}
    .tb-big:active{transform:scale(.94);}
    .tb-big .big-icon{font-size:22px;line-height:1;}
    .tb-big .big-label{font-size:9px;font-weight:900;letter-spacing:.3px;white-space:nowrap;}

    .tb-add-text{background:linear-gradient(135deg,#dbeafe,#c7d2fe);color:#1d4ed8;}
    .tb-add-text:hover{box-shadow:0 4px 14px rgba(59,130,246,.3);}
    .tb-add-photo{background:linear-gradient(135deg,#ede9fe,#fce7f3);color:#7c3aed;}
    .tb-add-photo:hover{box-shadow:0 4px 14px rgba(139,92,246,.3);}
    .tb-add-emoji{background:linear-gradient(135deg,#fef3c7,#fed7aa);color:#92400e;}
    .tb-add-emoji:hover{box-shadow:0 4px 14px rgba(245,158,11,.3);}

    /* Shape buttons */
    .tb-shape{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      width:48px;height:48px;border:none;cursor:pointer;border-radius:12px;
      font-family:'Baloo 2',sans-serif;
      transition:transform .12s,box-shadow .12s;
      gap:1px;flex-shrink:0;
    }
    .tb-shape:hover{transform:translateY(-2px);}
    .tb-shape:active{transform:scale(.92);}
    .tb-shape .sh-icon{font-size:20px;line-height:1;}
    .tb-shape .sh-label{font-size:8px;font-weight:800;letter-spacing:.2px;white-space:nowrap;}
    .sh-rect{background:#dbeafe;color:#1d4ed8;}
    .sh-circle{background:#fce7f3;color:#be185d;}
    .sh-star{background:#fef3c7;color:#92400e;}
    .sh-heart{background:#fce7f3;color:#e11d48;}
    .sh-tri{background:#dcfce7;color:#166534;}

    /* Small tool button */
    .tb-sm{
      width:38px;height:38px;border:none;cursor:pointer;border-radius:10px;
      background:transparent;color:#475569;font-size:14px;
      display:flex;align-items:center;justify-content:center;
      transition:background .15s,color .15s,transform .12s;flex-shrink:0;
    }
    .tb-sm:hover{background:#f1f5f9;color:#1a1040;}
    .tb-sm:active{transform:scale(.9);}
    .tb-sm.active-btn{background:#EDE9FE;color:var(--primary);}

    /* Color swatch */
    .col-swatch{
      width:30px;height:30px;border-radius:9px;border:2.5px solid #e2e8f0;
      cursor:pointer;transition:transform .12s,box-shadow .12s;flex-shrink:0;
    }
    .col-swatch:hover{transform:scale(1.18);box-shadow:0 3px 8px rgba(0,0,0,.2);}

    #selFontSize{
      height:38px;padding:0 8px;border:2px solid #e2e8f0;border-radius:10px;
      font-family:'Baloo 2',sans-serif;font-size:13px;font-weight:700;
      color:#1a1040;background:#f8fafc;cursor:pointer;outline:none;min-width:70px;
    }
    #selFontSize:focus{border-color:var(--primary);}

    #slideCounter{
      font-size:12px;font-weight:800;color:#7c6faa;
      white-space:nowrap;padding:0 8px;
      background:#f5f0ff;border-radius:10px;
      display:flex;align-items:center;
    }

    /* ‚îÄ‚îÄ‚îÄ WORKSPACE ‚îÄ‚îÄ‚îÄ */
    #workspace{
      flex:1;overflow:auto;
      display:flex;align-items:center;justify-content:center;
      padding:28px;
      background:
        radial-gradient(circle at 15% 25%,rgba(108,99,255,.08) 0%,transparent 55%),
        radial-gradient(circle at 85% 75%,rgba(255,101,132,.07) 0%,transparent 55%),
        #e8e0ff;
      position:relative;
    }
    #workspace::before{
      content:'';position:absolute;inset:0;opacity:.4;
      background-image:
        radial-gradient(circle,#c7b8ff 1px,transparent 1px);
      background-size:28px 28px;pointer-events:none;
    }
    #stageWrap{position:relative;flex-shrink:0;}
    #stage{
      width:960px;height:540px;background:#fff;
      position:relative;overflow:hidden;transform-origin:top left;
      box-shadow:0 0 0 4px rgba(108,99,255,.2),0 24px 64px rgba(0,0,0,.22),0 6px 16px rgba(0,0,0,.1);
      border-radius:4px;
    }

    /* ‚îÄ‚îÄ‚îÄ Elements ‚îÄ‚îÄ‚îÄ */
    .el{
      position:absolute;box-sizing:border-box;
      border:2.5px solid transparent;
      min-width:40px;min-height:30px;cursor:grab;touch-action:none;
    }
    .el.selected{border-color:var(--primary);cursor:grab;}
    .el.selected::after{
      content:'';position:absolute;inset:-7px;
      border:2px dashed rgba(108,99,255,.45);
      pointer-events:none;border-radius:3px;
    }
    .el.dragging{cursor:grabbing;}
    .el .content{width:100%;height:100%;overflow:hidden;}
    .textBox{
      width:100%;height:100%;padding:8px;
      user-select:text!important;cursor:text;outline:none;
      line-height:1.25;word-break:break-word;white-space:pre-wrap;
      background:transparent;
    }
    .shape{width:100%;height:100%;}
    .handles{display:none;position:absolute;inset:0;pointer-events:none;}
    .el.selected .handles{display:block;}
    .handle{
      width:13px;height:13px;background:#fff;
      border:2.5px solid var(--primary);border-radius:4px;
      position:absolute;pointer-events:auto;
      box-shadow:0 2px 6px rgba(0,0,0,.22);
    }
    .handle.nw{left:-7px;top:-7px;cursor:nwse-resize;}
    .handle.n{left:50%;top:-7px;transform:translateX(-50%);cursor:ns-resize;}
    .handle.ne{right:-7px;top:-7px;cursor:nesw-resize;}
    .handle.e{right:-7px;top:50%;transform:translateY(-50%);cursor:ew-resize;}
    .handle.se{right:-7px;bottom:-7px;cursor:nwse-resize;}
    .handle.s{left:50%;bottom:-7px;transform:translateX(-50%);cursor:ns-resize;}
    .handle.sw{left:-7px;bottom:-7px;cursor:nesw-resize;}
    .handle.w{left:-7px;top:50%;transform:translateY(-50%);cursor:ew-resize;}

    /* ‚îÄ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ‚îÄ */
    #statusBar{
      height:28px;background:#140830;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 14px;flex-shrink:0;
    }
    #statusBar span{font-size:9px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:#5b4f8a;}
    #saveStatus{color:#a78bfa!important;}
    #saveStatus.saved{color:#10b981!important;}

    /* ‚îÄ‚îÄ‚îÄ POPOVERS ‚îÄ‚îÄ‚îÄ */
    .popover{
      position:absolute;top:50%;left:50%;
      transform:translate(-50%,-50%);
      background:#fff;border-radius:20px;border:2px solid #e8e0ff;
      box-shadow:0 24px 64px rgba(0,0,0,.18),0 0 0 1px rgba(108,99,255,.1);
      padding:18px;z-index:200;
      animation:popIn .2s cubic-bezier(.34,1.56,.64,1);
    }
    @keyframes popIn{from{opacity:0;transform:translate(-50%,-50%) scale(.85);}to{opacity:1;transform:translate(-50%,-50%) scale(1);}}
    .popover-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .popover-title{font-size:12px;font-weight:900;letter-spacing:1px;text-transform:uppercase;color:#7c6faa;}
    .popover-close{
      width:28px;height:28px;border:none;cursor:pointer;
      background:#f5f0ff;border-radius:8px;color:#7c6faa;font-size:13px;
      display:flex;align-items:center;justify-content:center;transition:background .15s;
    }
    .popover-close:hover{background:#ede9fe;color:#4c3d80;}
    .color-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;}
    .color-btn{
      width:30px;height:30px;border:2.5px solid transparent;
      border-radius:9px;cursor:pointer;
      transition:transform .12s,border-color .12s,box-shadow .12s;
    }
    .color-btn:hover{transform:scale(1.22);box-shadow:0 3px 8px rgba(0,0,0,.2);}
    .color-btn.picked{border-color:#1a1040;}
    .color-section{margin-bottom:14px;}
    .color-section-label{font-size:10px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:#b39ddb;margin-bottom:7px;}
    .custom-color-wrap{margin-top:12px;display:flex;align-items:center;gap:10px;}
    .custom-color-wrap label{font-size:11px;font-weight:700;color:#7c6faa;}
    .custom-color-input{width:40px;height:40px;border:none;border-radius:10px;cursor:pointer;padding:2px;}

    .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;max-height:220px;overflow-y:auto;}
    .emoji-btn{
      width:40px;height:40px;border:none;background:transparent;cursor:pointer;
      border-radius:10px;font-size:24px;
      display:flex;align-items:center;justify-content:center;
      transition:background .12s,transform .12s;
    }
    .emoji-btn:hover{background:#f5f0ff;transform:scale(1.18);}

    /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
    #modalOverlay{
      position:fixed;inset:0;background:rgba(26,10,60,.75);
      backdrop-filter:blur(6px);display:none;
      align-items:center;justify-content:center;z-index:1000;padding:16px;
    }
    #modalOverlay.show{display:flex;}
    #modal{
      background:#fff;border-radius:24px;padding:28px;
      max-width:520px;width:100%;
      box-shadow:0 32px 80px rgba(0,0,0,.3),0 0 0 1px rgba(108,99,255,.1);
      position:relative;animation:modalIn .22s cubic-bezier(.34,1.56,.64,1);
    }
    @keyframes modalIn{from{opacity:0;transform:scale(.88)translateY(10px);}to{opacity:1;transform:scale(1)translateY(0);}}
    #modalTitle{font-size:20px;font-weight:900;color:#1a1040;text-align:center;margin-bottom:16px;}
    #modalBody{margin-bottom:22px;}
    #modalActions{display:flex;gap:10px;}
    .modal-btn{
      flex:1;padding:13px;border:none;cursor:pointer;border-radius:14px;
      font-family:'Baloo 2',sans-serif;font-size:14px;font-weight:800;
      transition:transform .12s,opacity .12s;
    }
    .modal-btn:hover{transform:translateY(-1px);}
    .modal-btn:active{opacity:.8;transform:translateY(0);}
    .modal-cancel{background:#f5f0ff;color:#7c6faa;}
    .modal-ok{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:#fff;box-shadow:0 4px 14px rgba(108,99,255,.4);
    }
    .modal-close{
      position:absolute;top:14px;right:14px;width:32px;height:32px;
      border:none;cursor:pointer;background:#f5f0ff;
      border-radius:9px;color:#94a3b8;font-size:15px;
      display:flex;align-items:center;justify-content:center;
      transition:background .15s;
    }
    .modal-close:hover{background:#ede9fe;color:#6C63FF;}

    /* Template grid */
    .tpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .tpl-card{
      padding:16px;border:2.5px solid #e8e0ff;border-radius:16px;
      cursor:pointer;text-align:center;
      transition:border-color .15s,background .15s,transform .12s,box-shadow .12s;
    }
    .tpl-card:hover{border-color:var(--primary);background:#f5f0ff;transform:translateY(-3px);box-shadow:0 8px 20px rgba(108,99,255,.15);}
    .tpl-card .tpl-icon{font-size:32px;margin-bottom:7px;}
    .tpl-card .tpl-name{font-size:13px;font-weight:900;color:#1a1040;}
    .tpl-card .tpl-desc{font-size:10px;font-weight:700;color:#b39ddb;margin-top:3px;}

    /* Image dialog */
    .img-tab-row{display:flex;gap:8px;margin-bottom:14px;}
    .img-tab{
      flex:1;padding:10px;border:2.5px solid #e8e0ff;border-radius:12px;
      font-family:'Baloo 2',sans-serif;font-size:12px;font-weight:800;
      cursor:pointer;color:#7c6faa;background:transparent;transition:all .15s;
    }
    .img-tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
    .drop-zone{
      border:2.5px dashed #c7b8ff;border-radius:14px;padding:32px;
      text-align:center;cursor:pointer;transition:all .15s;background:#f5f0ff;
    }
    .drop-zone:hover,.drop-zone.drag-over{background:#ede9fe;border-color:var(--primary);}
    .drop-zone .dz-icon{font-size:40px;margin-bottom:10px;}
    .drop-zone .dz-text{font-size:13px;font-weight:700;color:#7c6faa;}

    /* ‚îÄ‚îÄ‚îÄ PRESENTATION ‚îÄ‚îÄ‚îÄ */
    #presentOverlay{
      display:none;position:fixed;inset:0;background:#000;
      z-index:2000;flex-direction:column;align-items:center;justify-content:center;
    }
    #presentOverlay.show{display:flex;}
    #presentStageWrap{position:relative;flex-shrink:0;}
    #presentNavBar{
      position:fixed;bottom:0;left:0;right:0;height:56px;
      display:flex;align-items:center;justify-content:center;gap:14px;
      background:linear-gradient(transparent,rgba(0,0,0,.85));
      opacity:0;transition:opacity .3s;
    }
    #presentOverlay:hover #presentNavBar{opacity:1;}
    .pnav-btn{
      width:44px;height:44px;border:2px solid rgba(255,255,255,.3);
      background:rgba(255,255,255,.1);color:#fff;cursor:pointer;
      border-radius:14px;font-size:18px;
      display:flex;align-items:center;justify-content:center;
      backdrop-filter:blur(4px);transition:background .15s;
    }
    .pnav-btn:hover{background:rgba(255,255,255,.25);}
    #presentCounter{
      font-family:'Baloo 2',sans-serif;font-size:14px;font-weight:900;
      color:rgba(255,255,255,.8);min-width:64px;text-align:center;
    }
    #presentProgress{
      position:fixed;top:0;left:0;height:4px;
      background:linear-gradient(90deg,#6C63FF,#FF6584,#FFD166);
      transition:width .35s ease;border-radius:0 3px 3px 0;
    }
    #presentClose{
      position:fixed;top:14px;right:14px;width:44px;height:44px;
      background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.2);
      cursor:pointer;border-radius:12px;color:#fff;font-size:18px;
      display:flex;align-items:center;justify-content:center;
      opacity:0;transition:opacity .3s,background .15s;
    }
    #presentOverlay:hover #presentClose{opacity:1;}
    #presentClose:hover{background:rgba(255,255,255,.25);}

    /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
    #toast{
      position:fixed;bottom:44px;left:50%;
      transform:translateX(-50%) translateY(20px);
      background:linear-gradient(135deg,#1a0a3c,#2d1060);
      color:#c4b5fd;padding:11px 22px;border-radius:16px;
      font-size:13px;font-weight:800;
      box-shadow:0 10px 28px rgba(0,0,0,.3),0 0 0 1px rgba(108,99,255,.3);
      opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.34,1.56,.64,1);
      z-index:3000;letter-spacing:.3px;
    }
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

    /* ‚îÄ‚îÄ‚îÄ WELCOME MODAL ‚îÄ‚îÄ‚îÄ */
    #welcomeOverlay{
      position:fixed;inset:0;background:rgba(26,10,60,.8);
      backdrop-filter:blur(8px);
      display:flex;align-items:center;justify-content:center;
      z-index:2000;padding:16px;
    }
    #welcomeBox{
      background:#fff;border-radius:28px;padding:36px;
      max-width:480px;width:100%;
      box-shadow:0 40px 100px rgba(0,0,0,.35);
      text-align:center;
      animation:modalIn .3s cubic-bezier(.34,1.56,.64,1);
    }
    .welcome-mascot{font-size:72px;animation:bounce 1s ease-in-out infinite alternate;display:block;margin-bottom:4px;}
    @keyframes bounce{from{transform:translateY(0);}to{transform:translateY(-12px);}}
    .welcome-title{font-size:28px;font-weight:900;color:#1a1040;margin-bottom:6px;}
    .welcome-sub{font-size:14px;font-weight:700;color:#7c6faa;margin-bottom:24px;line-height:1.5;}
    .welcome-steps{display:flex;flex-direction:column;gap:10px;margin-bottom:28px;text-align:left;}
    .welcome-step{
      display:flex;align-items:center;gap:14px;
      background:#f5f0ff;border-radius:14px;padding:12px 16px;
      font-size:13px;font-weight:700;color:#4c3d80;
    }
    .welcome-step .step-icon{font-size:28px;flex-shrink:0;}
    .welcome-start{
      width:100%;padding:16px;border:none;cursor:pointer;
      background:linear-gradient(135deg,#6C63FF,#FF6584);color:#fff;
      border-radius:18px;font-family:'Baloo 2',sans-serif;
      font-size:18px;font-weight:900;letter-spacing:.3px;
      box-shadow:0 6px 20px rgba(108,99,255,.4);
      transition:transform .12s,box-shadow .15s;
    }
    .welcome-start:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(108,99,255,.5);}
    .welcome-start:active{transform:scale(.97);}

    /* ‚îÄ‚îÄ‚îÄ Field ‚îÄ‚îÄ‚îÄ */
    .field{
      width:100%;padding:11px 14px;border:2.5px solid #e8e0ff;border-radius:12px;
      font-family:'Baloo 2',sans-serif;font-size:13px;font-weight:600;color:#1a1040;
      outline:none;transition:border-color .15s;
    }
    .field:focus{border-color:var(--primary);}

    /* ‚îÄ‚îÄ‚îÄ Misc ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar{width:6px;height:6px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:#c7b8ff;border-radius:3px;}
    img{-webkit-user-drag:none;user-select:none;}
    button:focus-visible,select:focus-visible,input:focus-visible{outline:3px solid #818cf8;outline-offset:2px;}

    /* Sidebar move buttons */
    .sb-move-row{display:flex;gap:6px;padding:0 8px 8px;}
    .sb-move-btn{
      flex:1;padding:7px;background:#2d1060;border:2px solid #4c3d80;
      border-radius:10px;color:#7c6faa;font-size:12px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:4px;
      font-family:'Baloo 2',sans-serif;font-size:10px;font-weight:700;
      transition:background .15s,transform .12s;
    }
    .sb-move-btn:hover{background:#3d2070;transform:translateY(-1px);}
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header id="appHeader">
  <div class="logo-wrap">
    <div class="logo-icon">üé®</div>
    <div class="logo-name">–°–õ–ê–ô–î–ò–ö</div>
    <div class="logo-badge">Kids</div>
  </div>
  <div class="header-center">
    <button class="hbtn hbtn-undo" id="btnUndo" title="–ù–∞–∑–∞–¥ (Ctrl+Z)">
      <i class="fa-solid fa-rotate-left"></i><span>–ù–∞–∑–∞–¥</span>
    </button>
    <button class="hbtn hbtn-undo" id="btnRedo" title="–í–ø–µ—Ä–µ–¥ (Ctrl+Y)">
      <i class="fa-solid fa-rotate-right"></i><span>–í–ø–µ—Ä–µ–¥</span>
    </button>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <button class="hbtn hbtn-present" id="btnPresent">
      <i class="fa-solid fa-play"></i> ‚ñ∂ –ü–û–ö–ê–ó–ê–¢–ò!
    </button>
    <button class="hbtn hbtn-pdf" id="btnPDF">
      <i class="fa-solid fa-print"></i> –†–æ–∑–¥—Ä—É–∫—É–≤–∞—Ç–∏
    </button>
    <button class="hbtn hbtn-danger" id="btnReset" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Åe">
      <i class="fa-solid fa-trash"></i>
    </button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê BODY ‚ïê‚ïê‚ïê -->
<div id="appBody">

  <!-- Sidebar -->
  <aside id="sidebar">
    <button class="sb-new-btn" id="btnNewSlide">
      <span class="plus-icon">‚ûï</span> –ù–æ–≤–∏–π —Å–ª–∞–π–¥
    </button>
    <div id="slideList"></div>
    <div class="sb-move-row">
      <button class="sb-move-btn" id="btnSlideUp"><i class="fa-solid fa-arrow-up"></i> –í–≥–æ—Ä—É</button>
      <button class="sb-move-btn" id="btnSlideDown"><i class="fa-solid fa-arrow-down"></i> –í–Ω–∏–∑</button>
    </div>
    <div class="sb-footer">
      <button class="sb-tpl-btn" id="btnTemplates">
        <i class="fa-solid fa-magic-wand-sparkles"></i> üéÅ –ì–æ—Ç–æ–≤—ñ –º–∞–∫–µ—Ç–∏
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main id="main">
    <!-- ‚ïê‚ïê‚ïê TOOLBAR ‚ïê‚ïê‚ïê -->
    <div id="toolbar">

      <!-- –°–õ–ê–ô–î -->
      <div class="tb-section">
        <div class="tb-sec-label">üìÑ –°–ª–∞–π–¥</div>
        <div class="tb-row">
          <button class="tb-sm" id="btnDupSlide" title="–ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Å–ª–∞–π–¥">
            <i class="fa-regular fa-copy" style="color:#6C63FF;font-size:16px;"></i>
          </button>
          <button class="tb-sm" id="btnDelSlide" title="–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–∞–π–¥">
            <i class="fa-regular fa-trash-can" style="color:#ef4444;font-size:16px;"></i>
          </button>
          <button class="tb-sm" id="btnBg" title="–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É">
            <span style="font-size:20px;">üé®</span>
          </button>
        </div>
      </div>

      <!-- –î–û–î–ê–¢–ò -->
      <div class="tb-section">
        <div class="tb-sec-label">‚ûï –î–æ–¥–∞—Ç–∏</div>
        <div class="tb-row">
          <button class="tb-big tb-add-text" id="btnAddText" title="–ù–∞–ø–∏—Å–∞—Ç–∏ —Ç–µ–∫—Å—Ç">
            <span class="big-icon">‚úèÔ∏è</span>
            <span class="big-label">–ù–∞–ø–∏—Å–∞—Ç–∏</span>
          </button>
          <button class="tb-big tb-add-photo" id="btnAddImage" title="–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ">
            <span class="big-icon">üì∑</span>
            <span class="big-label">–§–æ—Ç–∫—É</span>
          </button>
          <button class="tb-big tb-add-emoji" id="btnEmoji" title="–î–æ–¥–∞—Ç–∏ —Å–º–∞–π–ª–∏–∫">
            <span class="big-icon">üòä</span>
            <span class="big-label">–°–º–∞–π–ª–∏–∫</span>
          </button>
        </div>
      </div>

      <!-- –§–Ü–ì–£–†–ò -->
      <div class="tb-section">
        <div class="tb-sec-label">üî∑ –§—ñ–≥—É—Ä–∏</div>
        <div class="tb-row">
          <button class="tb-shape sh-rect" id="btnShapeRect" title="–ü—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫">
            <span class="sh-icon">‚ñ≠</span>
            <span class="sh-label">–ü—Ä—è–º–æ–∫—É—Ç</span>
          </button>
          <button class="tb-shape sh-circle" id="btnShapeCircle" title="–ö–æ–ª–æ">
            <span class="sh-icon">‚≠ï</span>
            <span class="sh-label">–ö–æ–ª–æ</span>
          </button>
          <button class="tb-shape sh-star" id="btnShapeStar" title="–ó—ñ—Ä–∫–∞">
            <span class="sh-icon">‚≠ê</span>
            <span class="sh-label">–ó—ñ—Ä–∫–∞</span>
          </button>
          <button class="tb-shape sh-heart" id="btnShapeHeart" title="–°–µ—Ä—Ü–µ">
            <span class="sh-icon">‚ù§Ô∏è</span>
            <span class="sh-label">–°–µ—Ä—Ü–µ</span>
          </button>
          <button class="tb-shape sh-tri" id="btnShapeTri" title="–¢—Ä–∏–∫—É—Ç–Ω–∏–∫">
            <span class="sh-icon">üî∫</span>
            <span class="sh-label">–¢—Ä–∏–∫—É—Ç–Ω–∏–∫</span>
          </button>
        </div>
      </div>

      <!-- –¢–ï–ö–°–¢ -->
      <div class="tb-section">
        <div class="tb-sec-label">‚úèÔ∏è –¢–µ–∫—Å—Ç</div>
        <div class="tb-row" style="align-items:center;">
          <select id="selFontSize" title="–†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É">
            <option value="16">–ö—Ä–∏—Ö—ñ—Ç–Ω–∏–π</option>
            <option value="22">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
            <option value="32" selected>–°–µ—Ä–µ–¥–Ω—ñ–π</option>
            <option value="44">–í–µ–ª–∏–∫–∏–π</option>
            <option value="60">–î—É–∂–µ –≤–µ–ª–∏–∫–∏–π</option>
            <option value="80">–í–µ–ª–µ—Ç–µ–Ω—å!</option>
          </select>
          <button class="tb-sm" id="btnBold" title="–ñ–∏—Ä–Ω–∏–π"><b>–ñ</b></button>
          <button class="tb-sm" id="btnItalic" title="–ù–∞—Ö–∏–ª–µ–Ω–∏–π"><i>–ö</i></button>
          <button class="tb-sm" id="btnUnderline" title="–ü—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–∏–π"><u>–ü</u></button>
          <div style="width:1px;height:22px;background:#e8e0ff;margin:0 2px;"></div>
          <button class="tb-sm" id="btnAlignLeft" title="–õ—ñ–≤–æ—Ä—É—á"><i class="fa-solid fa-align-left"></i></button>
          <button class="tb-sm" id="btnAlignCenter" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É"><i class="fa-solid fa-align-center"></i></button>
          <button class="tb-sm" id="btnAlignRight" title="–ü—Ä–∞–≤–æ—Ä—É—á"><i class="fa-solid fa-align-right"></i></button>
          <div style="width:1px;height:22px;background:#e8e0ff;margin:0 2px;"></div>
          <button class="tb-sm" id="btnTextColor" title="–ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É" style="font-size:18px;">üñäÔ∏è</button>
        </div>
      </div>

      <!-- –û–ë'–Ñ–ö–¢ -->
      <div class="tb-section">
        <div class="tb-sec-label">üé® –§—ñ–≥—É—Ä–∞</div>
        <div class="tb-row">
          <button class="tb-sm" id="btnFill" title="–ö–æ–ª—ñ—Ä –∑–∞–ª–∏–≤–∫–∏" style="font-size:18px;">ü™£</button>
          <button class="tb-sm" id="btnStroke" title="–ö–æ–ª—ñ—Ä –∫–æ–Ω—Ç—É—Ä—É" style="font-size:18px;">üñåÔ∏è</button>
          <div style="width:1px;height:22px;background:#e8e0ff;margin:0 2px;"></div>
          <button class="tb-sm" id="btnBringFront" title="–ù–∞ –ø–µ—Ä–µ–¥–Ω—ñ–π –ø–ª–∞–Ω"><i class="fa-solid fa-layer-group"></i></button>
          <button class="tb-sm" id="btnSendBack" title="–ù–∞ –∑–∞–¥–Ω—ñ–π –ø–ª–∞–Ω"><i class="fa-solid fa-layer-group fa-flip-vertical"></i></button>
          <div style="width:1px;height:22px;background:#e8e0ff;margin:0 2px;"></div>
          <button class="tb-sm" id="btnDupEl" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ (Ctrl+D)" style="color:#6C63FF;"><i class="fa-regular fa-clone"></i></button>
          <button class="tb-sm" id="btnDelEl" title="–°—Ç–µ—Ä—Ç–∏ (Delete)" style="color:#ef4444;"><i class="fa-solid fa-trash"></i></button>
        </div>
      </div>

      <div style="flex:1;min-width:8px;"></div>
      <div id="slideCounter">–°–ª–∞–π–¥ 1/1</div>
    </div>

    <!-- Workspace -->
    <div id="workspace">
      <div id="stageWrap">
        <div id="stage" aria-label="–ü–æ–ª–æ—Ç–Ω–æ —Å–ª–∞–π–¥–∞"></div>
      </div>

      <!-- Color popover -->
      <div id="colorPopover" class="popover" style="display:none;max-width:330px;">
        <div class="popover-head">
          <div class="popover-title" id="colorTitle">üé® –ö–û–õ–Ü–†</div>
          <button class="popover-close" id="btnCloseColor"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="color-section">
          <div class="color-section-label">–Ø—Å–∫—Ä–∞–≤—ñ –∫–æ–ª—å–æ—Ä–∏</div>
          <div id="colorGrid" class="color-grid"></div>
        </div>
        <div class="color-section">
          <div class="color-section-label">–ù—ñ–∂–Ω—ñ –∫–æ–ª—å–æ—Ä–∏</div>
          <div id="colorGridPastel" class="color-grid"></div>
        </div>
        <div class="custom-color-wrap">
          <label>–°–≤—ñ–π –∫–æ–ª—ñ—Ä:</label>
          <input type="color" id="customColorInput" class="custom-color-input" value="#6C63FF"/>
          <button class="modal-btn modal-ok" id="btnApplyCustomColor"
            style="flex:none;padding:9px 16px;font-size:12px;">‚úì –û–±—Ä–∞—Ç–∏</button>
        </div>
      </div>

      <!-- Emoji popover -->
      <div id="emojiPopover" class="popover" style="display:none;max-width:360px;">
        <div class="popover-head">
          <div class="popover-title">üòä –°–ú–ê–ô–õ–ò–ö–ò –¢–ê –°–ò–ú–í–û–õ–ò</div>
          <button class="popover-close" id="btnCloseEmoji"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="emojiGrid" class="emoji-grid"></div>
      </div>
    </div>

    <!-- Status bar -->
    <div id="statusBar">
      <span id="slideInfo">–ü–æ–ª–æ—Ç–Ω–æ: 16:9 (960√ó540)</span>
      <span id="saveStatus">–ì–æ—Ç–æ–≤–æ ‚úì</span>
    </div>
  </main>
</div>

<!-- Modal -->
<div id="modalOverlay">
  <div id="modal">
    <button class="modal-close" id="btnModalClose"><i class="fa-solid fa-xmark"></i></button>
    <div id="modalTitle"></div>
    <div id="modalBody"></div>
    <div id="modalActions">
      <button class="modal-btn modal-cancel" id="btnModalCancel">–ù—ñ, –Ω–∞–∑–∞–¥</button>
      <button class="modal-btn modal-ok" id="btnModalOk">–î–æ–±—Ä–µ!</button>
    </div>
  </div>
</div>

<!-- Presentation overlay -->
<div id="presentOverlay">
  <div id="presentProgress"></div>
  <div id="presentStageWrap"></div>
  <button id="presentClose"><i class="fa-solid fa-xmark"></i></button>
  <div id="presentNavBar">
    <button class="pnav-btn" id="btnPrev"><i class="fa-solid fa-chevron-left"></i></button>
    <div id="presentCounter">1 / 1</div>
    <button class="pnav-btn" id="btnNext"><i class="fa-solid fa-chevron-right"></i></button>
  </div>
</div>

<!-- Welcome screen -->
<div id="welcomeOverlay">
  <div id="welcomeBox">
    <span class="welcome-mascot">üé®</span>
    <div class="welcome-title">–ü—Ä–∏–≤—ñ—Ç! –Ø –°–õ–ê–ô–î–ò–ö! üëã</div>
    <div class="welcome-sub">–Ø –¥–æ–ø–æ–º–æ–∂—É —Ç–æ–±—ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫—Ä—É—Ç–µ—Ü—å–∫—É<br>–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é –¥–ª—è —à–∫–æ–ª–∏!</div>
    <div class="welcome-steps">
      <div class="welcome-step">
        <span class="step-icon">‚úèÔ∏è</span>
        <span>–ù–∞—Ç–∏—Å–Ω–∏ <strong>"–ù–∞–ø–∏—Å–∞—Ç–∏"</strong> ‚Äî —ñ –ø–∏—à–∏ —â–æ —Ö–æ—á–µ—à!</span>
      </div>
      <div class="welcome-step">
        <span class="step-icon">üé®</span>
        <span>–û–±–µ—Ä–∏ <strong>–∫–æ–ª—å–æ—Ä–∏ —Ç–∞ —Ñ—ñ–≥—É—Ä–∏</strong> ‚Äî –∑—Ä–æ–±–∏ –∫—Ä–∞—Å–∏–≤–æ!</span>
      </div>
      <div class="welcome-step">
        <span class="step-icon">‚ñ∂Ô∏è</span>
        <span>–ù–∞—Ç–∏—Å–Ω–∏ <strong>"–ü–û–ö–ê–ó–ê–¢–ò!"</strong> ‚Äî —ñ –¥–∏–≤–∏—Å—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é!</span>
      </div>
    </div>
    <button class="welcome-start" id="btnWelcomeStart">
      üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ!
    </button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
  const STORAGE_KEY = 'slidyk_kids_v4';
  const MAX_HISTORY = 80;
  const BASE_W = 960, BASE_H = 540;

  const COLORS_VIVID = [
    '#000000','#ffffff','#ef4444','#f97316','#f59e0b','#eab308','#22c55e','#10b981',
    '#06b6d4','#3b82f6','#6366f1','#8b5cf6','#a855f7','#ec4899','#f43f5e','#64748b','#1e293b','#94a3b8'
  ];
  const COLORS_PASTEL = [
    '#fecaca','#fed7aa','#fef08a','#d9f99d','#a7f3d0','#99f6e4','#bae6fd','#bfdbfe',
    '#c7d2fe','#ddd6fe','#f5d0fe','#fbcfe8','#ffe4e6','#fef9c3','#f0fdf4','#f0f9ff','#faf5ff','#fdf2f8'
  ];
  const EMOJIS = [
    'üòÄ','üòÅ','üòÖ','üòç','üòé','ü§©','ü•≥','üòÇ','ü§î','üò¥','ü§ñ','üëΩ','ü¶Å','üê±','üê∂','üê∏','ü¶ä','üêº','üê®','üêß',
    'ü¶Ñ','üêâ','ü¶ã','üå∏','üå∫','üåª','üåà','‚≠ê','üåü','‚ú®','üî•','üíß','‚ùÑÔ∏è','üçï','üç¶','üéÇ','üç©','üçé','üçì','ü•ë',
    'üëã','üëç','üëè','‚ù§Ô∏è','üíô','üíö','üíõ','üß°','üíú','üñ§','ü§ù','‚úåÔ∏è','üëå','üôè','üí™',
    'üé®','üéÆ','üé∏','‚öΩ','üèÄ','üéØ','üèÜ','ü•á','üöÄ','üåç','üè†','üöó','üéÅ','üéâ','üéä','üîë','üí°','üìö','‚úèÔ∏è','üß©','üî≠','üß™'
  ];

  const TEMPLATES = [
    {id:'title', icon:'üì£', name:'–¢–∏—Ç—É–ª—å–Ω–∏–π',    desc:'–ù–∞–∑–≤–∞ + –∞–≤—Ç–æ—Ä'},
    {id:'two',   icon:'üìã', name:'–¢–µ–∫—Å—Ç + –º—ñ—Å—Ü–µ –¥–ª—è —Ñ–æ—Ç–æ', desc:'–¢–µ–∫—Å—Ç —ñ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ—Ä—É—á'},
    {id:'three', icon:'üèõ', name:'3 –±–ª–æ–∫–∏',      desc:'–¢—Ä–∏ —Ä—ñ–≤–Ω–∏—Ö –∫–æ–ª—å–æ—Ä–æ–≤–∏—Ö –±–ª–æ–∫–∏'},
    {id:'fact',  icon:'üí°', name:'–¶—ñ–∫–∞–≤–∏–π —Ñ–∞–∫—Ç', desc:'–ö—Ä–∞—Å–∏–≤–∞ –∫–∞—Ä—Ç–∫–∞ –∑ —Ñ–∞–∫—Ç–æ–º'},
    {id:'list',  icon:'üìù', name:'–°–ø–∏—Å–æ–∫',       desc:'–ó–∞–≥–æ–ª–æ–≤–æ–∫ —ñ –ø—É–Ω–∫—Ç–∏'},
    {id:'compare',icon:'üîÑ',name:'–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è',   desc:'–î–≤–∞ —Å—Ç–æ–≤–ø—á–∏–∫–∏: –∑–∞ —Ç–∞ –ø—Ä–æ—Ç–∏'},
  ];

  const uid = () => Math.floor(Date.now() * Math.random() * 1000 + Math.random() * 1e9);
  const clamp = (n,a,b) => Math.max(a,Math.min(b,n));
  const deepClone = o => JSON.parse(JSON.stringify(o));
  const safeParse = (s,fb) => { try{return JSON.parse(s);}catch{return fb;} };

  function normalizeEl(e){
    return {
      id: typeof e.id==='number' ? e.id : uid(),
      type: ['text','image','shape'].includes(e.type) ? e.type : 'text',
      x: Number.isFinite(e.x)?e.x:100, y: Number.isFinite(e.y)?e.y:100,
      w: Number.isFinite(e.w)?e.w:260, h: Number.isFinite(e.h)?e.h:80,
      z: Number.isFinite(e.z)?e.z:1,
      content: typeof e.content==='string'?e.content:'',
      style:{
        fontSize: Number.isFinite(e.style?.fontSize)?e.style.fontSize:32,
        color: typeof e.style?.color==='string'?e.style.color:'#1a1040',
        bold:!!e.style?.bold, italic:!!e.style?.italic, underline:!!e.style?.underline,
        align:['left','center','right'].includes(e.style?.align)?e.style.align:'left',
        fill: typeof e.style?.fill==='string'?e.style.fill:'#c7d2fe',
        stroke: typeof e.style?.stroke==='string'?e.style.stroke:'#6366f1'
      },
      shape:['rect','circle','star','heart','triangle'].includes(e.shape)?e.shape:'rect'
    };
  }

  function normalizeState(raw){
    if(!raw||!Array.isArray(raw.slides)||!raw.slides.length) return null;
    const slides = raw.slides.map(s=>({
      id: typeof s.id==='number'?s.id:uid(),
      background: typeof s.background==='string'?s.background:'#ffffff',
      elements: Array.isArray(s.elements)?s.elements.map(normalizeEl):[]
    }));
    return {slides, current:clamp(Number.isFinite(raw.current)?raw.current:0,0,slides.length-1), selected:null};
  }

  const App = (() => {
    let state;
    let undoStack=[], redoStack=[];
    const dom={};
    const elDom=new Map();
    const ptr={mode:'none',elId:null,handle:null,startX:0,startY:0,startBox:null,dragOff:{x:0,y:0}};
    let colorMode='textColor';
    let clip=null;
    let saveTimer=null, thumbTimer=null;
    const $=id=>document.getElementById(id);
    const slide=()=>state.slides[state.current];
    const elements=()=>slide().elements;
    const selectedEl=()=>state.selected?elements().find(e=>e.id===state.selected)||null:null;

    function normalizeZ(sl){
      [...sl.elements].sort((a,b)=>(a.z??1)-(b.z??1)).forEach((e,i)=>e.z=i+1);
    }

    let toastTimer;
    function toast(msg,dur=2200){
      dom.toast.textContent=msg;dom.toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>dom.toast.classList.remove('show'),dur);
    }

    function setSave(text,ok=false){
      dom.saveStatus.textContent=text;dom.saveStatus.classList.toggle('saved',ok);
    }
    function scheduleSave(){
      setSave('–ó–±–µ—Ä—ñ–≥–∞—î–º–æ‚Ä¶',false);
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>{
        localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
        setSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úì',true);
      },400);
    }
    function debounceThumbs(){
      if(thumbTimer) clearTimeout(thumbTimer);
      thumbTimer=setTimeout(renderThumbnails,250);
    }

    /* History */
    function pushHistory(){
      const snap=JSON.stringify(state);
      if(undoStack.length&&undoStack[undoStack.length-1]===snap) return;
      undoStack.push(snap);
      if(undoStack.length>MAX_HISTORY) undoStack.shift();
      redoStack=[];updateUndoRedo();
    }
    function updateUndoRedo(){
      dom.btnUndo.style.opacity=undoStack.length>1?'1':'0.4';
      dom.btnRedo.style.opacity=redoStack.length>0?'1':'0.4';
    }
    function undo(){
      if(undoStack.length<=1) return;
      redoStack.push(undoStack.pop());
      state=normalizeState(safeParse(undoStack[undoStack.length-1],null))||state;
      renderAll();scheduleSave();updateUndoRedo();toast('‚Ü© –°–∫–∞—Å–æ–≤–∞–Ω–æ');
    }
    function redo(){
      if(!redoStack.length) return;
      const next=redoStack.pop();undoStack.push(next);
      state=normalizeState(safeParse(next,null))||state;
      renderAll();scheduleSave();updateUndoRedo();toast('‚Ü™ –ü–æ–≤—Ç–æ—Ä–µ–Ω–æ');
    }

    /* Stage scaling */
    function scaleStage(){
      const ws=dom.workspace;
      const pad=64;
      const availW=ws.clientWidth-pad, availH=ws.clientHeight-pad;
      const scale=Math.min(availW/BASE_W,availH/BASE_H,1);
      dom.stage.style.transform=`scale(${scale})`;
      dom.stageWrap.style.width=(BASE_W*scale)+'px';
      dom.stageWrap.style.height=(BASE_H*scale)+'px';
      dom.stage.dataset.scale=String(scale);
    }

    function toStagePoint(cx,cy){
      const r=dom.stage.getBoundingClientRect();
      return{x:(cx-r.left)*(BASE_W/r.width),y:(cy-r.top)*(BASE_H/r.height)};
    }

    /* Selection */
    function selectEl(id){
      state.selected=id;closePopovers();
      for(const[eid,node] of elDom) node.classList.toggle('selected',eid===id);
      updateSlideCounter();
    }
    function deselect(){
      state.selected=null;closePopovers();
      for(const node of elDom.values()) node.classList.remove('selected');
    }

    /* Popovers */
    function initPopovers(){
      dom.colorGrid.innerHTML='';
      COLORS_VIVID.forEach(c=>{
        const b=document.createElement('button');
        b.className='color-btn';b.style.background=c;b.title=c;
        b.onclick=()=>{applyColor(c);closePopovers();};
        dom.colorGrid.appendChild(b);
      });
      dom.colorGridPastel.innerHTML='';
      COLORS_PASTEL.forEach(c=>{
        const b=document.createElement('button');
        b.className='color-btn';b.style.background=c;b.title=c;
        b.onclick=()=>{applyColor(c);closePopovers();};
        dom.colorGridPastel.appendChild(b);
      });
      dom.emojiGrid.innerHTML='';
      EMOJIS.forEach(em=>{
        const b=document.createElement('button');
        b.className='emoji-btn';b.textContent=em;
        b.onclick=()=>{addEmoji(em);closePopovers();};
        dom.emojiGrid.appendChild(b);
      });
    }

    function openColor(mode){
      colorMode=mode;
      dom.colorTitle.textContent={
        textColor:'üñäÔ∏è –ö–û–õ–Ü–† –¢–ï–ö–°–¢–£', bg:'üé® –ö–û–õ–Ü–† –§–û–ù–£',
        fill:'ü™£ –ö–û–õ–Ü–† –ó–ê–õ–ò–í–ö–ò', stroke:'üñåÔ∏è –ö–û–õ–Ü–† –ö–û–ù–¢–£–†–£'
      }[mode]||'üé® –ö–û–õ–Ü–†';
      closePopovers();dom.colorPopover.style.display='block';
    }
    function openEmoji(){closePopovers();dom.emojiPopover.style.display='block';}
    function closePopovers(){dom.colorPopover.style.display='none';dom.emojiPopover.style.display='none';}

    function applyColor(c){
      pushHistory();
      if(colorMode==='bg'){
        slide().background=c;dom.stage.style.background=c;
        renderThumbnails();scheduleSave();return;
      }
      const el=selectedEl();if(!el) return;
      if(colorMode==='textColor'&&el.type==='text'){
        el.style.color=c;
        const t=elDom.get(el.id)?.querySelector('.textBox');
        if(t) t.style.color=c;
      }
      if(colorMode==='fill'&&el.type==='shape'){
        el.style.fill=c;
        const s=elDom.get(el.id)?.querySelector('svg [fill]');
        if(s) s.setAttribute('fill',c);
      }
      if(colorMode==='stroke'&&el.type==='shape'){
        el.style.stroke=c;
        const s=elDom.get(el.id)?.querySelector('svg [stroke]');
        if(s) s.setAttribute('stroke',c);
      }
      debounceThumbs();scheduleSave();
    }

    /* Modal */
    function openModal({title,bodyHTML,okText='–î–æ–±—Ä–µ!',cancelText='–ù—ñ, –Ω–∞–∑–∞–¥',onOk,showActions=true}){
      dom.modalTitle.textContent=title;dom.modalBody.innerHTML=bodyHTML;
      dom.modalActions.style.display=showActions?'flex':'none';
      dom.btnModalOk.textContent=okText;dom.btnModalCancel.textContent=cancelText;
      dom.btnModalOk.onclick=()=>{onOk?.();closeModal();};
      dom.btnModalCancel.onclick=closeModal;
      dom.modalOverlay.classList.add('show');
    }
    function closeModal(){dom.modalOverlay.classList.remove('show');}
    function confirm({title,msg,okText='–¢–∞–∫',onYes}){
      openModal({title,bodyHTML:`<p style="font-size:15px;font-weight:700;color:#475569;line-height:1.65;">${msg}</p>`,okText,cancelText:'–ù—ñ, –Ω–∞–∑–∞–¥',onOk:onYes});
    }

    /* Render all */
    function renderAll(){renderThumbnails();renderStage();updateSlideCounter();}
    function updateSlideCounter(){
      dom.slideCounter.textContent=`–°–ª–∞–π–¥ ${state.current+1}/${state.slides.length}`;
      dom.slideInfo.textContent=`16:9 ‚Ä¢ ${state.slides.length} —Å–ª–∞–π–¥(—ñ–≤)`;
    }

    /* Thumbnails */
    function renderThumbnails(){
      dom.slideList.innerHTML='';
      state.slides.forEach((s,idx)=>{
        const item=document.createElement('div');
        item.className='slide-item'+(idx===state.current?' active':'');
        item.onclick=()=>{state.current=idx;state.selected=null;closePopovers();renderAll();scheduleSave();};

        const acts=document.createElement('div');acts.className='slide-actions';
        const mkBtn=(cls,icon,tip,fn)=>{
          const b=document.createElement('button');b.className='sa-btn '+cls;b.title=tip;
          b.innerHTML=`<i class="${icon}"></i>`;
          b.onclick=e=>{e.stopPropagation();fn();};return b;
        };
        acts.appendChild(mkBtn('sa-dup','fa-regular fa-copy','–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏',()=>duplicateSlide(idx)));
        acts.appendChild(mkBtn('sa-del','fa-solid fa-trash','–í–∏–¥–∞–ª–∏—Ç–∏',()=>confirmDeleteSlide(idx)));
        item.appendChild(acts);

        const num=document.createElement('div');num.className='slide-num';num.textContent=idx+1;
        item.appendChild(num);

        const wrap=document.createElement('div');wrap.className='thumb-wrap';
        const inner=document.createElement('div');inner.className='thumb-inner';
        inner.style.background=s.background;
        requestAnimationFrame(()=>{
          const sc=wrap.clientWidth/BASE_W;inner.style.transform=`scale(${sc})`;
        });
        const sorted=[...s.elements].sort((a,b)=>(a.z??1)-(b.z??1));
        sorted.forEach(el=>{
          const d=document.createElement('div');
          d.style.cssText=`position:absolute;left:${el.x}px;top:${el.y}px;width:${el.w}px;height:${el.h}px;overflow:hidden;`;
          if(el.type==='text'){
            Object.assign(d.style,{
              fontSize:(el.style.fontSize||32)+'px',color:el.style.color||'#1a1040',
              fontWeight:el.style.bold?'900':'700',fontStyle:el.style.italic?'italic':'normal',
              textDecoration:el.style.underline?'underline':'none',textAlign:el.style.align||'left',
              whiteSpace:'pre-wrap',padding:'8px',fontFamily:"'Baloo 2',sans-serif",lineHeight:'1.2'
            });
            d.textContent=el.content||'';
          } else if(el.type==='image'){
            const img=document.createElement('img');
            img.src=el.content;img.style.cssText='width:100%;height:100%;object-fit:cover;';
            d.appendChild(img);
          } else if(el.type==='shape'){
            d.appendChild(makeShapeSVG(el));
          }
          inner.appendChild(d);
        });
        wrap.appendChild(inner);item.appendChild(wrap);
        dom.slideList.appendChild(item);
      });
    }

    /* SVG shapes ‚Äî including new star, heart, triangle */
    function makeShapeSVG(el){
      const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('width','100%');svg.setAttribute('height','100%');
      svg.setAttribute('viewBox','0 0 100 100');
      svg.setAttribute('preserveAspectRatio','none');
      const fill=el.style.fill||'#c7d2fe';
      const stroke=el.style.stroke||'#6366f1';
      let s;
      if(el.shape==='circle'){
        s=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
        s.setAttribute('cx','50');s.setAttribute('cy','50');
        s.setAttribute('rx','47');s.setAttribute('ry','47');
      } else if(el.shape==='star'){
        s=document.createElementNS('http://www.w3.org/2000/svg','polygon');
        s.setAttribute('points','50,4 61,36 95,36 69,57 79,91 50,71 21,91 31,57 5,36 39,36');
      } else if(el.shape==='heart'){
        s=document.createElementNS('http://www.w3.org/2000/svg','path');
        s.setAttribute('d','M50,82 C50,82 7,52 7,28 C7,14 17,4 32,4 C40,4 47,9 50,16 C53,9 60,4 68,4 C83,4 93,14 93,28 C93,52 50,82 50,82 Z');
      } else if(el.shape==='triangle'){
        s=document.createElementNS('http://www.w3.org/2000/svg','polygon');
        s.setAttribute('points','50,4 96,93 4,93');
      } else {
        s=document.createElementNS('http://www.w3.org/2000/svg','rect');
        s.setAttribute('x','2');s.setAttribute('y','2');
        s.setAttribute('width','96');s.setAttribute('height','96');
        s.setAttribute('rx','6');
      }
      s.setAttribute('fill',fill);s.setAttribute('stroke',stroke);s.setAttribute('stroke-width','5');
      svg.appendChild(s);return svg;
    }

    function applyTextStyle(node,el){
      node.style.fontSize=(el.style.fontSize||32)+'px';
      node.style.color=el.style.color||'#1a1040';
      node.style.fontWeight=el.style.bold?'900':'700';
      node.style.fontStyle=el.style.italic?'italic':'normal';
      node.style.textDecoration=el.style.underline?'underline':'none';
      node.style.textAlign=el.style.align||'left';
    }

    /* Render stage */
    function renderStage(){
      dom.stage.innerHTML='';elDom.clear();
      dom.stage.style.background=slide().background;
      const sorted=[...elements()].sort((a,b)=>(a.z??1)-(b.z??1));
      sorted.forEach(el=>{
        const w=document.createElement('div');
        w.className='el'+(state.selected===el.id?' selected':'');
        w.dataset.id=String(el.id);
        w.style.cssText=`left:${el.x}px;top:${el.y}px;width:${el.w}px;height:${el.h}px;z-index:${el.z||1};`;
        const content=document.createElement('div');content.className='content';

        if(el.type==='text'){
          const t=document.createElement('div');
          t.className='textBox';t.contentEditable='true';t.spellcheck=false;
          t.textContent=el.content||'';applyTextStyle(t,el);
          t.style.fontFamily="'Baloo 2','Nunito',sans-serif";
          t.addEventListener('input',()=>{el.content=t.textContent||'';scheduleSave();debounceThumbs();});
          t.addEventListener('pointerdown',e=>{e.stopPropagation();selectEl(el.id);});
          content.appendChild(t);
        } else if(el.type==='image'){
          const img=document.createElement('img');
          img.src=el.content;img.draggable=false;
          img.style.cssText='width:100%;height:100%;object-fit:cover;pointer-events:none;';
          content.appendChild(img);
        } else if(el.type==='shape'){
          content.appendChild(makeShapeSVG(el));
        }

        w.appendChild(content);
        const handles=document.createElement('div');handles.className='handles';
        ['nw','n','ne','e','se','s','sw','w'].forEach(p=>{
          const h=document.createElement('div');
          h.className=`handle ${p}`;h.dataset.handle=p;
          h.addEventListener('pointerdown',e=>onHandleDown(e,el.id,p));
          handles.appendChild(h);
        });
        w.appendChild(handles);
        w.addEventListener('pointerdown',e=>onElDown(e,el.id));
        elDom.set(el.id,w);dom.stage.appendChild(w);
      });
    }

    /* Drag */
    function onElDown(e,id){
      if(e.target?.classList?.contains('textBox')) return;
      e.stopPropagation();selectEl(id);
      const el=elements().find(x=>x.id===id);
      const node=elDom.get(id);if(!el||!node) return;
      pushHistory();
      const p=toStagePoint(e.clientX,e.clientY);
      ptr.mode='drag';ptr.elId=id;
      ptr.dragOff={x:p.x-el.x,y:p.y-el.y};
      node.setPointerCapture(e.pointerId);node.classList.add('dragging');
      const onMove=ev=>{
        const el2=elements().find(x=>x.id===ptr.elId);
        const n2=elDom.get(ptr.elId);if(!el2||!n2) return;
        const pp=toStagePoint(ev.clientX,ev.clientY);
        el2.x=clamp(pp.x-ptr.dragOff.x,0,BASE_W-el2.w);
        el2.y=clamp(pp.y-ptr.dragOff.y,0,BASE_H-el2.h);
        n2.style.left=el2.x+'px';n2.style.top=el2.y+'px';
      };
      const onUp=()=>{
        node.classList.remove('dragging');
        node.removeEventListener('pointermove',onMove);
        normalizeZ(slide());debounceThumbs();scheduleSave();ptr.mode='none';
      };
      node.addEventListener('pointermove',onMove);
      node.addEventListener('pointerup',onUp,{once:true});
      node.addEventListener('pointercancel',onUp,{once:true});
    }

    /* Resize */
    function onHandleDown(e,id,handle){
      e.stopPropagation();e.preventDefault();selectEl(id);
      const el=elements().find(x=>x.id===id);
      const node=elDom.get(id);if(!el||!node) return;
      pushHistory();
      const p=toStagePoint(e.clientX,e.clientY);
      ptr.mode='resize';ptr.elId=id;ptr.handle=handle;
      ptr.startX=p.x;ptr.startY=p.y;
      ptr.startBox={x:el.x,y:el.y,w:el.w,h:el.h};
      node.setPointerCapture(e.pointerId);
      const onMove=ev=>{
        const el2=elements().find(x=>x.id===ptr.elId);
        const n2=elDom.get(ptr.elId);if(!el2||!n2||!ptr.startBox) return;
        const pp=toStagePoint(ev.clientX,ev.clientY);
        const dx=pp.x-ptr.startX,dy=pp.y-ptr.startY;
        let{x,y,w,h}=ptr.startBox;
        const has=s=>ptr.handle.includes(s);
        if(has('e')) w+=dx; if(has('s')) h+=dy;
        if(has('w')){x+=dx;w-=dx;} if(has('n')){y+=dy;h-=dy;}
        w=Math.max(40,w);h=Math.max(30,h);
        x=clamp(x,0,BASE_W-w);y=clamp(y,0,BASE_H-h);
        el2.x=x;el2.y=y;el2.w=w;el2.h=h;
        n2.style.left=x+'px';n2.style.top=y+'px';n2.style.width=w+'px';n2.style.height=h+'px';
      };
      const onUp=()=>{
        node.removeEventListener('pointermove',onMove);
        normalizeZ(slide());debounceThumbs();scheduleSave();ptr.mode='none';
      };
      node.addEventListener('pointermove',onMove);
      node.addEventListener('pointerup',onUp,{once:true});
      node.addEventListener('pointercancel',onUp,{once:true});
    }

    /* Slide ops */
    function addSlide(){
      pushHistory();
      state.slides.push({id:uid(),background:'#ffffff',elements:[]});
      state.current=state.slides.length-1;state.selected=null;
      renderAll();scheduleSave();toast('–ù–æ–≤–∏–π —Å–ª–∞–π–¥ –≥–æ—Ç–æ–≤–∏–π! üéâ');
    }
    function confirmDeleteSlide(idx=state.current){
      if(state.slides.length<=1){toast('–ü–æ—Ç—Ä—ñ–±–µ–Ω —Ö–æ—á–∞ –± 1 —Å–ª–∞–π–¥! üôÇ');return;}
      confirm({title:'üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–∞–π–¥?',msg:`–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–∞–π–¥ ${idx+1}? –¶–µ –Ω–∞–∑–∞–≤–∂–¥–∏!`,okText:'–¢–∞–∫, —Å—Ç–µ—Ä—Ç–∏!',onYes:()=>deleteSlide(idx)});
    }
    function deleteSlide(idx=state.current){
      if(state.slides.length<=1) return;
      pushHistory();state.slides.splice(idx,1);
      state.current=clamp(state.current,0,state.slides.length-1);
      state.selected=null;renderAll();scheduleSave();toast('–°–ª–∞–π–¥ –≤–∏–¥–∞–ª–µ–Ω–æ');
    }
    function duplicateSlide(idx=state.current){
      pushHistory();
      const copy=deepClone(state.slides[idx]);
      copy.id=uid();copy.elements.forEach(e=>e.id=uid());
      state.slides.splice(idx+1,0,copy);
      state.current=idx+1;state.selected=null;
      renderAll();scheduleSave();toast('–°–ª–∞–π–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úì');
    }
    function moveSlide(d){
      const i=state.current,j=i+d;
      if(j<0||j>=state.slides.length) return;
      pushHistory();
      [state.slides[i],state.slides[j]]=[state.slides[j],state.slides[i]];
      state.current=j;renderAll();scheduleSave();
    }

    /* Element ops */
    function addText(){
      pushHistory();
      const e=normalizeEl({
        id:uid(),type:'text',x:160,y:150,w:640,h:130,z:elements().length+1,
        content:'–ù–∞–ø–∏—à–∏ —â–æ—Å—å –∫–ª–∞—Å–Ω–µ! ‚ú®',
        style:{fontSize:32,color:'#1a1040',bold:false,italic:false,underline:false,align:'center',fill:'',stroke:''}
      });
      elements().push(e);state.selected=e.id;
      renderAll();scheduleSave();
      requestAnimationFrame(()=>{
        const t=elDom.get(e.id)?.querySelector('.textBox');
        if(t){t.focus();document.execCommand('selectAll',false,null);}
      });
    }
    function addEmoji(em){
      pushHistory();
      const e=normalizeEl({
        id:uid(),type:'text',x:390,y:190,w:180,h:180,z:elements().length+1,
        content:em,
        style:{fontSize:100,color:'#1a1040',bold:false,italic:false,underline:false,align:'center',fill:'',stroke:''}
      });
      elements().push(e);state.selected=e.id;renderAll();scheduleSave();
    }
    function addShape(kind){
      pushHistory();
      const fills={rect:'#c7d2fe',circle:'#fde68a',star:'#fef08a',heart:'#fecaca',triangle:'#bbf7d0'};
      const strokes={rect:'#6366f1',circle:'#d97706',star:'#d97706',heart:'#e11d48',triangle:'#16a34a'};
      const e=normalizeEl({
        id:uid(),type:'shape',x:240,y:150,w:480,h:240,z:elements().length+1,
        content:'',shape:kind,
        style:{fill:fills[kind]||'#c7d2fe',stroke:strokes[kind]||'#6366f1'}
      });
      elements().push(e);state.selected=e.id;renderAll();scheduleSave();
    }
    function addImage(){
      const html=`
        <div class="img-tab-row">
          <button class="img-tab active" id="tabFile" onclick="switchImgTab('file')"><i class="fa-solid fa-folder-open"></i> –ó —Ñ–∞–π–ª—É</button>
          <button class="img-tab" id="tabUrl" onclick="switchImgTab('url')"><i class="fa-solid fa-link"></i> –ó —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É</button>
        </div>
        <div id="imgPanelFile">
          <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div class="dz-icon">üñºÔ∏è</div>
            <div class="dz-text" style="font-size:14px;font-weight:800;color:#6C63FF;">–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –æ–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ</div>
            <div class="dz-text" style="margin-top:5px;font-size:12px;">–∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ —Ñ–æ—Ç–æ —Å—é–¥–∏</div>
          </div>
          <input type="file" id="fileInput" style="display:none;" accept="image/*"/>
        </div>
        <div id="imgPanelUrl" style="display:none;">
          <input type="text" id="imgUrl" class="field" placeholder="–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ (https://‚Ä¶)"/>
          <p style="font-size:11px;font-weight:600;color:#b39ddb;margin-top:8px;">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: https://‚Ä¶/photo.jpg</p>
        </div>`;
      openModal({
        title:'üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ',bodyHTML:html,okText:'üì∑ –î–æ–¥–∞—Ç–∏!',cancelText:'–ó–∞–∫—Ä–∏—Ç–∏',
        onOk:()=>{const url=$('imgUrl')?.value.trim();if(url) insertImage(url);}
      });
      window.switchImgTab=tab=>{
        $('tabFile').classList.toggle('active',tab==='file');
        $('tabUrl').classList.toggle('active',tab==='url');
        $('imgPanelFile').style.display=tab==='file'?'block':'none';
        $('imgPanelUrl').style.display=tab==='url'?'block':'none';
      };
      const dz=$('dropZone');
      dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
      dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
      dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f) readFile(f);});
      const fi=$('fileInput');
      fi.onchange=ev=>{const f=ev.target.files?.[0];if(f) readFile(f);};
      function readFile(f){
        const r=new FileReader();
        r.onload=()=>{insertImage(String(r.result));closeModal();};
        r.readAsDataURL(f);
      }
    }
    function insertImage(src){
      pushHistory();
      const e=normalizeEl({id:uid(),type:'image',x:200,y:115,w:560,h:310,z:elements().length+1,content:src});
      elements().push(e);state.selected=e.id;renderAll();scheduleSave();
    }

    function confirmDeleteSelected(){
      const el=selectedEl();if(!el){toast("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ –Ω–∞ —â–æ—Å—å üëÜ");return;}
      const names={text:'—Ç–µ–∫—Å—Ç',image:'—Ñ–æ—Ç–æ',shape:'—Ñ—ñ–≥—É—Ä—É'};
      confirm({title:'üóëÔ∏è –°—Ç–µ—Ä—Ç–∏?',msg:`–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é ${names[el.type]}?`,okText:'–¢–∞–∫, —Å—Ç–µ—Ä—Ç–∏!',onYes:deleteSelected});
    }
    function deleteSelected(){
      const el=selectedEl();if(!el) return;
      pushHistory();
      slide().elements=slide().elements.filter(e=>e.id!==el.id);
      state.selected=null;normalizeZ(slide());
      renderAll();scheduleSave();toast("–°—Ç–µ—Ä—Ç–æ! üóëÔ∏è");
    }
    function duplicateSelected(){
      const el=selectedEl();if(!el){toast("–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ —â–æ—Å—å üëÜ");return;}
      pushHistory();
      const copy=deepClone(el);copy.id=uid();
      copy.x=clamp(copy.x+24,0,BASE_W-copy.w);
      copy.y=clamp(copy.y+24,0,BASE_H-copy.h);
      copy.z=elements().length+1;
      elements().push(copy);state.selected=copy.id;normalizeZ(slide());
      renderAll();scheduleSave();toast('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úì');
    }
    function bringToFront(){
      const el=selectedEl();if(!el) return;
      pushHistory();el.z=elements().length+1;normalizeZ(slide());
      renderAll();scheduleSave();
    }
    function sendToBack(){
      const el=selectedEl();if(!el) return;
      pushHistory();el.z=0;normalizeZ(slide());
      renderAll();scheduleSave();
    }
    function setFontSize(px){
      const el=selectedEl();if(!el||el.type!=='text') return;
      pushHistory();el.style.fontSize=Number(px);
      const t=elDom.get(el.id)?.querySelector('.textBox');
      if(t) t.style.fontSize=el.style.fontSize+'px';
      debounceThumbs();scheduleSave();
    }
    function toggleStyle(key){
      const el=selectedEl();if(!el||el.type!=='text') return;
      pushHistory();el.style[key]=!el.style[key];
      const t=elDom.get(el.id)?.querySelector('.textBox');
      if(t) applyTextStyle(t,el);
      debounceThumbs();scheduleSave();
    }
    function setAlign(align){
      const el=selectedEl();if(!el||el.type!=='text') return;
      pushHistory();el.style.align=align;
      const t=elDom.get(el.id)?.querySelector('.textBox');
      if(t) t.style.textAlign=align;
      debounceThumbs();scheduleSave();
    }

    /* Templates */
    function openTemplates(){
      const cards=TEMPLATES.map(t=>`
        <div class="tpl-card" onclick="App._applyTpl('${t.id}')">
          <div class="tpl-icon">${t.icon}</div>
          <div class="tpl-name">${t.name}</div>
          <div class="tpl-desc">${t.desc}</div>
        </div>`).join('');
      openModal({
        title:'üéÅ –û–±–µ—Ä–∏ –≥–æ—Ç–æ–≤–∏–π –º–∞–∫–µ—Ç',
        bodyHTML:`<div class="tpl-grid">${cards}</div><p style="font-size:11px;font-weight:700;color:#b39ddb;margin-top:14px;text-align:center;">‚ö†Ô∏è –ú–∞–∫–µ—Ç –∑–∞–º—ñ–Ω–∏—Ç—å –≤–º—ñ—Å—Ç –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞</p>`,
        showActions:false
      });
    }
    function applyTemplate(kind){
      closeModal();pushHistory();
      const s=slide();s.elements=[];s.background='#ffffff';
      const e=ov=>normalizeEl({id:uid(),z:ov.z||1,shape:'rect',style:{fill:'#c7d2fe',stroke:'#6366f1'},...ov});

      if(kind==='title'){
        s.background='#F0F4FF';
        s.elements.push(e({type:'shape',x:40,y:40,w:880,h:460,z:1,shape:'rect',style:{fill:'#EDE9FE',stroke:'#8B5CF6'}}));
        s.elements.push(e({type:'text',x:80,y:140,w:800,h:200,z:2,content:'–ù–ê–ó–í–ê –ü–†–ï–ó–ï–ù–¢–ê–¶–Ü–á',style:{fontSize:64,color:'#1a1040',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:200,y:360,w:560,h:80,z:3,content:"–£—á–µ–Ω—å: –¢–≤–æ—î —ñ–º'—è",style:{fontSize:28,color:'#6366f1',bold:false,italic:true,underline:false,align:'center',fill:'',stroke:''}}));
      }
      if(kind==='two'){
        s.elements.push(e({type:'text',x:40,y:30,w:880,h:80,z:1,content:'–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∞–π–¥–∞',style:{fontSize:48,color:'#1a1040',bold:true,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:40,y:130,w:420,h:370,z:2,content:'‚Ä¢ –ü—É–Ω–∫—Ç –ø–µ—Ä—à–∏–π\n‚Ä¢ –ü—É–Ω–∫—Ç –¥—Ä—É–≥–∏–π\n‚Ä¢ –ü—É–Ω–∫—Ç —Ç—Ä–µ—Ç—ñ–π\n‚Ä¢ –©–µ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç',style:{fontSize:28,color:'#1a1040',bold:false,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
        s.elements.push(e({type:'shape',x:480,y:130,w:440,h:370,z:3,shape:'rect',style:{fill:'#FEF9C3',stroke:'#D97706'}}));
        s.elements.push(e({type:'text',x:520,y:290,w:360,h:80,z:4,content:'üñºÔ∏è –ü–æ—Å—Ç–∞–≤ —Ñ–æ—Ç–æ —Ç—É—Ç',style:{fontSize:24,color:'#D97706',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
      }
      if(kind==='three'){
        s.elements.push(e({type:'text',x:40,y:20,w:880,h:80,z:1,content:'–ú–Ü–ô –°–õ–ê–ô–î',style:{fontSize:52,color:'#1a1040',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        [{x:40,fill:'#DCFCE7',stroke:'#16A34A',t:'–Ü–¥–µ—è 1'},{x:340,fill:'#DBEAFE',stroke:'#2563EB',t:'–Ü–¥–µ—è 2'},{x:640,fill:'#FAE8FF',stroke:'#9333EA',t:'–Ü–¥–µ—è 3'}].forEach((b,i)=>{
          s.elements.push(e({type:'shape',x:b.x,y:120,w:280,h:390,z:2+i,shape:'rect',style:{fill:b.fill,stroke:b.stroke}}));
          s.elements.push(e({type:'text',x:b.x+20,y:138,w:240,h:60,z:10+i,content:b.t,style:{fontSize:34,color:'#1a1040',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
          s.elements.push(e({type:'text',x:b.x+20,y:210,w:240,h:270,z:20+i,content:'–ù–∞–ø–∏—à–∏ —Ç—É—Ç‚Ä¶',style:{fontSize:22,color:'#475569',bold:false,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
        });
      }
      if(kind==='fact'){
        s.background='#1a0a3c';
        s.elements.push(e({type:'shape',x:60,y:50,w:840,h:440,z:1,shape:'rect',style:{fill:'#2d1060',stroke:'#6C63FF'}}));
        s.elements.push(e({type:'text',x:80,y:70,w:200,h:60,z:2,content:'üí° –§–ê–ö–¢',style:{fontSize:28,color:'#FFD166',bold:true,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:100,y:150,w:760,h:200,z:3,content:'–ù–∞–ø–∏—à–∏ —Å–≤—ñ–π —Ü—ñ–∫–∞–≤–∏–π —Ñ–∞–∫—Ç —Ç—É—Ç!',style:{fontSize:40,color:'#ffffff',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:100,y:380,w:760,h:80,z:4,content:'‚Äî –î–∂–µ—Ä–µ–ª–æ –∞–±–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è',style:{fontSize:24,color:'#a78bfa',bold:false,italic:true,underline:false,align:'right',fill:'',stroke:''}}));
      }
      if(kind==='list'){
        s.elements.push(e({type:'shape',x:0,y:0,w:960,h:100,z:1,shape:'rect',style:{fill:'#6C63FF',stroke:'#4F46E5'}}));
        s.elements.push(e({type:'text',x:30,y:8,w:900,h:84,z:2,content:'–ó–ê–ì–û–õ–û–í–û–ö',style:{fontSize:52,color:'#ffffff',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:60,y:120,w:840,h:380,z:3,content:"‚úÖ –ü—É–Ω–∫—Ç –ø–µ—Ä—à–∏–π\n‚úÖ –ü—É–Ω–∫—Ç –¥—Ä—É–≥–∏–π\n‚úÖ –ü—É–Ω–∫—Ç —Ç—Ä–µ—Ç—ñ–π\n‚úÖ –ü—É–Ω–∫—Ç —á–µ—Ç–≤–µ—Ä—Ç–∏–π\n‚úÖ –ü—É–Ω–∫—Ç –ø'—è—Ç–∏–π",style:{fontSize:32,color:'#1a1040',bold:false,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
      }
      if(kind==='compare'){
        s.elements.push(e({type:'text',x:40,y:20,w:880,h:80,z:1,content:'–ü–û–†–Ü–í–ù–Ø–ù–ù–Ø',style:{fontSize:52,color:'#1a1040',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        s.elements.push(e({type:'shape',x:40,y:115,w:420,h:390,z:2,shape:'rect',style:{fill:'#DCFCE7',stroke:'#16A34A'}}));
        s.elements.push(e({type:'shape',x:500,y:115,w:420,h:390,z:3,shape:'rect',style:{fill:'#FEE2E2',stroke:'#DC2626'}}));
        s.elements.push(e({type:'text',x:40,y:115,w:420,h:60,z:4,content:'‚úÖ –ó–∞',style:{fontSize:36,color:'#16A34A',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:500,y:115,w:420,h:60,z:5,content:'‚ùå –ü—Ä–æ—Ç–∏',style:{fontSize:36,color:'#DC2626',bold:true,italic:false,underline:false,align:'center',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:60,y:195,w:380,h:280,z:6,content:'‚Ä¢ –ù–∞–ø–∏—à–∏ —Ç—É—Ç\n‚Ä¢ –©–µ –æ–¥–∏–Ω –ø–ª—é—Å\n‚Ä¢ –Ü —â–µ –æ–¥–∏–Ω',style:{fontSize:24,color:'#1a1040',bold:false,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
        s.elements.push(e({type:'text',x:520,y:195,w:380,h:280,z:7,content:'‚Ä¢ –ú—ñ–Ω—É—Å –ø–µ—Ä—à–∏–π\n‚Ä¢ –ú—ñ–Ω—É—Å –¥—Ä—É–≥–∏–π\n‚Ä¢ –ô —ñ–Ω—à–µ',style:{fontSize:24,color:'#1a1040',bold:false,italic:false,underline:false,align:'left',fill:'',stroke:''}}));
      }
      normalizeZ(s);state.selected=null;renderAll();scheduleSave();
      toast('–ú–∞–∫–µ—Ç –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ! üéâ');
    }
    window.App={_applyTpl:id=>applyTemplate(id)};

    /* PDF */
    async function exportPDF(){
      toast('–ì–æ—Ç—É—î–º–æ —Ñ–∞–π–ª‚Ä¶ –∑–∞—á–µ–∫–∞–π! üîÑ',5000);
      const container=document.createElement('div');
      container.style.cssText='font-family:"Baloo 2",sans-serif;';
      state.slides.forEach(s=>{
        const page=document.createElement('div');
        page.style.cssText=`width:960px;height:540px;background:${s.background};position:relative;overflow:hidden;page-break-after:always;`;
        const sorted=[...s.elements].sort((a,b)=>(a.z??1)-(b.z??1));
        sorted.forEach(el=>{
          const box=document.createElement('div');
          box.style.cssText=`position:absolute;left:${el.x}px;top:${el.y}px;width:${el.w}px;height:${el.h}px;overflow:hidden;`;
          if(el.type==='text'){
            Object.assign(box.style,{
              fontSize:(el.style.fontSize||32)+'px',color:el.style.color||'#1a1040',
              fontWeight:el.style.bold?'900':'700',fontStyle:el.style.italic?'italic':'normal',
              textDecoration:el.style.underline?'underline':'none',textAlign:el.style.align||'left',
              whiteSpace:'pre-wrap',padding:'8px',lineHeight:'1.2',fontFamily:"'Baloo 2',sans-serif"
            });
            box.textContent=el.content||'';
          } else if(el.type==='image'){
            const img=document.createElement('img');
            img.src=el.content;img.style.cssText='width:100%;height:100%;object-fit:cover;';
            box.appendChild(img);
          } else if(el.type==='shape'){
            box.appendChild(makeShapeSVG(el));
          }
          page.appendChild(box);
        });
        container.appendChild(page);
      });
      await html2pdf().from(container).set({
        margin:0,filename:'slidyk_kids.pdf',
        image:{type:'jpeg',quality:.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'px',format:[960,540],orientation:'landscape'}
      }).save();
      toast('–§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ ‚úÖ');
    }

    /* Presentation */
    const Present={
      idx:0,key:null,
      start(){
        this.idx=state.current;
        dom.presentOverlay.classList.add('show');
        this.render();
        this.key=e=>{
          if(e.key==='ArrowRight'||e.key===' '){e.preventDefault();if(this.idx<state.slides.length-1){this.idx++;this.render();}else this.stop();}
          if(e.key==='ArrowLeft'){e.preventDefault();if(this.idx>0){this.idx--;this.render();}}
          if(e.key==='Escape') this.stop();
        };
        window.addEventListener('keydown',this.key);
      },
      stop(){
        dom.presentOverlay.classList.remove('show');
        if(this.key) window.removeEventListener('keydown',this.key);
        this.key=null;
      },
      render(){
        dom.presentStageWrap.innerHTML='';
        const s=state.slides[this.idx];
        const scale=Math.min(window.innerWidth/BASE_W,window.innerHeight/BASE_H);
        const scaledW=BASE_W*scale,scaledH=BASE_H*scale;
        const wrap=document.createElement('div');
        wrap.style.cssText=`width:${scaledW}px;height:${scaledH}px;position:relative;overflow:hidden;`;
        const st=document.createElement('div');
        st.style.cssText=`width:${BASE_W}px;height:${BASE_H}px;background:${s.background};position:absolute;top:0;left:0;transform:scale(${scale});transform-origin:top left;overflow:hidden;`;
        const sorted=[...s.elements].sort((a,b)=>(a.z??1)-(b.z??1));
        sorted.forEach(el=>{
          const box=document.createElement('div');
          box.style.cssText=`position:absolute;left:${el.x}px;top:${el.y}px;width:${el.w}px;height:${el.h}px;overflow:hidden;`;
          if(el.type==='text'){
            Object.assign(box.style,{
              fontSize:(el.style.fontSize||32)+'px',color:el.style.color||'#1a1040',
              fontWeight:el.style.bold?'900':'700',fontStyle:el.style.italic?'italic':'normal',
              textDecoration:el.style.underline?'underline':'none',textAlign:el.style.align||'left',
              whiteSpace:'pre-wrap',padding:'8px',lineHeight:'1.2',fontFamily:"'Baloo 2',sans-serif"
            });
            box.textContent=el.content||'';
          } else if(el.type==='image'){
            const img=document.createElement('img');
            img.src=el.content;img.style.cssText='width:100%;height:100%;object-fit:cover;';
            box.appendChild(img);
          } else if(el.type==='shape'){
            box.appendChild(makeShapeSVG(el));
          }
          st.appendChild(box);
        });
        wrap.appendChild(st);dom.presentStageWrap.appendChild(wrap);
        const pct=((this.idx)/(state.slides.length-1||1))*100;
        dom.presentProgress.style.width=pct+'%';
        dom.presentCounter.textContent=`${this.idx+1} / ${state.slides.length}`;
      }
    };

    /* Reset */
    function resetAll(){
      confirm({
        title:'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Åe?',
        msg:'–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å —É—Å—ñ —Å–ª–∞–π–¥–∏ —ñ –ø–æ—á–Ω–µ –∑–∞–Ω–æ–≤–æ. –í–ø–µ–≤–Ω–µ–Ω—ñ?',
        okText:'–¢–∞–∫, —Å—Ç–µ—Ä—Ç–∏ –≤—Åe!',
        onYes:()=>{localStorage.removeItem(STORAGE_KEY);location.reload();}
      });
    }

    /* Keyboard */
    function initKeyboard(){
      window.addEventListener('keydown',e=>{
        const isTyping=document.activeElement?.classList?.contains('textBox');
        const mod=e.ctrlKey||e.metaKey;
        if(mod&&e.key.toLowerCase()==='z'){e.preventDefault();if(e.shiftKey) redo();else undo();return;}
        if(mod&&e.key.toLowerCase()==='y'){e.preventDefault();redo();return;}
        if(mod&&e.key.toLowerCase()==='d'){e.preventDefault();duplicateSelected();return;}
        if(!isTyping&&mod&&e.key.toLowerCase()==='c'){
          const el=selectedEl();if(el){clip=deepClone(el);toast('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úì');}return;
        }
        if(!isTyping&&mod&&e.key.toLowerCase()==='v'){
          if(clip){
            pushHistory();const copy=deepClone(clip);copy.id=uid();
            copy.x=clamp(copy.x+24,0,BASE_W-copy.w);copy.y=clamp(copy.y+24,0,BASE_H-copy.h);
            copy.z=elements().length+1;elements().push(copy);state.selected=copy.id;
            normalizeZ(slide());renderAll();scheduleSave();toast('–í—Å—Ç–∞–≤–ª–µ–Ω–æ ‚úì');
          }
          return;
        }
        if(!isTyping&&(e.key==='Delete'||e.key==='Backspace')){e.preventDefault();confirmDeleteSelected();return;}
        if(!isTyping&&['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
          const el=selectedEl();if(!el) return;
          e.preventDefault();const step=e.shiftKey?10:2;
          if(e.key==='ArrowUp') el.y=clamp(el.y-step,0,BASE_H-el.h);
          if(e.key==='ArrowDown') el.y=clamp(el.y+step,0,BASE_H-el.h);
          if(e.key==='ArrowLeft') el.x=clamp(el.x-step,0,BASE_W-el.w);
          if(e.key==='ArrowRight') el.x=clamp(el.x+step,0,BASE_W-el.w);
          const node=elDom.get(el.id);
          if(node){node.style.left=el.x+'px';node.style.top=el.y+'px';}
          debounceThumbs();scheduleSave();
        }
      });
    }

    /* Init DOM refs */
    function initDom(){
      dom.stage=$('stage');
      dom.stageWrap=$('stageWrap');
      dom.workspace=$('workspace');
      dom.slideList=$('slideList');
      dom.slideCounter=$('slideCounter');
      dom.slideInfo=$('slideInfo');
      dom.saveStatus=$('saveStatus');
      dom.colorPopover=$('colorPopover');
      dom.colorGrid=$('colorGrid');
      dom.colorGridPastel=$('colorGridPastel');
      dom.colorTitle=$('colorTitle');
      dom.emojiPopover=$('emojiPopover');
      dom.emojiGrid=$('emojiGrid');
      dom.modalOverlay=$('modalOverlay');
      dom.modalTitle=$('modalTitle');
      dom.modalBody=$('modalBody');
      dom.modalActions=$('modalActions');
      dom.btnModalOk=$('btnModalOk');
      dom.btnModalCancel=$('btnModalCancel');
      dom.presentOverlay=$('presentOverlay');
      dom.presentStageWrap=$('presentStageWrap');
      dom.presentProgress=$('presentProgress');
      dom.presentCounter=$('presentCounter');
      dom.btnUndo=$('btnUndo');
      dom.btnRedo=$('btnRedo');
      dom.btnPresent=$('btnPresent');
      dom.btnPDF=$('btnPDF');
      dom.btnReset=$('btnReset');
      dom.btnNewSlide=$('btnNewSlide');
      dom.btnTemplates=$('btnTemplates');
      dom.btnSlideUp=$('btnSlideUp');
      dom.btnSlideDown=$('btnSlideDown');
      dom.toast=$('toast');
      dom.stage.dataset.baseW=String(BASE_W);
      dom.stage.dataset.baseH=String(BASE_H);
    }

    /* Bind UI */
    function bindUI(){
      dom.btnUndo.onclick=undo;dom.btnRedo.onclick=redo;
      dom.btnPresent.onclick=()=>Present.start();
      dom.btnPDF.onclick=exportPDF;
      dom.btnReset.onclick=resetAll;
      dom.btnNewSlide.onclick=addSlide;
      dom.btnTemplates.onclick=openTemplates;
      dom.btnSlideUp.onclick=()=>moveSlide(-1);
      dom.btnSlideDown.onclick=()=>moveSlide(1);

      $('btnDupSlide').onclick=()=>duplicateSlide();
      $('btnDelSlide').onclick=()=>confirmDeleteSlide();
      $('btnBg').onclick=()=>openColor('bg');
      $('btnAddText').onclick=addText;
      $('btnAddImage').onclick=addImage;
      $('btnEmoji').onclick=openEmoji;
      $('btnShapeRect').onclick=()=>addShape('rect');
      $('btnShapeCircle').onclick=()=>addShape('circle');
      $('btnShapeStar').onclick=()=>addShape('star');
      $('btnShapeHeart').onclick=()=>addShape('heart');
      $('btnShapeTri').onclick=()=>addShape('triangle');

      $('selFontSize').onchange=e=>setFontSize(e.target.value);
      $('btnBold').onclick=()=>toggleStyle('bold');
      $('btnItalic').onclick=()=>toggleStyle('italic');
      $('btnUnderline').onclick=()=>toggleStyle('underline');
      $('btnAlignLeft').onclick=()=>setAlign('left');
      $('btnAlignCenter').onclick=()=>setAlign('center');
      $('btnAlignRight').onclick=()=>setAlign('right');
      $('btnTextColor').onclick=()=>openColor('textColor');

      $('btnFill').onclick=()=>openColor('fill');
      $('btnStroke').onclick=()=>openColor('stroke');
      $('btnBringFront').onclick=bringToFront;
      $('btnSendBack').onclick=sendToBack;
      $('btnDupEl').onclick=duplicateSelected;
      $('btnDelEl').onclick=confirmDeleteSelected;

      $('btnCloseColor').onclick=closePopovers;
      $('btnApplyCustomColor').onclick=()=>{applyColor($('customColorInput').value);closePopovers();};
      $('btnCloseEmoji').onclick=closePopovers;
      $('btnModalClose').onclick=closeModal;
      dom.modalOverlay.addEventListener('pointerdown',e=>{if(e.target===dom.modalOverlay) closeModal();});

      dom.stage.addEventListener('pointerdown',e=>{if(e.target===dom.stage) deselect();});
      dom.workspace.addEventListener('pointerdown',e=>{
        if(!dom.colorPopover.contains(e.target)&&!dom.emojiPopover.contains(e.target)) closePopovers();
      });

      $('btnPrev').onclick=()=>{if(Present.idx>0){Present.idx--;Present.render();}};
      $('btnNext').onclick=()=>{if(Present.idx<state.slides.length-1){Present.idx++;Present.render();}else Present.stop();};
      $('presentClose').onclick=()=>Present.stop();

      let touchStartX=0;
      dom.presentStageWrap.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;},{passive:true});
      dom.presentStageWrap.addEventListener('touchend',e=>{
        const dx=e.changedTouches[0].clientX-touchStartX;
        if(dx<-50){if(Present.idx<state.slides.length-1){Present.idx++;Present.render();}}
        if(dx>50){if(Present.idx>0){Present.idx--;Present.render();}}
      });
      dom.presentStageWrap.addEventListener('click',e=>{
        if(e.target===dom.presentStageWrap){
          if(Present.idx<state.slides.length-1){Present.idx++;Present.render();}else Present.stop();
        }
      });

      /* Welcome */
      $('btnWelcomeStart').onclick=()=>{
        $('welcomeOverlay').style.display='none';
        localStorage.setItem(STORAGE_KEY+'_welcomed','1');
        setTimeout(()=>toast('üéâ –ß—É–¥–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω–∏ "‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç–∏" —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏!',3500),300);
      };
    }

    /* Init state */
    function initState(){
      const saved=safeParse(localStorage.getItem(STORAGE_KEY),null);
      const norm=normalizeState(saved);
      if(norm){state=norm;undoStack=[JSON.stringify(state)];redoStack=[];return;}
      state={
        slides:[{
          id:uid(),background:'#F0F4FF',elements:[
            normalizeEl({id:uid(),type:'shape',x:40,y:40,w:880,h:460,z:1,shape:'rect',style:{fill:'#EDE9FE',stroke:'#8B5CF6'}}),
            normalizeEl({id:uid(),type:'text',x:80,y:90,w:800,h:240,z:2,content:'–ü—Ä–∏–≤—ñ—Ç! üëã\n–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –ø–æ—á–∞—Ç–∏',style:{fontSize:64,color:'#1a1040',bold:true,italic:false,underline:false,align:'center'}}),
            normalizeEl({id:uid(),type:'text',x:100,y:350,w:760,h:100,z:3,content:'‚ú® –ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ —Ç–µ–∫—Å—Ç –∞–±–æ –¥–æ–¥–∞–π —â–æ—Å—å –Ω–æ–≤–µ!',style:{fontSize:30,color:'#6366f1',bold:false,italic:false,underline:false,align:'center'}}),
          ]
        }],
        current:0,selected:null
      };
      undoStack=[JSON.stringify(state)];redoStack=[];scheduleSave();
    }

    /* Boot */
    function boot(){
      initDom();initPopovers();initState();bindUI();initKeyboard();
      scaleStage();renderAll();updateUndoRedo();

      const ro=new ResizeObserver(()=>scaleStage());
      ro.observe(dom.workspace);
      document.fonts?.ready?.then(()=>{renderThumbnails();scaleStage();});

      /* Show welcome only on first visit */
      if(!localStorage.getItem(STORAGE_KEY+'_welcomed')){
        $('welcomeOverlay').style.display='flex';
      } else {
        $('welcomeOverlay').style.display='none';
      }
    }
    return{boot};
  })();

  window.addEventListener('load',()=>App.boot());
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–õ–ê–ô–î–ò–ö Kids ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ–π</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

    :root {
      --slide-w: 960px;
      --slide-h: 540px; /* 16:9 */
    }

    html, body { height: 100%; }
    body {
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #cbd5e1;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .sharp { border-radius: 0 !important; }

    /* Stage (workspace slide) */
    #stage {
      width: 100%;
      max-width: var(--slide-w);
      aspect-ratio: 16 / 9;
      background: white;
      position: relative;
      overflow: hidden;
      border: 2px solid #475569;
      box-shadow: 10px 10px 0 rgba(0,0,0,.12);
      touch-action: none;
    }

    /* Elements */
    .el {
      position: absolute;
      box-sizing: border-box;
      border: 2px solid transparent;
      min-width: 40px;
      min-height: 30px;
      cursor: grab;
      touch-action: none;
    }

    .el.selected {
      border-color: #2563eb;
      cursor: grab;
    }

    .el.dragging { cursor: grabbing; }

    .el .content {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .textBox {
      padding: 8px;
      user-select: text !important;
      cursor: text;
      outline: none;
      line-height: 1.1;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .shape {
      width: 100%;
      height: 100%;
    }

    /* Resize handles */
    .handles { display: none; position: absolute; inset: 0; pointer-events: none; }
    .el.selected .handles { display: block; }

    .handle {
      width: 10px;
      height: 10px;
      background: #2563eb;
      position: absolute;
      pointer-events: auto;
    }

    .handle.nw { left: -6px; top: -6px; cursor: nwse-resize; }
    .handle.n  { left: 50%; top: -6px; transform: translateX(-50%); cursor: ns-resize; }
    .handle.ne { right: -6px; top: -6px; cursor: nesw-resize; }
    .handle.e  { right: -6px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }
    .handle.se { right: -6px; bottom: -6px; cursor: nwse-resize; }
    .handle.s  { left: 50%; bottom: -6px; transform: translateX(-50%); cursor: ns-resize; }
    .handle.sw { left: -6px; bottom: -6px; cursor: nesw-resize; }
    .handle.w  { left: -6px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }

    /* Sidebar slide thumbnail */
    .thumb {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: white;
      border: 2px solid #94a3b8;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .thumb.active {
      border-color: #2563eb;
      box-shadow: 4px 4px 0 #bfdbfe;
    }

    .thumb .mini {
      width: var(--slide-w);
      height: var(--slide-h);
      transform: scale(0.22);
      transform-origin: top left;
      pointer-events: none;
      position: relative;
    }

    /* Popovers */
    .popover {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 60;
      background: white;
      border: 2px solid #0f172a;
      box-shadow: 10px 10px 0 rgba(0,0,0,.12);
      padding: .75rem;
    }

    /* Presentation overlay */
    #presentOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 1000;
    }

    /* A11y focus */
    button:focus-visible, select:focus-visible, input:focus-visible {
      outline: 3px solid #60a5fa;
      outline-offset: 2px;
    }

    /* Prevent drag image */
    img { -webkit-user-drag: none; user-select: none; }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

  <!-- Header -->
  <header class="bg-slate-900 text-white p-3 flex justify-between items-center z-50">
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-layer-group text-blue-400 text-2xl"></i>
      <h1 class="text-xl font-black tracking-tight uppercase">–°–õ–ê–ô–î–ò–ö Kids</h1>
      <span class="ml-2 hidden sm:inline text-[10px] font-black uppercase tracking-widest text-slate-300">–ø—Ä–æ—Å—Ç–æ ‚Ä¢ –±–µ–∑–ø–µ—á–Ω–æ ‚Ä¢ –¥–ª—è 3‚Äì4 –∫–ª–∞—Å—É</span>
    </div>

    <div class="flex gap-2">
      <button id="btnPresent" class="bg-emerald-500 hover:bg-emerald-600 px-5 py-2 font-black sharp uppercase text-xs transition-all" title="–ü–æ—á–∞—Ç–∏ –ø–æ–∫–∞–∑">
        <i class="fa-solid fa-play mr-2"></i> –ü–µ—Ä–µ–≥–ª—è–¥
      </button>
      <button id="btnPDF" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 font-black sharp uppercase text-xs transition-all" title="–ó–±–µ—Ä–µ–≥—Ç–∏ PDF">
        <i class="fa-solid fa-file-pdf mr-2"></i> PDF
      </button>
      <button id="btnReset" class="bg-red-600 hover:bg-red-700 px-4 py-2 font-black sharp uppercase text-xs transition-all" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ">
        –û—á–∏—Å—Ç–∏—Ç–∏
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-100 border-r-2 border-slate-300 flex flex-col">
      <div class="p-4 border-b-2 border-slate-300 bg-white">
        <div class="flex items-center justify-between">
          <div class="text-[10px] font-black uppercase tracking-widest text-slate-500">–°–ª–∞–π–¥–∏</div>
          <div class="flex gap-1">
            <button id="btnSlideUp" class="p-2 border-2 border-slate-900 bg-white sharp hover:bg-slate-900 hover:text-white transition-all" title="–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ —Å–ª–∞–π–¥ –≤–≥–æ—Ä—É">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
            <button id="btnSlideDown" class="p-2 border-2 border-slate-900 bg-white sharp hover:bg-slate-900 hover:text-white transition-all" title="–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ —Å–ª–∞–π–¥ –≤–Ω–∏–∑">
              <i class="fa-solid fa-arrow-down"></i>
            </button>
          </div>
        </div>
      </div>

      <div id="slideList" class="p-4 overflow-y-auto flex-1 space-y-3"></div>

      <div class="p-4 border-t-2 border-slate-300 bg-white space-y-2">
        <button id="btnTemplates" class="w-full border-2 border-slate-900 py-2 font-black text-[10px] uppercase sharp hover:bg-slate-900 hover:text-white transition-all">
          –ú–∞–∫–µ—Ç–∏
        </button>
        <button id="btnNewSlide" class="w-full bg-blue-600 text-white py-3 font-black sharp uppercase text-xs hover:bg-blue-700 shadow-[4px_4px_0px_#1e40af]">
          –ù–æ–≤–∏–π —Å–ª–∞–π–¥
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col">

      <!-- Toolbar -->
      <div class="bg-white border-b-2 border-slate-300 p-2 flex items-start overflow-x-auto gap-3">

        <div class="flex flex-col px-3 border-r-2 border-slate-200">
          <span class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-tight">–°–ª–∞–π–¥</span>
          <div class="flex gap-1">
            <button id="btnDupSlide" class="p-2 border border-transparent hover:bg-slate-800 hover:text-white text-emerald-600 transition-all flex items-center justify-center" title="–î—É–±–ª—é–≤–∞—Ç–∏ —Å–ª–∞–π–¥">
              <i class="fa-regular fa-copy"></i>
            </button>
            <button id="btnDelSlide" class="p-2 border border-transparent hover:bg-slate-800 hover:text-white text-slate-400 transition-all flex items-center justify-center" title="–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–∞–π–¥">
              <i class="fa-regular fa-trash-can"></i>
            </button>
            <button id="btnBg" class="p-2 border border-transparent hover:bg-slate-800 hover:text-white text-orange-500 transition-all flex items-center justify-center" title="–§–æ–Ω">
              <i class="fa-solid fa-fill-drip"></i>
            </button>
          </div>
        </div>

        <div class="flex flex-col px-3 border-r-2 border-slate-200">
          <span class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-tight">–í—Å—Ç–∞–≤–∫–∞</span>
          <div class="flex gap-1">
            <button id="btnAddText" class="p-2 hover:bg-slate-800 hover:text-white text-blue-600 transition-all border border-transparent flex items-center justify-center" title="–¢–µ–∫—Å—Ç">
              <i class="fa-solid fa-font"></i>
            </button>
            <button id="btnAddImage" class="p-2 hover:bg-slate-800 hover:text-white text-purple-600 transition-all border border-transparent flex items-center justify-center" title="–§–æ—Ç–æ">
              <i class="fa-regular fa-image"></i>
            </button>
            <button id="btnEmoji" class="p-2 hover:bg-slate-800 hover:text-white text-amber-500 transition-all border border-transparent flex items-center justify-center" title="–°–º–∞–π–ª–∏–∫">
              <i class="fa-regular fa-face-smile"></i>
            </button>
            <button id="btnShapeRect" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ü—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫">
              <i class="fa-regular fa-square"></i>
            </button>
            <button id="btnShapeCircle" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ö–æ–ª–æ">
              <i class="fa-regular fa-circle"></i>
            </button>
          </div>
        </div>

        <div class="flex flex-col px-3 border-r-2 border-slate-200">
          <span class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-tight">–¢–µ–∫—Å—Ç</span>
          <div class="flex gap-1 items-center">
            <select id="selFontSize" class="text-[10px] font-bold border-2 border-slate-200 sharp p-1" title="–†–æ–∑–º—ñ—Ä">
              <option value="18">S</option>
              <option value="28" selected>M</option>
              <option value="40">L</option>
              <option value="56">XL</option>
            </select>
            <button id="btnBold" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ñ–∏—Ä–Ω–∏–π">
              <i class="fa-solid fa-bold"></i>
            </button>
            <button id="btnItalic" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ö—É—Ä—Å–∏–≤">
              <i class="fa-solid fa-italic"></i>
            </button>
            <button id="btnUnderline" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ü—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è">
              <i class="fa-solid fa-underline"></i>
            </button>
            <button id="btnAlignLeft" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–í–∏—Ä—ñ–≤–Ω—è—Ç–∏ –ª—ñ–≤–æ—Ä—É—á">
              <i class="fa-solid fa-align-left"></i>
            </button>
            <button id="btnAlignCenter" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">
              <i class="fa-solid fa-align-center"></i>
            </button>
            <button id="btnAlignRight" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ü—Ä–∞–≤–æ—Ä—É—á">
              <i class="fa-solid fa-align-right"></i>
            </button>
            <button id="btnTextColor" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É">
              <i class="fa-solid fa-palette"></i>
            </button>
          </div>
        </div>

        <div class="flex flex-col px-3">
          <span class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-tight">–û–±‚Äô—î–∫—Ç</span>
          <div class="flex gap-1">
            <button id="btnFill" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ó–∞–ª–∏–≤–∫–∞ (—Ñ—ñ–≥—É—Ä–∏)">
              <i class="fa-solid fa-droplet"></i>
            </button>
            <button id="btnStroke" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ö–æ–Ω—Ç—É—Ä (—Ñ—ñ–≥—É—Ä–∏)">
              <i class="fa-solid fa-pen-ruler"></i>
            </button>
            <button id="btnBringFront" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ù–∞ –ø–µ—Ä–µ–¥–Ω—ñ–π –ø–ª–∞–Ω">
              <i class="fa-solid fa-layer-group"></i>
            </button>
            <button id="btnSendBack" class="p-2 hover:bg-slate-800 hover:text-white text-slate-700 transition-all border border-transparent flex items-center justify-center" title="–ù–∞ –∑–∞–¥–Ω—ñ–π –ø–ª–∞–Ω">
              <i class="fa-solid fa-layer-group fa-flip-vertical"></i>
            </button>
            <button id="btnDupEl" class="p-2 hover:bg-slate-800 hover:text-white text-emerald-600 transition-all border border-transparent flex items-center justify-center" title="–î—É–±–ª—é–≤–∞—Ç–∏ –æ–±‚Äô—î–∫—Ç (Ctrl+D)">
              <i class="fa-regular fa-clone"></i>
            </button>
            <button id="btnDelEl" class="p-2 hover:bg-slate-800 hover:text-white text-red-500 transition-all border border-transparent flex items-center justify-center" title="–í–∏–¥–∞–ª–∏—Ç–∏ (Delete)">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>

      </div>

      <!-- Workspace -->
      <div id="workspace" class="flex-1 overflow-auto p-10 flex justify-center items-center relative">
        <div id="stage" class="sharp" aria-label="–ü–æ–ª–æ—Ç–Ω–æ —Å–ª–∞–π–¥–∞"></div>

        <!-- Color popover -->
        <div id="colorPopover" class="popover hidden sharp">
          <div class="flex items-center justify-between mb-2">
            <div id="colorTitle" class="text-[10px] font-black uppercase tracking-widest">–ö–û–õ–Ü–†</div>
            <button id="btnClosePopover" class="text-slate-400 hover:text-black" title="–ó–∞–∫—Ä–∏—Ç–∏">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div id="colorGrid" class="grid grid-cols-6 gap-2"></div>
        </div>

        <!-- Emoji popover -->
        <div id="emojiPopover" class="popover hidden sharp w-72">
          <div class="flex items-center justify-between mb-2">
            <div class="text-[10px] font-black uppercase tracking-widest">–°–ú–ê–ô–õ–ò–ö–ò</div>
            <button id="btnCloseEmoji" class="text-slate-400 hover:text-black" title="–ó–∞–∫—Ä–∏—Ç–∏">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div id="emojiGrid" class="grid grid-cols-8 gap-2"></div>
        </div>

      </div>

      <!-- Status bar -->
      <div class="bg-slate-800 text-slate-300 px-4 py-1 flex justify-between text-[10px] font-bold uppercase tracking-widest">
        <span id="zoomInfo">–ü–æ–ª–æ—Ç–Ω–æ: 16:9</span>
        <span id="saveInfo">–ì–æ—Ç–æ–≤–æ</span>
      </div>

    </main>

  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-[2000] flex items-center justify-center p-4">
    <div class="bg-white p-6 max-w-lg w-full border-2 border-slate-900 sharp shadow-[12px_12px_0px_#2563eb] relative" role="dialog" aria-modal="true">
      <button id="btnModalClose" class="absolute top-3 right-3 text-slate-300 hover:text-black" title="–ó–∞–∫—Ä–∏—Ç–∏">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
      <h3 id="modalTitle" class="text-lg font-black mb-4 uppercase text-center text-slate-900">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
      <div id="modalBody" class="mb-5"></div>
      <div id="modalActions" class="flex gap-2">
        <button id="btnModalCancel" class="flex-1 py-3 bg-slate-200 font-black uppercase text-xs sharp">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button id="btnModalOk" class="flex-1 py-3 bg-blue-600 text-white font-black uppercase text-xs sharp">–î–æ–±—Ä–µ</button>
      </div>
    </div>
  </div>

  <!-- Presentation overlay -->
  <div id="presentOverlay">
    <div id="presentStageWrap" class="w-full h-full flex items-center justify-center"></div>
    <button id="btnPresentClose" class="fixed top-6 right-6 text-white text-4xl opacity-60 hover:opacity-100 transition-all" title="–í–∏–π—Ç–∏">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <script>
    /**************
     * SLAYDYK Kids v2.1 (fixed)
     **************/

    const STORAGE_KEY = 'slidyk_kids_v2';
    const MAX_HISTORY = 60;

    const COLORS = [
      '#000000','#ffffff','#ef4444','#f97316','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899',
      '#64748b','#1e293b','#94a3b8','#22c55e','#0ea5e9','#a855f7','#facc15','#fb7185','#7c3aed'
    ];

    const EMOJIS = ['üòÄ','üòÅ','üòÖ','üòç','üòé','ü§©','ü•≥','ü§ñ','üëã','üëç','üëè','‚ù§Ô∏è','‚ú®','üåü','üî•','üí°','üé®','üéÆ','‚öΩ','üèÜ','üöÄ','üåà','üçï','üç¶','üê±','üê∂','üêº','ü¶ä','ü¶Ñ','üê∏','üêô','üß†','üìö','‚úèÔ∏è','üß©'];

    const uid = () => Math.floor(Date.now() + Math.random() * 100000);
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    const deepClone = (o) => JSON.parse(JSON.stringify(o));

    function safeParse(json, fallback) {
      try { return JSON.parse(json); } catch { return fallback; }
    }

    function normalizeState(raw) {
      if (!raw || typeof raw !== 'object') return null;
      if (!Array.isArray(raw.slides) || raw.slides.length === 0) return null;

      const slides = raw.slides.map(s => ({
        id: typeof s.id === 'number' ? s.id : uid(),
        background: typeof s.background === 'string' ? s.background : '#ffffff',
        elements: Array.isArray(s.elements) ? s.elements.map(e => ({
          id: typeof e.id === 'number' ? e.id : uid(),
          type: ['text','image','shape'].includes(e.type) ? e.type : 'text',
          x: Number.isFinite(e.x) ? e.x : 100,
          y: Number.isFinite(e.y) ? e.y : 100,
          w: Number.isFinite(e.w) ? e.w : 260,
          h: Number.isFinite(e.h) ? e.h : 80,
          z: Number.isFinite(e.z) ? e.z : 1,
          content: typeof e.content === 'string' ? e.content : '',
          style: typeof e.style === 'object' && e.style ? {
            fontSize: Number.isFinite(e.style.fontSize) ? e.style.fontSize : 28,
            color: typeof e.style.color === 'string' ? e.style.color : '#111827',
            bold: !!e.style.bold,
            italic: !!e.style.italic,
            underline: !!e.style.underline,
            align: ['left','center','right'].includes(e.style.align) ? e.style.align : 'left',
            fill: typeof e.style.fill === 'string' ? e.style.fill : '#60a5fa',
            stroke: typeof e.style.stroke === 'string' ? e.style.stroke : '#0f172a'
          } : {
            fontSize: 28,
            color: '#111827',
            bold: false,
            italic: false,
            underline: false,
            align: 'left',
            fill: '#60a5fa',
            stroke: '#0f172a'
          },
          shape: e.shape && ['rect','circle'].includes(e.shape) ? e.shape : 'rect'
        })) : []
      }));

      return {
        slides,
        current: Number.isFinite(raw.current) ? clamp(raw.current, 0, slides.length - 1) : 0,
        selected: Number.isFinite(raw.selected) ? raw.selected : null
      };
    }

    const App = (() => {
      let state;
      let undoStack = [];
      let redoStack = [];
      const dom = {};
      const elDomMap = new Map();

      const pointer = {
        mode: 'none',
        elId: null,
        handle: null,
        startX: 0,
        startY: 0,
        dragOffset: { x: 0, y: 0 },
        startBox: null
      };

      let colorMode = 'textColor';
      let clip = null;
      let saveTimer = null;
      let thumbsTimer = null;

      function $(id) { return document.getElementById(id); }
      function slide() { return state.slides[state.current]; }
      function elements() { return slide().elements; }
      function selectedEl() { return state.selected ? (elements().find(e => e.id === state.selected) || null) : null; }

      function normalizeZ(sl) {
        const sorted = [...sl.elements].sort((a,b) => (a.z ?? 1) - (b.z ?? 1));
        sorted.forEach((e, i) => e.z = i + 1);
      }

      function setSaveInfo(text) { dom.saveInfo.textContent = text || '–ì–æ—Ç–æ–≤–æ'; }

      function scheduleSave(label = '–ó–±–µ—Ä–µ–∂–µ–Ω–æ') {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          setSaveInfo(`${label}: ${new Date().toLocaleTimeString()}`);
        }, 200);
      }

      function debounceThumbs() {
        if (thumbsTimer) clearTimeout(thumbsTimer);
        thumbsTimer = setTimeout(() => renderThumbnails(), 300);
      }

      function pushHistory(reason = '') {
        const snap = JSON.stringify(state);
        if (undoStack.length && undoStack[undoStack.length - 1] === snap) return;
        undoStack.push(snap);
        if (undoStack.length > MAX_HISTORY) undoStack.shift();
        redoStack = [];
        if (reason) setSaveInfo(`–ó–º—ñ–Ω–∞: ${reason}`);
      }

      function undo() {
        if (undoStack.length <= 1) return;
        const currentSnap = undoStack.pop();
        redoStack.push(currentSnap);
        const prev = undoStack[undoStack.length - 1];
        state = normalizeState(safeParse(prev, null)) || state;
        state.selected = null;
        renderAll();
        scheduleSave('Undo');
      }

      function redo() {
        if (redoStack.length === 0) return;
        const next = redoStack.pop();
        undoStack.push(next);
        state = normalizeState(safeParse(next, null)) || state;
        state.selected = null;
        renderAll();
        scheduleSave('Redo');
      }

      function stageRect() { return dom.stage.getBoundingClientRect(); }

      function toStagePoint(clientX, clientY) {
        const r = stageRect();
        const baseW = Number(dom.stage.dataset.baseW);
        const baseH = Number(dom.stage.dataset.baseH);
        const sx = baseW / r.width;
        const sy = baseH / r.height;
        return { x: (clientX - r.left) * sx, y: (clientY - r.top) * sy, baseW, baseH };
      }

      function applyTextStyleToDom(node, el) {
        node.style.fontSize = (el.style.fontSize || 28) + 'px';
        node.style.color = el.style.color || '#111827';
        node.style.fontWeight = el.style.bold ? '900' : '700';
        node.style.fontStyle = el.style.italic ? 'italic' : 'normal';
        node.style.textDecoration = el.style.underline ? 'underline' : 'none';
        node.style.textAlign = el.style.align || 'left';
      }

      function updateSelectionDom() {
        for (const [id, node] of elDomMap.entries()) {
          node.classList.toggle('selected', state.selected === id);
        }
      }

      function selectElement(id) {
        state.selected = id;
        closePopovers();
        updateSelectionDom();
        scheduleSave('–í–∏–±—Ä–∞–Ω–æ');
      }

      function deselect() {
        state.selected = null;
        closePopovers();
        updateSelectionDom();
      }

      function initPopovers() {
        dom.colorGrid.innerHTML = '';
        COLORS.forEach(c => {
          const b = document.createElement('button');
          b.className = 'w-7 h-7 border-2 border-slate-200 sharp hover:scale-105 transition-transform';
          b.style.background = c;
          b.title = c;
          b.addEventListener('click', () => {
            applyColor(c);
            closePopovers();
          });
          dom.colorGrid.appendChild(b);
        });

        dom.emojiGrid.innerHTML = '';
        EMOJIS.forEach(emo => {
          const b = document.createElement('button');
          b.className = 'text-2xl p-1 sharp hover:bg-slate-100';
          b.textContent = emo;
          b.addEventListener('click', () => {
            addEmoji(emo);
            closePopovers();
          });
          dom.emojiGrid.appendChild(b);
        });
      }

      function openColor(mode) {
        colorMode = mode;
        dom.colorTitle.textContent = {
          textColor: '–ö–û–õ–Ü–† –¢–ï–ö–°–¢–£',
          bg: '–§–û–ù –°–õ–ê–ô–î–ê',
          fill: '–ó–ê–õ–ò–í–ö–ê (–§–Ü–ì–£–†–ò)',
          stroke: '–ö–û–ù–¢–£–† (–§–Ü–ì–£–†–ò)'
        }[mode] || '–ö–û–õ–Ü–†';
        closePopovers();
        dom.colorPopover.classList.remove('hidden');
      }

      function openEmoji() {
        closePopovers();
        dom.emojiPopover.classList.remove('hidden');
      }

      function closePopovers() {
        dom.colorPopover.classList.add('hidden');
        dom.emojiPopover.classList.add('hidden');
      }

      function applyColor(color) {
        pushHistory('–ö–æ–ª—ñ—Ä');
        if (colorMode === 'bg') {
          slide().background = color;
          dom.stage.style.background = slide().background;
          renderThumbnails();
          scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
          return;
        }
        const el = selectedEl();
        if (!el) return;
        if (colorMode === 'textColor' && el.type === 'text') {
          el.style.color = color;
          const textNode = elDomMap.get(el.id)?.querySelector('.textBox');
          if (textNode) textNode.style.color = color;
        }
        if (colorMode === 'fill' && el.type === 'shape') {
          el.style.fill = color;
          const shapeNode = elDomMap.get(el.id)?.querySelector('svg *');
          if (shapeNode) shapeNode.setAttribute('fill', color);
        }
        if (colorMode === 'stroke' && el.type === 'shape') {
          el.style.stroke = color;
          const shapeNode = elDomMap.get(el.id)?.querySelector('svg *');
          if (shapeNode) shapeNode.setAttribute('stroke', color);
        }
        renderThumbnails();
        scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function openModal({ title, bodyHTML, okText = '–î–æ–±—Ä–µ', cancelText = '–°–∫–∞—Å—É–≤–∞—Ç–∏', onOk, showActions = true }) {
        dom.modalTitle.textContent = title;
        dom.modalBody.innerHTML = bodyHTML;
        dom.modalActions.classList.toggle('hidden', !showActions);
        $('btnModalOk').textContent = okText;
        $('btnModalCancel').textContent = cancelText;
        $('btnModalOk').onclick = () => { if (onOk) onOk(); closeModal(); };
        $('btnModalCancel').onclick = () => closeModal();
        dom.modalOverlay.classList.remove('hidden');
      }

      function closeModal() { dom.modalOverlay.classList.add('hidden'); }

      function confirmAction({ title, message, okText = '–¢–∞–∫', cancelText = '–ù—ñ', onYes }) {
        openModal({
          title,
          bodyHTML: `<p class="text-sm font-bold text-slate-700">${message}</p>`,
          okText,
          cancelText,
          onOk: () => { if (onYes) onYes(); }
        });
      }

      function renderAll() {
        renderThumbnails();
        renderStage();
      }

      function renderThumbnails() {
        dom.slideList.innerHTML = '';
        state.slides.forEach((s, idx) => {
          const wrap = document.createElement('div');
          wrap.className = 'space-y-2';
          const head = document.createElement('div');
          head.className = 'flex items-center justify-between';
          const label = document.createElement('div');
          label.className = 'text-[10px] font-black uppercase tracking-widest text-slate-500';
          label.textContent = `–°–ª–∞–π–¥ ${idx + 1}`;
          const actions = document.createElement('div');
          actions.className = 'flex gap-1';
          const btn = (icon, title, cb) => {
            const b = document.createElement('button');
            b.className = 'p-2 border-2 border-slate-900 bg-white sharp hover:bg-slate-900 hover:text-white transition-all';
            b.innerHTML = icon; b.title = title;
            b.addEventListener('click', (e) => { e.stopPropagation(); cb(); });
            return b;
          };
          actions.appendChild(btn('<i class="fa-regular fa-copy"></i>', '–î—É–±–ª—é–≤–∞—Ç–∏', () => duplicateSlide(idx)));
          actions.appendChild(btn('<i class="fa-regular fa-trash-can"></i>', '–í–∏–¥–∞–ª–∏—Ç–∏', () => confirmDeleteSlide(idx)));
          head.appendChild(label); head.appendChild(actions);
          const thumb = document.createElement('div');
          thumb.className = 'thumb sharp ' + (idx === state.current ? 'active' : '');
          thumb.addEventListener('click', () => {
            state.current = idx; state.selected = null;
            closePopovers(); renderAll(); scheduleSave('–í–∏–±—Ä–∞–Ω–æ');
          });
          const mini = document.createElement('div');
          mini.className = 'mini'; mini.style.background = s.background;
          const els = [...s.elements].sort((a,b) => (a.z??1) - (b.z??1));
          els.forEach(el => {
            const d = document.createElement('div');
            d.style.position = 'absolute'; d.style.left = el.x + 'px'; d.style.top = el.y + 'px'; d.style.width = el.w + 'px'; d.style.height = el.h + 'px'; d.style.overflow = 'hidden';
            if (el.type === 'text') {
              d.style.fontSize = (el.style.fontSize || 28) + 'px'; d.style.color = el.style.color || '#111827'; d.style.fontWeight = el.style.bold ? '900' : '700'; d.style.fontStyle = el.style.italic ? 'italic' : 'normal'; d.style.textDecoration = el.style.underline ? 'underline' : 'none'; d.style.textAlign = el.style.align || 'left'; d.style.whiteSpace = 'pre-wrap'; d.style.padding = '8px'; d.textContent = el.content || '';
            }
            if (el.type === 'image') {
              const img = document.createElement('img'); img.src = el.content; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; d.appendChild(img);
            }
            if (el.type === 'shape') {
              const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
              const shape = document.createElementNS('http://www.w3.org/2000/svg', el.shape === 'circle' ? 'ellipse' : 'rect');
              if (el.shape === 'circle') { shape.setAttribute('cx', '50%'); shape.setAttribute('cy', '50%'); shape.setAttribute('rx', '48%'); shape.setAttribute('ry', '48%'); }
              else { shape.setAttribute('x', '2%'); shape.setAttribute('y', '2%'); shape.setAttribute('width', '96%'); shape.setAttribute('height', '96%'); }
              shape.setAttribute('fill', el.style.fill || '#60a5fa'); shape.setAttribute('stroke', el.style.stroke || '#0f172a'); shape.setAttribute('stroke-width', '8');
              svg.appendChild(shape); d.appendChild(svg);
            }
            mini.appendChild(d);
          });
          thumb.appendChild(mini); wrap.appendChild(head); wrap.appendChild(thumb);
          dom.slideList.appendChild(wrap);
        });
      }

      function renderStage() {
        dom.stage.innerHTML = '';
        elDomMap.clear();
        dom.stage.style.background = slide().background;
        const els = [...elements()].sort((a,b) => (a.z??1) - (b.z??1));
        els.forEach(el => {
          const w = document.createElement('div');
          w.className = 'el sharp' + (state.selected === el.id ? ' selected' : '');
          w.dataset.id = String(el.id); w.style.left = el.x + 'px'; w.style.top = el.y + 'px'; w.style.width = el.w + 'px'; w.style.height = el.h + 'px'; w.style.zIndex = String(el.z || 1);
          const content = document.createElement('div');
          content.className = 'content sharp';
          if (el.type === 'text') {
            const t = document.createElement('div');
            t.className = 'textBox'; t.contentEditable = 'true'; t.spellcheck = false; t.textContent = el.content || '';
            applyTextStyleToDom(t, el);
            t.addEventListener('input', () => { el.content = t.textContent || ''; scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ'); debounceThumbs(); });
            t.addEventListener('pointerdown', (e) => { e.stopPropagation(); selectElement(el.id); });
            content.appendChild(t);
          }
          if (el.type === 'image') {
            const img = document.createElement('img'); img.src = el.content; img.className = 'sharp'; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; img.draggable = false;
            content.appendChild(img);
          }
          if (el.type === 'shape') {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%'); svg.setAttribute('class', 'shape');
            const shape = document.createElementNS('http://www.w3.org/2000/svg', el.shape === 'circle' ? 'ellipse' : 'rect');
            if (el.shape === 'circle') { shape.setAttribute('cx', '50%'); shape.setAttribute('cy', '50%'); shape.setAttribute('rx', '48%'); shape.setAttribute('ry', '48%'); }
            else { shape.setAttribute('x', '2%'); shape.setAttribute('y', '2%'); shape.setAttribute('width', '96%'); shape.setAttribute('height', '96%'); }
            shape.setAttribute('fill', el.style.fill || '#60a5fa'); shape.setAttribute('stroke', el.style.stroke || '#0f172a'); shape.setAttribute('stroke-width', '10');
            svg.appendChild(shape); content.appendChild(svg);
          }
          w.appendChild(content);
          const handles = document.createElement('div');
          handles.className = 'handles';
          const pos = ['nw','n','ne','e','se','s','sw','w'];
          pos.forEach(p => {
            const h = document.createElement('div'); h.className = `handle ${p} sharp`; h.dataset.handle = p;
            h.addEventListener('pointerdown', (e) => onHandlePointerDown(e, el.id, p));
            handles.appendChild(h);
          });
          w.appendChild(handles);
          w.addEventListener('pointerdown', (e) => onElementPointerDown(e, el.id));
          elDomMap.set(el.id, w); dom.stage.appendChild(w);
        });
        updateSelectionDom();
      }

      function onElementPointerDown(e, id) {
        if (e.target && e.target.classList && e.target.classList.contains('textBox')) return;
        e.stopPropagation(); selectElement(id);
        const el = elements().find(x => x.id === id);
        const node = elDomMap.get(id);
        if (!el || !node) return;
        pushHistory('–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è');
        const p = toStagePoint(e.clientX, e.clientY);
        pointer.mode = 'drag'; pointer.elId = id; pointer.dragOffset = { x: p.x - el.x, y: p.y - el.y };
        node.setPointerCapture(e.pointerId); node.classList.add('dragging');
        const move = (ev) => onPointerMove(ev);
        const up = (ev) => onPointerUp(ev, move, up);
        node.addEventListener('pointermove', move);
        node.addEventListener('pointerup', up, { once: true });
        node.addEventListener('pointercancel', up, { once: true });
      }

      function onHandlePointerDown(e, id, handle) {
        e.stopPropagation(); e.preventDefault(); selectElement(id);
        const el = elements().find(x => x.id === id);
        const node = elDomMap.get(id);
        if (!el || !node) return;
        pushHistory('–ó–º—ñ–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É');
        const p = toStagePoint(e.clientX, e.clientY);
        pointer.mode = 'resize'; pointer.elId = id; pointer.handle = handle; pointer.startX = p.x; pointer.startY = p.y; pointer.startBox = { x: el.x, y: el.y, w: el.w, h: el.h };
        node.setPointerCapture(e.pointerId);
        const move = (ev) => onPointerMove(ev);
        const up = (ev) => onPointerUp(ev, move, up);
        node.addEventListener('pointermove', move);
        node.addEventListener('pointerup', up, { once: true });
        node.addEventListener('pointercancel', up, { once: true });
      }

      function onPointerMove(e) {
        const el = elements().find(x => x.id === pointer.elId);
        const node = elDomMap.get(pointer.elId);
        if (!el || !node) return;
        const p = toStagePoint(e.clientX, e.clientY);
        const baseW = Number(dom.stage.dataset.baseW);
        const baseH = Number(dom.stage.dataset.baseH);
        if (pointer.mode === 'drag') {
          const nx = p.x - pointer.dragOffset.x; const ny = p.y - pointer.dragOffset.y;
          el.x = clamp(nx, 0, baseW - el.w); el.y = clamp(ny, 0, baseH - el.h);
          node.style.left = el.x + 'px'; node.style.top = el.y + 'px';
          return;
        }
        if (pointer.mode === 'resize' && pointer.startBox) {
          const dx = p.x - pointer.startX; const dy = p.y - pointer.startY;
          let { x, y, w, h } = pointer.startBox;
          const minW = 40; const minH = 30;
          const has = (s) => pointer.handle.includes(s);
          if (has('e')) w = w + dx; if (has('s')) h = h + dy; if (has('w')) { x = x + dx; w = w - dx; } if (has('n')) { y = y + dy; h = h - dy; }
          w = Math.max(minW, w); h = Math.max(minH, h);
          x = clamp(x, 0, baseW - w); y = clamp(y, 0, baseH - h);
          el.x = x; el.y = y; el.w = w; el.h = h;
          node.style.left = el.x + 'px'; node.style.top = el.y + 'px'; node.style.width = el.w + 'px'; node.style.height = el.h + 'px';
        }
      }

      function onPointerUp(e, moveHandler, upHandler) {
        const node = elDomMap.get(pointer.elId);
        if (node) { node.classList.remove('dragging'); if (moveHandler) node.removeEventListener('pointermove', moveHandler); }
        pointer.mode = 'none'; pointer.elId = null; pointer.handle = null; pointer.startBox = null;
        normalizeZ(slide()); renderThumbnails(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function addSlide() {
        pushHistory('–ù–æ–≤–∏–π —Å–ª–∞–π–¥');
        state.slides.push({ id: uid(), background: '#ffffff', elements: [] });
        state.current = state.slides.length - 1; state.selected = null;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function confirmDeleteSlide(idx = state.current) {
        if (state.slides.length <= 1) {
          openModal({ title: '–ù–µ –º–æ–∂–Ω–∞', bodyHTML: '<p class="text-sm font-bold text-slate-700">–ú–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± 1 —Å–ª–∞–π–¥ üôÇ</p>', showActions: false });
          return;
        }
        confirmAction({ title: '–í–ò–î–ê–õ–ò–¢–ò –°–õ–ê–ô–î', message: `–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–∞–π–¥ ${idx + 1}?`, okText: '–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏', cancelText: '–ù—ñ', onYes: () => deleteSlide(idx) });
      }

      function deleteSlide(idx = state.current) {
        if (state.slides.length <= 1) return;
        pushHistory('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–∞–π–¥');
        state.slides.splice(idx, 1);
        state.current = clamp(state.current, 0, state.slides.length - 1); state.selected = null;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function duplicateSlide(idx = state.current) {
        pushHistory('–î—É–±–ª—é–≤–∞—Ç–∏ —Å–ª–∞–π–¥');
        const copy = deepClone(state.slides[idx]);
        copy.id = uid(); copy.elements.forEach(e => e.id = uid());
        state.slides.splice(idx + 1, 0, copy);
        state.current = idx + 1; state.selected = null;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function moveSlide(delta) {
        const i = state.current; const j = i + delta;
        if (j < 0 || j >= state.slides.length) return;
        pushHistory('–ü–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç–∏ —Å–ª–∞–π–¥');
        const tmp = state.slides[i]; state.slides[i] = state.slides[j]; state.slides[j] = tmp;
        state.current = j; renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function addText() {
        pushHistory('–¢–µ–∫—Å—Ç');
        const e = {
          id: uid(), type: 'text', x: 180, y: 160, w: 600, h: 120, z: elements().length + 1,
          content: '–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç‚Ä¶',
          style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#60a5fa', stroke: '#0f172a' },
          shape: 'rect'
        };
        elements().push(e); state.selected = e.id;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
        requestAnimationFrame(() => { const node = elDomMap.get(e.id)?.querySelector('.textBox'); if (node) { node.focus(); document.execCommand('selectAll', false, null); } });
      }

      function addEmoji(emo) {
        pushHistory('–°–º–∞–π–ª–∏–∫');
        const e = {
          id: uid(), type: 'text', x: 420, y: 220, w: 120, h: 120, z: elements().length + 1,
          content: emo,
          style: { fontSize: 56, color: '#111827', bold: false, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' },
          shape: 'rect'
        };
        elements().push(e); state.selected = e.id;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function addShape(kind) {
        pushHistory('–§—ñ–≥—É—Ä–∞');
        const e = {
          id: uid(), type: 'shape', x: 260, y: 170, w: 440, h: 240, z: elements().length + 1,
          content: '',
          style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#60a5fa', stroke: '#0f172a' },
          shape: kind
        };
        elements().push(e); state.selected = e.id;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function addImage() {
        const html = `
          <div class="space-y-4">
            <button id="pickFile" class="w-full py-4 border-2 border-dashed border-slate-300 sharp font-black text-xs uppercase hover:bg-slate-50 transition-colors">–û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª –∑ –ø—Ä–∏—Å—Ç—Ä–æ—é</button>
            <input type="file" id="fileInput" class="hidden" accept="image/*" />
            <div class="text-center text-[10px] font-black text-slate-400">–ê–ë–û</div>
            <input type="text" id="imgUrl" placeholder="–í—Å—Ç–∞–≤—Ç–µ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏‚Ä¶" class="w-full p-3 border-2 border-slate-900 sharp outline-none focus:border-blue-600 transition-colors" />
            <div class="text-[11px] font-bold text-slate-500">–ü–æ—Ä–∞–¥–∞: –∫—Ä–∞—â–µ –æ–±–∏—Ä–∞—Ç–∏ —Ñ–∞–π–ª –∑ –∫–æ–º–ø‚Äô—é—Ç–µ—Ä–∞ üôÇ</div>
          </div>
        `;
        openModal({ title: '–î–û–î–ê–¢–ò –§–û–¢–û', bodyHTML: html, okText: '–î–æ–¥–∞—Ç–∏', cancelText: '–ó–∞–∫—Ä–∏—Ç–∏', onOk: () => { const url = $('imgUrl').value.trim(); if (url) insertImage(url); } });
        $('pickFile').onclick = () => $('fileInput').click();
        $('fileInput').onchange = (ev) => {
          const f = ev.target.files && ev.target.files[0]; if (!f) return;
          const reader = new FileReader();
          reader.onload = () => { insertImage(String(reader.result)); closeModal(); };
          reader.readAsDataURL(f);
        };
      }

      function insertImage(src) {
        pushHistory('–§–æ—Ç–æ');
        const e = {
          id: uid(), type: 'image', x: 220, y: 140, w: 520, h: 300, z: elements().length + 1,
          content: src,
          style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#60a5fa', stroke: '#0f172a' },
          shape: 'rect'
        };
        elements().push(e); state.selected = e.id;
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function confirmDeleteSelected() {
        const el = selectedEl(); if (!el) return;
        const name = el.type === 'text' ? '—Ç–µ–∫—Å—Ç' : el.type === 'image' ? '—Ñ–æ—Ç–æ' : '—Ñ—ñ–≥—É—Ä—É';
        confirmAction({ title: '–í–ò–î–ê–õ–ò–¢–ò –û–ë‚Äô–Ñ–ö–¢', message: `–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ ${name}?`, okText: '–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏', cancelText: '–ù—ñ', onYes: () => deleteSelected() });
      }

      function deleteSelected() {
        const el = selectedEl(); if (!el) return;
        pushHistory('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±‚Äô—î–∫—Ç');
        slide().elements = slide().elements.filter(e => e.id !== el.id);
        state.selected = null; normalizeZ(slide());
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function duplicateSelected() {
        const el = selectedEl(); if (!el) return;
        pushHistory('–î—É–±–ª—é–≤–∞—Ç–∏ –æ–±‚Äô—î–∫—Ç');
        const copy = deepClone(el); copy.id = uid(); copy.x = clamp(copy.x + 20, 0, 960 - copy.w); copy.y = clamp(copy.y + 20, 0, 540 - copy.h); copy.z = elements().length + 1;
        elements().push(copy); state.selected = copy.id; normalizeZ(slide());
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function bringToFront() {
        const el = selectedEl(); if (!el) return;
        pushHistory('–ù–∞ –ø–µ—Ä–µ–¥–Ω—ñ–π –ø–ª–∞–Ω'); el.z = elements().length + 1; normalizeZ(slide());
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function sendToBack() {
        const el = selectedEl(); if (!el) return;
        pushHistory('–ù–∞ –∑–∞–¥–Ω—ñ–π –ø–ª–∞–Ω'); el.z = 0; normalizeZ(slide());
        renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function setFontSize(px) {
        const el = selectedEl(); if (!el || el.type !== 'text') return;
        pushHistory('–†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É'); el.style.fontSize = Number(px);
        const textNode = elDomMap.get(el.id)?.querySelector('.textBox'); if (textNode) textNode.style.fontSize = el.style.fontSize + 'px';
        debounceThumbs(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function toggleTextStyle(key) {
        const el = selectedEl(); if (!el || el.type !== 'text') return;
        pushHistory('–§–æ—Ä–º–∞—Ç'); el.style[key] = !el.style[key];
        const textNode = elDomMap.get(el.id)?.querySelector('.textBox'); if (textNode) applyTextStyleToDom(textNode, el);
        debounceThumbs(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function setAlign(align) {
        const el = selectedEl(); if (!el || el.type !== 'text') return;
        pushHistory('–í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è'); el.style.align = align;
        const textNode = elDomMap.get(el.id)?.querySelector('.textBox'); if (textNode) textNode.style.textAlign = align;
        debounceThumbs(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      function openTemplates() {
        const body = `
          <div class="grid grid-cols-1 gap-2">
            <button class="tpl p-3 bg-slate-50 border-2 border-slate-900 sharp font-black text-xs uppercase hover:bg-blue-600 hover:text-white transition-all" data-tpl="title">–¢–∏—Ç—É–ª—å–Ω–∏–π</button>
            <button class="tpl p-3 bg-slate-50 border-2 border-slate-900 sharp font-black text-xs uppercase hover:bg-blue-600 hover:text-white transition-all" data-tpl="two">–¢–µ–∫—Å—Ç + —Ñ–æ—Ç–æ</button>
            <button class="tpl p-3 bg-slate-50 border-2 border-slate-900 sharp font-black text-xs uppercase hover:bg-blue-600 hover:text-white transition-all" data-tpl="three">3 –±–ª–æ–∫–∏</button>
          </div>
          <div class="mt-4 text-[11px] font-bold text-slate-500">–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –º–∞–∫–µ—Ç–∞ ‚Äî –º–æ–∂–Ω–∞ –¥—Ä—É–∫—É–≤–∞—Ç–∏, –ø–µ—Ä–µ—Å—É–≤–∞—Ç–∏ —Ç–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ üôÇ</div>
        `;
        openModal({ title: '–ú–ê–ö–ï–¢–ò', bodyHTML: body, showActions: false });
        dom.modalBody.querySelectorAll('.tpl').forEach(btn => {
          btn.addEventListener('click', () => { applyTemplate(btn.dataset.tpl); closeModal(); });
        });
      }

      function applyTemplate(kind) {
        pushHistory('–ú–∞–∫–µ—Ç');
        const s = slide(); s.elements = []; s.background = '#ffffff';
        if (kind === 'title') {
          s.elements.push({ id: uid(), type: 'shape', x: 60, y: 60, w: 840, h: 420, z: 1, content: '', shape: 'rect', style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#dbeafe', stroke: '#1e40af' } });
          s.elements.push({ id: uid(), type: 'text', x: 120, y: 170, w: 720, h: 160, z: 2, content: '–ù–ê–ó–í–ê –ü–†–ï–ó–ï–ù–¢–ê–¶–Ü–á', shape: 'rect', style: { fontSize: 56, color: '#111827', bold: true, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' } });
          s.elements.push({ id: uid(), type: 'text', x: 220, y: 340, w: 520, h: 80, z: 3, content: '–ê–≤—Ç–æ—Ä: ‚Ä¶', shape: 'rect', style: { fontSize: 28, color: '#334155', bold: false, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' } });
        }
        if (kind === 'two') {
          s.elements.push({ id: uid(), type: 'text', x: 60, y: 60, w: 840, h: 80, z: 1, content: '–ó–ê–ì–û–õ–û–í–û–ö', shape: 'rect', style: { fontSize: 48, color: '#111827', bold: true, italic: false, underline: false, align: 'left', fill: '#60a5fa', stroke: '#0f172a' } });
          s.elements.push({ id: uid(), type: 'text', x: 60, y: 160, w: 420, h: 340, z: 2, content: `‚Ä¢ –ü—É–Ω–∫—Ç 1
‚Ä¢ –ü—É–Ω–∫—Ç 2
‚Ä¢ –ü—É–Ω–∫—Ç 3`, shape: 'rect', style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#60a5fa', stroke: '#0f172a' } });
          s.elements.push({ id: uid(), type: 'shape', x: 510, y: 160, w: 390, h: 340, z: 3, content: '', shape: 'rect', style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#fde68a', stroke: '#92400e' } });
          s.elements.push({ id: uid(), type: 'text', x: 540, y: 300, w: 330, h: 120, z: 4, content: '–î–æ–¥–∞–π —Ñ–æ—Ç–æ —Å—é–¥–∏', shape: 'rect', style: { fontSize: 28, color: '#92400e', bold: true, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' } });
        }
        if (kind === 'three') {
          s.elements.push({ id: uid(), type: 'text', x: 60, y: 50, w: 840, h: 70, z: 1, content: '–ú–Ü–ô –°–õ–ê–ô–î', shape: 'rect', style: { fontSize: 48, color: '#111827', bold: true, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' } });
          const blocks = [{ x: 60, fill: '#dcfce7', stroke: '#166534', title: '–Ü–¥–µ—è 1' }, { x: 340, fill: '#dbeafe', stroke: '#1e40af', title: '–Ü–¥–µ—è 2' }, { x: 620, fill: '#fae8ff', stroke: '#7e22ce', title: '–Ü–¥–µ—è 3' }];
          blocks.forEach((b, i) => {
            s.elements.push({ id: uid(), type: 'shape', x: b.x, y: 150, w: 280, h: 350, z: 2 + i, content: '', shape: 'rect', style: { fontSize: 28, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: b.fill, stroke: b.stroke } });
            s.elements.push({ id: uid(), type: 'text', x: b.x + 20, y: 175, w: 240, h: 60, z: 10 + i, content: b.title, shape: 'rect', style: { fontSize: 32, color: '#111827', bold: true, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' } });
            s.elements.push({ id: uid(), type: 'text', x: b.x + 20, y: 250, w: 240, h: 220, z: 20 + i, content: '–ù–∞–ø–∏—à–∏ —Ç—É—Ç‚Ä¶', shape: 'rect', style: { fontSize: 24, color: '#111827', bold: false, italic: false, underline: false, align: 'left', fill: '#60a5fa', stroke: '#0f172a' } });
          });
        }
        normalizeZ(s); state.selected = null; renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
      }

      async function exportPDF() {
        const container = document.createElement('div'); container.style.width = '960px';
        state.slides.forEach((s) => {
          const page = document.createElement('div'); page.style.cssText = `width:960px;height:540px;background:${s.background};position:relative;overflow:hidden;page-break-after:always;`;
          const els = [...s.elements].sort((a,b) => (a.z??1) - (b.z??1));
          els.forEach(el => {
            const box = document.createElement('div'); box.style.position = 'absolute'; box.style.left = el.x + 'px'; box.style.top = el.y + 'px'; box.style.width = el.w + 'px'; box.style.height = el.h + 'px';
            if (el.type === 'text') {
              box.style.fontSize = (el.style.fontSize || 28) + 'px'; box.style.color = el.style.color || '#111827'; box.style.fontWeight = el.style.bold ? '900' : '700'; box.style.fontStyle = el.style.italic ? 'italic' : 'normal'; box.style.textDecoration = el.style.underline ? 'underline' : 'none'; box.style.textAlign = el.style.align || 'left'; box.style.whiteSpace = 'pre-wrap'; box.style.padding = '8px'; box.textContent = el.content || '';
            }
            if (el.type === 'image') {
              const img = document.createElement('img'); img.src = el.content; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; box.appendChild(img);
            }
            if (el.type === 'shape') {
              const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
              const shape = document.createElementNS('http://www.w3.org/2000/svg', el.shape === 'circle' ? 'ellipse' : 'rect');
              if (el.shape === 'circle') { shape.setAttribute('cx', '50%'); shape.setAttribute('cy', '50%'); shape.setAttribute('rx', '48%'); shape.setAttribute('ry', '48%'); }
              else { shape.setAttribute('x', '2%'); shape.setAttribute('y', '2%'); shape.setAttribute('width', '96%'); shape.setAttribute('height', '96%'); }
              shape.setAttribute('fill', el.style.fill || '#60a5fa'); shape.setAttribute('stroke', el.style.stroke || '#0f172a'); shape.setAttribute('stroke-width', '10');
              svg.appendChild(shape); box.appendChild(svg);
            }
            page.appendChild(box);
          });
          container.appendChild(page);
        });
        await html2pdf().from(container).set({ margin: 0, filename: 'slidyk_kids.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'px', format: [960, 540], orientation: 'landscape' } }).save();
      }

      const Present = {
        idx: 0, keyHandler: null,
        start() {
          this.idx = state.current; dom.presentOverlay.style.display = 'block'; this.render();
          this.keyHandler = (e) => {
            if (e.key === 'ArrowRight' || e.key === ' ') { if (this.idx < state.slides.length - 1) { this.idx++; this.render(); } else this.stop(); }
            if (e.key === 'ArrowLeft') { if (this.idx > 0) { this.idx--; this.render(); } }
            if (e.key === 'Escape') this.stop();
          };
          window.addEventListener('keydown', this.keyHandler);
        },
        stop() { dom.presentOverlay.style.display = 'none'; if (this.keyHandler) window.removeEventListener('keydown', this.keyHandler); this.keyHandler = null; },
        render() {
          dom.presentStageWrap.innerHTML = '';
          const s = state.slides[this.idx];
          const st = document.createElement('div'); st.style.cssText = `width:960px;height:540px;background:${s.background};position:relative;overflow:hidden;border:10px solid #0f172a;`;
          const els = [...s.elements].sort((a,b) => (a.z??1) - (b.z??1));
          els.forEach(el => {
            const box = document.createElement('div'); box.style.position = 'absolute'; box.style.left = el.x + 'px'; box.style.top = el.y + 'px'; box.style.width = el.w + 'px'; box.style.height = el.h + 'px';
            if (el.type === 'text') {
              box.style.fontSize = (el.style.fontSize || 28) + 'px'; box.style.color = el.style.color || '#111827'; box.style.fontWeight = el.style.bold ? '900' : '700'; box.style.fontStyle = el.style.italic ? 'italic' : 'normal'; box.style.textDecoration = el.style.underline ? 'underline' : 'none'; box.style.textAlign = el.style.align || 'left'; box.style.whiteSpace = 'pre-wrap'; box.style.padding = '8px'; box.textContent = el.content || '';
            }
            if (el.type === 'image') {
              const img = document.createElement('img'); img.src = el.content; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; box.appendChild(img);
            }
            if (el.type === 'shape') {
              const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
              const shape = document.createElementNS('http://www.w3.org/2000/svg', el.shape === 'circle' ? 'ellipse' : 'rect');
              if (el.shape === 'circle') { shape.setAttribute('cx', '50%'); shape.setAttribute('cy', '50%'); shape.setAttribute('rx', '48%'); shape.setAttribute('ry', '48%'); }
              else { shape.setAttribute('x', '2%'); shape.setAttribute('y', '2%'); shape.setAttribute('width', '96%'); shape.setAttribute('height', '96%'); }
              shape.setAttribute('fill', el.style.fill || '#60a5fa'); shape.setAttribute('stroke', el.style.stroke || '#0f172a'); shape.setAttribute('stroke-width', '10');
              svg.appendChild(shape); box.appendChild(svg);
            }
            st.appendChild(box);
          });
          dom.presentStageWrap.appendChild(st);
        }
      };

      function resetAll() { confirmAction({ title: '–û–ß–ò–°–¢–ò–¢–ò –í–°–ï', message: '–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å —É—Å—ñ —Å–ª–∞–π–¥–∏ –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?', okText: '–¢–∞–∫, –æ—á–∏—Å—Ç–∏—Ç–∏', cancelText: '–ù—ñ', onYes: () => { localStorage.removeItem(STORAGE_KEY); location.reload(); } }); }
      function showObjectHelp() { openModal({ title: '–ü–Ü–î–ö–ê–ó–ö–ê: –û–±‚Äô—î–∫—Ç', showActions: false, bodyHTML: `<div class="space-y-3 text-sm font-bold text-slate-700"><p><b>–ó–∞–ª–∏–≤–∫–∞</b> ‚Äî –º—ñ–Ω—è—î –∫–æ–ª—ñ—Ä —Ñ—ñ–≥—É—Ä–∏.</p><p><b>–ö–æ–Ω—Ç—É—Ä</b> ‚Äî –∫–æ–ª—ñ—Ä –æ–±–≤–µ–¥–µ–Ω–Ω—è.</p><p><b>–ù–∞ –ø–µ—Ä–µ–¥–Ω—ñ–π –ø–ª–∞–Ω</b> ‚Äî —Ä–æ–±–∏—Ç—å –æ–±‚Äô—î–∫—Ç "–ø–æ–ø–µ—Ä–µ–¥—É".</p><p><b>–ù–∞ –∑–∞–¥–Ω—ñ–π –ø–ª–∞–Ω</b> ‚Äî —Ö–æ–≤–∞—î –æ–±‚Äô—î–∫—Ç "–ø–æ–∑–∞–¥—É".</p><p><b>–î—É–±–ª—é–≤–∞—Ç–∏</b> ‚Äî —Ä–æ–±–∏—Ç—å –∫–æ–ø—ñ—é.</p><p><b>–í–∏–¥–∞–ª–∏—Ç–∏</b> ‚Äî –ø—Ä–∏–±–∏—Ä–∞—î –æ–±‚Äô—î–∫—Ç.</p></div>` }); }

      function initKeyboard() {
        window.addEventListener('keydown', (e) => {
          const active = document.activeElement; const isTyping = active && active.classList && active.classList.contains('textBox');
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); if (e.shiftKey) redo(); else undo(); return; }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); return; }
          if (!isTyping && (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') { const el = selectedEl(); if (el) { clip = deepClone(el); setSaveInfo('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ'); } return; }
          if (!isTyping && (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v') { if (clip) { pushHistory('–í—Å—Ç–∞–≤–∏—Ç–∏'); const copy = deepClone(clip); copy.id = uid(); copy.x = clamp(copy.x + 24, 0, 960 - copy.w); copy.y = clamp(copy.y + 24, 0, 540 - copy.h); copy.z = elements().length + 1; elements().push(copy); state.selected = copy.id; normalizeZ(slide()); renderAll(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ'); } return; }
          if (!isTyping && (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'd') { e.preventDefault(); duplicateSelected(); return; }
          if (!isTyping && (e.key === 'Delete' || e.key === 'Backspace')) { confirmDeleteSelected(); return; }
          if (!isTyping && ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
            const el = selectedEl(); if (!el) return;
            e.preventDefault(); pushHistory('–ö—Ä–æ–∫'); const step = e.shiftKey ? 10 : 2;
            if (e.key === 'ArrowUp') el.y = clamp(el.y - step, 0, 540 - el.h); if (e.key === 'ArrowDown') el.y = clamp(el.y + step, 0, 540 - el.h); if (e.key === 'ArrowLeft') el.x = clamp(el.x - step, 0, 960 - el.w); if (e.key === 'ArrowRight') el.x = clamp(el.x + step, 0, 960 - el.w);
            const node = elDomMap.get(el.id); if (node) { node.style.left = el.x + 'px'; node.style.top = el.y + 'px'; }
            debounceThumbs(); scheduleSave('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');
          }
        });
      }

      function initState() {
        const saved = safeParse(localStorage.getItem(STORAGE_KEY), null);
        const norm = normalizeState(saved);
        if (norm) { state = norm; undoStack = [JSON.stringify(state)]; redoStack = []; return; }
        state = {
          slides: [{ id: uid(), background: '#ffffff', elements: [{ id: uid(), type: 'text', x: 140, y: 130, w: 680, h: 140, z: 1, content: `–ü—Ä–∏–≤—ñ—Ç! üëã
–ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤—É –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó`, style: { fontSize: 56, color: '#111827', bold: true, italic: false, underline: false, align: 'center', fill: '#60a5fa', stroke: '#0f172a' }, shape: 'rect' }] }],
          current: 0, selected: null
        };
        undoStack = [JSON.stringify(state)]; redoStack = []; scheduleSave('–°—Ç–≤–æ—Ä–µ–Ω–æ');
      }

      function bindUI() {
        $('btnPresent').onclick = () => Present.start(); $('btnPDF').onclick = () => exportPDF(); $('btnReset').onclick = () => resetAll();
        $('btnNewSlide').onclick = () => addSlide(); $('btnTemplates').onclick = () => openTemplates(); $('btnSlideUp').onclick = () => moveSlide(-1); $('btnSlideDown').onclick = () => moveSlide(1);
        $('btnDupSlide').onclick = () => duplicateSlide(); $('btnDelSlide').onclick = () => confirmDeleteSlide(); $('btnBg').onclick = () => openColor('bg');
        $('btnAddText').onclick = () => addText(); $('btnAddImage').onclick = () => addImage(); $('btnEmoji').onclick = () => openEmoji(); $('btnShapeRect').onclick = () => addShape('rect'); $('btnShapeCircle').onclick = () => addShape('circle');
        $('selFontSize').onchange = (e) => setFontSize(e.target.value);
        $('btnBold').onclick = () => toggleTextStyle('bold'); $('btnItalic').onclick = () => toggleTextStyle('italic'); $('btnUnderline').onclick = () => toggleTextStyle('underline');
        $('btnAlignLeft').onclick = () => setAlign('left'); $('btnAlignCenter').onclick = () => setAlign('center'); $('btnAlignRight').onclick = () => setAlign('right');
        $('btnTextColor').onclick = () => openColor('textColor');
        $('btnFill').onclick = () => openColor('fill'); $('btnStroke').onclick = () => openColor('stroke'); $('btnBringFront').onclick = () => bringToFront(); $('btnSendBack').onclick = () => sendToBack(); $('btnDupEl').onclick = () => duplicateSelected(); $('btnDelEl').onclick = () => confirmDeleteSelected();
        dom.zoomInfo.ondblclick = () => showObjectHelp();
        $('btnClosePopover').onclick = () => closePopovers(); $('btnCloseEmoji').onclick = () => closePopovers();
        $('btnModalClose').onclick = () => closeModal();
        dom.modalOverlay.addEventListener('pointerdown', (e) => { if (e.target === dom.modalOverlay) closeModal(); });
        $('btnPresentClose').onclick = () => Present.stop();
        dom.workspace.addEventListener('pointerdown', (e) => { if (!(dom.colorPopover.contains(e.target) || dom.emojiPopover.contains(e.target))) closePopovers(); });
        dom.stage.addEventListener('pointerdown', (e) => { if (e.target === dom.stage) deselect(); });
      }

      function initDom() {
        dom.stage = $('stage'); dom.slideList = $('slideList'); dom.workspace = $('workspace'); dom.saveInfo = $('saveInfo'); dom.zoomInfo = $('zoomInfo');
        dom.colorPopover = $('colorPopover'); dom.colorGrid = $('colorGrid'); dom.colorTitle = $('colorTitle');
        dom.emojiPopover = $('emojiPopover'); dom.emojiGrid = $('emojiGrid');
        dom.modalOverlay = $('modalOverlay'); dom.modalTitle = $('modalTitle'); dom.modalBody = $('modalBody'); dom.modalActions = $('modalActions');
        dom.presentOverlay = $('presentOverlay'); dom.presentStageWrap = $('presentStageWrap');
        dom.stage.dataset.baseW = '960'; dom.stage.dataset.baseH = '540';
      }

      function boot() {
        initDom(); initPopovers(); initState(); bindUI(); initKeyboard(); renderAll(); setSaveInfo('–ì–æ—Ç–æ–≤–æ');
        dom.zoomInfo.textContent = '–ü–æ–ª–æ—Ç–Ω–æ: 16:9 (–¥–≤—ñ—á—ñ –∫–ª—ñ–∫ ‚Äî –ø—ñ–¥–∫–∞–∑–∫–∞ ‚Äú–û–±‚Äô—î–∫—Ç‚Äù)';
      }
      return { boot };
    })();
    window.addEventListener('load', () => App.boot());
  </script>
</body>
</html>

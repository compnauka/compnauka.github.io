<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–∏–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä –¥–ª—è –¥—ñ—Ç–µ–π</title>

    <meta
      name="description"
      content="–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –æ–Ω–ª–∞–π–Ω —Ç—Ä–µ–Ω–∞–∂–µ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –¥–ª—è –¥—ñ—Ç–µ–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é. –í–∏–≤—á–∞–π—Ç–µ –∫–æ–º–ø'—é—Ç–µ—Ä–Ω—É –≥—Ä–∞–º–æ—Ç–Ω—ñ—Å—Ç—å –≥—Ä–∞—é—á–∏!"
    />
    <meta
      name="keywords"
      content="–∫–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–∏–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä,—Ç—Ä–µ–Ω–∞–∂–µ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏, –¥—ñ—Ç–∏, –Ω–∞–≤—á–∞–Ω–Ω—è, —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞, –≥—Ä–∞, typing, keyboard, kids, education"
    />
    <meta name="author" content="–ü–∞–Ω –ê—Ä—Ç–µ–º" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://pan-artem-cs-2025.example.com/" />

    <meta property="og:title" content="–¢—Ä–µ–Ω–∞–∂–µ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –¥–ª—è –¥—ñ—Ç–µ–π" />
    <meta
      property="og:description"
      content="–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –æ–Ω–ª–∞–π–Ω —Ç—Ä–µ–Ω–∞–∂–µ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –¥–ª—è –¥—ñ—Ç–µ–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é. –í–∏–≤—á–∞–π—Ç–µ –∫–æ–º–ø'—é—Ç–µ—Ä–Ω—É –≥—Ä–∞–º–æ—Ç–Ω—ñ—Å—Ç—å –≥—Ä–∞—é—á–∏!"
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://pan-artem-cs-2025.example.com/" />
    <meta property="og:locale" content="uk_UA" />
    <meta property="og:image" content="./favicon.png" />

    <link rel="icon" href="../../favicon.ico" type="image/x-icon" />
    <meta name="theme-color" content="#667eea" />

    <!-- (–û–ø—Ü—ñ–π–Ω–æ) Privacy-friendly analytics -->
    <script async src="https://plausible.io/js/pa-kBgdFkemKx0WM6VJQvasn.js"></script>
    <script>
      window.plausible =
        window.plausible ||
        function () {
          (plausible.q = plausible.q || []).push(arguments);
        };
    </script>

    <style>
      :root {
        --letter-size: 60px;
        --shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      h1 {
        color: white;
        text-align: center;
        margin: 6px 0 16px 0;
        font-size: 2.25em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        animation: glow 2s ease-in-out infinite alternate;
      }

      @keyframes glow {
        from {
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 255, 255, 0.5);
        }
        to {
          text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 18px rgba(255, 255, 255, 0.8);
        }
      }

      #game-container {
        width: 100%;
        max-width: 920px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 22px;
        box-shadow: var(--shadow);
        padding: 20px 20px 18px 20px;

        /* ‚úÖ —Ä–µ–∑–µ—Ä–≤ –º—ñ—Å—Ü—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–≤—É–∫—É */
        padding-top: 72px;

        backdrop-filter: blur(10px);
        position: relative;
      }

      /* ‚úÖ –∫–Ω–æ–ø–∫–∞ –∑–≤—É–∫—É –Ω–µ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—î –ø–∞–Ω–µ–ª—å */
      #sound-toggle {
        position: absolute;
        top: 18px;
        right: 18px;
        background: linear-gradient(45deg, #9c27b0, #7b1fa2);
        border: none;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.1em;
        display: grid;
        place-items: center;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.18);
      }
      #sound-toggle:focus-visible {
        outline: 3px solid #0d47a1;
        outline-offset: 2px;
      }

      /* --- INFO PANEL --- */
      #info-panel {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 14px;
      }

      .pill {
        font-size: 1.12em;
        font-weight: 900;
        color: #222;
        background: linear-gradient(45deg, #ffeb3b, #ffc107);
        padding: 12px 14px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        user-select: none;
        min-height: 54px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .pill.animate {
        transform: scale(1.04);
        background: linear-gradient(45deg, #4caf50, #81c784);
        color: white;
      }

      #target-pill {
        background: linear-gradient(45deg, #e3f2fd, #bbdefb);
        color: #0d47a1;
      }
      #target-pill .target-char {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.78);
        box-shadow: inset 0 0 0 2px rgba(13, 71, 161, 0.25);
        font-size: 1.2em;
        font-weight: 900;
      }
      #target-hint {
        font-weight: 900;
        color: #0d47a1;
      }

      /* --- GAME FIELD --- */
      #game-field {
        width: 100%;
        height: 320px;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 4px solid #2196f3;
        border-radius: 22px;
        position: relative;
        overflow: hidden;
        margin-bottom: 16px;
        box-shadow: inset 0 0 16px rgba(0, 0, 0, 0.08);
      }

      #feedback-message {
        position: absolute;
        top: 14px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #4caf50, #388e3c);
        color: white;
        padding: 10px 18px;
        border-radius: 999px;
        font-size: 1.05em;
        font-weight: 900;
        opacity: 0;
        transition: opacity 0.22s;
        z-index: 15;
        pointer-events: none;
      }
      #feedback-message.show {
        opacity: 1;
      }
      #feedback-message.negative {
        background: linear-gradient(45deg, #f44336, #d32f2f);
      }

      /* Letters */
      .letter {
        position: absolute;
        width: var(--letter-size);
        height: var(--letter-size);
        border-radius: 50%;
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        border: 3px solid #2196f3;
        display: grid;
        place-items: center;
        will-change: transform;
        user-select: none;
      }

      .letter .glyph {
        font-size: 2.25em;
        font-weight: 900;
        color: #333;
        transition: transform 0.18s ease, color 0.18s ease;
      }

      .letter.correct {
        background: linear-gradient(145deg, #4caf50, #388e3c);
        border-color: #2e7d32;
      }
      .letter.correct .glyph {
        color: #fff;
        transform: scale(1.15);
      }

      .letter.missed {
        background: linear-gradient(145deg, #f44336, #d32f2f);
        border-color: #c62828;
      }
      .letter.missed .glyph {
        color: #fff;
        transform: scale(0.88);
      }

      /* ‚úÖ Urgent –±–µ–∑ transform (–Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—î –∑ correct/missed) */
      .letter.urgent {
        border-color: #ff5722;
        animation: urgentGlow 0.55s ease-in-out infinite alternate;
      }
      @keyframes urgentGlow {
        from {
          box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.0), 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        to {
          box-shadow: 0 0 0 10px rgba(255, 87, 34, 0.18), 0 6px 12px rgba(0, 0, 0, 0.2);
        }
      }

      /* --- GAME OVER --- */
      #game-over {
        display: none;
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20;
        border-radius: 22px;
        backdrop-filter: blur(5px);
        padding: 18px;
        text-align: center;
      }
      #game-over h2 {
        color: #2196f3;
        font-size: 2em;
        margin: 4px 0 10px 0;
      }
      .final {
        font-size: 1.12em;
        margin: 6px 0;
        color: #333;
        font-weight: 800;
      }
      .final strong {
        color: #2e7d32;
      }
      #achievement {
        margin-top: 10px;
        font-weight: 900;
        color: #ff9800;
      }

      /* --- BUTTONS --- */
      .grid-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 12px;
        width: 100%;
        margin: 10px 0;
      }

      button.action,
      .grid-buttons button {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
        border: none;
        padding: 12px 18px;
        font-size: 1.05em;
        border-radius: 16px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        font-family: inherit;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.18);
        user-select: none;
      }
      .grid-buttons button:hover,
      button.action:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.26);
      }
      .grid-buttons button:active,
      button.action:active {
        transform: translateY(1px);
      }
      .grid-buttons button:focus-visible,
      button.action:focus-visible {
        outline: 3px solid #0d47a1;
        outline-offset: 2px;
      }

      .grid-buttons button.selected {
        background: linear-gradient(45deg, #9642e6, #7217cd);
        box-shadow: 0 8px 16px rgba(162, 89, 230, 0.35);
      }
      .grid-buttons button.selected::after {
        content: "‚úì";
        position: absolute;
        top: 7px;
        right: 10px;
        font-size: 0.85em;
        opacity: 0.95;
      }

      #start-button {
        background: linear-gradient(45deg, #43ea4c, #1bcf3b);
        font-weight: 900;
        font-size: 1.15em;
        width: 100%;
        margin-top: 10px;
      }
      #stop-button {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        font-weight: 900;
        font-size: 1.15em;
        width: 100%;
        margin-top: 10px;
        display: none;
      }

      /* toggles */
      .toggles {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .toggle {
        border-radius: 16px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        min-height: 56px;
      }
      .toggle label {
        font-weight: 900;
        color: #333;
      }
      .toggle input[type="checkbox"] {
        width: 22px;
        height: 22px;
        accent-color: #2196f3;
        cursor: pointer;
        flex: 0 0 auto;
      }

      #instructions {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 20px;
        margin-top: 18px;
        max-width: 920px;
        width: 100%;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
      }
      #instructions h3 {
        color: #2196f3;
        margin-top: 0;
        font-size: 1.5em;
      }
      #instructions p {
        color: #333;
        line-height: 1.6;
        font-size: 1.05em;
      }
      .note-box {
        border-radius: 14px;
        padding: 14px;
        margin: 10px 0;
        background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        border-left: 5px solid #9c27b0;
        font-weight: 800;
      }

      footer {
        text-align: center;
        margin: 26px 0 10px 0;
        color: #fcfcfc;
        font-size: 1em;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }

      /* ‚úÖ –∞–¥–∞–ø—Ç–∏–≤, —â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ –Ω–∞—ó–∂–¥–∂–∞–ª–æ */
      @media (max-width: 820px) {
        #info-panel {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 520px) {
        #info-panel {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <h1>üéÆ –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–∏–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä üéÆ</h1>

    <div id="game-container">
      <button
        id="sound-toggle"
        type="button"
        title="–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫"
        aria-label="–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ –≥—Ä–∏"
      >
        üîä
      </button>

      <div id="info-panel">
        <div id="score" class="pill" aria-live="polite">üèÜ –ë–∞–ª–∏: <span id="score-num">0</span></div>
        <div id="timer" class="pill" aria-live="polite">‚è∞ –ß–∞—Å: <span id="timer-num">60</span></div>
        <div id="streak" class="pill" aria-live="polite">üî• –°–µ—Ä—ñ—è: <span id="streak-num">0</span></div>
        <div id="target-pill" class="pill" aria-live="polite" title="–ù–∞–π–±–ª–∏–∂—á–∏–π —Å–∏–º–≤–æ–ª –¥–æ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—é">
          üéØ –¶—ñ–ª—å: <span class="target-char" id="target-char">‚Äî</span>
          <span id="target-hint"></span>
        </div>
      </div>

      <div id="game-field" aria-label="–Ü–≥—Ä–æ–≤–µ –ø–æ–ª–µ">
        <div id="feedback-message" role="status" aria-live="polite"></div>

        <div id="game-over" aria-live="polite">
          <h2>üéâ –ß–∞—Å –≤–∏–π—à–æ–≤! üéâ</h2>

          <div class="final" id="final-score">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong>0</strong> –±–∞–ª—ñ–≤</div>
          <div class="final" id="final-level">–†—ñ–≤–µ–Ω—å: <strong>–î—É–∂–µ –ø—Ä–æ—Å—Ç–∏–π</strong></div>
          <div class="final" id="final-speed">–®–≤–∏–¥–∫—ñ—Å—Ç—å: <strong>–°–µ—Ä–µ–¥–Ω—è</strong></div>

          <div class="final" id="final-accuracy">–¢–æ—á–Ω—ñ—Å—Ç—å: <strong>0%</strong></div>
          <div class="final" id="final-counts">‚úÖ 0 / ‚ùå 0 / ‚è≠Ô∏è 0</div>
          <div class="final" id="final-reaction">–°–µ—Ä–µ–¥–Ω—è —Ä–µ–∞–∫—Ü—ñ—è: <strong>‚Äî</strong></div>
          <div class="final" id="final-hardest">–°–∫–ª–∞–¥–Ω—ñ —Å–∏–º–≤–æ–ª–∏: <strong>‚Äî</strong></div>

          <div id="achievement"></div>
          <div style="margin-top: 10px; color: #555; font-weight: 900;">
            –ü–æ—Ä–∞–¥–∞: –¥–∏–≤–∏—Å—å –Ω–∞ —Å–∏–º–≤–æ–ª–∏ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ, –∞ –Ω–µ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É üòâ
          </div>
        </div>
      </div>

      <div class="grid-buttons" id="levels" aria-label="–†—ñ–≤–Ω—ñ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ">
        <button type="button" data-level="beginner" class="selected" style="position:relative;">üåü –î—É–∂–µ –ø—Ä–æ—Å—Ç–∏–π</button>
        <button type="button" data-level="easy" style="position:relative;">üòä –ü—Ä–æ—Å—Ç–∏–π</button>
        <button type="button" data-level="medium" style="position:relative;">üí™ –°–µ—Ä–µ–¥–Ω—ñ–π</button>
        <button type="button" data-level="hard" style="position:relative;">üî• –°–∫–ª–∞–¥–Ω–∏–π</button>
      </div>

      <div class="grid-buttons" id="speed-control" aria-label="–®–≤–∏–¥–∫—ñ—Å—Ç—å">
        <button type="button" data-speed="slow" style="position:relative;">üêå –ü–æ–≤—ñ–ª—å–Ω–æ</button>
        <button type="button" data-speed="medium" class="selected" style="position:relative;">üö∂ –°–µ—Ä–µ–¥–Ω—å–æ</button>
        <button type="button" data-speed="fast" style="position:relative;">üèÉ –®–≤–∏–¥–∫–æ</button>
      </div>

      <div class="toggles">
        <div class="toggle">
          <label for="trainingMode">üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º (–ø–æ–∫–∞–∑—É—î ¬´—Ü—ñ–ª—å¬ª)</label>
          <input id="trainingMode" type="checkbox" checked />
        </div>

        <div class="toggle">
          <label for="smartMode">üß† –†–æ–∑—É–º–Ω–∏–π —Ä–µ–∂–∏–º (–ª–µ–≥–∫–æ –∞–¥–∞–ø—Ç—É—î —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å)</label>
          <input id="smartMode" type="checkbox" checked />
        </div>
      </div>

      <button id="start-button" class="action" type="button">üöÄ –ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
      <button id="stop-button" class="action" type="button">‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –≥—Ä—É</button>
    </div>

    <div id="instructions">
      <h3>üìö –Ø–∫ –≥—Ä–∞—Ç–∏:</h3>
      <p><strong>1.</strong> –û–±–µ—Ä–∏ —Ä—ñ–≤–µ–Ω—å —ñ —à–≤–∏–¥–∫—ñ—Å—Ç—å, –Ω–∞—Ç–∏—Å–Ω–∏ ‚ÄúüöÄ –ü–æ—á–∞—Ç–∏ –≥—Ä—É‚Äù.</p>
      <p><strong>2.</strong> –°–∏–º–≤–æ–ª–∏ –ª–µ—Ç—è—Ç—å –∑–ª—ñ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ. –ù–∞—Ç–∏—Å–Ω–∏ —Ç–æ–π —Å–∞–º–∏–π —Å–∏–º–≤–æ–ª –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—ñ.</p>
      <p><strong>3.</strong> –Ø–∫—â–æ —Å–∏–º–≤–æ–ª <strong>–≤–µ–ª–∏–∫–∏–π</strong> ‚Äî –ø–æ—Ç—Ä—ñ–±–µ–Ω <strong>Shift</strong>.</p>
      <p><strong>4.</strong> –ù–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ –ø–æ–±–∞—á–∏—à —Ç–æ—á–Ω—ñ—Å—Ç—å, —Ä–µ–∞–∫—Ü—ñ—é —Ç–∞ ‚Äú—Å–∫–ª–∞–¥–Ω—ñ —Å–∏–º–≤–æ–ª–∏‚Äù.</p>

      <div class="note-box">
        <strong>–ü–ï–†–ï–î –ü–û–ß–ê–¢–ö–û–ú –†–û–ë–û–¢–ò</strong><br />
        –ù–ï –ó–ê–ë–£–î–¨ –û–ë–†–ê–¢–ò –£–ö–†–ê–á–ù–°–¨–ö–£ –ú–û–í–£ –ù–ê –ö–û–ú–ü'–Æ–¢–ï–†–Ü üíõüíô
      </div>

      <div class="note-box" style="background:linear-gradient(135deg,#e3f2fd,#bbdefb); border-left-color:#2196f3;">
        <strong>–ì–∞—Ä—è—á—ñ –∫–ª–∞–≤—ñ—à—ñ:</strong><br />
        ‚Ä¢ <strong>Enter</strong> ‚Äî —Å—Ç–∞—Ä—Ç (–∫–æ–ª–∏ –≥—Ä–∞ –Ω–µ –π–¥–µ)<br />
        ‚Ä¢ <strong>Esc</strong> ‚Äî –∑—É–ø–∏–Ω–∏—Ç–∏ –≥—Ä—É
      </div>
    </div>

    <footer>2025 –ö–æ–º–ø'—é—Ç–µ—Ä–Ω–∞ –Ω–∞—É–∫–∞ –∑ –ø–∞–Ω–æ–º –ê—Ä—Ç–µ–º–æ–º</footer>

    <script>
      /***********************
       * 1) –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
       ***********************/
      const GAME_DURATION_SECONDS = 60;
      const MAX_ACTIVE_LETTERS = 18;
      const URGENT_THRESHOLD = 0.82;

      const FEEDBACK_HIDE_MS = 1400;

      const POINTS_DEFAULT = 1;
      const POINTS_MEDIUM = 2;
      const POINTS_FAST = 3;
      const FAST_MS = 1000;
      const MEDIUM_MS = 2000;
      const STREAK_BONUS_DIVISOR = 5;

      const speedSettings = {
        slow: { durationMs: 10000, spawnMs: 2400 },
        medium: { durationMs: 6000, spawnMs: 1500 },
        fast: { durationMs: 3600, spawnMs: 850 },
      };

      const levelChars = {
        beginner: "–∞–æ—ñ—î–Ω—Ç—Å—Ä–≤–ª",
        easy: "–∞–±–≤–≥–¥–µ—î–∂–∑–∏—ñ—ó–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—å—é—è“ë",
        medium:
          "–∞–±–≤–≥–¥–µ—î–∂–∑–∏—ñ—ó–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—å—é—è“ë–ê–ë–í–ì–î–ï–Ñ–ñ–ó–ò–Ü–á–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–¨–Æ–Ø“ê",
        hard:
          "–∞–±–≤–≥–¥–µ—î–∂–∑–∏—ñ—ó–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—å—é—è“ë–ê–ë–í–ì–î–ï–Ñ–ñ–ó–ò–Ü–á–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–¨–Æ–Ø“ê0123456789!\"‚Ññ;%:?*()-_=+",
      };

      const levelNames = { beginner: "–î—É–∂–µ –ø—Ä–æ—Å—Ç–∏–π", easy: "–ü—Ä–æ—Å—Ç–∏–π", medium: "–°–µ—Ä–µ–¥–Ω—ñ–π", hard: "–°–∫–ª–∞–¥–Ω–∏–π" };
      const speedNames = { slow: "–ü–æ–≤—ñ–ª—å–Ω–∞", medium: "–°–µ—Ä–µ–¥–Ω—è", fast: "–®–≤–∏–¥–∫–∞" };

      const motivationalMessages = [
        "–ß—É–¥–æ–≤–æ! üåü",
        "–°—É–ø–µ—Ä! üéâ",
        "–í—ñ–¥–º—ñ–Ω–Ω–æ! üí™",
        "–ö–ª–∞—Å–Ω–æ! üëè",
        "–ú–æ–ª–æ–¥–µ—Ü—å! üèÜ",
        "–ö—Ä—É—Ç–æ! üî•",
        "–§–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–æ! ‚≠ê",
        "–ë—Ä–∞–≤–æ! üëç",
      ];

      const streakMessages = {
        5: "–ü'—è—Ç—å –ø—ñ–¥—Ä—è–¥! üî•",
        10: "–î–µ—Å—è—Ç—å –ø—ñ–¥—Ä—è–¥! üí™",
        15: "–ü'—è—Ç–Ω–∞–¥—Ü—è—Ç—å! üåü",
        20: "–î–≤–∞–¥—Ü—è—Ç—å! üèÜ",
        25: "–ù–µ–π–º–æ–≤—ñ—Ä–Ω–æ! üéâ",
      };

      /***********************
       * 2) STATE (–≤—Å–µ —É performance.now)
       ***********************/
      const state = {
        level: "beginner",
        speed: "medium",

        running: false,

        // ‚úÖ —É—Å—ñ —Ç–∞–π–º—ñ–Ω–≥–∏ –≤ performance.now()
        endAt: 0,
        nextSpawnAt: 0,

        durationMs: speedSettings.medium.durationMs,
        spawnMs: speedSettings.medium.spawnMs,

        score: 0,
        streak: 0,
        maxStreak: 0,

        correct: 0,
        wrong: 0,
        missed: 0,

        reactionTimes: [],
        charStats: new Map(),

        letters: new Map(), // id -> letter
        idCounter: 1,

        trainingMode: true,
        smartMode: true,

        soundEnabled: true,
        audioCtx: null,
      };

      /***********************
       * 3) DOM
       ***********************/
      const dom = {
        scoreNum: document.getElementById("score-num"),
        timerNum: document.getElementById("timer-num"),
        streakNum: document.getElementById("streak-num"),

        timerPill: document.getElementById("timer"),
        scorePill: document.getElementById("score"),
        streakPill: document.getElementById("streak"),

        targetPill: document.getElementById("target-pill"),
        targetChar: document.getElementById("target-char"),
        targetHint: document.getElementById("target-hint"),

        gameField: document.getElementById("game-field"),
        feedback: document.getElementById("feedback-message"),

        gameOver: document.getElementById("game-over"),
        finalScore: document.getElementById("final-score"),
        finalLevel: document.getElementById("final-level"),
        finalSpeed: document.getElementById("final-speed"),
        finalAccuracy: document.getElementById("final-accuracy"),
        finalCounts: document.getElementById("final-counts"),
        finalReaction: document.getElementById("final-reaction"),
        finalHardest: document.getElementById("final-hardest"),
        achievement: document.getElementById("achievement"),

        startBtn: document.getElementById("start-button"),
        stopBtn: document.getElementById("stop-button"),
        soundBtn: document.getElementById("sound-toggle"),

        levelsWrap: document.getElementById("levels"),
        speedWrap: document.getElementById("speed-control"),

        trainingMode: document.getElementById("trainingMode"),
        smartMode: document.getElementById("smartMode"),
      };

      /***********************
       * 4) HELPERS
       ***********************/
      const nowMs = () => performance.now();

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function isLetterWithCase(ch) {
        return ch && ch.toLowerCase() !== ch.toUpperCase();
      }

      function ensureCharStat(ch) {
        if (!state.charStats.has(ch)) state.charStats.set(ch, { correct: 0, wrong: 0, missed: 0 });
        return state.charStats.get(ch);
      }

      function pulsePill(el) {
        el.classList.add("animate");
        setTimeout(() => el.classList.remove("animate"), 220);
      }

      function showFeedback(text, positive = true) {
        dom.feedback.textContent = text;
        dom.feedback.classList.add("show");
        dom.feedback.classList.toggle("negative", !positive);
        clearTimeout(showFeedback._t);
        showFeedback._t = setTimeout(() => {
          dom.feedback.classList.remove("show", "negative");
        }, FEEDBACK_HIDE_MS);
      }

      function computeDifficulty() {
        const base = speedSettings[state.speed];
        const modifier = { beginner: 1.2, easy: 1, medium: 0.92, hard: 0.82 }[state.level];
        state.durationMs = Math.round(base.durationMs * modifier);
        state.spawnMs = Math.round(base.spawnMs * modifier);
      }

      function getRandomChar() {
        const chars = levelChars[state.level];
        return chars[Math.floor(Math.random() * chars.length)];
      }

      function getFieldMetrics() {
        const rect = dom.gameField.getBoundingClientRect();
        const size = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--letter-size")) || 60;
        return { width: rect.width, height: rect.height, size };
      }

      function updateUI() {
        dom.scoreNum.textContent = state.score;
        dom.streakNum.textContent = state.streak;

        const t = state.running ? Math.max(0, Math.ceil((state.endAt - nowMs()) / 1000)) : GAME_DURATION_SECONDS;
        dom.timerNum.textContent = t;

        if (state.running && t <= 10) {
          dom.timerPill.style.background = "linear-gradient(45deg, #f44336, #d32f2f)";
          dom.timerPill.style.color = "white";
        } else {
          dom.timerPill.style.background = "linear-gradient(45deg, #ffeb3b, #ffc107)";
          dom.timerPill.style.color = "#222";
        }
      }

      /***********************
       * 5) AUDIO (lazy init)
       ***********************/
      function ensureAudio() {
        if (!state.soundEnabled) return;
        if (state.audioCtx) return;
        try {
          state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.warn("Web Audio not supported:", e);
          state.soundEnabled = false;
          dom.soundBtn.textContent = "üîá";
          dom.soundBtn.title = "–ó–≤—É–∫ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è";
          dom.soundBtn.setAttribute("aria-label", "–ó–≤—É–∫ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è");
        }
      }

      async function resumeAudioIfNeeded() {
        if (!state.soundEnabled) return;
        ensureAudio();
        if (!state.audioCtx) return;
        if (state.audioCtx.state === "suspended") {
          try {
            await state.audioCtx.resume();
          } catch (_) {}
        }
      }

      function playSound(type) {
        if (!state.soundEnabled) return;
        if (!state.audioCtx || state.audioCtx.state !== "running") return;

        try {
          const o = state.audioCtx.createOscillator();
          const g = state.audioCtx.createGain();
          o.connect(g);
          g.connect(state.audioCtx.destination);

          let f1 = 200, f2 = 100, d = 0.18;
          if (type === "correct") { f1 = 850; f2 = 1250; d = 0.10; }
          if (type === "gameOver") { f1 = 420; f2 = 220; d = 0.45; }

          o.frequency.setValueAtTime(f1, state.audioCtx.currentTime);
          if (type !== "miss") o.frequency.exponentialRampToValueAtTime(f2, state.audioCtx.currentTime + d);

          g.gain.setValueAtTime(0.10, state.audioCtx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.001, state.audioCtx.currentTime + d + 0.05);

          o.start();
          o.stop(state.audioCtx.currentTime + d + 0.08);
          o.onended = () => { o.disconnect(); g.disconnect(); };
        } catch (e) {
          console.error("Sound error:", e);
        }
      }

      /***********************
       * 6) LETTERS (RAF loop)
       ***********************/
      function createLetter(char) {
        const { height, size } = getFieldMetrics();
        const y = Math.random() * Math.max(1, height - size - 6) + 3;

        const el = document.createElement("div");
        el.className = "letter";
        el.innerHTML = `<span class="glyph"></span>`;
        el.querySelector(".glyph").textContent = char;

        const id = state.idCounter++;
        const letter = {
          id,
          char,
          el,
          startAt: nowMs(),     // ‚úÖ performance.now
          durationMs: state.durationMs,
          yPx: y,
          removed: false,
        };

        state.letters.set(id, letter);
        dom.gameField.appendChild(el);
        return letter;
      }

      function removeLetter(letter, { correct = false, missed = false } = {}) {
        if (!letter || letter.removed) return;
        letter.removed = true;

        letter.el.classList.remove("urgent");
        if (correct) letter.el.classList.add("correct");
        if (missed) letter.el.classList.add("missed");

        setTimeout(() => {
          if (letter.el && letter.el.parentNode) letter.el.remove();
        }, 220);

        state.letters.delete(letter.id);
      }

      function letterProgress(letter, tNow) {
        return clamp((tNow - letter.startAt) / letter.durationMs, 0, 1);
      }

      function mostUrgentLetter(tNow) {
        let best = null;
        let bestP = -1;
        for (const l of state.letters.values()) {
          const p = letterProgress(l, tNow);
          if (p > bestP) { bestP = p; best = l; }
        }
        return { best, bestP };
      }

      function updateTargetHUD(tNow) {
        if (!state.trainingMode || !state.running || state.letters.size === 0) {
          dom.targetChar.textContent = "‚Äî";
          dom.targetHint.textContent = "";
          dom.targetPill.style.opacity = "0.8";
          return;
        }

        const { best } = mostUrgentLetter(tNow);
        if (!best) return;

        dom.targetPill.style.opacity = "1";
        dom.targetChar.textContent = best.char;

        let hint = "";
        if (isLetterWithCase(best.char) && best.char === best.char.toUpperCase()) hint = " (Shift)";
        dom.targetHint.textContent = hint;
      }

      function spawnIfNeeded(tNow) {
        if (tNow < state.nextSpawnAt) return;

        if (state.letters.size >= MAX_ACTIVE_LETTERS) {
          state.nextSpawnAt = tNow + Math.max(180, state.spawnMs * 0.35);
          return;
        }

        createLetter(getRandomChar());
        state.nextSpawnAt = tNow + state.spawnMs;
      }

      function applySmartDifficulty() {
        if (!state.smartMode) return;
        if (state.streak > 0 && state.streak % 10 === 0) {
          state.spawnMs = Math.max(520, Math.round(state.spawnMs * 0.95));
          state.durationMs = Math.max(2400, Math.round(state.durationMs * 0.97));
        }
      }

      function gameLoop() {
        if (!state.running) return;

        const tNow = nowMs();

        if (tNow >= state.endAt) {
          endGame();
          return;
        }

        spawnIfNeeded(tNow);

        const { width, size } = getFieldMetrics();
        const xStart = -size - 10;
        const xEnd = width + 10;

        for (const l of state.letters.values()) {
          const p = letterProgress(l, tNow);
          const x = xStart + (xEnd - xStart) * p;

          l.el.style.transform = `translate(${x}px, ${l.yPx}px)`;

          if (p >= URGENT_THRESHOLD) l.el.classList.add("urgent");

          if (p >= 1) {
            state.missed++;
            state.streak = 0;

            ensureCharStat(l.char).missed++;
            showFeedback("–ü—Ä–æ–ø—É—â–µ–Ω–æ! üò¢", false);
            playSound("miss");

            removeLetter(l, { missed: true });
          }
        }

        updateTargetHUD(tNow);
        updateUI();

        requestAnimationFrame(gameLoop);
      }

      /***********************
       * 7) INPUT
       ***********************/
      function handleKeydown(e) {
        if (state.running && ["Space", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.code)) {
          e.preventDefault();
        }

        if (!state.running && e.key === "Enter") {
          startGame();
          return;
        }
        if (state.running && e.key === "Escape") {
          stopGame();
          return;
        }

        if (!state.running) return;
        if (e.ctrlKey || e.altKey || e.metaKey) return;
        if (e.key === "Shift" || e.key === "Alt" || e.key === "Control" || e.key === "Meta") return;

        const pressed = e.key;
        const tNow = nowMs();

        const candidates = [];
        for (const l of state.letters.values()) {
          if (l.char === pressed) candidates.push(l);
        }

        if (candidates.length > 0) {
          let best = candidates[0];
          let bestP = letterProgress(best, tNow);

          for (let i = 1; i < candidates.length; i++) {
            const p = letterProgress(candidates[i], tNow);
            if (p > bestP) { bestP = p; best = candidates[i]; }
          }

          const reaction = tNow - best.startAt;
          state.reactionTimes.push(reaction);

          let points = POINTS_DEFAULT;
          if (reaction < FAST_MS) points = POINTS_FAST;
          else if (reaction < MEDIUM_MS) points = POINTS_MEDIUM;

          state.streak++;
          state.maxStreak = Math.max(state.maxStreak, state.streak);

          if (state.streak >= STREAK_BONUS_DIVISOR) points += Math.floor(state.streak / STREAK_BONUS_DIVISOR);

          state.score += points;
          state.correct++;

          ensureCharStat(best.char).correct++;

          playSound("correct");
          pulsePill(dom.scorePill);
          pulsePill(dom.streakPill);

          let msg = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
          if (streakMessages[state.streak]) msg = streakMessages[state.streak];
          if (points > 1) msg += ` +${points} –±–∞–ª—ñ–≤!`;
          showFeedback(msg, true);

          removeLetter(best, { correct: true });

          applySmartDifficulty();
          updateUI();
          return;
        }

        if (pressed && pressed.length === 1) {
          state.wrong++;
          state.streak = 0;
          playSound("miss");
          pulsePill(dom.streakPill);
          showFeedback("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! üòî", false);
          updateUI();
        }
      }

      /***********************
       * 8) GAME CONTROL
       ***********************/
      function clearLetters() {
        for (const l of state.letters.values()) {
          if (l.el && l.el.parentNode) l.el.remove();
        }
        state.letters.clear();
      }

      function resetStats() {
        state.score = 0;
        state.streak = 0;
        state.maxStreak = 0;

        state.correct = 0;
        state.wrong = 0;
        state.missed = 0;

        state.reactionTimes = [];
        state.charStats = new Map();
      }

      function setSelected(container, attr, value) {
        const buttons = container.querySelectorAll("button");
        buttons.forEach((b) => b.classList.remove("selected"));
        const btn = container.querySelector(`button[${attr}="${value}"]`);
        if (btn) btn.classList.add("selected");
      }

      function startGame() {
        if (state.running) return;

        resumeAudioIfNeeded();

        try { plausible("GameStart"); } catch (_) {}

        dom.gameOver.style.display = "none";
        dom.startBtn.style.display = "none";
        dom.stopBtn.style.display = "block";

        resetStats();
        clearLetters();

        computeDifficulty();

        state.running = true;
        state.endAt = nowMs() + GAME_DURATION_SECONDS * 1000;
        state.nextSpawnAt = nowMs() + 550;

        updateUI();
        requestAnimationFrame(gameLoop);
      }

      function stopGame() {
        if (!state.running) return;
        state.running = false;
        clearLetters();
        dom.gameOver.style.display = "none";
        dom.startBtn.style.display = "block";
        dom.stopBtn.style.display = "none";
        updateTargetHUD(nowMs());
        updateUI();
      }

      function endGame() {
        if (!state.running) return;

        try { plausible("GameEnd", { props: { score: state.score, level: state.level, speed: state.speed } }); } catch (_) {}

        state.running = false;
        clearLetters();
        playSound("gameOver");

        const totalAttempts = state.correct + state.wrong + state.missed;
        const accuracy = totalAttempts > 0 ? Math.round((state.correct / totalAttempts) * 100) : 0;

        const avgReaction =
          state.reactionTimes.length > 0
            ? Math.round(state.reactionTimes.reduce((a, b) => a + b, 0) / state.reactionTimes.length)
            : null;

        const hardList = Array.from(state.charStats.entries())
          .map(([ch, s]) => ({ ch, bad: (s.wrong || 0) + (s.missed || 0) }))
          .filter((x) => x.bad > 0)
          .sort((a, b) => b.bad - a.bad)
          .slice(0, 3);

        const hardestText = hardList.length ? hardList.map((x) => `${x.ch}(${x.bad})`).join(" ¬∑ ") : "‚Äî";

        dom.finalScore.innerHTML = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong>${state.score}</strong> –±–∞–ª—ñ–≤`;
        dom.finalLevel.innerHTML = `–†—ñ–≤–µ–Ω—å: <strong>${levelNames[state.level]}</strong>`;
        dom.finalSpeed.innerHTML = `–®–≤–∏–¥–∫—ñ—Å—Ç—å: <strong>${speedNames[state.speed]}</strong>`;
        dom.finalAccuracy.innerHTML = `–¢–æ—á–Ω—ñ—Å—Ç—å: <strong>${accuracy}%</strong>`;
        dom.finalCounts.textContent = `‚úÖ ${state.correct} / ‚ùå ${state.wrong} / ‚è≠Ô∏è ${state.missed}`;
        dom.finalReaction.innerHTML = `–°–µ—Ä–µ–¥–Ω—è —Ä–µ–∞–∫—Ü—ñ—è: <strong>${avgReaction ? avgReaction + " –º—Å" : "‚Äî"}</strong>`;
        dom.finalHardest.innerHTML = `–°–∫–ª–∞–¥–Ω—ñ —Å–∏–º–≤–æ–ª–∏: <strong>${hardestText}</strong>`;

        let achievement = "";
        if (state.score >= 100) achievement = "üèÜ –ú–∞–π—Å—Ç–µ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏!";
        else if (state.score >= 50) achievement = "‚≠ê –ß—É–¥–æ–≤–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!";
        else if (state.score >= 25) achievement = "üëç –ì–∞—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞!";
        else if (state.score >= 10) achievement = "üí™ –ü—Ä–æ–¥–æ–≤–∂—É–π —Ç—Ä–µ–Ω—É–≤–∞—Ç–∏—Å—è!";
        else achievement = "üåü –ü–µ—Ä—à–∏–π –∫—Ä–æ–∫ –∑—Ä–æ–±–ª–µ–Ω–æ!";

        if (state.maxStreak >= 20) achievement += " üî• –ù–µ–π–º–æ–≤—ñ—Ä–Ω–∞ —Å–µ—Ä—ñ—è!";
        else if (state.maxStreak >= 10) achievement += " ‚ö° –ß—É–¥–æ–≤–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è!";
        if (accuracy >= 90 && totalAttempts >= 20) achievement += " üéØ –î—É–∂–µ —Ç–æ—á–Ω–∞ –≥—Ä–∞!";

        dom.achievement.textContent = achievement;

        dom.gameOver.style.display = "flex";
        dom.startBtn.style.display = "block";
        dom.stopBtn.style.display = "none";

        updateTargetHUD(nowMs());
        updateUI();
      }

      /***********************
       * 9) EVENTS
       ***********************/
      function onLevelClick(e) {
        const btn = e.target.closest("button[data-level]");
        if (!btn) return;
        state.level = btn.getAttribute("data-level");
        setSelected(dom.levelsWrap, "data-level", state.level);
        computeDifficulty();
      }

      function onSpeedClick(e) {
        const btn = e.target.closest("button[data-speed]");
        if (!btn) return;
        state.speed = btn.getAttribute("data-speed");
        setSelected(dom.speedWrap, "data-speed", state.speed);
        computeDifficulty();
      }

      async function toggleSound() {
        state.soundEnabled = !state.soundEnabled;
        dom.soundBtn.textContent = state.soundEnabled ? "üîä" : "üîá";
        dom.soundBtn.setAttribute("aria-label", state.soundEnabled ? "–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ –≥—Ä–∏" : "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ –≥—Ä–∏");
        if (state.soundEnabled) await resumeAudioIfNeeded();
      }

      function init() {
        computeDifficulty();
        updateUI();

        dom.levelsWrap.addEventListener("click", onLevelClick);
        dom.speedWrap.addEventListener("click", onSpeedClick);

        dom.startBtn.addEventListener("click", startGame);
        dom.stopBtn.addEventListener("click", stopGame);

        dom.soundBtn.addEventListener("click", toggleSound);

        dom.trainingMode.addEventListener("change", () => {
          state.trainingMode = dom.trainingMode.checked;
          updateTargetHUD(nowMs());
        });

        dom.smartMode.addEventListener("change", () => {
          state.smartMode = dom.smartMode.checked;
        });

        document.addEventListener("keydown", handleKeydown);

        window.addEventListener("beforeunload", () => {
          state.running = false;
          clearLetters();
        });

        updateTargetHUD(nowMs());
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>

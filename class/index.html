<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∞—Å–Ω–∞ –ö—ñ–º–Ω–∞—Ç–∞: –°–ø—ñ–ª—å–Ω–∏–π –ï–∫—Ä–∞–Ω</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –Ü–∫–æ–Ω–∫–∏ FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—ñ–¥–µ–æ */
        .video-wrapper {
            position: relative;
            background: #0f172a; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω */
            border-radius: 0.75rem;
            overflow: hidden;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        /* –ï—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ - –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ */
        .video-wrapper:hover {
            transform: translateY(-4px);
            border-color: #3b82f6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–æ–ø–æ—Ä—Ü—ñ—ó –µ–∫—Ä–∞–Ω—É */
        }

        /* –ë–µ–π–¥–∂ –∑ —ñ–º–µ–Ω–µ–º —É—á–Ω—è */
        .student-badge {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            pointer-events: none;
        }

        /* –ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º */
        #fullscreen-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight">ClassView</span>
                </div>
                <button id="logout-btn" class="hidden text-sm font-medium text-slate-500 hover:text-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt mr-1"></i> –í–∏–π—Ç–∏
                </button>
            </div>
        </div>
    </nav>

    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏ -->
    <div id="error-toast" class="fixed top-20 right-4 max-w-sm bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-500"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-red-700 font-medium" id="error-message">–ü–æ–º–∏–ª–∫–∞</p>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col items-center justify-center min-h-[calc(100vh-4rem)]">
        
        <!-- –ï–ö–†–ê–ù 1: –í–∏–±—ñ—Ä —Ä–æ–ª—ñ -->
        <div id="screen-role" class="w-full max-w-4xl animate-fade-in">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-4">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è –µ–∫—Ä–∞–Ω—ñ–≤ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</h1>
                <p class="text-lg text-slate-600 max-w-2xl mx-auto">–ü—Ä–æ—Å—Ç–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≤—á–∏—Ç–µ–ª—ñ–≤ —Ç–∞ —É—á–Ω—ñ–≤. –ë–µ–∑ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó, –ª–∏—à–µ –∫–æ–¥ —Å–µ—Å—ñ—ó.</p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                <!-- –ö–∞—Ä—Ç–∫–∞ –í—á–∏—Ç–µ–ª—è -->
                <button onclick="app.setupTeacher()" class="group relative bg-white p-8 rounded-2xl shadow-sm hover:shadow-xl border-2 border-slate-100 hover:border-blue-500 transition-all duration-300 text-left">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-arrow-right text-blue-500 text-xl"></i>
                    </div>
                    <div class="w-14 h-14 bg-blue-50 rounded-xl flex items-center justify-center mb-6 group-hover:bg-blue-600 transition-colors">
                        <i class="fas fa-chalkboard-user text-2xl text-blue-600 group-hover:text-white transition-colors"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">–Ø –í—á–∏—Ç–µ–ª—å</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É —Å–µ—Å—ñ—é, –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥ –¥–æ—Å—Ç—É–ø—É —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –µ–∫—Ä–∞–Ω–∏ —É—á–Ω—ñ–≤.</p>
                </button>

                <!-- –ö–∞—Ä—Ç–∫–∞ –£—á–Ω—è -->
                <button onclick="app.setupStudent()" class="group relative bg-white p-8 rounded-2xl shadow-sm hover:shadow-xl border-2 border-slate-100 hover:border-green-500 transition-all duration-300 text-left">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-arrow-right text-green-500 text-xl"></i>
                    </div>
                    <div class="w-14 h-14 bg-green-50 rounded-xl flex items-center justify-center mb-6 group-hover:bg-green-600 transition-colors">
                        <i class="fas fa-laptop-code text-2xl text-green-600 group-hover:text-white transition-colors"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-900 mb-2">–Ø –£—á–µ–Ω—å</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —ñ—Å–Ω—É—é—á–æ—ó —Å–µ—Å—ñ—ó –∑–∞ –∫–æ–¥–æ–º —Ç–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è —Å–≤–æ—ó–º –µ–∫—Ä–∞–Ω–æ–º.</p>
                </button>
            </div>
        </div>

        <!-- –ï–ö–†–ê–ù 2: –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –í—á–∏—Ç–µ–ª—è -->
        <div id="screen-teacher" class="hidden w-full">
            <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å–µ—Å—ñ—î—é -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-6">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É</p>
                        <div class="flex items-center gap-3">
                            <span id="session-code" class="text-5xl font-mono font-bold text-blue-600 tracking-wider">...</span>
                            <button onclick="app.copyCode()" class="p-2 text-slate-400 hover:text-blue-600 transition" title="–ö–æ–ø—ñ—é–≤–∞—Ç–∏">
                                <i class="fas fa-copy text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="h-12 w-px bg-slate-200 hidden md:block"></div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">–°—Ç–∞—Ç—É—Å</p>
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </span>
                            <span class="font-medium text-slate-700">–ê–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—ñ—è</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">–ê–≤—Ç–æ-–∑–∞–∫—Ä–∏—Ç—Ç—è —á–µ—Ä–µ–∑ 45 —Ö–≤</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 bg-slate-50 px-4 py-3 rounded-lg border border-slate-100">
                    <i class="fas fa-users text-slate-400"></i>
                    <span class="text-slate-600 font-medium">–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ: <strong id="student-count" class="text-slate-900">0</strong></span>
                </div>
            </div>

            <!-- –°—ñ—Ç–∫–∞ –µ–∫—Ä–∞–Ω—ñ–≤ -->
            <div id="screens-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- –°—é–¥–∏ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –¥–æ–¥–∞—é—Ç—å—Å—è –≤—ñ–¥–µ–æ -->
            </div>

            <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (–ø–æ—Ä–æ–∂–Ω—ñ–π —Å—Ç–∞–Ω) -->
            <div id="waiting-state" class="text-center py-24 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-wifi text-3xl text-slate-300"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-900">–ù–µ–º–∞—î –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏—Ö —É—á–Ω—ñ–≤</h3>
                <p class="text-slate-500 mt-2">–ü–æ–≤—ñ–¥–æ–º—Ç–µ —É—á–Ω—è–º –∫–æ–¥ <span class="font-mono font-bold bg-slate-100 px-2 py-1 rounded">...</span></p>
            </div>
        </div>

        <!-- –ï–ö–†–ê–ù 3: –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –£—á–Ω—è -->
        <div id="screen-student" class="hidden w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100">
                
                <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É -->
                <div id="student-login-form">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-900">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</h2>
                        <p class="text-slate-500">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥, —è–∫–∏–π –Ω–∞–¥–∞–≤ –≤—á–∏—Ç–µ–ª—å</p>
                    </div>

                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">–í–∞—à–µ —ñ–º'—è</label>
                            <input type="text" id="student-name" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="–û–ª–µ–∫—Å–∞–Ω–¥—Ä –ü.">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">–ö–æ–¥ —Å–µ—Å—ñ—ó</label>
                            <input type="text" id="join-code" maxlength="4" class="w-full px-4 py-3 text-center text-2xl font-mono tracking-widest rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none uppercase transition" placeholder="0000">
                        </div>

                        <button id="join-btn" onclick="app.joinSession()" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform transition active:scale-95 flex justify-center items-center gap-2">
                            <span>–ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é</span>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- –°—Ç–∞–Ω —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó -->
                <div id="student-broadcasting" class="hidden text-center py-6">
                    <div class="w-24 h-24 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-20"></span>
                        <i class="fas fa-broadcast-tower text-4xl text-green-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-900 mb-2">–í–∏ –≤ –µ—Ñ—ñ—Ä—ñ!</h3>
                    <p class="text-slate-500 mb-8">–í–∞—à –µ–∫—Ä–∞–Ω –∑–∞—Ä–∞–∑ —Ç—Ä–∞–Ω—Å–ª—é—î—Ç—å—Å—è –≤—á–∏—Ç–µ–ª—é.</p>
                    
                    <div class="bg-blue-50 p-4 rounded-lg text-left text-sm text-blue-800 mb-6">
                        <i class="fas fa-info-circle mr-2"></i> –ù–µ –∑–∞–∫—Ä–∏–≤–∞–π—Ç–µ —Ü—é –≤–∫–ª–∞–¥–∫—É, —â–æ–± –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è.
                    </div>

                    <button onclick="location.reload()" class="w-full py-3 border-2 border-red-100 text-red-600 font-bold rounded-lg hover:bg-red-50 transition">
                        –ó—É–ø–∏–Ω–∏—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø–æ–≤–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É -->
    <div id="fullscreen-modal">
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-50 bg-gradient-to-b from-black/80 to-transparent">
            <span id="fs-student-name" class="text-white text-xl font-bold px-4">–Ü–º'—è —É—á–Ω—è</span>
            <button onclick="app.closeFullscreen()" class="text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-3 transition backdrop-blur-sm">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <video id="fs-video" autoplay playsinline muted class="max-w-full max-h-full"></video>
    </div>

    <!-- –ú–æ–¥—É–ª—å Firebase —Ç–∞ –õ–æ–≥—ñ–∫–∏ -->
    <script type="module">
        // –Ü–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π Firebase (Modular SDK v9+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, serverTimestamp, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
        // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
        const firebaseConfig = {
          apiKey: "AIzaSyASg6XwiqAflGj8Lhr1QvONaIiwg-KyeJ8",
          authDomain: "classview-64b87.firebaseapp.com",
          projectId: "classview-64b87",
          storageBucket: "classview-64b87.firebasestorage.app",
          messagingSenderId: "874387554954",
          appId: "1:874387554954:web:aaff431cec6d88a63f6373",
          measurementId: "G-5GCW9TRRRP"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app'; // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —ñ–∑–æ–ª—è—Ü—ñ—ó –¥–∞–Ω–∏—Ö

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let auth, db, currentUser;
        
        // STUN —Å–µ—Ä–≤–µ—Ä–∏ –≤—ñ–¥ Google (–ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è NAT/Firewall)
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // –°—Ç–∞–Ω –¥–æ–¥–∞—Ç–∫—É
        const state = {
            role: null,         // 'teacher' –∞–±–æ 'student'
            sessionId: null,    // ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–µ—Å—ñ—ó –≤ Firestore
            pcs: {},            // –û–±'—î–∫—Ç –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è RTCPeerConnection (–∫–ª—é—á: studentId)
            localStream: null,  // –ü–æ—Ç—ñ–∫ –µ–∫—Ä–∞–Ω—É —É—á–Ω—è
            unsubscribeFuncs: [] // –ú–∞—Å–∏–≤ —Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è –≤—ñ–¥–ø–∏—Å–∫–∏ –≤—ñ–¥ —Å–ª—É—Ö–∞—á—ñ–≤ Firestore
        };

        class ClassroomApp {
            constructor() {
                this.initFirebase();
                this.bindEvents();
            }

            // --- 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---

            async initFirebase() {
                try {
                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
                    const config = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : firebaseConfig;
                    const app = initializeApp(config);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // –ê–Ω–æ–Ω—ñ–º–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è (–Ω–µ –≤–∏–º–∞–≥–∞—î –ø–∞—Ä–æ–ª—ñ–≤, –∞–ª–µ –¥–∞—î User ID)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInAnonymously(auth); // –°–ø—Ä–æ—â–µ–Ω–æ –¥–ª—è —Ü—å–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
                    } else {
                        await signInAnonymously(auth);
                    }

                    // –°–ª—É—Ö–∞—î–º–æ —Å—Ç–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            console.log("Auth success:", user.uid);
                        } else {
                            this.showError("–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è");
                        }
                    });

                } catch (e) {
                    console.error("Firebase init error", e);
                    this.showError("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö");
                }
            }

            bindEvents() {
                // –ö–Ω–æ–ø–∫–∞ –≤–∏—Ö–æ–¥—É
                document.getElementById('logout-btn').addEventListener('click', () => location.reload());
            }

            // --- 2. –õ–æ–≥—ñ–∫–∞ –í—á–∏—Ç–µ–ª—è ---

            async setupTeacher() {
                if (!currentUser) return this.showError("–ó–∞—á–µ–∫–∞–π—Ç–µ –Ω–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è...");
                
                state.role = 'teacher';
                this.switchScreen('screen-teacher');
                
                try {
                    // –ì–µ–Ω–µ—Ä—É—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π 4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥
                    const code = Math.floor(1000 + Math.random() * 9000).toString();
                    document.getElementById('session-code').innerText = code;
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å —Å–µ—Å—ñ—ó –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —à–ª—è—Ö public/data –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –≤ —Ü—å–æ–º—É –¥–µ–º–æ
                    const sessionRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'sessions'));
                    state.sessionId = sessionRef.id;

                    const expiresAt = Date.now() + (45 * 60 * 1000); // 45 —Ö–≤–∏–ª–∏–Ω

                    await setDoc(sessionRef, {
                        code: code,
                        teacherId: currentUser.uid,
                        createdAt: serverTimestamp(),
                        expiresAt: expiresAt
                    });

                    // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Å–µ—Å—ñ—ó
                    this.startExpiryCheck(expiresAt);

                    // –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—è –Ω–∞ –∑–º—ñ–Ω–∏ –≤ –∫–æ–ª–µ–∫—Ü—ñ—ó —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ —Ü—ñ—î—ó —Å–µ—Å—ñ—ó
                    const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'sessions', state.sessionId, 'students');
                    
                    const unsub = onSnapshot(studentsRef, (snapshot) => {
                        this.updateStudentCount(snapshot.size);
                        
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                this.handleStudentConnected(change.doc.id, change.doc.data());
                            }
                            if (change.type === "removed") {
                                this.handleStudentDisconnected(change.doc.id);
                            }
                        });
                    }, (error) => this.showError("–í—Ç—Ä–∞—á–µ–Ω–æ –∑–≤'—è–∑–æ–∫ –∑—ñ —Å–ø–∏—Å–∫–æ–º —É—á–Ω—ñ–≤"));

                    state.unsubscribeFuncs.push(unsub);

                } catch (e) {
                    console.error(e);
                    this.showError("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å–µ—Å—ñ—é");
                }
            }

            async handleStudentConnected(studentId, data) {
                console.log(`üîµ Student ${data.name} connecting... ID: ${studentId}`);
                
                // 1. –°—Ç–≤–æ—Ä—é—î–º–æ WebRTC –∑'—î–¥–Ω–∞–Ω–Ω—è
                const pc = new RTCPeerConnection(rtcConfig);
                state.pcs[studentId] = pc;

                // –ß–µ—Ä–≥–∞ –¥–ª—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤, —è–∫—ñ –ø—Ä–∏–π—à–ª–∏ –¥–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è remoteDescription
                const iceQueue = [];

                // 2. –°—Ç–≤–æ—Ä—é—î–º–æ UI –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ñ–¥–µ–æ
                this.createVideoElement(studentId, data.name);

                // –õ–æ–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –∑'—î–¥–Ω–∞–Ω–Ω—è
                pc.onconnectionstatechange = () => {
                    console.log(`üì° Connection state (${data.name}):`, pc.connectionState);
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`üßä ICE connection state (${data.name}):`, pc.iceConnectionState);
                };

                // 3. –û–±—Ä–æ–±–∫–∞ –≤—Ö—ñ–¥–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É (–∫–æ–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤—ñ–¥–µ–æ)
                pc.ontrack = (event) => {
                    console.log(`üé• Received track from ${data.name}:`, event.track.kind);
                    const videoEl = document.getElementById(`vid-${studentId}`);
                    if (videoEl && event.streams[0]) {
                        videoEl.srcObject = event.streams[0];
                        console.log(`‚úÖ Video element updated for ${data.name}`);
                    }
                };

                // 4. –û–±–º—ñ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ (ICE Candidates)
                const candidatesCollection = collection(db, 'artifacts', appId, 'public', 'data', 'sessions', state.sessionId, 'students', studentId, 'candidates');
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log(`üîÑ Sending ICE candidate to ${data.name}`);
                        addDoc(candidatesCollection, {
                            candidate: event.candidate.toJSON(),
                            from: 'teacher',
                            createdAt: serverTimestamp()
                        }).catch(e => console.error('‚ùå Error sending ICE:', e));
                    } else {
                        console.log(`‚úîÔ∏è All ICE candidates sent for ${data.name}`);
                    }
                };

                // 5. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –æ–ø–∏—Å –∑'—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥ —É—á–Ω—è (Offer)
                if (data.offer) {
                    try {
                        console.log(`üì® Setting remote description from ${data.name}`);
                        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                        console.log(`‚úÖ Remote description set for ${data.name}`);
                        
                        // –û–±—Ä–æ–±–ª—è—î–º–æ —á–µ—Ä–≥—É –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤
                        console.log(`üîÑ Processing ${iceQueue.length} queued ICE candidates`);
                        while (iceQueue.length > 0) {
                            try {
                                await pc.addIceCandidate(iceQueue.shift());
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Error adding queued ICE candidate:', e);
                            }
                        }

                        // –ì–µ–Ω–µ—Ä—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (Answer)
                        console.log(`üì§ Creating answer for ${data.name}`);
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        console.log(`‚úÖ Local description set for ${data.name}`);

                        // –ó–∞–ø–∏—Å—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', state.sessionId, 'students', studentId), {
                            answer: { type: answer.type, sdp: answer.sdp }
                        });
                        console.log(`‚úÖ Answer sent to ${data.name}`);
                    } catch (e) {
                        console.error(`‚ùå Error in WebRTC handshake for ${data.name}:`, e);
                        this.showError(`–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ ${data.name}`);
                    }
                }

                // 6. –°–ª—É—Ö–∞—î–º–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∏ –≤—ñ–¥ —É—á–Ω—è
                const q = query(candidatesCollection, where("from", "==", "student"));
                const unsubIce = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            try {
                                const candidateData = change.doc.data().candidate;
                                const candidate = new RTCIceCandidate(candidateData);
                                console.log(`üîΩ Received ICE candidate from ${data.name}`);
                                
                                if (pc.remoteDescription) {
                                    await pc.addIceCandidate(candidate);
                                    console.log(`‚úÖ ICE candidate added for ${data.name}`);
                                } else {
                                    console.log(`‚è≥ Queueing ICE candidate (no remote description yet)`);
                                    iceQueue.push(candidate);
                                }
                            } catch (e) {
                                console.warn("‚ö†Ô∏è ICE candidate error:", e);
                            }
                        }
                    });
                }, (error) => {
                    console.error('‚ùå Error listening to ICE candidates:', error);
                });
                state.unsubscribeFuncs.push(unsubIce);
            }

            handleStudentDisconnected(studentId) {
                // –í–∏–¥–∞–ª—è—î–º–æ DOM –µ–ª–µ–º–µ–Ω—Ç
                const el = document.getElementById(`wrap-${studentId}`);
                if (el) el.remove();
                
                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è
                if (state.pcs[studentId]) {
                    state.pcs[studentId].close();
                    delete state.pcs[studentId];
                }

                // –Ø–∫—â–æ –±—É–≤ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –Ω–∞ –ø–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω
                const fsModal = document.getElementById('fullscreen-modal');
                if (fsModal.style.display === 'flex') {
                    this.closeFullscreen();
                }

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î —â–µ —É—á–Ω—ñ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≥–ª—É—à–∫–∏
                const count = document.getElementById('screens-grid').childElementCount;
                this.updateStudentCount(count);
            }

            // --- 3. –õ–æ–≥—ñ–∫–∞ –£—á–Ω—è ---

            async setupStudent() {
                if (!currentUser) return this.showError("–ó–∞—á–µ–∫–∞–π—Ç–µ –Ω–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è...");
                state.role = 'student';
                this.switchScreen('screen-student');
            }

            async joinSession() {
                const btn = document.getElementById('join-btn');
                const codeInput = document.getElementById('join-code').value.trim();
                const nameInput = document.getElementById('student-name').value.trim();

                if (codeInput.length !== 4) return this.showError("–ö–æ–¥ –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ 4 —Ü–∏—Ñ—Ä–∏");
                if (nameInput.length < 2) return this.showError("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è");

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...';

                try {
                    // 1. –®—É–∫–∞—î–º–æ —Å–µ—Å—ñ—é –∑–∞ –∫–æ–¥–æ–º
                    console.log("üîç Searching for session:", codeInput);
                    const sessionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'sessions');
                    const q = query(sessionsRef, where("code", "==", codeInput));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) throw new Error("–°–µ—Å—ñ—é –∑ —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");

                    const sessionDoc = querySnapshot.docs[0];
                    const sessionData = sessionDoc.data();
                    state.sessionId = sessionDoc.id;

                    if (Date.now() > sessionData.expiresAt) throw new Error("–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó —Ü—ñ—î—ó —Å–µ—Å—ñ—ó –º–∏–Ω—É–≤");
                    console.log("‚úÖ Session found:", state.sessionId);

                    // 2. –ó–∞–ø–∏—Ç—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫—Ä–∞–Ω—É
                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getDisplayMedia({
                            video: { cursor: "always", frameRate: 15 },
                            audio: false
                        });
                        console.log("‚úÖ Screen stream acquired");
                    } catch (err) {
                        throw new Error("–í–∏ –≤—ñ–¥—Ö–∏–ª–∏–ª–∏ –∑–∞–ø–∏—Ç –Ω–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é –µ–∫—Ä–∞–Ω—É");
                    }

                    state.localStream = stream;
                    stream.getVideoTracks()[0].onended = () => location.reload();

                    // 3. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ WebRTC
                    const pc = new RTCPeerConnection(rtcConfig);
                    state.pcs['teacher'] = pc;
                    const iceQueue = [];

                    pc.onconnectionstatechange = () => console.log("üì° Student connection state:", pc.connectionState);
                    pc.oniceconnectionstatechange = () => console.log("üßä Student ICE state:", pc.iceConnectionState);

                    stream.getTracks().forEach(track => pc.addTrack(track, stream));

                    // 4. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Offer
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    console.log("‚úÖ Offer created and local desc set");

                    // 5. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—á–Ω—è –≤ Firestore
                    const studentRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sessions', state.sessionId, 'students'), {
                        name: nameInput,
                        offer: { type: offer.type, sdp: offer.sdp },
                        joinedAt: serverTimestamp()
                    });
                    console.log("‚úÖ Student registered in DB:", studentRef.id);

                    // 6. –û–±—Ä–æ–±–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ (–≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤—á–∏—Ç–µ–ª—é)
                    const candidatesCollection = collection(db, 'artifacts', appId, 'public', 'data', 'sessions', state.sessionId, 'students', studentRef.id, 'candidates');

                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log("üîÑ Sending ICE to teacher");
                            addDoc(candidatesCollection, {
                                candidate: event.candidate.toJSON(),
                                from: 'student',
                                createdAt: serverTimestamp()
                            });
                        }
                    };

                    // 7. –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (Answer) –≤—ñ–¥ –≤—á–∏—Ç–µ–ª—è
                    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', state.sessionId, 'students', studentRef.id), async (snap) => {
                        const data = snap.data();
                        if (data && data.answer && !pc.currentRemoteDescription) {
                            console.log("üì® Received answer from teacher");
                            const answer = new RTCSessionDescription(data.answer);
                            await pc.setRemoteDescription(answer);
                            console.log("‚úÖ Remote description set (Answer)");
                            
                            // –û–±—Ä–æ–±–∫–∞ —á–µ—Ä–≥–∏ ICE
                            console.log(`üîÑ Processing ${iceQueue.length} queued ICE candidates from teacher`);
                            while (iceQueue.length > 0) {
                                try {
                                    await pc.addIceCandidate(iceQueue.shift());
                                } catch (e) { console.warn("Queued ICE error", e); }
                            }
                        }
                    });

                    // –°–ª—É—Ö–∞—î–º–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∏ –≤—ñ–¥ –≤—á–∏—Ç–µ–ª—è
                    const qIce = query(candidatesCollection, where("from", "==", "teacher"));
                    onSnapshot(qIce, (snapshot) => {
                        snapshot.docChanges().forEach(async (change) => {
                            if (change.type === 'added') {
                                const candData = change.doc.data().candidate;
                                const cand = new RTCIceCandidate(candData);
                                console.log("üîΩ Received ICE from teacher");
                                
                                if (pc.remoteDescription) {
                                    await pc.addIceCandidate(cand);
                                } else {
                                    console.log("‚è≥ Queueing Teacher ICE");
                                    iceQueue.push(cand);
                                }
                            }
                        });
                    });

                    // –£—Å–ø—ñ—Ö
                    document.getElementById('student-login-form').classList.add('hidden');
                    document.getElementById('student-broadcasting').classList.remove('hidden');

                } catch (err) {
                    console.error("Student error:", err);
                    this.showError(err.message);
                    btn.disabled = false;
                    btn.innerHTML = '–ü–æ—á–∞—Ç–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é';
                    if (state.localStream) {
                        state.localStream.getTracks().forEach(t => t.stop());
                    }
                }
            }


            // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó UI ---

            createVideoElement(id, name) {
                const grid = document.getElementById('screens-grid');
                if (document.getElementById(`wrap-${id}`)) return;

                const wrap = document.createElement('div');
                wrap.id = `wrap-${id}`;
                wrap.className = 'video-wrapper animate-fade-in';
                wrap.onclick = () => this.openFullscreen(id, name);

                wrap.innerHTML = `
                    <video id="vid-${id}" autoplay playsinline muted></video>
                    <div class="student-badge">
                        <i class="fas fa-user-graduate text-xs"></i> ${name}
                    </div>
                `;
                
                grid.appendChild(wrap);
                this.updateStudentCount(document.getElementById('screens-grid').children.length);
            }

            openFullscreen(id, name) {
                const sourceVid = document.getElementById(`vid-${id}`);
                const fsModal = document.getElementById('fullscreen-modal');
                const fsVideo = document.getElementById('fs-video');
                
                if (sourceVid && sourceVid.srcObject) {
                    fsVideo.srcObject = sourceVid.srcObject;
                    document.getElementById('fs-student-name').innerText = name;
                    fsModal.style.display = 'flex';
                }
            }

            closeFullscreen() {
                const fsModal = document.getElementById('fullscreen-modal');
                const fsVideo = document.getElementById('fs-video');
                fsModal.style.display = 'none';
                fsVideo.srcObject = null;
            }

            switchScreen(screenId) {
                ['screen-role', 'screen-teacher', 'screen-student'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
            }

            updateStudentCount(count) {
                const num = typeof count === 'number' ? count : 0;
                document.getElementById('student-count').innerText = num;
                
                const emptyState = document.getElementById('waiting-state');
                if (num > 0) emptyState.classList.add('hidden');
                else emptyState.classList.remove('hidden');
            }

            showError(msg) {
                const toast = document.getElementById('error-toast');
                document.getElementById('error-message').innerText = msg;
                toast.classList.remove('translate-x-full');
                setTimeout(() => toast.classList.add('translate-x-full'), 4000);
            }

            copyCode() {
                const code = document.getElementById('session-code').innerText;
                navigator.clipboard.writeText(code);
                // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤—ñ–∑—É–∞–ª—å–Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
            }

            startExpiryCheck(expiresAt) {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É
                setInterval(() => {
                    if (Date.now() > expiresAt) {
                        alert("–ß–∞—Å —Å–µ—Å—ñ—ó (45 —Ö–≤) –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –°–µ—Å—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
                        location.reload();
                    }
                }, 60000);
            }
        }

        // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
        window.app = new ClassroomApp();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн-дошка</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Запобігає появі смуг прокрутки */
        }
        .tool-btn {
            transition: all 0.2s ease-in-out;
        }
        .tool-btn.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .color-btn.active {
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-white text-gray-900">

    <!-- Головний контейнер -->
    <div id="app" class="relative w-screen h-screen flex">

        <!-- Панель інструментів -->
        <div id="toolbar" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 bg-gray-100 p-3 rounded-xl shadow-lg flex items-center flex-wrap justify-center gap-y-2 md:space-x-4 border border-gray-200">
            <!-- Інструменти малювання -->
            <div class="flex items-center space-x-2">
                <button id="pen-tool" class="tool-btn p-3 rounded-lg bg-gray-200 hover:bg-blue-200 active" data-tool="pen" title="Перо">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                </button>
                <button id="eraser-tool" class="tool-btn p-3 rounded-lg bg-gray-200 hover:bg-blue-200" data-tool="eraser" title="Гумка">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.42 4.58a2.12 2.12 0 0 0-3-3L7.42 13.58a2.12 2.12 0 0 0 0 3l7 7a2.12 2.12 0 0 0 3 0l3-3a2.12 2.12 0 0 0 0-3z"></path><path d="m18 11-7.5 7.5"></path><path d="m14 15-7.5 7.5"></path></svg>
                </button>
            </div>

            <!-- Розділювач -->
            <div class="w-px h-8 bg-gray-300"></div>

            <!-- Колір та Розмір -->
            <div class="flex items-center space-x-2">
                 <input type="color" id="color-picker" value="#000000" class="w-10 h-10 p-1 bg-gray-200 rounded-lg cursor-pointer" title="Вибір кольору">
                 <div class="flex items-center space-x-1.5">
                    <button data-color="#000000" class="color-btn w-8 h-8 rounded-lg bg-black border-2 active" title="Чорний"></button>
                    <button data-color="#ef4444" class="color-btn w-8 h-8 rounded-lg bg-red-500 border-2 border-transparent" title="Червоний"></button>
                    <button data-color="#22c55e" class="color-btn w-8 h-8 rounded-lg bg-green-500 border-2 border-transparent" title="Зелений"></button>
                    <button data-color="#3b82f6" class="color-btn w-8 h-8 rounded-lg bg-blue-500 border-2 border-transparent" title="Синій"></button>
                 </div>
            </div>
             <div class="flex items-center space-x-2 bg-gray-200 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>
                <input type="range" id="size-slider" min="1" max="50" value="5" class="w-24 cursor-pointer" title="Розмір пензля">
            </div>


            <!-- Розділювач -->
            <div class="w-px h-8 bg-gray-300"></div>

            <!-- Дії -->
            <div class="flex items-center space-x-2">
                <button id="undo-btn" class="tool-btn p-3 rounded-lg bg-gray-200 hover:bg-blue-200" title="Скасувати">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 14 4 9 9 4"></polyline><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg>
                </button>
                <button id="redo-btn" class="tool-btn p-3 rounded-lg bg-gray-200 hover:bg-blue-200" title="Повторити">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 14 20 9 15 4"></polyline><path d="M4 20v-7a4 4 0 0 1 4-4h12"></path></svg>
                </button>
                 <button id="clear-btn" class="tool-btn p-3 rounded-lg bg-red-200 hover:bg-red-300" title="Очистити полотно">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>

            <!-- Розділювач -->
            <div class="w-px h-8 bg-gray-300"></div>

            <!-- Збереження та QR -->
            <div class="flex items-center space-x-2">
                <button id="save-btn" class="tool-btn p-3 rounded-lg bg-green-200 hover:bg-green-300" title="Зберегти як PNG">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </button>
                <button id="qr-btn" class="tool-btn p-3 rounded-lg bg-purple-200 hover:bg-purple-300" title="Згенерувати QR-код">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </button>
            </div>
        </div>

        <!-- Полотно -->
        <canvas id="whiteboard" class="w-full h-full bg-white"></canvas>

        <!-- Модальне вікно підтвердження очищення -->
        <div id="clear-modal" class="fixed inset-0 z-30 items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Очистити полотно</h3>
                <p class="text-sm text-gray-500 mb-4">Ви впевнені, що хочете все стерти? Цю дію неможливо скасувати.</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-clear-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Очистити</button>
                    <button id="cancel-clear-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none">Скасувати</button>
                </div>
            </div>
        </div>

        <!-- Модальне вікно генератора QR-коду -->
        <div id="qr-modal" class="fixed inset-0 z-30 items-center justify-center hidden modal-backdrop">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">Згенерувати QR-код</h3>
                    <button id="close-qr-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="qr-url-input" placeholder="https://example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="generate-qr-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Згенерувати</button>
                    <div id="qrcode-container" class="flex justify-center items-center p-4 bg-white rounded-md mt-4 min-h-[200px]">
                        <!-- QR-код буде згенеровано тут -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('whiteboard');
            const ctx = canvas.getContext('2d');

            // --- Керування станом ---
            let isDrawing = false;
            let currentTool = 'pen'; // 'pen' або 'eraser'
            let currentColor = '#000000';
            let currentSize = 5;
            let lastX = 0;
            let lastY = 0;

            // Історія для скасування/повторення
            let history = [];
            let historyIndex = -1;
            const MAX_HISTORY_SIZE = 30; // Обмеження використання пам'яті

            // --- Елементи інтерфейсу ---
            const penToolBtn = document.getElementById('pen-tool');
            const eraserToolBtn = document.getElementById('eraser-tool');
            const colorPicker = document.getElementById('color-picker');
            const colorButtons = document.querySelectorAll('.color-btn');
            const sizeSlider = document.getElementById('size-slider');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const clearBtn = document.getElementById('clear-btn');
            const saveBtn = document.getElementById('save-btn');
            const qrBtn = document.getElementById('qr-btn');

            // --- Модальні вікна ---
            const clearModal = document.getElementById('clear-modal');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const qrModal = document.getElementById('qr-modal');
            const closeQrBtn = document.getElementById('close-qr-btn');
            const qrUrlInput = document.getElementById('qr-url-input');
            const generateQrBtn = document.getElementById('generate-qr-btn');
            const qrcodeContainer = document.getElementById('qrcode-container');
            let qrcodeInstance = null;

            // --- Ініціалізація ---
            function initializeCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                
                // Встановлення білого фону за замовчуванням
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                saveState(); // Зберегти початковий порожній стан
            }

            // --- Логіка малювання ---
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = getMousePos(e);
            }

            function draw(e) {
                if (!isDrawing) return;

                const [currentX, currentY] = getMousePos(e);

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);

                if (currentTool === 'pen') {
                    ctx.strokeStyle = currentColor;
                    ctx.lineWidth = currentSize;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                } else if (currentTool === 'eraser') {
                    // Гумка працює, малюючи білим кольором
                    ctx.strokeStyle = '#FFFFFF'; 
                    ctx.lineWidth = currentSize;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                }
                
                ctx.stroke();

                [lastX, lastY] = [currentX, currentY];
            }

            function stopDrawing() {
                if (!isDrawing) return;
                isDrawing = false;
                ctx.beginPath(); // Скинути шлях
                saveState();
            }

            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                // Обробка подій миші та дотику
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                return [clientX - rect.left, clientY - rect.top];
            }
            
            // --- Історія (Скасувати/Повторити) ---
            function saveState() {
                if (historyIndex < history.length - 1) {
                    history.splice(historyIndex + 1);
                }
                
                if (history.length >= MAX_HISTORY_SIZE) {
                    history.shift(); 
                }

                history.push(canvas.toDataURL());
                historyIndex = history.length - 1;
                updateUndoRedoButtons();
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    restoreState();
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    restoreState();
                }
            }

            function restoreState() {
                const img = new Image();
                img.src = history[historyIndex];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
                };
                updateUndoRedoButtons();
            }

            function updateUndoRedoButtons() {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= history.length - 1;
                undoBtn.classList.toggle('opacity-50', undoBtn.disabled);
                redoBtn.classList.toggle('opacity-50', redoBtn.disabled);
            }

            // --- Обробники інструментів та опцій ---
            function switchTool(tool) {
                currentTool = tool;
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.tool-btn[data-tool="${tool}"]`).classList.add('active');
            }

            function setActiveColor(selectedButton) {
                colorButtons.forEach(button => {
                    button.classList.remove('active');
                });
                if(selectedButton) {
                    selectedButton.classList.add('active');
                }
            }

            function clearCanvas() {
                ctx.fillStyle = '#FFFFFF';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                saveState();
            }

            function saveCanvasAsImage() {
                const link = document.createElement('a');
                link.download = 'whiteboard-drawing.png';
                link.href = canvas.toDataURL('image/png').replace('image/png', 'image/octet-stream');
                link.click();
            }
            
            // --- Логіка модальних вікон ---
            function showModal(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function hideModal(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            function generateQRCode() {
                const url = qrUrlInput.value.trim();
                if (!url) {
                    qrcodeContainer.innerHTML = '<p class="text-gray-500">Будь ласка, введіть URL.</p>';
                    return;
                }
                
                qrcodeContainer.innerHTML = ''; // Очистити попередній QR-код
                try {
                    qrcodeInstance = new QRCode(qrcodeContainer, {
                        text: url,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } catch (error) {
                    console.error("Помилка генерації QR-коду:", error);
                    qrcodeContainer.innerHTML = '<p class="text-red-500">Не вдалося згенерувати QR-код. Неправильний URL?</p>';
                }
            }

            // --- Слухачі подій ---
            // Слухачі полотна
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Слухачі дотику
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            // Слухачі панелі інструментів
            penToolBtn.addEventListener('click', () => switchTool('pen'));
            eraserToolBtn.addEventListener('click', () => switchTool('eraser'));
            
            colorPicker.addEventListener('input', (e) => {
                currentColor = e.target.value;
                setActiveColor(null); // Зняти виділення з кнопок швидкого вибору
            });

            colorButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const color = button.dataset.color;
                    currentColor = color;
                    colorPicker.value = color;
                    setActiveColor(button);
                });
            });

            sizeSlider.addEventListener('input', (e) => currentSize = e.target.value);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            saveBtn.addEventListener('click', saveCanvasAsImage);

            // Слухачі модального вікна очищення
            clearBtn.addEventListener('click', () => showModal(clearModal));
            confirmClearBtn.addEventListener('click', () => {
                clearCanvas();
                hideModal(clearModal);
            });
            cancelClearBtn.addEventListener('click', () => hideModal(clearModal));
            
            // Слухачі модального вікна QR
            qrBtn.addEventListener('click', () => {
                qrUrlInput.value = '';
                qrcodeContainer.innerHTML = '<p class="text-gray-500">Введіть URL для створення QR-коду.</p>';
                showModal(qrModal);
            });
            closeQrBtn.addEventListener('click', () => hideModal(qrModal));
            generateQrBtn.addEventListener('click', generateQRCode);
            
            // Обробник зміни розміру вікна
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const imgData = canvas.toDataURL();
                    initializeCanvas();
                    
                    const img = new Image();
                    img.src = imgData;
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
                    };
                }, 100);
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });

            // --- Початкове налаштування ---
            initializeCanvas();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- –ó–º—ñ–Ω–µ–Ω–æ –Ω–∞–∑–≤—É –Ω–∞ "–ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ" –∑–≥—ñ–¥–Ω–æ –∑ —Ñ–∞–π–ª–æ–º -->
    <title>–ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ - –ê–ª–≥–æ—Ä–∏—Ç–º—ñ—á–Ω–∞ RPG</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —à—Ä–∏—Ñ—Ç—ñ–≤ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –∫–∏—Ä–∏–ª–∏—Ü—ñ –∑ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Tailwind –¥–ª—è –Ω–æ–≤–æ–≥–æ —à—Ä–∏—Ñ—Ç—É —Ç–∞ —Å—Ç–∏–ª—ñ–≤ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Roboto', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Helvetica', 'Arial', 'sans-serif'],
                        'display': ['Open Sans', 'Roboto', 'sans-serif'], // –®—Ä–∏—Ñ—Ç–∏ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –∫–∏—Ä–∏–ª–∏—Ü—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
                    }
                }
            }
        }
    </script>
    <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è 3D-–∫–Ω–æ–ø–æ–∫, —è–∫—ñ —Å–∫–ª–∞–¥–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —á–∏—Å—Ç–∏–º Tailwind -->
    <style>
        .btn-3d {
            transition: all 0.1s ease-in-out;
            /* –°—Ç–≤–æ—Ä–µ–Ω–Ω—è 3D-–µ—Ñ–µ–∫—Ç—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç—ñ–Ω—ñ */
            box-shadow: 0 4px 0 0 var(--shadow-color);
        }
        .btn-3d:disabled {
            box-shadow: 0 4px 0 0 var(--shadow-color);
            /* –î–æ–¥–∞–Ω–æ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è */
            filter: grayscale(0.6);
            opacity: 0.7;
        }
        .btn-3d:not(:disabled):active {
            /* –ï—Ñ–µ–∫—Ç –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è */
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 var(--shadow-color);
        }
         /* –°—Ç–∏–ª—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è */
        .btn-sort {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 3px 0 0 var(--shadow-color);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-sort:not(:disabled):active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 0 var(--shadow-color);
        }
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø—É–ª—å—Å–∞—Ü—ñ—ó –¥–ª—è –º–æ–Ω—Å—Ç—Ä–∞ */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .monster-pulse {
            animation: pulse 1.5s infinite;
        }
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .slide-in {
            animation: slideIn 0.3s;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ */
        .hidden-by-level {
            display: none !important;
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∏—Ä–∏–ª–∏—Ü—ñ */
        body, h1, h2, h3, p, span, div, button {
            font-family: 'Roboto', 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            font-feature-settings: 'liga' 1, 'kern' 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –∑ –∫–∏—Ä–∏–ª–∏—Ü–µ—é */
        .font-display {
            font-family: 'Open Sans', 'Roboto', sans-serif !important;
            font-weight: 700;
            letter-spacing: 0.025em;
        }
        
        /* –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∑—É–º—É –ø—Ä–∏ –¥–≤—ñ–π–Ω–æ–º—É —Ç–æ—Ä–∫–∞–Ω–Ω—ñ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
        * {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ input –ø–æ–ª—è—Ö */
        input, textarea {
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∑–∞—Ö–∏—Å—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–æ–º–∞–Ω–¥ */
        .cmd-btn, .control-btn, .btn-sort {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 to-blue-700 min-h-screen p-2.5 flex justify-center items-start font-sans">
    
    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—Ä–∏ -->
    <div class="bg-white rounded-2xl p-4 md:p-6 shadow-2xl max-w-6xl w-full my-4">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ —ñ–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å —Ä—ñ–≤–Ω—è –≤ –æ–¥–Ω–æ–º—É —Ä—è–¥–∫—É -->
        <div class="flex flex-col md:flex-row gap-4 md:gap-6 items-start md:items-center mb-4 md:mb-6">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-1 text-center md:text-left">
                <h1 class="font-display text-4xl md:text-5xl text-yellow-500 drop-shadow-lg mb-3">ü¶∏ –ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ üêâ</h1>
                <p class="text-gray-600 text-base md:text-lg">–°—Ç–≤–æ—Ä–∏ –∞–ª–≥–æ—Ä–∏—Ç–º, –∑–±–µ—Ä–∏ —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è —ñ –∑–¥–æ–ª–∞–π –º–æ–Ω—Å—Ç—Ä—ñ–≤!</p>
            </div>

            <!-- –Ü–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å —Ä—ñ–≤–Ω—è -->
            <div class="level-info bg-gradient-to-br from-purple-600 to-indigo-700 p-3 md:p-4 rounded-2xl text-white shadow-lg flex-shrink-0 w-full md:w-auto">
                <h2 class="font-display text-2xl md:text-3xl mb-2 text-center">üè∞ –†—ñ–≤–µ–Ω—å <span id="levelNum">1</span></h2>
                <p class="level-desc text-sm md:text-base mb-3 text-center" id="levelDesc"></p>
                <div class="stats-bar flex gap-2 md:gap-3 justify-center flex-wrap">
                    <div class="stat bg-white/20 rounded-lg px-3 py-1.5 flex items-center gap-2 text-sm md:text-base">‚öîÔ∏è <span id="damage">0</span></div>
                    <div class="stat bg-white/20 rounded-lg px-3 py-1.5 flex items-center gap-2 text-sm md:text-base">üõ°Ô∏è <span id="armor">0</span></div>
                    <div class="stat bg-white/20 rounded-lg px-3 py-1.5 flex items-center gap-2 text-sm md:text-base">‚ù§Ô∏è <span id="health">100</span></div>
                    <div class="stat bg-white/20 rounded-lg px-3 py-1.5 flex items-center gap-2 text-sm md:text-base font-display">üéØ –¶—ñ–ª—å: <span id="parGold">?</span> ü•á</div>
                </div>
            </div>
        </div>

        <!-- –Ü–≥—Ä–æ–≤–∞ –∑–æ–Ω–∞: –ö–∞—Ä—Ç–∞ (–ª—ñ–≤–æ—Ä—É—á) —ñ –ö–æ–º–∞–Ω–¥–∏ (–ø—Ä–∞–≤–æ—Ä—É—á) –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ -->
        <div class="game-area grid grid-cols-1 md:grid-cols-[1.2fr_1fr] gap-4 md:gap-6">
            
            <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ (–ö–∞—Ä—Ç–∞) -->
            <div class="grid-container bg-gray-100 rounded-2xl p-3 md:p-4 shadow-inner">
                <h3 class="font-display text-2xl text-center text-indigo-600 mb-3">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥</h3>
                <div class="grid grid-cols-6 gap-0.5 md:gap-1 mb-3 max-w-md mx-auto" id="grid">
                    <!-- JS –≥–µ–Ω–µ—Ä—É—î –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Ç—É—Ç -->
                </div>
                <div class="legend grid grid-cols-2 sm:grid-cols-3 gap-2 text-xs md:text-sm">
                    <div class="legend-item flex items-center gap-1.5 bg-white p-1.5 rounded-md shadow-sm">ü¶∏ –ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ</div>
                    <div class="legend-item flex items-center gap-1.5 bg-white p-1.5 rounded-md shadow-sm">üíÄ –ú–æ–Ω—Å—Ç—Ä</div>
                    <div class="legend-item flex items-center gap-1.5 bg-white p-1.5 rounded-md shadow-sm">‚öîÔ∏è –ó–±—Ä–æ—è</div>
                    <div class="legend-item flex items-center gap-1.5 bg-white p-1.5 rounded-md shadow-sm">üõ°Ô∏è –ë—Ä–æ–Ω—è</div>
                    <div class="legend-item flex items-center gap-1.5 bg-white p-1.5 rounded-md shadow-sm">üß™ –ó—ñ–ª–ª—è</div>
                    <div class="legend-item flex items-center gap-1.5 bg-white p-1.5 rounded-md shadow-sm">üå≤ –ü–µ—Ä–µ—à–∫–æ–¥–∞</div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ (–ö–æ–º–∞–Ω–¥–∏) -->
            <div class="commands-area bg-gray-100 rounded-2xl p-3 md:p-4 shadow-inner flex flex-col">
                <h3 class="font-display text-2xl text-center text-indigo-600 mb-3">üìú –¢–≤–æ—ó –ö–æ–º–∞–Ω–¥–∏</h3>
                
                <!-- –ö–Ω–æ–ø–∫–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥ -->
                <div class="command-buttons grid grid-cols-2 gap-3 mb-4">
                    <button class="cmd-btn btn-3d font-display text-white rounded-xl p-3 text-base md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level" onclick="game.addMove('up')" id="btnUp">
                        <i class="fas fa-arrow-up mr-2"></i>–í–≥–æ—Ä—É
                    </button>
                    <button class="cmd-btn btn-3d font-display text-white rounded-xl p-3 text-base md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level" onclick="game.addMove('down')" id="btnDown">
                        <i class="fas fa-arrow-down mr-2"></i>–í–Ω–∏–∑
                    </button>
                    <button class="cmd-btn btn-3d font-display text-white rounded-xl p-3 text-base md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level" onclick="game.addMove('left')" id="btnLeft">
                        <i class="fas fa-arrow-left mr-2"></i>–õ—ñ–≤–æ—Ä—É—á
                    </button>
                    <button class="cmd-btn btn-3d font-display text-white rounded-xl p-3 text-base md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level" onclick="game.addMove('right')" id="btnRight">
                        <i class="fas fa-arrow-right mr-2"></i>–ü—Ä–∞–≤–æ—Ä—É—á
                    </button>
                    <button class="cmd-btn btn-3d loop-btn font-display text-white rounded-xl p-3 text-base md:text-lg col-span-2 bg-yellow-500 [--shadow-color:theme(colors.yellow.700)] hover:bg-yellow-400 hidden-by-level" onclick="game.addLoop()" id="btnLoop">
                        <i class="fas fa-redo mr-2"></i>–ü–æ—á–∞—Ç–∏ –¶–∏–∫–ª
                    </button>
                    <button class="cmd-btn btn-3d font-display text-white rounded-xl p-3 text-base md:text-lg col-span-2 hidden-by-level" onclick="game.addToRoot()" id="btnRoot">
                        <i class="fas fa-sign-out-alt mr-2"></i>–í–∏–π—Ç–∏ –∑ —Ü–∏–∫–ª—É
                    </button>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –∞–ª–≥–æ—Ä–∏—Ç–º—É -->
                <h3 class="font-display text-xl text-center text-indigo-600 mb-2">üíª –¢–≤—ñ–π –∞–ª–≥–æ—Ä–∏—Ç–º:</h3>
                <div class="command-list bg-white border-2 border-indigo-200 rounded-lg p-2 min-h-[150px] max-h-[400px] overflow-y-auto mb-4 flex-grow" id="commandList">
                    <p class="text-gray-400 text-center p-4">–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏</p>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ä—Ç" / "–û—á–∏—Å—Ç–∏—Ç–∏" -->
                <div class="control-buttons grid grid-cols-2 md:flex gap-3">
                    <button class="control-btn btn-3d font-display text-white rounded-xl p-3 text-lg md:text-xl md:flex-1 bg-green-500 [--shadow-color:theme(colors.green.700)] hover:bg-green-400" onclick="game.run()" id="btnRun">
                        <i class="fas fa-play mr-2"></i>–°—Ç–∞—Ä—Ç
                    </button>
                    <button class="control-btn btn-3d font-display text-white rounded-xl p-3 text-lg md:text-xl md:flex-1 bg-red-500 [--shadow-color:theme(colors.red.700)] hover:bg-red-400" onclick="game.clear()" id="btnClear">
                        <i class="fas fa-trash mr-2"></i>–û—á–∏—Å—Ç–∏—Ç–∏
                    </button>
                </div>
            </div>
        </div>

        <!-- –°—Ü–µ–Ω–∞ –±–æ—é (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∞) -->
        <div class="battle-scene hidden bg-gradient-to-br from-gray-800 to-black text-white rounded-2xl p-4 mt-4 md:mt-6" id="battleScene">
            <h2 class="font-display text-3xl text-center text-yellow-400 mb-4">üí• –ë–Ü–ô! üí•</h2>
            <div class="battle-characters flex justify-around items-center flex-wrap gap-4 mb-4">
                <div class="character text-center w-36">
                    <!-- –û–Ω–æ–≤–ª–µ–Ω–æ —ñ–∫–æ–Ω–∫—É –õ–∏—Ü–∞—Ä—è -->
                    <div class="character-icon text-6xl md:text-7xl">ü¶∏</div>
                    <div class="font-bold text-lg"><strong>–ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ</strong></div>
                    <div class="text-sm">‚ù§Ô∏è <span id="heroHealthText">100</span></div>
                    <div class="health-bar bg-gray-600 h-5 rounded-full overflow-hidden mt-1 shadow-inner">
                        <div class="health-fill hero-health h-full rounded-full bg-gradient-to-r from-green-400 to-green-600 transition-all duration-500" id="heroHealthBar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="text-4xl md:text-5xl font-display text-yellow-400">‚ö°</div>
                <div class="character text-center w-36">
                    <div class="character-icon text-6xl md:text-7xl" id="monsterIcon">üíÄ</div>
                    <div class="font-bold text-lg"><strong id="monsterName">–ú–æ–Ω—Å—Ç—Ä</strong></div>
                    <div class="text-sm">‚ù§Ô∏è <span id="monsterHealthText">50</span></div>
                    <div class="health-bar bg-gray-600 h-5 rounded-full overflow-hidden mt-1 shadow-inner">
                        <div class="health-fill h-full rounded-full bg-gradient-to-r from-red-400 to-red-600 transition-all duration-500" id="monsterHealthBar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            <div class="battle-log bg-white/10 rounded-lg p-3 min-h-[100px] max-h-[200px] overflow-y-auto text-sm text-left font-mono" id="battleLog"></div>
        </div>

        <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–£—Å–ø—ñ—Ö/–ü–æ–º–∏–ª–∫–∞) -->
        <div class="message hidden text-center p-3 rounded-lg mt-4 md:mt-6 text-base md:text-lg font-bold" id="message"></div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å" (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∞) -->
        <div class="mt-4 md:mt-6">
            <!-- –ó–º—ñ–Ω–µ–Ω–æ: –í–∏–¥–∞–ª–µ–Ω–æ –∫–ª–∞—Å "control-buttons", –¥–æ–¥–∞–Ω–æ "flex justify-center" -->
            <div class="flex justify-center">
                <!-- –ó–º—ñ–Ω–µ–Ω–æ: –í–∏–¥–∞–ª–µ–Ω–æ –∫–ª–∞—Å "next-btn", –¥–æ–¥–∞–Ω–æ "w-full max-w-xs" –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è -->
                <button class="control-btn btn-3d hidden font-display text-gray-800 rounded-xl p-3 text-lg md:text-xl bg-yellow-400 [--shadow-color:theme(colors.yellow.600)] hover:bg-yellow-300 w-full max-w-xs" id="nextBtn" onclick="game.nextLevel()">
                    <i class="fas fa-forward mr-2"></i>–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å
                </button>
            </div>
        </div>
    </div>

    <!-- ===== –ù–û–í–ò–ô –ï–õ–ï–ú–ï–ù–¢: –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ç—É—Ç–æ—Ä—ñ–∞–ª—É ===== -->
    <div id="tutorialModalBackdrop" class="fixed inset-0 bg-black/60 z-40 hidden"></div>
    <div id="tutorialModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-5 md:p-6 rounded-2xl shadow-2xl z-50 w-11/12 max-w-md hidden">
        <h2 class="font-display text-3xl text-yellow-500 text-center mb-4">üîÅ –ù–æ–≤–∞ –°–∏–ª–∞: –¶–ò–ö–õ–ò! üîÅ</h2>
        <p class="text-gray-700 mb-4 text-center">–¶–∏–∫–ª–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤. –¶–µ –µ–∫–æ–Ω–æ–º–∏—Ç—å –±–ª–æ–∫–∏!</p>
        <div class="bg-gray-100 rounded-lg p-3 mb-5 text-gray-800">
            <p class="font-medium mb-1">1. –ù–∞—Ç–∏—Å–Ω–∏ <strong class="text-yellow-600">"–ü–æ—á–∞—Ç–∏ –¶–∏–∫–ª"</strong>.</p>
            <p class="font-medium mb-1">2. –î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏, —è–∫—ñ —Ö–æ—á–µ—à –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏.</p>
            <p class="font-medium">3. –ù–∞—Ç–∏—Å–Ω–∏ <strong class="text-red-500">"–í–∏–π—Ç–∏ –∑ —Ü–∏–∫–ª—É"</strong>.</p>
        </div>
        <!-- –í–ò–ü–†–ê–í–õ–ï–ù–û: "class_name" –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ "class" -->
        <button class="btn-3d w-full font-display text-white rounded-xl p-3 text-lg bg-green-500 [--shadow-color:theme(colors.green.700)] hover:bg-green-400" onclick="game.hideTutorialModal()">
            –ó—Ä–æ–∑—É–º—ñ–ª–æ!
        </button>
    </div>
    <!-- =============================================== -->


    <script>
        const GAME_CONFIG = {
            baseDamage: 20,
            baseArmor: 8,
            potionHealth: 25,
            animationDelay: 300
        };

        // ===== –ù–û–í–ò–ô –ú–ê–°–ò–í –†–Ü–í–ù–Ü–í (–ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–µ —É—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è) =====
        const levels = [
            // --- –†—ñ–≤–µ–Ω—å 1: –¢—ñ–ª—å–∫–∏ "–ü—Ä–∞–≤–æ—Ä—É—á" ---
            {
                size: 6,
                hero: [2, 0], // –ì–µ—Ä–æ–π –ø–æ —Ü–µ–Ω—Ç—Ä—É –∑–ª—ñ–≤–∞
                monster: [2, 5], // –ú–æ–Ω—Å—Ç—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–ø—Ä–∞–≤–∞
                items: { weapons: [], armor: [], potions: [] }, // –ù–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                monsterStats: { health: 10, damage: 0, name: "–û–ø—É–¥–∞–ª–æ", icon: "üëª" },
                obstacles: [], // –ù–µ–º–∞—î –ø–µ—Ä–µ—à–∫–æ–¥
                desc: "–î—ñ–π–¥–∏ –¥–æ –û–ø—É–¥–∞–ª–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ª–∏—à–µ –∫–Ω–æ–ø–∫—É '–ü—Ä–∞–≤–æ—Ä—É—á'!",
                par: { gold: 5, silver: 5 } // –ü–æ—Ç—Ä—ñ–±–Ω–æ 5 –∫—Ä–æ–∫—ñ–≤
            },
            // --- –†—ñ–≤–µ–Ω—å 2: –£—Å—ñ –Ω–∞–ø—Ä—è–º–∫–∏ + –ü–µ—Ä–µ—à–∫–æ–¥–∏ ---
            {
                size: 6,
                hero: [5, 0],
                monster: [0, 5],
                items: { weapons: [], armor: [], potions: [] },
                monsterStats: { health: 20, damage: 5, name: "–ì–æ–±–ª—ñ–Ω", icon: "üíÄ" },
                obstacles: [[3, 1], [3, 2], [3, 3], [2, 3], [2, 4], [2, 5]],
                desc: "–û–±—ñ–π–¥–∏ –ø–µ—Ä–µ—à–∫–æ–¥–∏, —â–æ–± –¥—ñ—Å—Ç–∞—Ç–∏—Å—è –¥–æ –ì–æ–±–ª—ñ–Ω–∞!",
                par: { gold: 10, silver: 12 }
            },
            // --- –†—ñ–≤–µ–Ω—å 3: –î–æ–¥–∞–Ω–æ –ó–±—Ä–æ—é —Ç–∞ –ë—Ä–æ–Ω—é ---
            {
                size: 6,
                hero: [5, 0],
                monster: [0, 5],
                items: {
                    weapons: [[3, 2]],
                    armor: [[2, 4]],
                    potions: []
                },
                monsterStats: { health: 50, damage: 12, name: "–û—Ä–∫", icon: "üëπ" },
                obstacles: [[4, 1], [4, 2], [1, 3], [1, 4]],
                desc: "–ó–±–µ—Ä–∏ –∑–±—Ä–æ—é (‚öîÔ∏è) —Ç–∞ –±—Ä–æ–Ω—é (üõ°Ô∏è) –Ω–∞ —à–ª—è—Ö—É –¥–æ –û—Ä–∫–∞!",
                par: { gold: 12, silver: 15 }
            },
            // --- –†—ñ–≤–µ–Ω—å 4: –î–æ–¥–∞–Ω–æ –ó—ñ–ª–ª—è ---
            {
                size: 6,
                hero: [5, 0],
                monster: [0, 5],
                items: {
                    weapons: [[4, 1], [1, 4]],
                    armor: [[2, 3]],
                    potions: [[3, 4]]
                },
                monsterStats: { health: 80, damage: 18, name: "–¢—Ä–æ–ª—å", icon: "üëø" },
                obstacles: [[1, 1], [1, 2], [3, 3], [4, 2]],
                desc: "–ó–±–µ—Ä–∏ –≤—Å–µ —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è, –≤–∫–ª—é—á–Ω–æ –∑ –∑—ñ–ª–ª—è–º (üß™)!",
                par: { gold: 14, silver: 18 }
            },
            // --- –†—ñ–≤–µ–Ω—å 5: –í–≤–µ–¥–µ–Ω–Ω—è –¶–∏–∫–ª—ñ–≤ ---
            {
                size: 6,
                hero: [5, 0],
                monster: [5, 5],
                items: {
                    weapons: [[5, 2]],
                    armor: [[5, 3]],
                    potions: [[5, 4]]
                },
                monsterStats: { health: 50, damage: 10, name: "–°–∫–µ–ª–µ—Ç", icon: "üíÄ" },
                obstacles: [[4, 0], [4, 1], [4, 2], [4, 3], [4, 4], [4, 5]], // –°—Ç—ñ–Ω–∞
                desc: "–ù–æ–≤–∞ –º–µ—Ö–∞–Ω—ñ–∫–∞! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –¶–ò–ö–õ–ò, —â–æ–± –ø—Ä–æ–π—Ç–∏!",
                par: { gold: 5, silver: 8 } // –ù–∞–ø—Ä: –í–ø—Ä–∞–≤–æ, –¶–∏–∫–ª(3) [–í–ø—Ä–∞–≤–æ], –í–ø—Ä–∞–≤–æ.
            },
            // --- –†—ñ–≤–µ–Ω—å 6: –°–∫–ª–∞–¥–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –∑ —Ü–∏–∫–ª–∞–º–∏ ---
            {
                size: 6,
                hero: [5, 0],
                monster: [0, 5],
                items: {
                    weapons: [[4, 0], [3, 1], [2, 2], [1, 3]],
                    armor: [[0, 4]],
                    potions: [[5, 2], [5, 3]]
                },
                monsterStats: { health: 120, damage: 25, name: "–î—Ä–∞–∫–æ–Ω", icon: "üêâ" },
                obstacles: [[4, 1], [4, 2], [4, 3], [4, 4], [2, 1], [2, 3], [2, 4], [0, 1], [1, 1]],
                desc: "–§—ñ–Ω–∞–ª—å–Ω–∏–π –≤–∏–∫–ª–∏–∫! –û–ø—Ç–∏–º—ñ–∑—É–π —Å–≤—ñ–π —à–ª—è—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü–∏–∫–ª—ñ–≤.",
                par: { gold: 10, silver: 15 }
            }
        ];
        // ========================================================


        // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —ñ–≥—Ä–æ–≤–∏–π –æ–±'—î–∫—Ç
        const game = {
            currentLevel: 0,
            heroPos: [5, 0],
            commands: [],
            currentContext: null, 
            nextId: 0,
            isRunning: false,
            playerStats: { damage: 0, armor: 0, health: 100 },
            collectedItems: new Set(),
            tutorialShown: false, // –ù–û–í–ò–ô –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –¥–ª—è —Ç—É—Ç–æ—Ä—ñ–∞–ª—É

            init() {
                const level = levels[this.currentLevel];
                this.heroPos = [...level.hero];
                this.commands = [];
                this.currentContext = null; 
                this.nextId = 0;
                this.playerStats = { damage: 0, armor: 0, health: 100 };
                this.collectedItems.clear();
                
                document.getElementById('levelNum').textContent = this.currentLevel + 1;
                document.getElementById('levelDesc').textContent = level.desc;
                document.getElementById('parGold').textContent = level.par.gold;
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('message').className = 'message hidden'; 
                document.getElementById('battleScene').classList.add('hidden');
                // –î–æ–¥–∞–Ω–æ: –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è, —â–æ —ñ–≥—Ä–æ–≤–∞ –∑–æ–Ω–∞ –≤–∏–¥–∏–º–∞ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                document.querySelector('.game-area').classList.remove('hidden');
                
                // –û–Ω–æ–≤–ª–µ–Ω–æ —ñ–∫–æ–Ω–∫—É –õ–∏—Ü–∞—Ä—è –≤ —Å—Ü–µ–Ω—ñ –±–æ—é
                document.querySelector('.battle-characters .character-icon').innerHTML = 'ü¶∏';

                this.updateStats();
                this.renderGrid();
                this.renderCommands();
                this.setButtonsState(false);
                this.updateContextButton();
                this.updateButtonVisibility(); // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –∫–µ—Ä—É—î –≤–∏–¥–∏–º—ñ—Å—Ç—é –∫–Ω–æ–ø–æ–∫
                
                // –ù–û–í–ê –õ–û–ì–Ü–ö–ê: –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—É—Ç–æ—Ä—ñ–∞–ª –Ω–∞ 5-–º—É —Ä—ñ–≤–Ω—ñ (—ñ–Ω–¥–µ–∫—Å 4)
                if (this.currentLevel === 4 && !this.tutorialShown) {
                    this.showTutorialModal();
                    this.tutorialShown = true;
                }
            },

            // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ö–µ—Ä—É—î –≤–∏–¥–∏–º—ñ—Å—Ç—é –∫–Ω–æ–ø–æ–∫ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä—ñ–≤–Ω—è
            updateButtonVisibility() {
                const levelIndex = this.currentLevel;
                
                const btnUp = document.getElementById('btnUp');
                const btnDown = document.getElementById('btnDown');
                const btnLeft = document.getElementById('btnLeft');
                const btnRight = document.getElementById('btnRight');
                const btnLoop = document.getElementById('btnLoop');
                const btnRoot = document.getElementById('btnRoot');

                // –°–ø–µ—Ä—à—É —Ö–æ–≤–∞—î–º–æ –≤—Å—ñ, —â–æ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ
                btnUp.classList.add('hidden-by-level');
                btnDown.classList.add('hidden-by-level');
                btnLeft.classList.add('hidden-by-level');
                btnRight.classList.add('hidden-by-level');
                btnLoop.classList.add('hidden-by-level');
                btnRoot.classList.add('hidden-by-level');

                if (levelIndex === 0) {
                    // –†—ñ–≤–µ–Ω—å 1: –¢—ñ–ª—å–∫–∏ "–ü—Ä–∞–≤–æ—Ä—É—á"
                    btnRight.classList.remove('hidden-by-level');
                } else if (levelIndex >= 1) {
                    // –†—ñ–≤–µ–Ω—å 2+: –£—Å—ñ –Ω–∞–ø—Ä—è–º–∫–∏
                    btnUp.classList.remove('hidden-by-level');
                    btnDown.classList.remove('hidden-by-level');
                    btnLeft.classList.remove('hidden-by-level');
                    btnRight.classList.remove('hidden-by-level');
                }
                
                if (levelIndex >= 4) {
                    // –†—ñ–≤–µ–Ω—å 5+: –î–æ–¥–∞—î–º–æ –¶–∏–∫–ª–∏
                    btnLoop.classList.remove('hidden-by-level');
                    btnRoot.classList.remove('hidden-by-level');
                }
            },

            // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
            showTutorialModal() {
                document.getElementById('tutorialModalBackdrop').classList.remove('hidden');
                document.getElementById('tutorialModal').classList.remove('hidden');
            },

            // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ü—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
            hideTutorialModal() {
                document.getElementById('tutorialModalBackdrop').classList.add('hidden');
                document.getElementById('tutorialModal').classList.add('hidden');
            },

            setButtonsState(disabled) {
                ['btnUp', 'btnDown', 'btnLeft', 'btnRight', 'btnRun', 'btnClear', 'btnLoop', 'btnRoot'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = disabled;
                });
                 document.querySelectorAll('.command-list input, .command-list button').forEach(el => {
                    el.disabled = disabled;
                });
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–∫–∏ "–í–∏–π—Ç–∏ –∑ —Ü–∏–∫–ª—É" –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—Å–µ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
                this.updateContextButton(disabled); 
            },

            updateStats() {
                document.getElementById('damage').textContent = this.playerStats.damage;
                document.getElementById('armor').textContent = this.playerStats.armor;
                document.getElementById('health').textContent = this.playerStats.health;
            },

            renderGrid() {
                const level = levels[this.currentLevel];
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                
                for (let row = 0; row < level.size; row++) {
                    for (let col = 0; col < level.size; col++) {
                        const cell = document.createElement('div');
                        let classes = 'cell aspect-square flex items-center justify-center text-2xl md:text-3xl rounded border-2';
                        const posKey = `${row},${col}`;
                        
                        if (row === this.heroPos[0] && col === this.heroPos[1]) {
                            classes += ' bg-blue-200 border-blue-500 shadow-lg z-10'; 
                            cell.innerHTML = 'ü¶∏';
                        } else if (row === level.monster[0] && col === level.monster[1]) {
                            classes += ' bg-red-200 border-red-500 monster-pulse'; 
                            cell.innerHTML = level.monsterStats.icon;
                        } else if (level.obstacles.some(o => o[0] === row && o[1] === col)) {
                            classes += ' bg-gray-600 border-gray-800'; 
                            cell.innerHTML = 'üå≤';
                        } else if (level.items.weapons.some(w => w[0] === row && w[1] === col)) {
                            classes += ' bg-green-100 border-green-300'; 
                            cell.innerHTML = '‚öîÔ∏è';
                            if (this.collectedItems.has(posKey)) classes += ' opacity-30';
                        } else if (level.items.armor.some(a => a[0] === row && a[1] === col)) {
                            classes += ' bg-green-100 border-green-300';
                            cell.innerHTML = 'üõ°Ô∏è';
                            if (this.collectedItems.has(posKey)) classes += ' opacity-30';
                        } else if (level.items.potions.some(p => p[0] === row && p[1] === col)) {
                            classes += ' bg-green-100 border-green-300';
                            cell.innerHTML = 'üß™';
                            if (this.collectedItems.has(posKey)) classes += ' opacity-30';
                        } else {
                            classes += ' bg-green-100 border-green-300'; // empty
                        }
                        
                        cell.className = classes;
                        grid.appendChild(cell);
                    }
                }
            },

            addMove(direction) {
                if (this.isRunning) return;
                const targetList = this.currentContext || this.commands;
                targetList.push({ 
                    type: 'move', 
                    direction,
                    id: this.nextId++
                });
                this.renderCommands();
            },

            addLoop() {
                if (this.isRunning) return;
                const targetList = this.currentContext || this.commands;
                const newLoop = { 
                    type: 'loop', 
                    count: 2,
                    children: [],
                    id: this.nextId++
                };
                targetList.push(newLoop);
                this.currentContext = newLoop.children;
                this.renderCommands();
                this.updateContextButton();
            },

            addToRoot() {
                if (this.isRunning) return;
                this.currentContext = null;
                this.renderCommands();
                this.updateContextButton();
            },

            updateContextButton(gameIsRunning = false) {
                const btn = document.getElementById('btnRoot');
                if (gameIsRunning) {
                    btn.disabled = true;
                    return;
                }
                
                if (this.currentContext) {
                    btn.disabled = false;
                    btn.classList.add('bg-red-500', '[--shadow-color:theme(colors.red.700)]', 'hover:bg-red-400');
                    btn.classList.remove('bg-gray-400', '[--shadow-color:theme(colors.gray.600)]', 'opacity-60', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.remove('bg-red-500', '[--shadow-color:theme(colors.red.700)]', 'hover:bg-red-400');
                    btn.classList.add('bg-gray-400', '[--shadow-color:theme(colors.gray.600)]', 'opacity-60', 'cursor-not-allowed');
                }
            },

            findCommandById(id, list = this.commands) {
                for (let i = 0; i < list.length; i++) {
                    if (list[i].id === id) {
                        return { parent: list, index: i, cmd: list[i] };
                    }
                    if (list[i].type === 'loop') {
                        const found = this.findCommandById(id, list[i].children);
                        if (found) return found;
                    }
                }
                return null;
            },

            removeCommand(id) {
                if (this.isRunning) return;
                const found = this.findCommandById(id);
                if (found) {
                    if (found.cmd.type === 'loop' && this.currentContext === found.cmd.children) {
                        this.currentContext = null; 
                        this.updateContextButton();
                    }
                    found.parent.splice(found.index, 1);
                    this.renderCommands();
                }
            },

            updateLoopCount(id, value) {
                if (this.isRunning) return;
                const found = this.findCommandById(id);
                if (found && found.cmd.type === 'loop') {
                    found.cmd.count = Math.max(1, Math.min(10, parseInt(value) || 1));
                }
            },

            moveCommand(id, direction) {
                if (this.isRunning) return;
                const found = this.findCommandById(id);
                if (!found) return;
                
                const { parent, index } = found;
                const newIndex = direction === 'up' ? index - 1 : index + 1;
                
                if (newIndex < 0 || newIndex >= parent.length) return;
                
                [parent[index], parent[newIndex]] = [parent[newIndex], parent[index]];
                this.renderCommands();
            },

            renderCommands() {
                const listEl = document.getElementById('commandList');
                listEl.innerHTML = '';

                if (this.commands.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-400 text-center p-4">–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏</p>';
                    return;
                }

                this.renderCommandList(this.commands, listEl, 0);
            },

            renderCommandList(list, container, nestLevel) {
                list.forEach((cmd, index) => {
                    const item = document.createElement('div');
                    item.className = 'command-item slide-in flex justify-between items-center p-2.5 rounded-lg gap-2 mb-2'; // –î–æ–¥–∞–≤ mb-2
                    if (nestLevel > 0) item.classList.add('nested', 'ml-5');
                    
                    // –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–ø–µ—Ä –ø—ñ–¥—Å–≤—ñ—á—É—î —Ñ–æ–Ω –≤—Å—å–æ–≥–æ —Å–ø–∏—Å–∫—É, –∞ –Ω–µ –æ–∫—Ä–µ–º—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
                    // if (this.currentContext === list) {
                    //     item.classList.add('bg-yellow-100', 'border-l-yellow-400');
                    // }
                    
                    if (cmd.type === 'move') {
                        const emoji = { up: '<i class="fas fa-arrow-up"></i>', down: '<i class="fas fa-arrow-down"></i>', left: '<i class="fas fa-arrow-left"></i>', right: '<i class="fas fa-arrow-right"></i>' }[cmd.direction];
                        const name = { up: '–í–≥–æ—Ä—É', down: '–í–Ω–∏–∑', left: '–õ—ñ–≤–æ—Ä—É—á', right: '–ü—Ä–∞–≤–æ—Ä—É—á' }[cmd.direction];
                        item.classList.add('bg-indigo-100', 'border-l-4', 'border-indigo-400'); // –ó—Ä–æ–±–∏–≤ border-l-4
                        
                        item.innerHTML = `
                            <div class="command-text font-medium text-gray-800 flex items-center gap-2">
                                <span class="text-xl">${emoji}</span>
                                <span>${name}</span>
                            </div>
                            <div class="flex gap-1.5 flex-shrink-0">
                                <button class="btn-sort remove-btn p-1 rounded-md text-xs text-white ${index === 0 ? 'opacity-0 cursor-default' : ''}" onclick="game.moveCommand(${cmd.id}, 'up')" style="--shadow-color:theme(colors.green.700); background: #4CAF50;" ${index === 0 ? 'disabled' : ''}><i class="fas fa-chevron-up"></i></button>
                                <button class="btn-sort remove-btn p-1 rounded-md text-xs text-white ${index === list.length - 1 ? 'opacity-0 cursor-default' : ''}" onclick="game.moveCommand(${cmd.id}, 'down')" style="--shadow-color:theme(colors.green.700); background: #4CAF50;" ${index === list.length - 1 ? 'disabled' : ''}><i class="fas fa-chevron-down"></i></button>
                                <button class="btn-sort remove-btn p-1 rounded-md text-xs text-white" onclick="game.removeCommand(${cmd.id})" style="--shadow-color:theme(colors.red.700); background: #f44336;"><i class="fas fa-times"></i></button>
                            </div>
                        `;
                    } else if (cmd.type === 'loop') {
                        item.classList.add('loop-item', 'bg-yellow-100', 'border-l-4', 'border-yellow-500'); // –ó—Ä–æ–±–∏–≤ border-l-4
                        item.innerHTML = `
                            <div class="command-text font-medium text-gray-800 flex items-center gap-2 flex-wrap">
                                <span class="text-xl"><i class="fas fa-redo"></i></span>
                                <span>–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏</span>
                                <input type="number" 
                                       class="loop-input w-12 p-1 rounded-md border-2 border-yellow-400 text-center font-bold" 
                                       value="${cmd.count}" 
                                       min="1" max="10"
                                       onchange="game.updateLoopCount(${cmd.id}, this.value)"
                                       onclick="event.stopPropagation()">
                                <span>—Ä–∞–∑—ñ–≤:</span>
                            </div>
                            <div class="flex gap-1.5 flex-shrink-0">
                                <button class="btn-sort remove-btn p-1 rounded-md text-xs text-white ${index === 0 ? 'opacity-0 cursor-default' : ''}" onclick="game.moveCommand(${cmd.id}, 'up')" style="--shadow-color:theme(colors.green.700); background: #4CAF50;" ${index === 0 ? 'disabled' : ''}><i class="fas fa-chevron-up"></i></button>
                                <button class="btn-sort remove-btn p-1 rounded-md text-xs text-white ${index === list.length - 1 ? 'opacity-0 cursor-default' : ''}" onclick="game.moveCommand(${cmd.id}, 'down')" style="--shadow-color:theme(colors.green.700); background: #4CAF50;" ${index === list.length - 1 ? 'disabled' : ''}><i class="fas fa-chevron-down"></i></button>
                                <button class="btn-sort remove-btn p-1 rounded-md text-xs text-white" onclick="game.removeCommand(${cmd.id})" style="--shadow-color:theme(colors.red.700); background: #f44336;"><i class="fas fa-times"></i></button>
                            </div>
                        `;
                        container.appendChild(item);
                        
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
                        const childrenContainer = document.createElement('div');
                        childrenContainer.className = 'nested-container ml-5 pl-3 border-l-2 border-yellow-500/50';
                        
                        if (cmd.children.length > 0) {
                            this.renderCommandList(cmd.children, childrenContainer, nestLevel + 1);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'command-item bg-yellow-50/50 opacity-70 p-2.5 rounded-lg mb-2'; // –î–æ–¥–∞–≤ mb-2
                            placeholder.innerHTML = `
                                <div class="command-text italic text-gray-500">
                                    <span><em>–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏ –≤ —Ü–∏–∫–ª</em></span>
                                </div>
                            `;
                            childrenContainer.appendChild(placeholder);
                        }
                        container.appendChild(childrenContainer);

                        // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                        if (this.currentContext === cmd.children) {
                            childrenContainer.classList.add('bg-yellow-50');
                            childrenContainer.classList.add('rounded-md');
                        }
                        
                        // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä –∫—ñ–Ω—Ü—è —Ü–∏–∫–ª—É
                        // const endMarker = document.createElement('div');
                        // endMarker.className = 'command-item loop-end nested ml-5 bg-gray-100 border-l-gray-400 p-2.5 rounded-lg';
                        // endMarker.innerHTML = `
                        //     <div class="command-text font-medium text-gray-600 flex items-center gap-2">
                        //         <span>${'  '.repeat(nestLevel)}</span>
                        //         <span class="text-xl">üîö</span>
                        //         <span>–ö—ñ–Ω–µ—Ü—å —Ü–∏–∫–ª—É</span>
                        //     </div>
                        // `;
                        // container.appendChild(endMarker);
                        return;
                    }
                    
                    container.appendChild(item);
                });

                // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ, —è–∫—â–æ root-–∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω–∏–π
                // –í–ò–ü–†–ê–í–õ–ï–ù–û: 'listEl' –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ 'container', –æ—Å–∫—ñ–ª—å–∫–∏ 'listEl' —Ç—É—Ç –Ω–µ —ñ—Å–Ω—É—î
                if (this.currentContext === this.commands) {
                    container.classList.add('bg-yellow-50');
                } else {
                    container.classList.remove('bg-yellow-50');
                }
            },

            clear() {
                if (this.isRunning) return;
                // –î–æ–¥–∞–Ω–æ: –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–≥—Ä–æ–≤—É –∑–æ–Ω—É –ø—Ä–∏ –æ—á–∏—â–µ–Ω–Ω—ñ
                document.querySelector('.game-area').classList.remove('hidden');
                this.init(); 
            },

            async run() {
                if (this.commands.length === 0 || this.isRunning) return;
                
                this.isRunning = true;
                this.setButtonsState(true);
                this.heroPos = [...levels[this.currentLevel].hero];
                this.playerStats = { damage: 0, armor: 0, health: 100 };
                this.collectedItems.clear();
                document.getElementById('message').className = 'message hidden';
                document.getElementById('battleScene').classList.add('hidden');
                
                this.renderGrid();
                this.updateStats();
                
                await this.executeCommands(this.commands);
                
                const level = levels[this.currentLevel];
                if (this.heroPos[0] === level.monster[0] && this.heroPos[1] === level.monster[1]) {
                    await this.startBattle();
                } else {
                    this.showMessage('error', 'üòî –¢–∏ –Ω–µ –¥—ñ–π—à–æ–≤ –¥–æ –º–æ–Ω—Å—Ç—Ä–∞! –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.');
                }
                
                this.isRunning = false;
                this.setButtonsState(false);
            },

            async executeCommands(list) {
                const level = levels[this.currentLevel];
                
                for (const cmd of list) {
                    if (!this.isRunning) return; 

                    if (cmd.type === 'move') {
                        const prevPos = [...this.heroPos];
                        
                        switch(cmd.direction) {
                            case 'up': this.heroPos[0] = Math.max(0, this.heroPos[0] - 1); break;
                            case 'down': this.heroPos[0] = Math.min(level.size - 1, this.heroPos[0] + 1); break;
                            case 'left': this.heroPos[1] = Math.max(0, this.heroPos[1] - 1); break;
                            case 'right': this.heroPos[1] = Math.min(level.size - 1, this.heroPos[1] + 1); break;
                        }

                        const isObstacle = level.obstacles.some(o => o[0] === this.heroPos[0] && o[1] === this.heroPos[1]);
                        
                        if (isObstacle) {
                            this.heroPos = [...prevPos];
                        } else {
                            const posKey = `${this.heroPos[0]},${this.heroPos[1]}`;
                            if (!this.collectedItems.has(posKey)) {
                                if (level.items.weapons.some(w => w[0] === this.heroPos[0] && w[1] === this.heroPos[1])) {
                                    this.playerStats.damage += GAME_CONFIG.baseDamage;
                                    this.collectedItems.add(posKey);
                                } else if (level.items.armor.some(a => a[0] === this.heroPos[0] && a[1] === this.heroPos[1])) {
                                    this.playerStats.armor += GAME_CONFIG.baseArmor;
                                    this.collectedItems.add(posKey);
                                } else if (level.items.potions.some(p => p[0] === this.heroPos[0] && p[1] === this.heroPos[1])) {
                                    this.playerStats.health = Math.min(100, this.playerStats.health + GAME_CONFIG.potionHealth);
                                    this.collectedItems.add(posKey);
                                }
                            }
                        }
                        
                        this.updateStats();
                        this.renderGrid();
                        await new Promise(resolve => setTimeout(resolve, GAME_CONFIG.animationDelay));
                        
                    } else if (cmd.type === 'loop') {
                        for (let i = 0; i < cmd.count; i++) {
                            if (!this.isRunning) return; 
                            await this.executeCommands(cmd.children);
                        }
                    }
                }
            },

            countBlocks(list = this.commands) {
                let count = 0;
                for (const cmd of list) {
                    count++;
                    if (cmd.type === 'loop') {
                        count += this.countBlocks(cmd.children);
                    }
                }
                return count;
            },

            async startBattle() {
                const level = levels[this.currentLevel];
                const monster = level.monsterStats;
                
                // –î–æ–¥–∞–Ω–æ: –•–æ–≤–∞—î–º–æ —ñ–≥—Ä–æ–≤—É –∑–æ–Ω—É –ø—ñ–¥ —á–∞—Å –±–æ—é
                document.querySelector('.game-area').classList.add('hidden');
                document.getElementById('battleScene').classList.remove('hidden');
                document.getElementById('monsterIcon').innerHTML = monster.icon;
                document.getElementById('monsterName').textContent = monster.name;
                
                let heroHealth = this.playerStats.health;
                let monsterHealth = monster.health;
                
                document.getElementById('heroHealthText').textContent = heroHealth;
                document.getElementById('monsterHealthText').textContent = monsterHealth;
                document.getElementById('heroHealthBar').style.width = '100%';
                document.getElementById('monsterHealthBar').style.width = '100%';
                
                const log = document.getElementById('battleLog');
                log.innerHTML = '';
                
                const addLog = (text) => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    entry.textContent = text;
                    log.appendChild(entry);
                    log.scrollTop = log.scrollHeight;
                };
                
                addLog('‚öîÔ∏è –ë—ñ–π —Ä–æ–∑–ø–æ—á–∞–≤—Å—è!');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                let roundNum = 1;
                while (heroHealth > 0 && monsterHealth > 0) {
                    addLog(`--- –†–∞—É–Ω–¥ ${roundNum} ---`);
                    
                    const heroDamage = Math.max(5, this.playerStats.damage);
                    monsterHealth = Math.max(0, monsterHealth - heroDamage);
                    addLog(`üó°Ô∏è –ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ –∞—Ç–∞–∫—É—î! –ó–∞–≤–¥–∞–Ω–æ ${heroDamage} —É—Ä–æ–Ω—É.`);
                    document.getElementById('monsterHealthText').textContent = monsterHealth;
                    document.getElementById('monsterHealthBar').style.width = `${(monsterHealth / monster.health) * 100}%`;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    if (monsterHealth <= 0) break;
                    
                    const actualDamage = Math.max(0, monster.damage - this.playerStats.armor); // –ú–æ–Ω—Å—Ç—Ä –Ω–∞ L1 –Ω–µ –±'—î
                    heroHealth = Math.max(0, heroHealth - actualDamage);
                    if (actualDamage > 0) {
                        addLog(`üí• ${monster.name} –∞—Ç–∞–∫—É—î! –ó–∞–≤–¥–∞–Ω–æ ${actualDamage} —É—Ä–æ–Ω—É (${this.playerStats.armor} –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ).`);
                    } else {
                         addLog(`üí• ${monster.name} –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∞—Ç–∞–∫—É–≤–∞—Ç–∏, –∞–ª–µ –Ω–µ –∑–∞–≤–¥–∞—î —É—Ä–æ–Ω—É!`);
                    }
                    document.getElementById('heroHealthText').textContent = heroHealth;
                    document.getElementById('heroHealthBar').style.width = `${(heroHealth / this.playerStats.health) * 100}%`;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    roundNum++;
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (heroHealth > 0) {
                    addLog('üéâ –ü–ï–†–ï–ú–û–ì–ê! –ú–æ–Ω—Å—Ç—Ä –ø–µ—Ä–µ–º–æ–∂–µ–Ω–∏–π!');
                    
                    const blockCount = this.countBlocks();
                    const par = level.par;
                    let stars = 'ü•â (–ë—Ä–æ–Ω–∑–∞)';
                    if (blockCount <= par.gold) {
                        stars = 'ü•á (–ó–æ–ª–æ—Ç–æ!)';
                    } else if (blockCount <= par.silver) {
                        stars = 'ü•à (–°—Ä—ñ–±–ª–æ)';
                    }

                    this.showMessage('success', `üéâ –ü–µ—Ä–µ–º–æ–≥–∞! –ë–ª–æ–∫—ñ–≤: ${blockCount}. ${stars}`);
                    document.getElementById('nextBtn').classList.remove('hidden');
                } else {
                    addLog('üíÄ –ü–æ—Ä–∞–∑–∫–∞... –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!');
                    this.showMessage('error', 'üíÄ –ü—Ä–æ–≥—Ä–∞–≤... –°–ø—Ä–æ–±—É–π —ñ–Ω—à—É —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é!');
                }
            },

            showMessage(type, text) {
                const msg = document.getElementById('message');
                msg.textContent = text;
                msg.className = 'message text-center p-3 rounded-lg mt-4 md:mt-6 text-base md:text-lg font-bold';
                if (type === 'success') {
                    msg.classList.add('bg-green-100', 'text-green-800');
                } else {
                    msg.classList.add('bg-red-100', 'text-red-800');
                }
            },

            nextLevel() {
                if (this.currentLevel < levels.length - 1) {
                    this.currentLevel++;
                    this.init();
                } else {
                    this.showMessage('success', 'üèÜ –í—ñ—Ç–∞—é! –¢–∏ –ø—Ä–æ–π—à–æ–≤ —É—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π!');
                    document.getElementById('nextBtn').classList.add('hidden');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // –†–æ–±–∏–º–æ 'game' –≥–ª–æ–±–∞–ª—å–Ω–∏–º, —â–æ–± 'onclick' –≤ HTML –ø—Ä–∞—Ü—é–≤–∞–≤
            window.game = game;
            game.init();
            
            // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –Ω–µ–±–∞–∂–∞–Ω–∏–º –∂–µ—Å—Ç–∞–º –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö
            document.addEventListener('touchstart', function(e) {
                // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –¥–≤—ñ–π–Ω–æ–º—É —Ç–æ—Ä–∫–∞–Ω–Ω—é –¥–ª—è –∑—É–º—É
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('touchend', function(e) {
                // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é –ø—Ä–∏ –¥–æ–≤–≥–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ
                e.preventDefault();
            }, { passive: false });
            
            // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∑—É–º—É –ø—Ä–∏ –¥–≤—ñ–π–Ω–æ–º—É —Ç–æ—Ä–∫–∞–Ω–Ω—ñ
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é –ø—Ä–∏ –¥–æ–≤–≥–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
        });
    </script>
</body>
</html>



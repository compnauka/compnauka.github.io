<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>–ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ ‚Äî –º—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ –∑–≤—É–∫–∏</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = { theme: { extend: { fontFamily: { sans: ['Roboto','-apple-system','BlinkMacSystemFont','Segoe UI','Helvetica','Arial','sans-serif'], display: ['Open Sans','Roboto','sans-serif'] }, screens: { xs: '380px' } } } };
</script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Open+Sans:wght@600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
:root { --transition-ms: 240; }
html { -webkit-text-size-adjust: 100%; overflow-x: hidden; }
body { overflow-x: hidden; }
body, h1, h2, h3, p, span, div, button { font-family: 'Roboto','Open Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
.btn-3d { transition: transform .1s ease, box-shadow .1s ease, filter .1s; box-shadow: 0 4px 0 0 var(--shadow-color); }
.btn-3d:disabled { box-shadow: 0 4px 0 0 var(--shadow-color); filter: grayscale(.6); opacity:.7; }
.btn-3d:not(:disabled):active { transform: translateY(2px); box-shadow: 0 2px 0 0 var(--shadow-color); }
.btn-sort { transition: transform .1s ease, box-shadow .1s ease; box-shadow: 0 3px 0 0 var(--shadow-color); width: 2.25rem; height: 2.25rem; display: inline-flex; align-items:center; justify-content:center; }
.btn-sort:not(:disabled):active { transform: translateY(1px); box-shadow: 0 2px 0 0 var(--shadow-color); }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
.monster-pulse { animation: pulse 1.5s infinite; }
@media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
.hidden-by-level { display: none !important; }
body { touch-action: manipulation; -webkit-touch-callout: none; padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); padding-bottom: env(safe-area-inset-bottom); }
button, .cmd-btn, .control-btn, .btn-sort { user-select: none; -webkit-tap-highlight-color: transparent; }
input, textarea { user-select: text; }

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –¥–ª—è –∫–ª—ñ—Ç–∏–Ω–æ–∫ */
.cell { 
  transition: transform calc(var(--transition-ms)*1ms) ease, opacity calc(var(--transition-ms)*1ms) ease; 
  font-size: clamp(0.7rem, 1.8vw, 1.9rem); 
  will-change: transform, opacity;
  line-height: 1;
}
.cell.collecting { transform: scale(1.35); z-index: 20; }

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —à–∏—Ä–∏–Ω–∞ grid */
#grid { 
  width: min(98vw, 26rem); 
  max-width: 100%;
}

@media (min-width: 640px) { 
  #grid { width: min(88vw, 30rem); }
  .cell { font-size: clamp(1rem, 2.2vw, 1.9rem); }
}
@media (min-width: 768px) { 
  #grid { width: min(72vw, 32rem); }
  .cell { font-size: clamp(1.2rem, 2.4vw, 1.9rem); }
}
@media (min-width: 1024px) { 
  #grid { width: 34rem; }
  .cell { font-size: 1.9rem; }
}

/* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
@media (max-height: 500px) and (orientation: landscape) {
  .cmd-btn { 
    min-height: 36px !important; 
    padding: 0.4rem 0.6rem !important;
    font-size: 0.75rem !important;
  }
  .cmd-btn i { font-size: 1rem !important; }
  .cmd-btn span { font-size: 0.65rem !important; }
  .control-btn { 
    min-height: 36px !important; 
    padding: 0.5rem !important;
    font-size: 0.85rem !important;
  }
  .command-list { max-height: 25vh !important; min-height: 80px !important; }
  h3.font-display { font-size: 1.1rem !important; }
  .cell { font-size: clamp(0.6rem, 1.5vw, 1.2rem) !important; }
}

.controls-sticky { position: sticky; bottom: 0; backdrop-filter: saturate(1.05) blur(3px); }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
</style>
</head>
<body class="bg-gradient-to-br from-blue-900 to-blue-700 min-h-screen p-2 xs:p-3 flex justify-center items-start font-sans">
<div class="container mx-auto max-w-6xl w-full">
<div class="bg-white/90 backdrop-blur rounded-2xl p-3 md:p-6 shadow-2xl w-full mt-2">
<div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-6">
<div class="flex-1 text-center md:text-left">
<h1 class="font-display text-2xl xs:text-3xl md:text-5xl text-yellow-500 drop-shadow-lg leading-tight">ü¶∏ –ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ üêâ</h1>
<p class="text-gray-700 text-xs xs:text-sm md:text-lg mt-1">–°—Ç–≤–æ—Ä–∏ –∞–ª–≥–æ—Ä–∏—Ç–º, –∑–±–µ—Ä–∏ —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è —ñ –∑–¥–æ–ª–∞–π –º–æ–Ω—Å—Ç—Ä—ñ–≤!</p>
</div>
<section class="level-info bg-gradient-to-br from-purple-600 to-indigo-700 p-2.5 md:p-4 rounded-2xl text-white shadow-lg w-full md:w-auto">
<div class="flex items-center justify-between gap-2 mb-2">
<h2 class="font-display text-xl md:text-3xl">üè∞ –†—ñ–≤–µ–Ω—å <span id="levelNum">1</span></h2>
<div class="flex gap-2">
<button id="soundToggle" class="btn-3d text-white rounded-lg p-1.5 md:p-2 text-base md:text-lg bg-white/20 hover:bg-white/30" aria-pressed="false" aria-label="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫" onclick="game.toggleSound()" style="--shadow-color:rgba(0,0,0,.3)"><i class="fas fa-volume-up" id="soundIcon" aria-hidden="true"></i></button>
<button id="fullscreenToggle" class="btn-3d text-white rounded-lg p-1.5 md:p-2 text-base md:text-lg bg-white/20 hover:bg-white/30" aria-label="–ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º" onclick="game.toggleFullscreen()" style="--shadow-color:rgba(0,0,0,.3)"><i class="fas fa-expand" id="fullscreenIcon" aria-hidden="true"></i></button>
</div>
</div>
<p class="level-desc text-xs md:text-base mb-2 text-center" id="levelDesc"></p>
<div class="stats-bar flex gap-1.5 md:gap-3 justify-center flex-wrap text-xs md:text-base">
<div class="stat bg-white/20 rounded-lg px-2 md:px-3 py-1 md:py-1.5 flex items-center gap-1 md:gap-2">‚öîÔ∏è <span id="damage">0</span></div>
<div class="stat bg-white/20 rounded-lg px-2 md:px-3 py-1 md:py-1.5 flex items-center gap-1 md:gap-2">üõ°Ô∏è <span id="armor">0</span></div>
<div class="stat bg-white/20 rounded-lg px-2 md:px-3 py-1 md:py-1.5 flex items-center gap-1 md:gap-2">‚ù§Ô∏è <span id="health">100</span></div>
<div class="stat bg-white/20 rounded-lg px-2 md:px-3 py-1 md:py-1.5 flex items-center gap-1 md:gap-2 font-display">üéØ –¶—ñ–ª—å: <span id="parGold">?</span> ü•á</div>
</div>
</section>
</div>
</div>

<main class="bg-white rounded-2xl p-3 md:p-6 shadow-2xl w-full my-3">
<div class="game-area grid grid-cols-1 md:grid-cols-[1.15fr_1fr] gap-3 md:gap-6">
<section class="grid-container bg-gray-50 rounded-2xl p-2.5 md:p-4 shadow-inner" aria-label="–ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥">
<h3 class="font-display text-xl md:text-2xl text-center text-indigo-600 mb-2 md:mb-3">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ø—Ä–∏–≥–æ–¥</h3>
<div class="mx-auto" id="grid" role="grid" aria-label="–°—ñ—Ç–∫–∞ –∫–∞—Ä—Ç–∏"></div>
<div class="legend grid grid-cols-2 sm:grid-cols-3 gap-1.5 text-xs mt-2 md:mt-3">
<div class="legend-item flex items-center gap-1 bg-white p-1 rounded-md shadow-sm">ü¶∏ –ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ</div>
<div class="legend-item flex items-center gap-1 bg-white p-1 rounded-md shadow-sm">üíÄ –ú–æ–Ω—Å—Ç—Ä</div>
<div class="legend-item flex items-center gap-1 bg-white p-1 rounded-md shadow-sm">‚öîÔ∏è –ó–±—Ä–æ—è</div>
<div class="legend-item flex items-center gap-1 bg-white p-1 rounded-md shadow-sm">üõ°Ô∏è –ë—Ä–æ–Ω—è</div>
<div class="legend-item flex items-center gap-1 bg-white p-1 rounded-md shadow-sm">üß™ –ó—ñ–ª–ª—è</div>
<div class="legend-item flex items-center gap-1 bg-white p-1 rounded-md shadow-sm">üå≤ –ü–µ—Ä–µ—à–∫–æ–¥–∞</div>
</div>
</section>

<aside class="commands-area bg-gray-50 rounded-2xl p-2.5 md:p-4 shadow-inner flex flex-col" aria-label="–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º—É">
<h3 class="font-display text-xl md:text-2xl text-center text-indigo-600 mb-2 md:mb-3">üìú –¢–≤–æ—ó –ö–æ–º–∞–Ω–¥–∏</h3>
<div class="command-buttons grid grid-cols-4 gap-1.5 sm:gap-2.5 mb-3">
<button class="cmd-btn btn-3d font-display text-white rounded-xl px-2 py-2 text-sm md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level min-h-[48px] flex flex-col items-center justify-center gap-0.5" onclick="game.addMove('up')" id="btnUp"><i class="fas fa-arrow-up text-lg md:text-xl"></i><span class="text-xs md:text-sm">–í–≥–æ—Ä—É</span></button>
<button class="cmd-btn btn-3d font-display text-white rounded-xl px-2 py-2 text-sm md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level min-h-[48px] flex flex-col items-center justify-center gap-0.5" onclick="game.addMove('down')" id="btnDown"><i class="fas fa-arrow-down text-lg md:text-xl"></i><span class="text-xs md:text-sm">–í–Ω–∏–∑</span></button>
<button class="cmd-btn btn-3d font-display text-white rounded-xl px-2 py-2 text-sm md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level min-h-[48px] flex flex-col items-center justify-center gap-0.5" onclick="game.addMove('left')" id="btnLeft"><i class="fas fa-arrow-left text-lg md:text-xl"></i><span class="text-xs md:text-sm">–õ—ñ–≤–æ—Ä—É—á</span></button>
<button class="cmd-btn btn-3d font-display text-white rounded-xl px-2 py-2 text-sm md:text-lg bg-blue-500 [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400 hidden-by-level min-h-[48px] flex flex-col items-center justify-center gap-0.5" onclick="game.addMove('right')" id="btnRight"><i class="fas fa-arrow-right text-lg md:text-xl"></i><span class="text-xs md:text-sm">–ü—Ä–∞–≤–æ—Ä—É—á</span></button>
<button class="cmd-btn btn-3d loop-btn font-display text-white rounded-xl px-2 py-2 text-sm md:text-lg col-span-2 bg-yellow-500 [--shadow-color:theme(colors.yellow.700)] hover:bg-yellow-400 hidden-by-level min-h-[44px]" onclick="game.addLoop()" id="btnLoop"><i class="fas fa-redo mr-1"></i>–ü–æ—á–∞—Ç–∏ –¶–∏–∫–ª</button>
<button class="cmd-btn btn-3d font-display text-white rounded-xl px-2 py-2 text-sm md:text-lg col-span-2 hidden-by-level min-h-[44px]" onclick="game.addToRoot()" id="btnRoot"><i class="fas fa-sign-out-alt mr-1"></i>–í–∏–π—Ç–∏ –∑ —Ü–∏–∫–ª—É</button>
</div>
<h3 class="font-display text-base md:text-xl text-center text-indigo-600 mb-2">üíª –¢–≤—ñ–π –∞–ª–≥–æ—Ä–∏—Ç–º:</h3>
<div class="command-list bg-white border-2 border-indigo-200 rounded-lg p-2 min-h-[120px] max-h-[35vh] overflow-y-auto mb-3 flex-grow" id="commandList" aria-live="polite"></div>
<div class="controls-sticky grid grid-cols-2 md:flex gap-2 sm:gap-2.5 pt-2">
<button class="control-btn btn-3d font-display text-white rounded-xl py-2.5 text-base md:text-xl md:flex-1 bg-green-500 [--shadow-color:theme(colors.green.700)] hover:bg-green-400 min-h-[44px]" onclick="game.run()" id="btnRun"><i class="fas fa-play mr-1 md:mr-2"></i>–°—Ç–∞—Ä—Ç</button>
<button class="control-btn btn-3d font-display text-white rounded-xl py-2.5 text-base md:text-xl md:flex-1 bg-red-500 [--shadow-color:theme(colors.red.700)] hover:bg-red-400 min-h-[44px]" onclick="game.clear()" id="btnClear"><i class="fas fa-trash mr-1 md:mr-2"></i>–û—á–∏—Å—Ç–∏—Ç–∏</button>
</div>
</aside>
</div>

<section class="battle-scene hidden bg-gradient-to-br from-gray-800 to-black text-white rounded-2xl p-4 mt-4 md:mt-6" id="battleScene" aria-label="–°—Ü–µ–Ω–∞ –±–æ—é">
<h2 class="font-display text-2xl md:text-3xl text-center text-yellow-400 mb-4">üí• –ë–Ü–ô! üí•</h2>
<div class="battle-characters flex justify-around items-center flex-wrap gap-4 mb-4">
<div class="character text-center w-32 md:w-36">
<div class="character-icon text-5xl md:text-7xl">ü¶∏</div>
<div class="font-bold text-base md:text-lg"><strong>–ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ</strong></div>
<div class="text-xs md:text-sm">‚ù§Ô∏è <span id="heroHealthText">100</span></div>
<div class="health-bar bg-gray-600 h-4 md:h-5 rounded-full overflow-hidden mt-1 shadow-inner">
<div class="health-fill hero-health h-full rounded-full bg-gradient-to-r from-green-400 to-green-600 transition-all duration-500" id="heroHealthBar" style="width:100%"></div>
</div>
</div>
<div class="text-3xl md:text-5xl font-display text-yellow-400">‚ö°</div>
<div class="character text-center w-32 md:w-36">
<div class="character-icon text-5xl md:text-7xl" id="monsterIcon">üíÄ</div>
<div class="font-bold text-base md:text-lg"><strong id="monsterName">–ú–æ–Ω—Å—Ç—Ä</strong></div>
<div class="text-xs md:text-sm">‚ù§Ô∏è <span id="monsterHealthText">50</span></div>
<div class="health-bar bg-gray-600 h-4 md:h-5 rounded-full overflow-hidden mt-1 shadow-inner">
<div class="health-fill h-full rounded-full bg-gradient-to-r from-red-400 to-red-600 transition-all duration-500" id="monsterHealthBar" style="width:100%"></div>
</div>
</div>
</div>
<div class="battle-log bg-white/10 rounded-lg p-3 min-h-[80px] max-h-[180px] overflow-y-auto text-xs md:text-sm text-left font-mono" id="battleLog" aria-live="polite"></div>
</section>

<div class="message hidden text-center p-2.5 rounded-lg mt-3 md:mt-6 text-sm md:text-lg font-bold" id="message" role="status" aria-live="polite"></div>
</main>
</div>

<!-- –ú—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π –∞—É–¥—ñ–æ-–¥–≤–∏–∂–æ–∫ (–ª–∏—à–µ –ø–µ—Ä–µ–º–æ–≥–∞/–ø–æ—Ä–∞–∑–∫–∞) -->
<script>
class SoundEngine {
constructor() {
this.urls = {
victory: 'https://www.soundjay.com/misc/sounds/success-fanfare-trumpets.mp3',
defeat: 'https://www.soundjay.com/misc/sounds/fail-buzzer-02.mp3'
};
this.enabled = true;
this.ctx = null;
this.buffers = new Map();
this._unlocked = false;
}
async unlock(){ if(this._unlocked) return; try { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); const b=this.ctx.createBuffer(1,1,22050); const s=this.ctx.createBufferSource(); s.buffer=b; s.connect(this.ctx.destination); s.start(0); this._unlocked = true; } catch(e){} }
async load(name){ if(!this.ctx) return null; if(this.buffers.has(name)) return this.buffers.get(name); const res=await fetch(this.urls[name]); const arr=await res.arrayBuffer(); const buf=await this.ctx.decodeAudioData(arr); this.buffers.set(name, buf); return buf; }
async play(name, volume=0.32){ if(!this.enabled) return; if(this.ctx){ try{ const buf=await this.load(name); if(!buf) return; const src=this.ctx.createBufferSource(); const gain=this.ctx.createGain(); gain.gain.value=volume; src.buffer=buf; src.connect(gain).connect(this.ctx.destination); src.start(this.ctx.currentTime); return; }catch(e){} } const a=new Audio(this.urls[name]); a.volume=0.32; a.play().catch(()=>{}); }
}
const SND = new SoundEngine();
window.addEventListener('pointerdown', ()=>SND.unlock(), { once: true, passive: true });
</script>

<!-- –õ–æ–≥—ñ–∫–∞ –≥—Ä–∏ -->
<script>
const GAME_CONFIG = { baseDamage:20, baseArmor:8, potionHealth:25 };
const STEP_MS = 360;

const levels = [
{ size:8, hero:[3,2], monster:[3,5], items:{weapons:[],armor:[],potions:[]}, monsterStats:{health:10,damage:0,name:'–û–ø—É–¥–∞–ª–æ',icon:'üëª'}, obstacles:[[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,6],[2,7],[3,0],[3,1],[3,6],[3,7],[4,0],[4,1],[4,6],[4,7],[5,0],[5,1],[5,6],[5,7],[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[6,6],[6,7],[7,0],[7,1],[7,2],[7,3],[7,4],[7,5],[7,6],[7,7]], desc:"–î—ñ–π–¥–∏ –¥–æ –û–ø—É–¥–∞–ª–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ª–∏—à–µ –∫–Ω–æ–ø–∫—É '–ü—Ä–∞–≤–æ—Ä—É—á'!", par:{gold:3,silver:4}},
{ size:8, hero:[5,2], monster:[2,5], items:{weapons:[],armor:[],potions:[]}, monsterStats:{health:20,damage:5,name:'–ì–æ–±–ª—ñ–Ω',icon:'üíÄ'}, obstacles:[[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,6],[2,7],[3,0],[3,1],[3,3],[3,4],[3,6],[3,7],[4,0],[4,1],[4,3],[4,4],[4,5],[4,6],[4,7],[5,0],[5,1],[5,6],[5,7],[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[6,6],[6,7],[7,0],[7,1],[7,2],[7,3],[7,4],[7,5],[7,6],[7,7]], desc:'–û–±—ñ–π–¥–∏ –ø–µ—Ä–µ—à–∫–æ–¥–∏, —â–æ–± –¥—ñ—Å—Ç–∞—Ç–∏—Å—è –¥–æ –ì–æ–±–ª—ñ–Ω–∞!', par:{gold:10,silver:12}},
{ size:8, hero:[5,2], monster:[2,5], items:{weapons:[[4,3]],armor:[[3,4]],potions:[]}, monsterStats:{health:50,damage:12,name:'–û—Ä–∫',icon:'üëπ'}, obstacles:[[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,6],[2,7],[3,0],[3,1],[3,6],[3,7],[4,0],[4,1],[4,2],[4,6],[4,7],[5,0],[5,1],[5,6],[5,7],[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[6,6],[6,7],[7,0],[7,1],[7,2],[7,3],[7,4],[7,5],[7,6],[7,7]], desc:'–ó–±–µ—Ä–∏ –∑–±—Ä–æ—é (‚öîÔ∏è) —Ç–∞ –±—Ä–æ–Ω—é (üõ°Ô∏è) –Ω–∞ —à–ª—è—Ö—É –¥–æ –û—Ä–∫–∞!', par:{gold:12,silver:15}},
{ size:8, hero:[5,2], monster:[2,5], items:{weapons:[[4,2],[2,4]],armor:[[3,3]],potions:[[4,4]]}, monsterStats:{health:80,damage:18,name:'–¢—Ä–æ–ª—å',icon:'üëø'}, obstacles:[[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,6],[2,7],[3,0],[3,1],[3,6],[3,7],[4,0],[4,1],[4,6],[4,7],[5,0],[5,1],[5,6],[5,7],[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[6,6],[6,7],[7,0],[7,1],[7,2],[7,3],[7,4],[7,5],[7,6],[7,7]], desc:'–ó–±–µ—Ä–∏ –≤—Å–µ —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è, –≤–∫–ª—é—á–Ω–æ –∑ –∑—ñ–ª–ª—è–º (üß™)!', par:{gold:14,silver:18}},
{ size:8, hero:[5,2], monster:[2,5], items:{weapons:[[4,2]],armor:[[3,2]],potions:[[2,2]]}, monsterStats:{health:50,damage:10,name:'–°–∫–µ–ª–µ—Ç',icon:'üíÄ'}, obstacles:[[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,6],[2,7],[3,0],[3,1],[3,6],[3,7],[4,0],[4,1],[4,6],[4,7],[5,0],[5,1],[5,6],[5,7],[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[6,6],[6,7],[7,0],[7,1],[7,2],[7,3],[7,4],[7,5],[7,6],[7,7]], desc:'–ù–æ–≤–∞ –º–µ—Ö–∞–Ω—ñ–∫–∞! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –¶–ò–ö–õ–ò, —â–æ–± –ø—Ä–æ–π—Ç–∏!', par:{gold:5,silver:8}},
{ size:8, hero:[7,0], monster:[0,7], items:{weapons:[[6,1],[5,2],[4,3],[3,4]],armor:[[2,5]],potions:[[6,3],[6,5]]}, monsterStats:{health:120,damage:25,name:'–î—Ä–∞–∫–æ–Ω',icon:'üêâ'}, obstacles:[[5,1],[5,2],[5,3],[5,4],[3,2],[3,4],[3,5],[1,2],[2,2]], desc:'–§—ñ–Ω–∞–ª—å–Ω–∏–π –≤–∏–∫–ª–∏–∫! –û–ø—Ç–∏–º—ñ–∑—É–π —Å–≤—ñ–π —à–ª—è—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü–∏–∫–ª—ñ–≤.', par:{gold:10,silver:15}}
];

const game = {
currentLevel: 0,
heroPos: [7,0],
commands: [],
currentContext: null,
nextId: 0,
isRunning: false,
playerStats: { damage:0, armor:0, health:100 },
collectedItems: new Set(),
tutorialShown: false,
soundDisabled: false,
gridCells: [],

init(){
const L = levels[this.currentLevel];
this.heroPos = [...L.hero];
this.commands = []; this.currentContext = null; this.nextId = 0;
this.playerStats = { damage:0, armor:0, health:100 };
this.collectedItems.clear();
this.gridCells = [];

document.getElementById('levelNum').textContent = this.currentLevel + 1;
document.getElementById('levelDesc').textContent = L.desc;
document.getElementById('parGold').textContent = L.par.gold;
document.getElementById('message').className = 'message hidden';
document.getElementById('battleScene').classList.add('hidden');
this.hideVictoryModal();
document.querySelector('.game-area').classList.remove('hidden');

document.querySelector('.battle-characters .character-icon')?.replaceChildren('ü¶∏');

document.documentElement.style.setProperty('--transition-ms', '240');

this.updateStats();
this.buildGridOnce();
this.renderCommands();
this.setButtonsState(false);
this.updateContextButton();
this.updateButtonVisibility();

if (this.currentLevel === 4 && !this.tutorialShown) { this.showTutorialModal(); this.tutorialShown = true; }
},

buildGridOnce(){
const L = levels[this.currentLevel];
const grid = document.getElementById('grid');
grid.innerHTML = '';
grid.className = 'grid grid-cols-8 gap-0.5';
for(let r=0;r<L.size;r++){
for(let c=0;c<L.size;c++){
const cell = document.createElement('div');
cell.className = 'cell aspect-square flex items-center justify-center rounded border border-green-300 bg-green-100';
cell.setAttribute('role','gridcell');
grid.appendChild(cell);
this.gridCells.push(cell);
}
}
this.fullGridPaint();
},

fullGridPaint(){
const L = levels[this.currentLevel];
const size = L.size;
for(let r=0;r<size;r++){
for(let c=0;c<size;c++){
const cell = this.gridCells[r*size + c];
let classes = 'cell aspect-square flex items-center justify-center rounded border';
const posKey = `${r},${c}`;
if (r===this.heroPos[0] && c===this.heroPos[1]) { classes += ' bg-blue-200 border-blue-500 shadow-lg z-10'; cell.textContent='ü¶∏'; }
else if (r===L.monster[0] && c===L.monster[1]) { classes += ' bg-red-200 border-red-500 monster-pulse'; cell.textContent=L.monsterStats.icon; }
else if (L.obstacles.some(o=>o[0]===r&&o[1]===c)) { classes += ' bg-gray-600 border-gray-800'; cell.textContent='üå≤'; }
else if (L.items.weapons.some(w=>w[0]===r&&w[1]===c)) { classes += ' bg-green-100 border-green-300'; cell.textContent='‚öîÔ∏è'; if(this.collectedItems.has(posKey)) classes+=' opacity-30'; }
else if (L.items.armor.some(a=>a[0]===r&&a[1]===c)) { classes += ' bg-green-100 border-green-300'; cell.textContent='üõ°Ô∏è'; if(this.collectedItems.has(posKey)) classes+=' opacity-30'; }
else if (L.items.potions.some(p=>p[0]===r&&p[1]===c)) { classes += ' bg-green-100 border-green-300'; cell.textContent='üß™'; if(this.collectedItems.has(posKey)) classes+=' opacity-30'; }
else { classes += ' bg-green-100 border-green-300'; cell.textContent=''; }
cell.className = classes;
}
}
},

swapHero(prevR, prevC, newR, newC){
const L = levels[this.currentLevel];
const size = L.size;
const prevCell = this.gridCells[prevR*size + prevC];
const newCell = this.gridCells[newR*size + newC];

const posPrev = `${prevR},${prevC}`;
let prevClass = 'cell aspect-square flex items-center justify-center rounded border';
if (L.obstacles.some(o=>o[0]===prevR&&o[1]===prevC)) { prevClass += ' bg-gray-600 border-gray-800'; prevCell.textContent='üå≤'; }
else if (L.items.weapons.some(w=>w[0]===prevR&&w[1]===prevC)) { prevClass += ' bg-green-100 border-green-300'; prevCell.textContent='‚öîÔ∏è'; if(this.collectedItems.has(posPrev)) prevClass+=' opacity-30'; }
else if (L.items.armor.some(a=>a[0]===prevR&&a[1]===prevC)) { prevClass += ' bg-green-100 border-green-300'; prevCell.textContent='üõ°Ô∏è'; if(this.collectedItems.has(posPrev)) prevClass+=' opacity-30'; }
else if (L.items.potions.some(p=>p[0]===prevR&&p[1]===prevC)) { prevClass += ' bg-green-100 border-green-300'; prevCell.textContent='üß™'; if(this.collectedItems.has(posPrev)) prevClass+=' opacity-30'; }
else { prevClass += ' bg-green-100 border-green-300'; prevCell.textContent=''; }
prevCell.className = prevClass;

let newClass = 'cell aspect-square flex items-center justify-center rounded border bg-blue-200 border-blue-500 shadow-lg z-10';
newCell.className = newClass; newCell.textContent = 'ü¶∏';
},

updateButtonVisibility(){
const i = this.currentLevel;
const ids = ['btnUp','btnDown','btnLeft','btnRight','btnLoop','btnRoot'];
ids.forEach(id => document.getElementById(id).classList.add('hidden-by-level'));
if (i === 0) document.getElementById('btnRight').classList.remove('hidden-by-level');
if (i >= 1) ['btnUp','btnDown','btnLeft','btnRight'].forEach(id => document.getElementById(id).classList.remove('hidden-by-level'));
if (i >= 4) ['btnLoop','btnRoot'].forEach(id => document.getElementById(id).classList.remove('hidden-by-level'));
},

showTutorialModal(){ document.getElementById('tutorialModalBackdrop')?.classList.remove('hidden'); document.getElementById('tutorialModal')?.classList.remove('hidden'); },
hideTutorialModal(){ document.getElementById('tutorialModalBackdrop')?.classList.add('hidden'); document.getElementById('tutorialModal').classList.add('hidden'); },
showVictoryModal(n, medal){ document.getElementById('victoryBlockCount').textContent = n; document.getElementById('victoryMedal').textContent = medal; document.getElementById('victoryModalBackdrop').classList.remove('hidden'); document.getElementById('victoryModal').classList.remove('hidden'); },
hideVictoryModal(){ document.getElementById('victoryModalBackdrop').classList.add('hidden'); document.getElementById('victoryModal').classList.add('hidden'); },

setButtonsState(dis){ ['btnUp','btnDown','btnLeft','btnRight','btnRun','btnClear','btnLoop','btnRoot'].forEach(id => { const b=document.getElementById(id); if(b) b.disabled = dis; }); document.querySelectorAll('.command-list input, .command-list button').forEach(el => el.disabled = dis); this.updateContextButton(dis); },
updateContextButton(run=false){ const btn = document.getElementById('btnRoot'); if(!btn) return; if(run){ btn.disabled = true; return; } if(this.currentContext){ btn.disabled=false; btn.classList.add('bg-red-500','[--shadow-color:theme(colors.red.700)]','hover:bg-red-400'); btn.classList.remove('bg-gray-400','[--shadow-color:theme(colors.gray.600)]','opacity-60','cursor-not-allowed'); } else { btn.disabled=true; btn.classList.remove('bg-red-500','[--shadow-color:theme(colors.red.700)]','hover:bg-red-400'); btn.classList.add('bg-gray-400','[--shadow-color:theme(colors.gray.600)]','opacity-60','cursor-not-allowed'); } },
updateStats(){ document.getElementById('damage').textContent=this.playerStats.damage; document.getElementById('armor').textContent=this.playerStats.armor; document.getElementById('health').textContent=this.playerStats.health; },

addMove(dir){ if(this.isRunning) return; (this.currentContext||this.commands).push({type:'move', direction:dir, id:this.nextId++}); this.renderCommands(); },
addLoop(){ if(this.isRunning) return; const t=this.currentContext||this.commands; const loop={type:'loop', count:2, children:[], id:this.nextId++}; t.push(loop); this.currentContext=loop.children; this.renderCommands(); this.updateContextButton(); },
addToRoot(){ if(this.isRunning) return; this.currentContext=null; this.renderCommands(); this.updateContextButton(); },

findCommandById(id, list=this.commands){ for(let i=0;i<list.length;i++){ if(list[i].id===id) return {parent:list,index:i,cmd:list[i]}; if(list[i].type==='loop'){ const f=this.findCommandById(id, list[i].children); if(f) return f; } } return null; },
removeCommand(id){ if(this.isRunning) return; const f=this.findCommandById(id); if(f){ if(f.cmd.type==='loop' && this.currentContext===f.cmd.children){ this.currentContext=null; this.updateContextButton(); } f.parent.splice(f.index,1); this.renderCommands(); } },
updateLoopCount(id,v){ if(this.isRunning) return; const f=this.findCommandById(id); if(f && f.cmd.type==='loop'){ f.cmd.count=Math.max(1,Math.min(10,parseInt(v)||1)); } },
moveCommand(id,dir){ if(this.isRunning) return; const f=this.findCommandById(id); if(!f) return; const {parent,index}=f; const ni = dir==='up'? index-1 : index+1; if(ni<0||ni>=parent.length) return; [parent[index], parent[ni]]=[parent[ni], parent[index]]; this.renderCommands(); },

renderCommands(){ const listEl=document.getElementById('commandList'); listEl.innerHTML=''; if(this.commands.length===0){ listEl.innerHTML='<p class="text-gray-400 text-center p-3 text-sm">–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏</p>'; return; } this.renderCommandList(this.commands, listEl, 0); },
renderCommandList(list, container, nest){ list.forEach((cmd, index)=>{ const item=document.createElement('div'); item.className='command-item flex justify-between items-center p-2 rounded-lg gap-2 mb-2 text-sm'; if(nest>0) item.classList.add('nested','ml-4'); if(cmd.type==='move'){ const em={up:'<i class=\'fas fa-arrow-up\'></i>',down:'<i class=\'fas fa-arrow-down\'></i>',left:'<i class=\'fas fa-arrow-left\'></i>',right:'<i class=\'fas fa-arrow-right\'></i>'}[cmd.direction]; const name={up:'–í–≥–æ—Ä—É',down:'–í–Ω–∏–∑',left:'–õ—ñ–≤–æ—Ä—É—á',right:'–ü—Ä–∞–≤–æ—Ä—É—á'}[cmd.direction]; item.classList.add('bg-indigo-100','border-l-4','border-indigo-400'); item.innerHTML=`<div class="command-text font-medium text-gray-800 flex items-center gap-2"><span class="text-base">${em}</span><span>${name}</span></div><div class="flex gap-1 flex-shrink-0"><button class="btn-sort p-1 rounded-md text-xs text-white ${index===0?'opacity-0 cursor-default':''}" onclick="game.moveCommand(${cmd.id}, 'up')" style="--shadow-color:theme(colors.green.700); background:#4CAF50;" ${index===0?'disabled':''} aria-label="–í–≥–æ—Ä—É"><i class="fas fa-chevron-up"></i></button><button class="btn-sort p-1 rounded-md text-xs text-white ${index===list.length-1?'opacity-0 cursor-default':''}" onclick="game.moveCommand(${cmd.id}, 'down')" style="--shadow-color:theme(colors.green.700); background:#4CAF50;" ${index===list.length-1?'disabled':''} aria-label="–í–Ω–∏–∑"><i class="fas fa-chevron-down"></i></button><button class="btn-sort p-1 rounded-md text-xs text-white" onclick="game.removeCommand(${cmd.id})" style="--shadow-color:theme(colors.red.700); background:#f44336;" aria-label="–í–∏–¥–∞–ª–∏—Ç–∏"><i class="fas fa-times"></i></button></div>`; }
else if(cmd.type==='loop'){ item.classList.add('loop-item','bg-yellow-100','border-l-4','border-yellow-500'); item.innerHTML=`<div class="command-text font-medium text-gray-800 flex items-center gap-2 flex-wrap"><span class="text-base"><i class="fas fa-redo"></i></span><span>–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏</span><label class="sr-only" for="loop_${cmd.id}">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω—å</label><input id="loop_${cmd.id}" type="number" class="loop-input w-12 p-1 rounded-md border-2 border-yellow-400 text-center font-bold text-sm" value="${cmd.count}" min="1" max="10" onchange="game.updateLoopCount(${cmd.id}, this.value)" onclick="event.stopPropagation()"><span>—Ä–∞–∑—ñ–≤:</span></div><div class="flex gap-1 flex-shrink-0"><button class="btn-sort p-1 rounded-md text-xs text-white ${index===0?'opacity-0 cursor-default':''}" onclick="game.moveCommand(${cmd.id}, 'up')" style="--shadow-color:theme(colors.green.700); background:#4CAF50;" ${index===0?'disabled':''} aria-label="–¶–∏–∫–ª –≤–≥–æ—Ä—É"><i class="fas fa-chevron-up"></i></button><button class="btn-sort p-1 rounded-md text-xs text-white ${index===list.length-1?'opacity-0 cursor-default':''}" onclick="game.moveCommand(${cmd.id}, 'down')" style="--shadow-color:theme(colors.green.700); background:#4CAF50;" ${index===list.length-1?'disabled':''} aria-label="–¶–∏–∫–ª –≤–Ω–∏–∑"><i class="fas fa-chevron-down"></i></button><button class="btn-sort p-1 rounded-md text-xs text-white" onclick="game.removeCommand(${cmd.id})" style="--shadow-color:theme(colors.red.700); background:#f44336;" aria-label="–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–∏–∫–ª"><i class="fas fa-times"></i></button></div>`; container.appendChild(item); const children=document.createElement('div'); children.className='nested-container ml-4 pl-2 border-l-2 border-yellow-500/50'; if(cmd.children.length>0){ this.renderCommandList(cmd.children, children, nest+1); } else { const ph=document.createElement('div'); ph.className='command-item bg-yellow-50/50 opacity-70 p-2 rounded-lg mb-2'; ph.innerHTML='<div class="command-text italic text-gray-500 text-xs"><span><em>–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏ –≤ —Ü–∏–∫–ª</em></span></div>'; children.appendChild(ph); } container.appendChild(children); if(this.currentContext===cmd.children){ children.classList.add('bg-yellow-50','rounded-md'); } return; }
container.appendChild(item); });
if(this.currentContext===this.commands){ container.classList.add('bg-yellow-50'); } else { container.classList.remove('bg-yellow-50'); }
},

clear(){ if(this.isRunning) return; document.querySelector('.game-area').classList.remove('hidden'); this.hideVictoryModal(); this.init(); },

delay(ms){ return new Promise(r=>setTimeout(r, ms)); },

async run(){ if(this.commands.length===0 || this.isRunning) return; this.isRunning=true; this.setButtonsState(true); const L=levels[this.currentLevel]; this.heroPos=[...L.hero]; this.playerStats={damage:0,armor:0,health:100}; this.collectedItems.clear(); document.getElementById('message').className='message hidden'; document.getElementById('battleScene').classList.add('hidden'); this.fullGridPaint(); this.updateStats(); await this.executeCommands(this.commands); if(this.heroPos[0]===L.monster[0] && this.heroPos[1]===L.monster[1]){ await this.startBattle(); } else { this.showMessage('error','üòî –¢–∏ –Ω–µ –¥—ñ–π—à–æ–≤ –¥–æ –º–æ–Ω—Å—Ç—Ä–∞! –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.'); } this.isRunning=false; this.setButtonsState(false); },

animateItemCollectionAt(r,c){ const L=levels[this.currentLevel]; const size=L.size; const cell=this.gridCells[r*size + c]; if(!cell) return; cell.classList.add('collecting'); setTimeout(()=>cell.classList.remove('collecting'), 200); },

async executeCommands(list){ const L=levels[this.currentLevel]; for(const cmd of list){ if(!this.isRunning) return; if(cmd.type==='move'){
const prev=[...this.heroPos];
if(cmd.direction==='up') this.heroPos[0]=Math.max(0,this.heroPos[0]-1); else if(cmd.direction==='down') this.heroPos[0]=Math.min(L.size-1,this.heroPos[0]+1); else if(cmd.direction==='left') this.heroPos[1]=Math.max(0,this.heroPos[1]-1); else if(cmd.direction==='right') this.heroPos[1]=Math.min(L.size-1,this.heroPos[1]+1);
const isObstacle=L.obstacles.some(o=>o[0]===this.heroPos[0]&&o[1]===this.heroPos[1]);
if(isObstacle){ this.heroPos=[...prev]; }
else {
this.swapHero(prev[0], prev[1], this.heroPos[0], this.heroPos[1]);
const key=`${this.heroPos[0]},${this.heroPos[1]}`;
if(!this.collectedItems.has(key)){
const w=L.items.weapons.some(w=>w[0]===this.heroPos[0]&&w[1]===this.heroPos[1]);
const a=L.items.armor.some(a=>a[0]===this.heroPos[0]&&a[1]===this.heroPos[1]);
const p=L.items.potions.some(p=>p[0]===this.heroPos[0]&&p[1]===this.heroPos[1]);
if(w||a||p){ if(w) this.playerStats.damage+=GAME_CONFIG.baseDamage; else if(a) this.playerStats.armor+=GAME_CONFIG.baseArmor; else if(p) this.playerStats.health=Math.min(100,this.playerStats.health+GAME_CONFIG.potionHealth); this.collectedItems.add(key); this.updateStats(); this.animateItemCollectionAt(this.heroPos[0], this.heroPos[1]); }
}
}
await this.delay(STEP_MS);
} else if(cmd.type==='loop'){ for(let i=0;i<cmd.count;i++){ if(!this.isRunning) return; await this.executeCommands(cmd.children); } }
} },

countBlocks(list=this.commands){ let c=0; for(const cmd of list){ c++; if(cmd.type==='loop') c+=this.countBlocks(cmd.children); } return c; },

async startBattle(){ const L=levels[this.currentLevel]; const M=L.monsterStats; document.querySelector('.game-area').classList.add('hidden'); document.getElementById('battleScene').classList.remove('hidden'); document.getElementById('monsterIcon').replaceChildren(M.icon); document.getElementById('monsterName').textContent=M.name; let hero=this.playerStats.health, mon=M.health; document.getElementById('heroHealthText').textContent=hero; document.getElementById('monsterHealthText').textContent=mon; document.getElementById('heroHealthBar').style.width='100%'; document.getElementById('monsterHealthBar').style.width='100%'; const log=document.getElementById('battleLog'); log.innerHTML=''; const add=t=>{ const e=document.createElement('div'); e.textContent=t; log.appendChild(e); log.scrollTop=log.scrollHeight; };
add('‚öîÔ∏è –ë—ñ–π —Ä–æ–∑–ø–æ—á–∞–≤—Å—è!'); await this.delay(650);
let round=1; while(hero>0 && mon>0){ add(`--- –†–∞—É–Ω–¥ ${round} ---`); const hd=Math.max(5,this.playerStats.damage); mon=Math.max(0,mon-hd); add(`üó°Ô∏è –ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ –∞—Ç–∞–∫—É—î! –ó–∞–≤–¥–∞–Ω–æ ${hd} —É—Ä–æ–Ω—É.`); document.getElementById('monsterHealthText').textContent=mon; document.getElementById('monsterHealthBar').style.width=`${(mon/M.health)*100}%`; await this.delay(650); if(mon<=0) break; const ad=Math.max(0, M.damage - this.playerStats.armor); hero=Math.max(0, hero - ad); add(ad>0? `üí• ${M.name} –∞—Ç–∞–∫—É—î! –ó–∞–≤–¥–∞–Ω–æ ${ad} —É—Ä–æ–Ω—É (${this.playerStats.armor} –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ).` : `üí• ${M.name} –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∞—Ç–∞–∫—É–≤–∞—Ç–∏, –∞–ª–µ –Ω–µ –∑–∞–≤–¥–∞—î —É—Ä–æ–Ω—É!`); document.getElementById('heroHealthText').textContent=hero; document.getElementById('heroHealthBar').style.width=`${(hero/this.playerStats.health)*100}%`; await this.delay(650); round++; }
await this.delay(320); if(hero>0){ add('üéâ –ü–ï–†–ï–ú–û–ì–ê! –ú–æ–Ω—Å—Ç—Ä –ø–µ—Ä–µ–º–æ–∂–µ–Ω–∏–π!'); SND.play('victory'); const blocks=this.countBlocks(); const par=L.par; let medal='ü•â (–ë—Ä–æ–Ω–∑–∞)'; if(blocks<=par.gold) medal='ü•á (–ó–æ–ª–æ—Ç–æ!)'; else if(blocks<=par.silver) medal='ü•à (–°—Ä—ñ–±–ª–æ)'; this.showVictoryModal(blocks, medal); } else { add('üíÄ –ü–æ—Ä–∞–∑–∫–∞... –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑!'); SND.play('defeat'); this.showMessage('error','üíÄ –ü—Ä–æ–≥—Ä–∞–≤... –°–ø—Ä–æ–±—É–π —ñ–Ω—à—É —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é!'); }
},

showMessage(type, text){ const msg=document.getElementById('message'); msg.textContent=text; msg.className='message text-center p-2.5 rounded-lg mt-3 md:mt-6 text-sm md:text-lg font-bold'; if(type==='success'){ msg.classList.add('bg-green-100','text-green-800'); } else { msg.classList.add('bg-red-100','text-red-800'); } },
nextLevel(){ this.hideVictoryModal(); if(this.currentLevel < levels.length-1){ this.currentLevel++; this.init(); } else { this.showMessage('success','üèÜ –í—ñ—Ç–∞—é! –¢–∏ –ø—Ä–æ–π—à–æ–≤ —É—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≥–µ—Ä–æ–π!'); } },
toggleSound(){ this.soundDisabled=!this.soundDisabled; SND.enabled = !this.soundDisabled; const ic=document.getElementById('soundIcon'); const b=document.getElementById('soundToggle'); if(this.soundDisabled){ ic.className='fas fa-volume-mute'; b.title='–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫–∏'; b.setAttribute('aria-pressed','true'); } else { ic.className='fas fa-volume-up'; b.title='–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫–∏'; b.setAttribute('aria-pressed','false'); } },
toggleFullscreen(){ const ic=document.getElementById('fullscreenIcon'); const b=document.getElementById('fullscreenToggle'); if(!document.fullscreenElement){ document.documentElement.requestFullscreen().then(()=>{ ic.className='fas fa-compress'; b.title='–í–∏–π—Ç–∏ –∑ –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É'; }).catch(()=>{}); } else { document.exitFullscreen().then(()=>{ ic.className='fas fa-expand'; b.title='–£–≤—ñ–π—Ç–∏ –≤ –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º'; }).catch(()=>{}); } }
};

document.addEventListener('DOMContentLoaded', ()=>{
window.game = game; game.init();
document.addEventListener('fullscreenchange', ()=>{ const ic=document.getElementById('fullscreenIcon'); const b=document.getElementById('fullscreenToggle'); if(document.fullscreenElement){ ic.className='fas fa-compress'; b.title='–í–∏–π—Ç–∏ –∑ –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É'; } else { ic.className='fas fa-expand'; b.title='–£–≤—ñ–π—Ç–∏ –≤ –ø–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º'; } });
let lastTouchEnd=0; document.addEventListener('touchend', e=>{ const now=Date.now(); if(now-lastTouchEnd<=300){ e.preventDefault(); } lastTouchEnd=now; }, {passive:false});
document.addEventListener('contextmenu', e=> e.preventDefault());
});
</script>

<div id="tutorialModalBackdrop" class="fixed inset-0 bg-black/60 z-40 hidden" aria-hidden="true"></div>
<div id="tutorialModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-4 md:p-6 rounded-2xl shadow-2xl z-50 w-11/12 max-w-md hidden" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
<h2 id="tutorialTitle" class="font-display text-2xl md:text-3xl text-yellow-500 text-center mb-3 md:mb-4">üîÅ –ù–æ–≤–∞ –°–∏–ª–∞: –¶–ò–ö–õ–ò! üîÅ</h2>
<p class="text-gray-700 mb-3 md:mb-4 text-center text-sm md:text-base">–¶–∏–∫–ª–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤. –¶–µ –µ–∫–æ–Ω–æ–º–∏—Ç—å –±–ª–æ–∫–∏!</p>
<div class="bg-gray-100 rounded-lg p-2.5 md:p-3 mb-4 md:mb-5 text-gray-800 text-sm md:text-base">
<p class="font-medium mb-1">1. –ù–∞—Ç–∏—Å–Ω–∏ <strong class="text-yellow-600">¬´–ü–æ—á–∞—Ç–∏ –¶–∏–∫–ª¬ª</strong>.</p>
<p class="font-medium mb-1">2. –î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥–∏, —è–∫—ñ —Ö–æ—á–µ—à –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏.</p>
<p class="font-medium">3. –ù–∞—Ç–∏—Å–Ω–∏ <strong class="text-red-500">¬´–í–∏–π—Ç–∏ –∑ —Ü–∏–∫–ª—É¬ª</strong>.</p>
</div>
<button class="btn-3d w-full font-display text-white rounded-xl p-2.5 md:p-3 text-base md:text-lg bg-green-500 [--shadow-color:theme(colors.green.700)] hover:bg-green-400" onclick="game.hideTutorialModal()">–ó—Ä–æ–∑—É–º—ñ–ª–æ!</button>
</div>

<div id="victoryModalBackdrop" class="fixed inset-0 bg-black/60 z-40 hidden" onclick="game.hideVictoryModal()" aria-hidden="true"></div>
<div id="victoryModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-4 md:p-8 rounded-2xl shadow-2xl z-50 w-11/12 max-w-lg hidden" onclick="event.stopPropagation()" role="dialog" aria-modal="true" aria-labelledby="victoryTitle">
<div class="bg-gradient-to-r from-green-400 to-green-500 text-white p-3 md:p-4 rounded-xl mb-4 md:mb-6 text-center">
<div class="flex items-center justify-center gap-2 md:gap-3 mb-2">
<span class="text-2xl md:text-3xl" aria-hidden="true">üéâ</span>
<h2 id="victoryTitle" class="font-display text-xl md:text-3xl">–ü–µ—Ä–µ–º–æ–≥–∞!</h2>
<span class="text-2xl md:text-3xl" aria-hidden="true">üèÜ</span>
</div>
<div class="text-base md:text-xl font-bold" id="victoryStats">–ë–ª–æ–∫—ñ–≤: <span id="victoryBlockCount">0</span></div>
<div class="text-sm md:text-base mt-1" id="victoryMedal">ü•á (–ó–æ–ª–æ—Ç–æ!)</div>
</div>
<div class="text-center">
<button class="btn-3d font-display text-gray-800 rounded-xl p-3 md:p-4 text-lg md:text-xl bg-yellow-400 [--shadow-color:theme(colors.yellow.600)] hover:bg-yellow-300 w-full" id="victoryNextBtn" onclick="game.nextLevel()"><i class="fas fa-forward mr-2" aria-hidden="true"></i>–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å</button>
</div>
</div>
</body>
</html>

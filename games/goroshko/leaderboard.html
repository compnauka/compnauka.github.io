<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–¢—É—Ä–Ω—ñ—Ä–Ω–∞ —Ç–∞–±–ª–∏—Ü—è ‚Äî –ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–æ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<link rel="stylesheet" href="css/styles.css" />
</head>
<body class="bg-gradient-to-br from-purple-900 to-indigo-700 min-h-screen p-4 font-sans">

<div class="container mx-auto max-w-5xl">
  <!-- –•–µ–¥–µ—Ä -->
  <div class="bg-white rounded-2xl p-6 shadow-2xl mb-4">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div>
        <h1 class="font-display text-3xl md:text-4xl text-yellow-500">üèÜ –¢—É—Ä–Ω—ñ—Ä–Ω–∞ —Ç–∞–±–ª–∏—Ü—è</h1>
        <p class="text-gray-600 mt-1">–ù–∞–π–∫—Ä–∞—â—ñ –≥—Ä–∞–≤—Ü—ñ —Ç–∞ —ó—Ö–Ω—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</p>
      </div>
      <a href="index.html" class="btn-3d bg-blue-500 text-white px-6 py-2 rounded-lg font-bold [--shadow-color:theme(colors.blue.700)] hover:bg-blue-400">
        <i class="fas fa-arrow-left mr-2"></i>–î–æ –≥—Ä–∏
      </a>
    </div>
  </div>

  <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
  <div class="bg-white rounded-2xl p-4 shadow-2xl mb-4">
    <div class="flex gap-3 flex-wrap">
      <button class="filter-btn btn-3d bg-purple-500 text-white px-4 py-2 rounded-lg font-medium [--shadow-color:theme(colors.purple.700)]" data-view="global">
        üåç –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥
      </button>
      <button class="filter-btn btn-3d bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium [--shadow-color:theme(colors.gray.400)]" data-view="level">
        üéØ –ó–∞ —Ä—ñ–≤–Ω–µ–º
      </button>
    </div>

    <!-- –í–∏–±—ñ—Ä —Ä—ñ–≤–Ω—è -->
    <div id="levelSelector" class="mt-4 hidden">
      <label class="block text-gray-700 font-medium mb-2">–í–∏–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å:</label>
      <select id="levelSelect" class="w-full md:w-64 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
        <option value="0">–†—ñ–≤–µ–Ω—å 1 ‚Äî –û–ø—É–¥–∞–ª–æ</option>
        <option value="1">–†—ñ–≤–µ–Ω—å 2 ‚Äî –ì–æ–±–ª—ñ–Ω</option>
        <option value="2">–†—ñ–≤–µ–Ω—å 3 ‚Äî –û—Ä–∫</option>
        <option value="3">–†—ñ–≤–µ–Ω—å 4 ‚Äî –¢—Ä–æ–ª—å</option>
        <option value="4">–†—ñ–≤–µ–Ω—å 5 ‚Äî –°–∫–µ–ª–µ—Ç</option>
        <option value="5">–†—ñ–≤–µ–Ω—å 6 ‚Äî –î—Ä–∞–∫–æ–Ω</option>
      </select>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤ -->
  <div class="bg-white rounded-2xl p-6 shadow-2xl">
    <div id="loadingState" class="text-center py-12">
      <div class="inline-block animate-spin text-4xl mb-4">‚ö°</div>
      <p class="text-gray-600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É...</p>
    </div>

    <div id="leaderboardContent" class="hidden">
      <!-- –¢–æ–ø 3 -->
      <div id="topThree" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

      <!-- –†–µ—à—Ç–∞ —Ç–∞–±–ª–∏—Ü—ñ -->
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b-2 border-gray-300">
              <th class="text-left py-3 px-2 font-bold text-gray-700">–ú—ñ—Å—Ü–µ</th>
              <th class="text-left py-3 px-2 font-bold text-gray-700">–ì—Ä–∞–≤–µ—Ü—å</th>
              <th class="text-center py-3 px-2 font-bold text-gray-700" id="scoreHeader">–ü—Ä–æ–π–¥–µ–Ω–æ</th>
              <th class="text-center py-3 px-2 font-bold text-gray-700">ü•á</th>
              <th class="text-center py-3 px-2 font-bold text-gray-700">ü•à</th>
              <th class="text-center py-3 px-2 font-bold text-gray-700">ü•â</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <!-- –ü–æ–∑–∏—Ü—ñ—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è -->
      <div id="userRankCard" class="mt-6 p-4 bg-gradient-to-r from-blue-100 to-purple-100 rounded-xl border-2 border-blue-300 hidden">
        <p class="text-center font-bold text-gray-800">
          <i class="fas fa-user text-blue-600 mr-2"></i>
          –¢–≤–æ—è –ø–æ–∑–∏—Ü—ñ—è: <span id="userRankText" class="text-2xl text-blue-600">‚Äî</span>
        </p>
      </div>
    </div>

    <!-- –ü—É—Å—Ç–∏–π —Å—Ç–∞–Ω -->
    <div id="emptyState" class="hidden text-center py-12">
      <div class="text-6xl mb-4">üèúÔ∏è</div>
      <p class="text-gray-600 text-lg">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</p>
      <p class="text-gray-500 text-sm mt-2">–°—Ç–∞–Ω—å –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –ø—Ä–æ–π–¥–µ —Ü–µ–π —Ä—ñ–≤–µ–Ω—å!</p>
    </div>
  </div>
</div>

<script type="module">
import { authManager } from './js/auth.js';
import { storage } from './js/storage.js';

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
authManager.init();

let currentView = 'global';
let currentLevel = null;

// –ï–ª–µ–º–µ–Ω—Ç–∏
const loadingState = document.getElementById('loadingState');
const leaderboardContent = document.getElementById('leaderboardContent');
const emptyState = document.getElementById('emptyState');
const topThree = document.getElementById('topThree');
const leaderboardBody = document.getElementById('leaderboardBody');
const levelSelector = document.getElementById('levelSelector');
const levelSelect = document.getElementById('levelSelect');
const userRankCard = document.getElementById('userRankCard');
const userRankText = document.getElementById('userRankText');
const scoreHeader = document.getElementById('scoreHeader');

// –§—ñ–ª—å—Ç—Ä–∏
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.filter-btn').forEach(b => {
      b.classList.remove('bg-purple-500', 'text-white');
      b.classList.add('bg-gray-200', 'text-gray-700');
    });
    btn.classList.remove('bg-gray-200', 'text-gray-700');
    btn.classList.add('bg-purple-500', 'text-white');

    currentView = btn.dataset.view;
    
    if (currentView === 'level') {
      levelSelector.classList.remove('hidden');
      currentLevel = parseInt(levelSelect.value);
    } else {
      levelSelector.classList.add('hidden');
      currentLevel = null;
    }

    loadLeaderboard();
  });
});

levelSelect.addEventListener('change', () => {
  currentLevel = parseInt(levelSelect.value);
  loadLeaderboard();
});

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—É—Ä–Ω—ñ—Ä–Ω–æ—ó —Ç–∞–±–ª–∏—Ü—ñ
async function loadLeaderboard() {
  showLoading();

  try {
    const data = await storage.getLeaderboard(currentLevel, 100);

    if (data.length === 0) {
      showEmpty();
      return;
    }

    renderLeaderboard(data);

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    if (authManager.isAuthenticated() && currentLevel !== null) {
      const rank = await storage.getUserRank(currentLevel);
      if (rank) {
        userRankText.textContent = `#${rank}`;
        userRankCard.classList.remove('hidden');
      }
    }
  } catch (error) {
    console.error('Error loading leaderboard:', error);
    showEmpty();
  }
}

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
function renderLeaderboard(data) {
  loadingState.classList.add('hidden');
  emptyState.classList.add('hidden');
  leaderboardContent.classList.remove('hidden');

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
  if (currentView === 'level') {
    scoreHeader.textContent = '–ë–ª–æ–∫—ñ–≤';
  } else {
    scoreHeader.textContent = '–ü—Ä–æ–π–¥–µ–Ω–æ';
  }

  // –¢–æ–ø 3
  topThree.innerHTML = '';
  const top3 = data.slice(0, 3);
  
  top3.forEach((player, index) => {
    const medals = ['ü•á', 'ü•à', 'ü•â'];
    const colors = ['from-yellow-400 to-yellow-500', 'from-gray-300 to-gray-400', 'from-orange-400 to-orange-500'];
    
    const card = document.createElement('div');
    card.className = `bg-gradient-to-br ${colors[index]} text-white rounded-xl p-6 text-center shadow-lg transform hover:scale-105 transition`;
    card.innerHTML = `
      <div class="text-5xl mb-3">${medals[index]}</div>
      <div class="font-bold text-xl mb-2">${escapeHtml(player.displayName || '–ì—Ä–∞–≤–µ—Ü—å')}</div>
      ${currentView === 'global' 
        ? `<div class="text-sm opacity-90">–ü—Ä–æ–π–¥–µ–Ω–æ: ${player.totalCompleted || 0}</div>
           <div class="text-sm opacity-90">ü•á ${player.goldMedals || 0} ü•à ${player.silverMedals || 0} ü•â ${player.bronzeMedals || 0}</div>`
        : `<div class="text-2xl font-bold">${player.blocks} –±–ª–æ–∫—ñ–≤</div>
           <div class="text-sm opacity-90">${player.medal === 'gold' ? 'ü•á' : player.medal === 'silver' ? 'ü•à' : 'ü•â'}</div>`
      }
    `;
    topThree.appendChild(card);
  });

  // –†–µ—à—Ç–∞ —Ç–∞–±–ª–∏—Ü—ñ
  leaderboardBody.innerHTML = '';
  const rest = data.slice(3);

  rest.forEach((player) => {
    const row = document.createElement('tr');
    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition';
    
    const isCurrentUser = authManager.getUserId() === player.userId;
    if (isCurrentUser) {
      row.classList.add('bg-blue-50', 'font-bold');
    }

    row.innerHTML = `
      <td class="py-3 px-2 text-gray-700">#${player.rank}</td>
      <td class="py-3 px-2">
        <span class="font-medium">${escapeHtml(player.displayName || '–ì—Ä–∞–≤–µ—Ü—å')}</span>
        ${isCurrentUser ? '<span class="ml-2 text-blue-600 text-sm">(—Ç–∏)</span>' : ''}
      </td>
      ${currentView === 'global'
        ? `<td class="py-3 px-2 text-center">${player.totalCompleted || 0}</td>
           <td class="py-3 px-2 text-center">${player.goldMedals || 0}</td>
           <td class="py-3 px-2 text-center">${player.silverMedals || 0}</td>
           <td class="py-3 px-2 text-center">${player.bronzeMedals || 0}</td>`
        : `<td class="py-3 px-2 text-center font-bold">${player.blocks}</td>
           <td class="py-3 px-2 text-center">${player.medal === 'gold' ? '1' : '‚Äî'}</td>
           <td class="py-3 px-2 text-center">${player.medal === 'silver' ? '1' : '‚Äî'}</td>
           <td class="py-3 px-2 text-center">${player.medal === 'bronze' ? '1' : '‚Äî'}</td>`
      }
    `;
    
    leaderboardBody.appendChild(row);
  });
}

function showLoading() {
  loadingState.classList.remove('hidden');
  leaderboardContent.classList.add('hidden');
  emptyState.classList.add('hidden');
  userRankCard.classList.add('hidden');
}

function showEmpty() {
  loadingState.classList.add('hidden');
  leaderboardContent.classList.add('hidden');
  emptyState.classList.remove('hidden');
  userRankCard.classList.add('hidden');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
loadLeaderboard();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Ä—Å—å–∫–∏–π –±—ñ–π</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Neucha&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --sea-color-1: #021027;
            --sea-color-2: #03183a;
            --paper-color: #fdfaf2;
            --pen-color: #2c3e50;
            --blue-pen: #3498db;
            --red-pen: #e74c3c;
        }

        body {
            font-family: 'Neucha', cursive;
            background-color: var(--sea-color-1);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        .sea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .wave {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 88.7'%3E%3Cpath d='M800 56.9c-155.5 0-204.9-50-405.5-49.9-200 0-250 49.9-394.5 49.9v31.8h800v-.2-31.6z' fill='%2303183a'/%3E%3C/svg%3E");
            position: absolute;
            width: 200%;
            height: 100%;
            animation: wave 10s -3s linear infinite;
            transform: translate3d(0, 0, 0);
            opacity: 0.8;
        }

        .wave:nth-of-type(2) {
            bottom: 0;
            animation: wave 18s linear reverse infinite;
            opacity: 0.5;
        }

        .wave:nth-of-type(3) {
            bottom: 0;
            animation: wave 20s -1s reverse infinite;
            opacity: 0.3;
        }

        @keyframes wave {
            0% {transform: translateX(0);}
            50% {transform: translateX(-25%);}
            100% {transform: translateX(-50%);}
        }

        .container {
            background: var(--paper-color);
            border-radius: 5px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 0 10px rgba(255,255,255,0.1);
            max-width: 1200px;
            width: 100%;
            border: 1px solid #ddd;
        }

        h1 {
            text-align: center;
            color: var(--pen-color);
            margin-bottom: 25px;
            font-size: 3em;
            position: relative;
        }

        #soundToggle {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            font-size: 0.8em;
            cursor: pointer;
            color: var(--pen-color);
            transition: color 0.2s;
        }
        #soundToggle:hover {
            color: var(--blue-pen);
        }

        .menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .button {
            background: transparent;
            color: var(--pen-color);
            border: 2px solid var(--pen-color);
            padding: 12px 35px;
            font-size: 22px;
            font-family: 'Neucha', cursive;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .button:hover {
            background: var(--pen-color);
            color: var(--paper-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            background: #aaa;
            color: #777;
            border-color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            padding: 12px 20px;
            font-size: 18px;
            font-family: 'Neucha', cursive;
            border: 2px solid var(--pen-color);
            border-radius: 5px;
            outline: none;
            min-width: 250px;
            background: transparent;
        }

        .game-area { display: none; }
        .game-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .game-code {
            background: transparent;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 24px;
            font-weight: normal;
            color: var(--blue-pen);
            display: inline-block;
            margin: 10px 0;
            cursor: pointer;
            border: 2px dashed var(--blue-pen);
        }

        .status {
            font-size: 24px;
            margin: 10px 0;
            min-height: 36px;
            color: var(--pen-color);
        }

        .boards {
            display: flex;
            gap: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .board-title {
            font-size: 26px;
            font-weight: normal;
            margin-bottom: 10px;
            color: var(--pen-color);
        }
        
        .rotate-btn {
            margin-bottom: 10px; /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –∫–Ω–æ–ø–∫–∏ */
        }

        .board {
            display: grid;
            grid-template-columns: repeat(10, 35px);
            grid-template-rows: repeat(10, 35px);
            gap: 0;
            background: var(--pen-color);
            border: 2px solid var(--pen-color);
        }
        
        .board.active-turn {
            box-shadow: 0 0 15px 5px var(--blue-pen);
        }

        .cell {
            background: var(--paper-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        .cell:nth-child(10n) { border-right: none; }
        .cell:nth-last-child(-n+10) { border-bottom: none; }


        #enemyBoard .cell.valid-shot:hover {
             background: #e0f7fa;
        }
        
        .cell.ship {
            background-image: linear-gradient(45deg, var(--blue-pen) 25%, transparent 25%, transparent 50%, var(--blue-pen) 50%, var(--blue-pen) 75%, transparent 75%, transparent);
            background-size: 5px 5px;
        }
        
        .cell.preview-ok {
            background: rgba(46, 204, 113, 0.3) !important;
        }
        .cell.preview-bad {
            background: rgba(231, 76, 60, 0.3) !important;
        }

        .cell.hit {
            cursor: not-allowed;
        }

        .cell.hit::after {
            font-family: "Font Awesome 6 Free";
            content: "\f00d"; /* fa-xmark */
            font-weight: 900;
            color: var(--red-pen);
        }

        .cell.miss {
            cursor: not-allowed;
        }

        .cell.miss::after {
            content: '‚Ä¢';
            color: var(--pen-color);
            font-size: 30px;
        }

        .cell.sunk {
            background-color: rgba(198, 40, 40, 0.2);
        }

        .ships-list {
            margin-top: 15px;
            font-size: 20px;
            width: 250px;
        }

        .ships-list div {
            padding: 3px 0;
        }
        
        .message-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            background: var(--paper-color);
            padding: 40px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease-out;
            border: 2px solid var(--pen-color);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .message-box h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: var(--pen-color);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="sea">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>
    <div class="container">
        <h1>
            <i class="fa-solid fa-anchor"></i> –ú–æ—Ä—Å—å–∫–∏–π –±—ñ–π <i class="fa-solid fa-anchor"></i>
            <i id="soundToggle" class="fa-solid fa-volume-high" title="–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫"></i>
        </h1>
        
        <div class="menu" id="menu">
            <button class="button" onclick="createGame()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
            <div class="input-group">
                <input type="text" id="joinCode" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –≥—Ä–∏" maxlength="6">
                <button class="button" onclick="joinGame()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å</button>
            </div>
        </div>

        <div class="game-area" id="gameArea">
            <div class="game-info">
                 <div class="game-code" id="gameCodeDisplay" title="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏">–ö–æ–¥ –≥—Ä–∏: <span id="displayCode"></span></div>
                <div class="timer" id="timer"></div>
                <div class="status" id="status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å—É–ø–µ—Ä–Ω–∏–∫–∞...</div>
            </div>

            <div class="boards">
                <div class="board-container">
                    <div class="board-title">–í–∞—à–µ –ø–æ–ª–µ</div>
                    <button class="button rotate-btn" id="rotateBtn" onclick="rotateShip()"><i class="fa-solid fa-rotate"></i> –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ—Ä–∞–±–µ–ª—å</button>
                    <div class="board" id="myBoard"></div>
                    <div class="ships-list" id="shipsList"></div>
                </div>

                <div class="board-container">
                    <div class="board-title">–ü–æ–ª–µ —Å—É–ø–µ—Ä–Ω–∏–∫–∞</div>
                    <div class="board" id="enemyBoard"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="message-overlay" id="messageOverlay">
        <div class="message-box">
            <h2 id="messageText"></h2>
            <button class="button" onclick="location.reload()">–ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase, –Ω–∞–¥–∞–Ω–∞ –≤–∞–º–∏
        const firebaseConfig = {
            apiKey: "AIzaSyB0OEvx1SaXXClGRYeFt40P5RFTf1aantE",
            authDomain: "sea-battle-bf3c9.firebaseapp.com",
            databaseURL: "https://sea-battle-bf3c9-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "sea-battle-bf3c9",
            storageBucket: "sea-battle-bf3c9.firebasestorage.app",
            messagingSenderId: "514029502541",
            appId: "1:514029502541:web:70fa166ba97c2bc1fedc04"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- –ó–≤—É–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏ ---
        let audioCtx;
        let isMuted = localStorage.getItem('battleshipMuted') === 'true';
        let lastSunkCount = 0;

        const sounds = {
            play: (type, ...args) => {
                if (isMuted || !audioCtx) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const soundGenerators = {
                    miss: () => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                        osc.frequency.linearRampToValueAtTime(80, audioCtx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
                        osc.connect(gain).connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.2);
                    },
                    hit: () => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
                        osc.connect(gain).connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.15);
                    },
                    sunk: () => {
                         for (let i = 0; i < 3; i++) {
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.type = 'square';
                            osc.frequency.setValueAtTime(300 - i * 40, audioCtx.currentTime + i * 0.1);
                            gain.gain.setValueAtTime(0.3, audioCtx.currentTime + i * 0.1);
                            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.1 + 0.1);
                            osc.connect(gain).connect(audioCtx.destination);
                            osc.start(audioCtx.currentTime + i * 0.1);
                            osc.stop(audioCtx.currentTime + i * 0.1 + 0.1);
                        }
                    },
                    win: () => {
                        const notes = [261, 329, 392, 523];
                        notes.forEach((freq, i) => {
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.type = 'triangle';
                            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.15);
                            gain.gain.setValueAtTime(0.4, audioCtx.currentTime + i * 0.15);
                            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.15 + 0.1);
                            osc.connect(gain).connect(audioCtx.destination);
                            osc.start(audioCtx.currentTime + i * 0.15);
                            osc.stop(audioCtx.currentTime + i * 0.15 + 0.1);
                        });
                    }
                };
                if(soundGenerators[type]) soundGenerators[type](...args);
            }
        };
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        // ----------------------

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Å—Ç–∞–Ω—É –≥—Ä–∏
        let gameCode = '';
        let playerId = localStorage.getItem('battleshipPlayerId') || crypto.randomUUID();
        localStorage.setItem('battleshipPlayerId', playerId);
        let playerNumber = 0;
        let localGameData = null; // –õ–æ–∫–∞–ª—å–Ω–∞ –∫–æ–ø—ñ—è —Å—Ç–∞–Ω—É –≥—Ä–∏
        
        let isHorizontal = true;
        const ships = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
        let currentShipIndex = 0;
        let myBoardData = Array(10).fill().map(() => Array(10).fill(0));
        let setupPhase = true;

        const myBoardEl = document.getElementById('myBoard');
        const enemyBoardEl = document.getElementById('enemyBoard');
        const statusEl = document.getElementById('status');
        const rotateBtn = document.getElementById('rotateBtn');
        const soundToggle = document.getElementById('soundToggle');

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è UI
        createBoardDOM('myBoard', handleMyBoardClick);
        createBoardDOM('enemyBoard', handleEnemyBoardClick);
        updateShipsList();
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–≤—É–∫—É
        soundToggle.className = isMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
        soundToggle.title = isMuted ? '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫' : '–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
        soundToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            localStorage.setItem('battleshipMuted', isMuted);
            soundToggle.className = isMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
            soundToggle.title = isMuted ? '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫' : '–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
            if(!isMuted) initAudio();
        });

        window.createGame = async function() {
            initAudio();
            gameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            playerNumber = 1;
            const initialGameState = {
                player1: { id: playerId, ready: false, board: null },
                player2: { id: null, ready: false, board: null },
                currentTurn: 1, gameStarted: false, moves: [], winner: null, createdAt: serverTimestamp()
            };
            await set(ref(db, `games/${gameCode}`), initialGameState);
            showGameArea();
            listenToGame();
        };

        window.joinGame = async function() {
            initAudio();
            const code = document.getElementById('joinCode').value.toUpperCase();
            if (!code) return showMessage("–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –≥—Ä–∏!");

            const gameRef = ref(db, `games/${code}`);
            const snapshot = await get(gameRef);

            if (!snapshot.exists()) return showMessage('–ì—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!');
            const gameData = snapshot.val();
            if (gameData.player2.id && gameData.player2.id !== playerId) return showMessage('–ö—ñ–º–Ω–∞—Ç–∞ –≤–∂–µ –∑–∞–π–Ω—è—Ç–∞!');
            
            gameCode = code;
            playerNumber = 2;
            await update(ref(db, `games/${gameCode}/player2`), { id: playerId });
            showGameArea();
            listenToGame();
        };

        function listenToGame() {
            const gameRef = ref(db, `games/${gameCode}`);
            onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    showMessage("–ì—Ä—É –±—É–ª–æ –≤–∏–¥–∞–ª–µ–Ω–æ –∞–±–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
                    setTimeout(() => location.reload(), 3000);
                    return;
                }
                const gameData = snapshot.val();
                localGameData = gameData;

                const p1 = gameData.player1;
                const p2 = gameData.player2;
                if (p1 && p2 && p1.id && p2.id && !gameData.gameStarted && p1.ready && p2.ready) {
                    if (playerNumber === 1) {
                        update(ref(db, `games/${gameCode}`), { gameStarted: true });
                    }
                }
                updateUI();
            });
        }
        
        function updateUI() {
            if (!localGameData) return;
            
            const isMyTurn = localGameData.currentTurn === playerNumber;
            const enemyPlayerNum = playerNumber === 1 ? 2 : 1;

            if (localGameData.winner) {
                if(!document.getElementById('messageOverlay').style.display || document.getElementById('messageOverlay').style.display === 'none') {
                    sounds.play(localGameData.winner === playerNumber ? 'win' : 'sunk');
                }
                setupPhase = false;
                if (localGameData.winner === playerNumber) showMessage("üéâ –ü–µ—Ä–µ–º–æ–≥–∞! üéâ");
                else showMessage("üò• –í–∏ –ø—Ä–æ–≥—Ä–∞–ª–∏ üò•");

                 enemyBoardEl.classList.remove('active-turn');
                 myBoardEl.classList.remove('active-turn');
                 statusEl.textContent = "–ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!";
            } else if (localGameData.gameStarted) {
                setupPhase = false;
                rotateBtn.classList.add('hidden');
                document.getElementById('shipsList').classList.add('hidden');
                statusEl.textContent = isMyTurn ? "üéØ –í–∞—à —Ö—ñ–¥!" : `‚è≥ –•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...`;
                enemyBoardEl.classList.toggle('active-turn', isMyTurn);
                myBoardEl.classList.toggle('active-turn', !isMyTurn);
            } else {
                const me = localGameData[`player${playerNumber}`];
                const enemy = localGameData[`player${enemyPlayerNum}`];
                if (!enemy.id) statusEl.textContent = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å—É–ø–µ—Ä–Ω–∏–∫–∞...";
                else if (me.ready) statusEl.textContent = "–û—á—ñ–∫—É—î–º–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...";
                else statusEl.textContent = "–†–æ–∑—Å—Ç–∞–≤—Ç–µ —Å–≤–æ—ó –∫–æ—Ä–∞–±–ª—ñ!";
            }
            renderBoards();
        }
        
        function renderBoards() {
            const myPlayerData = localGameData[`player${playerNumber}`];
            const myBoardToRender = myPlayerData.board || myBoardData;
            
            for (let r = 0; r < 10; r++) {
                for (let c = 0; c < 10; c++) {
                    const cell = myBoardEl.children[r * 10 + c];
                    cell.className = 'cell';
                    if (myBoardToRender[r][c] > 0) cell.classList.add('ship');
                }
            }
            
            const moves = localGameData.moves ? Object.values(localGameData.moves) : [];
            const { sunkShips } = processMoves(moves);

            moves.forEach(move => {
                const boardEl = move.player === playerNumber ? enemyBoardEl : myBoardEl;
                const cell = boardEl.children[move.row * 10 + move.col];
                cell.classList.add(move.result);
            });
            
            if (sunkShips.length > lastSunkCount) {
                sounds.play('sunk');
                lastSunkCount = sunkShips.length;
            }
            
            sunkShips.forEach(ship => {
                const boardEl = ship.player === playerNumber ? myBoardEl : enemyBoardEl;
                ship.cells.forEach(pos => {
                    const cell = boardEl.children[pos.row * 10 + pos.col];
                    cell.classList.add('sunk');
                });
            });
        }
        
        function processMoves(moves) {
            let sunkShips = [];
            const p1Board = localGameData.player1.board;
            const p2Board = localGameData.player2.board;
            if (!p1Board || !p2Board) return { sunkShips };
            
            const shipIdsOnBoard1 = getShipIds(p1Board);
            const shipIdsOnBoard2 = getShipIds(p2Board);
            const p2_moves = moves.filter(m => m.player === 2 && m.result === 'hit');
            const p1_moves = moves.filter(m => m.player === 1 && m.result === 'hit');

            shipIdsOnBoard1.forEach(shipId => {
                if (isShipSunk(shipId, p1Board, p2_moves)) {
                    sunkShips.push({ player: 1, cells: getShipCells(shipId, p1Board) });
                }
            });
             shipIdsOnBoard2.forEach(shipId => {
                if (isShipSunk(shipId, p2Board, p1_moves)) {
                    sunkShips.push({ player: 2, cells: getShipCells(shipId, p2Board) });
                }
            });
            return { sunkShips };
        }

        function showGameArea() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('displayCode').textContent = gameCode;
        }
        
        function createBoardDOM(boardId, clickHandler) {
            const boardEl = document.getElementById(boardId);
            boardEl.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => clickHandler(i, j));
                    if (boardId === 'myBoard') {
                         cell.addEventListener('mouseenter', () => previewShip(i, j));
                         cell.addEventListener('mouseleave', clearPreview);
                    }
                    boardEl.appendChild(cell);
                }
            }
        }
        
        function showMessage(msg) {
             const overlay = document.getElementById('messageOverlay');
             if (overlay.style.display === 'flex') return;
             document.getElementById('messageText').textContent = msg;
             overlay.style.display = 'flex';
        }

        function handleMyBoardClick(row, col) {
            if (!setupPhase || currentShipIndex >= ships.length) return;
            const size = ships[currentShipIndex];
            if (canPlaceShip(row, col, size, isHorizontal, myBoardData)) {
                for (let i = 0; i < size; i++) {
                    const r = isHorizontal ? row : row + i;
                    const c = isHorizontal ? col + i : col;
                    myBoardData[r][c] = currentShipIndex + 1;
                }
                currentShipIndex++;
                updateShipsList();
                renderMyPlacement();
                if (currentShipIndex >= ships.length) finishSetup();
            }
        }
        
        function renderMyPlacement() {
            for (let r = 0; r < 10; r++) {
                for (let c = 0; c < 10; c++) {
                    const cell = myBoardEl.children[r * 10 + c];
                    cell.classList.toggle('ship', myBoardData[r][c] > 0);
                }
            }
        }

        function previewShip(row, col) {
            if (!setupPhase || currentShipIndex >= ships.length) return;
            clearPreview();
            const size = ships[currentShipIndex];
            const canPlace = canPlaceShip(row, col, size, isHorizontal, myBoardData);
            for (let i = 0; i < size; i++) {
                const r = isHorizontal ? row : row + i;
                const c = isHorizontal ? col + i : col;
                if (r < 10 && c < 10) {
                    const cell = myBoardEl.children[r * 10 + c];
                    if (!cell.classList.contains('ship')) {
                       cell.classList.add(canPlace ? 'preview-ok' : 'preview-bad');
                    }
                }
            }
        }

        function clearPreview() {
             const cells = myBoardEl.querySelectorAll('.preview-ok, .preview-bad');
             cells.forEach(cell => cell.classList.remove('preview-ok', 'preview-bad'));
        }
        
        window.rotateShip = function() { isHorizontal = !isHorizontal; };

        function canPlaceShip(row, col, size, horizontal, board) {
            for (let i = 0; i < size; i++) {
                const r = horizontal ? row : row + i;
                const c = horizontal ? col + i : col;
                if (r >= 10 || c >= 10) return false;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const nr = r + dr;
                        const nc = c + dc;
                        if (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] !== 0) return false;
                    }
                }
            }
            return true;
        }
        
        function updateShipsList() {
            const counts = { 4: 0, 3: 0, 2: 0, 1: 0 };
            let shipsToPlace = ships.slice(currentShipIndex);
            if (shipsToPlace.length === 0) {
                 document.getElementById('shipsList').innerHTML = "‚úÖ –í—Å—ñ –∫–æ—Ä–∞–±–ª—ñ —Ä–æ–∑—Å—Ç–∞–≤–ª–µ–Ω–æ!";
                 return;
            }
            shipsToPlace.forEach(size => counts[size]++);
            document.getElementById('shipsList').innerHTML = `
                <div><i class="fa-solid fa-ship"></i> x4: ${counts[4] || 0}</div>
                <div><i class="fa-solid fa-ship"></i> x3: ${counts[3] || 0}</div>
                <div><i class="fa-solid fa-ship"></i> x2: ${counts[2] || 0}</div>
                <div><i class="fa-solid fa-ship"></i> x1: ${counts[1] || 0}</div>
            `;
        }

        async function finishSetup() {
            setupPhase = false;
            rotateBtn.classList.add('hidden');
            const updateData = {};
            updateData[`player${playerNumber}/board`] = myBoardData;
            updateData[`player${playerNumber}/ready`] = true;
            await update(ref(db, `games/${gameCode}`), updateData);
        }

        async function handleEnemyBoardClick(row, col) {
            if (!localGameData || localGameData.winner || !localGameData.gameStarted || setupPhase || localGameData.currentTurn !== playerNumber) return;

            const moves = localGameData.moves ? Object.values(localGameData.moves) : [];
            if (moves.some(m => m.row === row && m.col === col && m.player === playerNumber)) return;

            const enemyPlayerNum = playerNumber === 1 ? 2 : 1;
            const enemyBoard = localGameData[`player${enemyPlayerNum}`].board;
            const result = enemyBoard[row][col] > 0 ? 'hit' : 'miss';
            
            sounds.play(result);
            statusEl.textContent = result === 'hit' ? 'üéØ –í–ª—É—á–∏–≤! –°—Ç—Ä—ñ–ª—è–π—Ç–µ —â–µ!' : '‚ùå –ü—Ä–æ–º–∞—Ö!';
            
            const newMove = { player: playerNumber, row, col, result };
            const nextTurn = result === 'miss' ? enemyPlayerNum : playerNumber;
            const newMoves = [...moves, newMove];

            const updatedData = { currentTurn: nextTurn, moves: newMoves };
            
            const totalShipCells = enemyBoard.flat().filter(cell => cell > 0).length;
            const hitsOnEnemy = newMoves.filter(m => m.player === playerNumber && m.result === 'hit').length;
            if (hitsOnEnemy === totalShipCells) updatedData.winner = playerNumber;

            await update(ref(db, `games/${gameCode}`), updatedData);
        }
        
        function getShipIds(board) {
            const ids = new Set(board.flat());
            ids.delete(0);
            return [...ids];
        }
        
        function getShipCells(shipId, board) {
            const cells = [];
            for (let r = 0; r < 10; r++) for (let c = 0; c < 10; c++) if (board[r][c] === shipId) cells.push({ row: r, col: c });
            return cells;
        }
        
        function isShipSunk(shipId, board, hitMoves) {
            const shipCells = getShipCells(shipId, board);
            return shipCells.every(sc => hitMoves.some(h => h.row === sc.row && h.col === sc.col));
        }

        document.getElementById('gameCodeDisplay').onclick = function() {
            navigator.clipboard.writeText(gameCode).then(() => {
                const d = document.getElementById('gameCodeDisplay');
                const t = d.innerHTML;
                d.innerHTML = '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
                setTimeout(() => { d.innerHTML = t; }, 1500);
            }).catch(err => console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥: ', err));
        };
        
        enemyBoardEl.addEventListener('mouseover', e => {
            if (e.target.classList.contains('cell')) {
                const cell = e.target;
                if (!cell.classList.contains('hit') && !cell.classList.contains('miss')) cell.classList.add('valid-shot');
            }
        });

        enemyBoardEl.addEventListener('mouseout', e => {
             if (e.target.classList.contains('cell')) e.target.classList.remove('valid-shot');
        });

    </script>
</body>
</html>

